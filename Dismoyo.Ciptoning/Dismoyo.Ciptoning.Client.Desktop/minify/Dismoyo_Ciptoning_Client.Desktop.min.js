function checkContainer(){$("#mainContent").is(":visible")?($(".desktop-layout").tabs({activate:$.layout.callbacks.resizeTabLayout}),$(".dx-viewport").layout({name:"viewport",initPanes:!1,resizeWithWindow:!1,center:{paneSelector:".desktop-layout",children:{name:"desktopLayout",north:{paneSelector:"#topPane",resizable:!1,spacing_open:0,spacing_closed:0},center:{paneSelector:"#mainContent",onresize:$.layout.callbacks.resizeTabLayout},west:{paneSelector:"#leftPane",initHidden:!0,initClosed:!0},south:{paneSelector:"#bottomPane",resizable:!1,spacing_open:0,spacing_closed:0}}}})):setTimeout(checkContainer,50)}function checkNotification(){var n=Dismoyo_Ciptoning_Client.app.CurrentUser,t=headerMenu();n&&t&&t.option("visible")?new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vUserNotifications,select:["_"],filter:[["UserID","=",n.ID()],["IsRead","=",!1]],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vUserNotificationViewModel(n)}}).load().done(function(i){n.NotificationCount()==undefined&&n.NotificationCount(0);var r=t.option("items"),u="Images/user_notification_empty_32px.png";n.NotificationCount()!=i.length&&n.NotificationCount(i.length);CommonUtility.setJsonCookie("CurrentUser",n.toJS(),7);n.NotificationCount()>0&&(u="Images/user_notification_32px.png");r[0].iconSrc!=u&&(r[0].iconSrc=u,t.option("items",r));setTimeout(checkNotification,1e4)}).fail(function(){setTimeout(checkNotification,1e4)}):setTimeout(checkNotification,500)}function showNotification(){var i=notificationList(),t=Dismoyo_Ciptoning_Client.app.CurrentUser,n;t.NotificationCount()!=undefined&&t.NotificationCount()>0?(n=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vUserNotifications,select:["ID","HtmlMessage","IsRead"],filter:[["UserID","=",t.ID()],["IsRead","=",!1]],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vUserNotificationViewModel(n)}}),i.option("dataSource",n),n.load().done(function(t){var i,r;for(notificationPopover().show(),i=0;i<t.length;i++)r=t[i].toJS(),r.IsRead==!1&&(r.HtmlMessage="",r.IsRead=!0,n.store().update(r.ID,r).done(function(){i>=t.length-1&&checkNotification()}).fail(function(){i>=t.length-1&&checkNotification()}))})):notificationPopover().show()}function Home_checkContainer(){if(CommonUtility.validateLoggedInUser())if($("#Home_viewSubContent").is(":visible")){var n=$("#Home_viewContent").layout({name:"HomeViewContent",north:{paneSelector:"#Home_viewContentHeader",resizable:!1,spacing_open:0,spacing_closed:0},center:{paneSelector:"#Home_viewSubContent",children:{west:{paneSelector:"#Home_leftChartContent",resizable:!1,width:"300px",spacing_open:0,spacing_closed:0},center:{paneSelector:"#Home_centerChartContent",onresize:$.layout.callbacks.resizeTabLayout},east:{paneSelector:"#Home_rightChartContent",resizable:!1,spacing_open:0,spacing_closed:0}}}});desktopPane().show("west")}else setTimeout(vSalesmanTargets_checkContainer,50)}var vDiscountGroupsViewInstance,vDiscountStratasViewInstance;$(document).ready(function(){checkContainer();checkNotification()});var loadingPanel=function(){return DXUtility.getDXInstance(null,"#loadingPanel","dxLoadPanel")},setLoadingPanelByVisibility=function(n,t){var i=DXUtility.getDXInstance(null,n,"dxLoadPanel");i&&i.option("visible",t)},showLoadingPanel=function(){var n=loadingPanel();n&&n.option("visible",!0)},hideLoadingPanel=function(){var n=loadingPanel();n&&n.option("visible",!1)},desktopPane=function(){return $(".desktop-layout").layout()},mainMenuItems=[{ID:"1",name:"Home",iconSrc:"Images/home_32px.png",uri:"Home",viewScript:"Views/Home/Home.js",view:"Views/Home/Home.dxview"},{ID:"2",name:"Settings",iconSrc:"Images/settings_32px.png",isHeadOffice:!0},{ID:"2_1",categoryId:"2",name:"Users",iconSrc:"Images/user_32px.png",uri:"vUsers",viewScript:"Views/vUser/vUsers.js",view:"Views/vUser/vUsers.dxview",isHeadOffice:!0},{ID:"2_2",categoryId:"2",name:"User Groups",iconSrc:"Images/role_32px.png",uri:"vRoles",viewScript:"Views/vRole/vRoles.js",view:"Views/vRole/vRoles.dxview",isHeadOffice:!0},{ID:"2_3",categoryId:"2",name:"Permissions",iconSrc:"Images/permission_32px.png",uri:"vPermissionObjects",viewScript:"Views/vPermissionObject/vPermissionObjects.js",view:"Views/vPermissionObject/vPermissionObjects.dxview",isHeadOffice:!0},{ID:"2_5",categoryId:"2",name:"System Parameters",iconSrc:"Images/system_parameter_32px.png",uri:"vSystemParameters",viewScript:"Views/vSystemParameter/vSystemParameters.js",view:"Views/vSystemParameter/vSystemParameters.dxview",isHeadOffice:!0},{ID:"3",name:"Master Data",iconSrc:"Images/master_data_32px.png"},{ID:"3_1",categoryId:"3",name:"Sales Organization",iconSrc:"Images/sales_organization_32px.png",isHeadOffice:!0},{ID:"3_1_1",categoryId:"3_1",name:"Territories",iconSrc:"Images/territory_32px.png",uri:"vTerritories",viewScript:"Views/vTerritory/vTerritories.js",view:"Views/vTerritory/vTerritories.dxview",isHeadOffice:!0,permissionObjectID:"Territories.View"},{ID:"3_1_2",categoryId:"3_1",name:"Regions",iconSrc:"Images/region_32px.png",uri:"vRegions",viewScript:"Views/vRegion/vRegions.js",view:"Views/vRegion/vRegions.dxview",isHeadOffice:!0,permissionObjectID:"Regions.View"},{ID:"3_1_3",categoryId:"3_1",name:"Areas",iconSrc:"Images/area_32px.png",uri:"vAreas",viewScript:"Views/vArea/vAreas.js",view:"Views/vArea/vAreas.dxview",isHeadOffice:!0,permissionObjectID:"Areas.View"},{ID:"3_1_4",categoryId:"3_1",name:"Companies",iconSrc:"Images/company_32px.png",uri:"vCompanies",viewScript:"Views/vCompany/vCompanies.js",view:"Views/vCompany/vCompanies.dxview",isHeadOffice:!0,permissionObjectID:"Companies.View"},{ID:"3_1_5",categoryId:"3_1",name:"Sites",iconSrc:"Images/site_32px.png",uri:"vSites",viewScript:"Views/vSite/vSites.js",view:"Views/vSite/vSites.dxview",isHeadOffice:!0,permissionObjectID:"Sites.View"},{ID:"3_2",categoryId:"3",name:"Inventories",iconSrc:"Images/inventory_32px.png"},{ID:"3_2_1",categoryId:"3_2",name:"Product Brands",iconSrc:"Images/product_brand_32px.png",uri:"vProductBrands",viewScript:"Views/vProductBrand/vProductBrands.js",view:"Views/vProductBrand/vProductBrands.dxview",isHeadOffice:!0},{ID:"3_2_2",categoryId:"3_2",name:"Products",iconSrc:"Images/product_32px.png",uri:"vProducts",viewScript:"Views/vProduct/vProducts.js",view:"Views/vProduct/vProducts.dxview",isHeadOffice:!0},{ID:"3_2_3",categoryId:"3_2",name:"Product Prices",iconSrc:"Images/product_price_32px.png",uri:"vProductPrices",viewScript:"Views/vProductPrice/vProductPrices.js",view:"Views/vProductPrice/vProductPrices.dxview",isHeadOffice:!0},{ID:"3_2_4",categoryId:"3_2",name:"Warehouses",iconSrc:"Images/warehouse_32px.png",uri:"vWarehouses",viewScript:"Views/vWarehouse/vWarehouses.js",view:"Views/vWarehouse/vWarehouses.dxview"},{ID:"3_3",categoryId:"3",name:"Sales Orders",iconSrc:"Images/sales_32px.png"},{ID:"3_3_1",categoryId:"3_3",name:"Customer Categories",iconSrc:"Images/sales_organization_32px.png",uri:"vCustomerCategories",viewScript:"Views/vCustomerCategory/vCustomerCategories.js",view:"Views/vCustomerCategory/vCustomerCategories.dxview",isHeadOffice:!0},{ID:"3_3_2",categoryId:"3_3",name:"Salesman",iconSrc:"Images/salesman_32px.png",uri:"vSalesmen",viewScript:"Views/vSalesman/vSalesmen.js",view:"Views/vSalesman/vSalesmen.dxview"},{ID:"3_3_3",categoryId:"3_3",name:"Customers",iconSrc:"Images/customer_32px.png",uri:"vCustomers",viewScript:"Views/vCustomer/vCustomers.js",view:"Views/vCustomer/vCustomers.dxview"},{ID:"3_3_4",categoryId:"3_3",name:"Salesman Target",iconSrc:"Images/salesman_target_32px.png",uri:"vSalesmanTargets",viewScript:"Views/vSalesmanTarget/vSalesmanTargets.js",view:"Views/vSalesmanTarget/vSalesmanTargets.dxview"},{ID:"3_3_6",categoryId:"3_3",name:"Closing Period ",iconSrc:"Images/close_period_32px.png",uri:"vClosingPeriods",viewScript:"Views/vClosingPeriod/vClosingPeriods.js",view:"Views/vClosingPeriod/vClosingPeriods.dxview",isHeadOffice:!0},{ID:"3_4",categoryId:"3",name:"Discount & Promo",iconSrc:"Images/discount_promo_32px.png",isHeadOffice:!0},{ID:"3_4_1",categoryId:"3_4",name:"Discount Strata",iconSrc:"Images/discount_strata_32px.png",uri:"vDiscountStratas",viewScript:"Views/vDiscountStrata/vDiscountStratas.js",view:"Views/vDiscountStrata/vDiscountStratas.dxview",isHeadOffice:!0},{ID:"3_4_2",categoryId:"3_4",name:"Discount Groups",iconSrc:"Images/discount_group_32px.png",uri:"vDiscountGroups",viewScript:"Views/vDiscountGroup/vDiscountGroups.js",view:"Views/vDiscountGroup/vDiscountGroups.dxview",isHeadOffice:!0},{ID:"3_5",categoryId:"3",name:"Routes",iconSrc:"Images/route_32px.png"},{ID:"3_5_2",categoryId:"3_5",name:"Route Plans",iconSrc:"Images/route_plan_32px.png",uri:"vRoutePlans",viewScript:"Views/vRoutePlan/vRoutePlans.js",view:"Views/vRoutePlan/vRoutePlans.dxview"},{ID:"4",name:"Inventory Transaction",iconSrc:"Images/inventory_32px.png"},{ID:"4_1",categoryId:"4",name:"Stock Views",iconSrc:"Images/stock_view_32px.png",uri:"vStockViews",viewScript:"Views/vStockView/vStockViews.js",view:"Views/vStockView/vStockViews.dxview"},{ID:"4_2",categoryId:"4",name:"Stock Receivals",iconSrc:"Images/stock_receive_32px.png",uri:"vStockReceives",viewScript:"Views/vStockReceive/vStockReceives.js",view:"Views/vStockReceive/vStockReceives.dxview"},{ID:"4_3",categoryId:"4",name:"Stock Opnames",iconSrc:"Images/stock_opname_32px.png",uri:"vStockOpnames",viewScript:"Views/vStockOpname/vStockOpnames.js",view:"Views/vStockOpname/vStockOpnames.dxview"},{ID:"4_4",categoryId:"4",name:"Stock Changes",onClick:"#vStockChanges",iconSrc:"Images/stock_changes_32px.png",uri:"vStockChanges",viewScript:"Views/vStockChanges/vStockChanges.js",view:"Views/vStockChanges/vStockChanges.dxview"},{ID:"4_5",categoryId:"4",name:"Stock Disposals",onClick:"#vStockDisposals",iconSrc:"Images/stock_disposal_32px.png",uri:"vStockDisposals",viewScript:"Views/vStockDisposal/vStockDisposals.js",view:"Views/vStockDisposal/vStockDisposals.dxview"},{ID:"4_6",categoryId:"4",name:"Stock Transfers",iconSrc:"Images/stock_transfer_32px.png",uri:"vStockTransfers",viewScript:"Views/vStockTransfer/vStockTransfers.js",view:"Views/vStockTransfer/vStockTransfers.dxview"},{ID:"5",name:"Sales Order Transaction",iconSrc:"Images/sales_32px.png"},{ID:"5_1",categoryId:"5",name:"Sales Orders",iconSrc:"Images/sales_order_32px.png",uri:"vSalesOrders",viewScript:"Views/vSalesOrder/vSalesOrders.js",view:"Views/vSalesOrder/vSalesOrders.dxview"},{ID:"5_2",categoryId:"5",name:"Sales Order Returns",iconSrc:"Images/sales_order_return_32px.png",uri:"vSalesOrderReturns",viewScript:"Views/vSalesOrderReturn/vSalesOrderReturns.js",view:"Views/vSalesOrderReturn/vSalesOrderReturns.dxview"},{ID:"5_3",categoryId:"5",name:"Sales Order Swaps",iconSrc:"Images/sales_order_swap_32px.png",uri:"vSalesOrderSwaps",viewScript:"Views/vSalesOrderSwap/vSalesOrderSwaps.js",view:"Views/vSalesOrderSwap/vSalesOrderSwaps.dxview"},{ID:"5_4",categoryId:"5",name:"Sales Order FOC",iconSrc:"Images/sales_order_foc_32px.png",uri:"vSalesOrderFOCs",viewScript:"Views/vSalesOrderFOC/vSalesOrderFOCs.js",view:"Views/vSalesOrderFOC/vSalesOrderFOCs.dxview"},{ID:"5_5",categoryId:"5",name:"Sales Order Samples",iconSrc:"Images/sales_order_sample_32px.png",uri:"vSalesOrderSamples",viewScript:"Views/vSalesOrderSample/vSalesOrderSamples.js",view:"Views/vSalesOrderSample/vSalesOrderSamples.dxview"},{ID:"6",name:"Reports",iconSrc:"Images/reports_32px.png"},{ID:"6_1",categoryId:"6",name:"Daily Sales Reports",iconSrc:"Images/daily_sales_report_32px.png",uri:"vDailySalesReports",viewScript:"Views/vDailySalesReport/vDailySalesReports.js",view:"Views/vDailySalesReport/vDailySalesReports.dxview"},{ID:"6_2",categoryId:"6",name:"Sales by Channel Reports",iconSrc:"Images/sales_by_channel_report_32px.png",uri:"vSalesByChannelReports",viewScript:"Views/vSalesByChannelReport/vSalesByChannelReports.js",view:"Views/vSalesByChannelReport/vSalesByChannelReports.dxview"},{ID:"6_3",categoryId:"6",name:"Sales by Site Reports",iconSrc:"Images/sales_by_site_report_32px.png",uri:"vSalesBySiteReports",viewScript:"Views/vSalesBySiteReport/vSalesBySiteReports.js",view:"Views/vSalesBySiteReport/vSalesBySiteReports.dxview"},{ID:"6_4",categoryId:"6",name:"Daily Salesman Reports",iconSrc:"Images/daily_salesman_report_32px.png",uri:"vDailySalesmanReports",viewScript:"Views/vDailySalesmanReport/vDailySalesmanReports.js",view:"Views/vDailySalesmanReport/vDailySalesmanReports.dxview"},{ID:"6_5",categoryId:"6",name:"Sales by Order Reports",iconSrc:"Images/sales_by_order_report_32px.png",uri:"vSalesByOrderReports",viewScript:"Views/vSalesByOrderReport/vSalesByOrderReports.js",view:"Views/vSalesByOrderReport/vSalesByOrderReports.dxview"},{ID:"6_6",categoryId:"6",name:"Customer Master Reports",iconSrc:"Images/customer_master_report_32px.png",uri:"vCustomerMasterReports",viewScript:"Views/vCustomerMasterReport/vCustomerMasterReports.js",view:"Views/vCustomerMasterReport/vCustomerMasterReports.dxview"},{ID:"6_7",categoryId:"6",name:"Salesman Activity Reports",iconSrc:"Images/stock_view_32px.png",uri:"vSalesmanActivityReports",viewScript:"Views/vSalesmanActivityReport/vSalesmanActivityReports.js",view:"Views/vSalesmanActivityReport/vSalesmanActivityReports.dxview"}],headerMenu=function(){return DXUtility.getDXInstance(null,"#headerMenu","dxMenu")},notificationPopover=function(){return DXUtility.getDXInstance(null,"#notificationPopover","dxPopover")},notificationList=function(){return DXUtility.getDXInstance(null,"#notificationList","dxList")},changePassword=new Dismoyo_Ciptoning_Client.ChangePassword;(function(n,t){var i=t.framework.html.layoutSets;i.desktop=i.desktop||[];i.desktop.push({platform:"generic",controller:new t.framework.html.DefaultLayoutController({name:"desktop"})})})(jQuery,DevExpress);Dismoyo_Ciptoning_Client.ChangePassword=function(){var n={performSave:function(){var r=i(),n=r.validate().isValid,u=n?"":"Please specify the required fields.",e=Dismoyo_Ciptoning_Client.app.CurrentUser,o=r.getEditor("OldPassword").option("value"),f;n&&o!=e.Password()&&(u="Old Password is incorrect.",n=!1);n&&(f={ID:e.ID(),Password:r.getEditor("NewPassword").option("value")},Dismoyo_Ciptoning_Client.DB.ChangePasswords.update(f.ID,f).done(function(){DevExpress.ui.dialog.alert("Password has been successfully changed. System will navigate to the Sign In page.","Change Password Succeed");t.visible(!1);CommonUtility.clearCookie("CurrentUser");Dismoyo_Ciptoning_Client.app.navigate(Dismoyo_Ciptoning_Client.app.router.format({view:"Login"}))}).fail(function(n){DevExpress.ui.dialog.alert(n.message,"Change Password Failed")}));u!=""&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(u),"Change Password Failed")},performCancel:function(){t.visible(!1)}},r=function(){return DXUtility.getDXInstance(null,"#ChangePassword_popup","dxPopup")},t={showTitle:!0,width:400,height:230,title:"Change Password",visible:ko.observable(!1)},u=function(){return DXUtility.getDXInstance(null,"#ChangePassword_popupContent","dxScrollView")},i=function(){return DXUtility.getDXInstance(null,"#ChangePassword_form","dxForm")},f={colCount:3,showColonAfterLabel:!1,labelLocation:"left",onEnterKey:function(){n.performSearch()},items:[{dataField:"OldPassword",validationRules:[{type:"required"}],label:{text:"Old Password"},colSpan:3,editorOptions:{mode:"password",maxLength:64,onEnterKey:function(){n.performSave()}}},{dataField:"NewPassword",validationRules:[{type:"required"}],label:{text:"NewPassword"},colSpan:3,editorOptions:{mode:"password",maxLength:64,onEnterKey:function(){n.performSave()}}},{dataField:"ConfirmNewPassword",validationRules:[{type:"required"},{type:"custom",validationCallback:function(n){var t=i().getEditor("NewPassword").option("value");return n.value!=t?(n.rule.message="Confirm New Password is not match with New Password.",!1):!0}}],label:{text:"Confirm New Password"},colSpan:3,editorOptions:{mode:"password",maxLength:64,onEnterKey:function(){n.performSave()}}}]},e=function(){return DXUtility.getDXInstance(null,"#ChangePassword_save","dxButton")},o={text:"Save",type:"apply",onClick:function(){n.performSave()}},s=function(){return DXUtility.getDXInstance(null,"#ChangePassword_cancel","dxButton")},h={text:"Cancel",onClick:function(){n.performCancel()}};return{events:n,popup:r,popupOptions:t,popupData:ko.observable(),popupContent:u,popupContentOptions:{scrollByContent:!0,scrollByThumb:!0},form:i,formOptions:f,save:e,saveOptions:o,cancel:s,cancelOptions:h}};Dismoyo_Ciptoning_Client.Home=function(n,t){"use strict";function u(){var t,n,i;Home_checkContainer();t=Dismoyo_Ciptoning_Client.app.CurrentUser;n=[];t.IsHeadOffice()||(n=[["TerritoryID","=",t.TerritoryID()],"and",["RegionID","=",t.RegionID()],"and",["AreaID","=",t.AreaID()],"and",["CompanyID","=",t.CompanyID()],"and",["SiteID","=",t.SiteID()]]);i=new Date;n.length>0&&n.push("and");n.push(["TransactionDate",">=",DateTimeUtility.getFirstDayOfMonth(i)]);n.push("and");n.push(["TransactionDate","<=",DateTimeUtility.getLastDayOfMonth(i)]);n.length>0&&(n=[n])}var i=t.layoutController.name==="split",r=$.Deferred(),f=function(){return DXUtility.getDXInstance(null,"#Home_leftChart","dxChart")},e=function(){return DXUtility.getDXInstance(null,"#Home_centerChart","dxChart")},o=function(){return DXUtility.getDXInstance(null,"#Home_rightChart","dxChart")};return{isReady:r.promise(),viewShowing:u,openCreateViewAsRoot:i,icon:"Images/home_32px.png",leftChartOptions:{dataSource:[{arg:"A",val:24},{arg:"B",val:120},{arg:"C",val:32},{arg:"D",val:3}],legend:{visible:!1},series:{type:"bar"},argumentAxis:{tickInterval:10},valueAxis:{label:{format:{}}},title:"Current Sales Order"},centerChartOptions:{dataSource:[],legend:{visible:!1},series:{type:"bar"},argumentAxis:{tickInterval:10},valueAxis:{label:{format:{}}},title:"This Month Sales Order"},rightChartOptions:{dataSource:[{arg:"AA",val:24},{arg:"BB",val:120},{arg:"CC",val:32},{arg:"DD",val:3}],legend:{visible:!1},series:{type:"bar"},argumentAxis:{tickInterval:10},valueAxis:{label:{format:{}}},title:"Current Sales Order"}}};Dismoyo_Ciptoning_Client.Login=function(n,t){"use strict";function e(){if($("#Login_controls").is(":visible")){var n=$("#Login_viewContent").layout({name:"LoginViewContent",center:{paneSelector:"#Login_viewSubContent",spacing_open:0,spacing_closed:0,onresize:function(n,t){var i=DXUtility.getDXInstance(t,"#Login_gallery","dxGallery");i&&(i.option("width",t.width()),i.option("height",t.height()))}},east:{paneSelector:"#Login_controls",size:350,resizable:!1,spacing_open:0,spacing_closed:0}});n.resizeAll()}else setTimeout(Login_checkContainer,50)}function o(){e();$("#headerWelcome").text("");headerMenu().option("visible",!1);desktopPane().hide("west")}function i(){var t=r(),u=t.validate().isValid,n,i;u&&(showLoadingPanel(),n=new Dismoyo_Ciptoning_Client.vUserViewModel,n.Name(t.getEditor("UserName").option("value")),n.Password(t.getEditor("Password").option("value")),i=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vUsers,filter:["Name","=",n.Name()],expand:"ChildPermissions",map:function(n){return new Dismoyo_Ciptoning_Client.vUserViewModel(n)}}),CommonUtility.setJsonCookie("CurrentUser",n.toJS(),7),i.load().done(function(t){var r,c,i,e,u,o,f,l,s,h;if(t.length>0){for(r=t[0],c=r.toJS().ChildPermissions,r.Password(n.Password()),r.ChildPermissions(undefined),CommonUtility.setJsonCookie("CurrentUser",r.toJS(),7),i=JSON.stringify(c),(i==undefined||i==null)&&(i=""),e=Math.ceil(i.length/2048),CommonUtility.setCookie("CurrentUserPermissionsLength",e,7),u=0;u<e;u++)o=u*2048,f=o+2048,f>=i.length&&(f=i.length),l=i.substring(o,f),CommonUtility.setCookie("CurrentUserPermissions"+(u+1).toString(),l,7);s=headerMenu();h=s.option("items");h[0].iconSrc="Images/user_notification_empty_32px.png";s.option("items",h);Dismoyo_Ciptoning_Client.LocalStore.loadAllData();Dismoyo_Ciptoning_Client.app.navigate(Dismoyo_Ciptoning_Client.app.router.format({view:"Home"}))}else DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Invalid user name or password"),"Login Failed"),CommonUtility.clearCookie("CurrentUser");hideLoadingPanel()}).fail(function(n){DevExpress.ui.dialog.alert(n.message,"Login Failed");CommonUtility.clearCookie("CurrentUser");hideLoadingPanel()}))}var u=t.layoutController.name==="split",f=$.Deferred(),s=function(){return DXUtility.getDXInstance(null,"#Login_gallery","dxGallery")},r=function(){return DXUtility.getDXInstance(null,"#Login_form","dxForm")},h={colCount:1,showColonAfterLabel:!1,labelLocation:"left",onEnterKey:function(){i()},items:[{itemType:"group",caption:"Sign In",colCount:3,items:[{dataField:"UserName",validationRules:[{type:"required"}],label:{text:"User Name"},colSpan:3,editorOptions:{maxLength:256,onEnterKey:function(){i()}}},{dataField:"Password",validationRules:[{type:"required"}],label:{text:"Password"},colSpan:3,editorOptions:{mode:"password",maxLength:64,onEnterKey:function(){i()}}}]}]},c=function(){return DXUtility.getDXInstance(null,"#Login_submit","dxButton")},l={text:"Sign In",width:"120px",type:"default",onClick:function(){i()}};return{isReady:f.promise(),viewShowing:o,openCreateViewAsRoot:u,icon:"Images/territory_32px.png",gallery:s,galleryOptions:{dataSource:["Galleries/1.jpg","Galleries/2.jpg","Galleries/3.jpg"],height:"100%",stretchImages:!0,slideshowDelay:3e3,loop:!0,showNavButtons:!0,showIndicator:!0},loginForm:r,loginFormOptions:h,submit:c,submitOptions:l}};Dismoyo_Ciptoning_Client.CollapsibleFilter=function(){var n={performSearch:function(){},performClear:function(){var r=t().option("items"),u,f,e,i;for(u in r)if(r[u].itemType){if(r[u].itemType=="group"){f=r[u].items;for(e in f)i=t().getEditor(f[e].dataField),i&&i.option("value",null)}}else i=t().getEditor(r[u].dataField),i&&i.option("value",null);n.performSearch()}},i=function(){return DXUtility.getDXInstance(null,"#collapsibleFilter_filter","dxAccordion")},r={dataSource:[{title:"Filter"}],itemTemplate:"content",collapsible:!0,multiple:!0,focusStateEnabled:!1,onItemTitleClick:DXUtility.fixAccordionItemTitleClick,onItemClick:DXUtility.fixAccordionItemClick},t=function(){return DXUtility.getDXInstance(null,"#collapsibleFilter_form","dxForm")},u={colCount:3,showColonAfterLabel:!1,labelLocation:"top",onEnterKey:function(){n.performSearch()}},f=function(){return DXUtility.getDXInstance(null,"#collapsibleFilter_search","dxButton")},e={text:"Search",icon:"search",type:"apply",onClick:function(){n.performSearch()}},o=function(){return DXUtility.getDXInstance(null,"#collapsibleFilter_clear","dxButton")},s={text:"Clear",onClick:function(){n.performClear()}};return{events:n,filter:i,filterOptions:r,form:t,formOptions:u,search:f,searchOptions:e,clear:o,clearOptions:s}};Dismoyo_Ciptoning_Client.CommonGridView=function(){var n={performNewRow:function(){i().addRow()},performDeleteRows:function(t){var f=t.option("dataSource"),i=t.getSelectedRowKeys(),r,u;for(i.length>0&&t.beginCustomLoading(),r=0,u=0;u<i.length;u++)f.store().remove(i[u]).done(function(){r++;r>=i.length-1&&f.load().done(function(){t.clearSelection();t.endCustomLoading();t.refresh();n.rowsRemoved()}).fail(function(){t.endCustomLoading()})}).fail(function(u){var e=$(".dx-popup-normal>.dx-dialog-content");e.length==0&&DevExpress.ui.dialog.alert(u.message,"Delete Failed");r++;r>=i.length-1&&f.load().done(function(){t.clearSelection();t.endCustomLoading();t.refresh();n.rowsRemoved()}).fail(function(){t.endCustomLoading()})})},rowInserted:function(){},rowUpdated:function(){},rowRemoved:function(){},rowsRemoved:function(){},rowChanged:function(){},initRow:function(){},editingStart:function(){},selectionChanged:function(){},rowValidation:function(){}},f=function(){return $("#commonGridView_commands")},e=function(){return DXUtility.getDXInstance(null,"#commonGridView_newRow","dxButton")},o={text:"New",icon:"add",onClick:function(){n.performNewRow(this)}},r=function(){return DXUtility.getDXInstance(null,"#commonGridView_deleteRows","dxButton")},s={text:"Delete",icon:"remove",disabled:!0,onClick:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(t){if(t){var r=i();n.performDeleteRows(r,r.getSelectedRowsData())}})}},t=function(){$(".dx-error-row").remove()},u=function(n){t();var r=$(".dx-datagrid-table.dx-datagrid-table-fixed","#commonGridView_dataGrid").first(),i="<tr class='dx-error-row'><td colspan='"+$("col",$(r).first()).length+"' role='presentation'><div class='dx-closebutton dx-datagrid-action' onclick='javascript: $(this).parent().parent().remove();'><\/div><div class='dx-error-message'>";i+=n;i+="<\/div><\/td><\/tr>";$("tbody",$(r).first()).append(i)},h=function(n,t){var i=n.component.columnOption(t,"validationRules"),r=n.component.columnOption(t,"value");for(var u in i)if(i[u].type=="required"&&r!=null)return!0;return!1},i=function(){return DXUtility.getDXInstance(null,"#commonGridView_dataGrid","dxDataGrid")},c={height:"100%",paging:{},pager:{showPageSizeSelector:!0,allowedPageSizes:[5,10,20],showInfo:!0,showNavigationButtons:!0},allowColumnResizing:!0,columnAutoWidth:!1,hoverStateEnabled:!0,selection:{mode:"multiple"},editing:{editMode:"row",allowUpdating:!0,allowDeleting:!0,editEnabled:!0,removeEnabled:!0},onRowInserted:function(i){n.rowInserted(i);n.rowChanged(i);t()},onRowUpdated:function(i){n.rowUpdated(i);n.rowChanged(i);t()},onRowRemoved:function(i){n.rowRemoved(i);n.rowChanged(i);t()},onCellClick:function(){t()},onSelectionChanged:function(i){var u=i.component.option("editing");r().option("disabled",!(u.allowDeleting&&i.selectedRowsData.length>0));n.selectionChanged(i);t()},onEditingStart:function(t){var i,r,u,f;n.editingStart(t);i=t.component.option("columns");for(r in i)t.component.columnOption(i[r].dataField,"onlyAllowAdd")&&t.component.columnOption(i[r].dataField,"allowEditing",!1),i[r].dataField=="Code"&&t.component.columnOption(i[r].dataField,"allowEditing",!1),t.component.columnOption(i[r].dataField,"dataType")=="number"&&(u=t.component.columnOption(i[r].dataField,"validationRules"),u||(u=[]),f=t.component.columnOption(i[r].dataField,"format"),f=="fixedPoint"?u.push({type:"pattern",pattern:"^[0-9]+(.[0-9][0-9]?)?",message:i[r].caption+" must be positive number"}):u.push({type:"pattern",pattern:"^[0-9]+$",message:i[r].caption+" must be positive number"}),t.component.columnOption(i[r].dataField,"validationRules",u));t.component.repaint()},onInitNewRow:function(t){var i,r,u,f;n.initRow(t);i=t.component.option("columns");for(r in i)t.component.columnOption(i[r].dataField,"onlyAllowAdd")&&t.component.columnOption(i[r].dataField,"allowEditing",!0),i[r].dataField=="Code"&&t.component.columnOption(i[r].dataField,"allowEditing",!0),t.component.columnOption(i[r].dataField,"dataType")=="number"&&(u=t.component.columnOption(i[r].dataField,"validationRules"),u||(u=[]),f=t.component.columnOption(i[r].dataField,"format"),f=="fixedPoint"?u.push({type:"pattern",pattern:"^[0-9]+(.[0-9][0-9]?)?",message:i[r].caption+" must be positive number"}):u.push({type:"pattern",pattern:"^[0-9]+$",message:i[r].caption+" must be positive number"}),t.component.columnOption(i[r].dataField,"validationRules",u)),t.component.columnOption(i[r].dataField,"defaultValue")!==undefined&&(t.data[i[r].dataField]=t.component.columnOption(i[r].dataField,"defaultValue"));t.component.repaint()},onRowValidating:function(i){var f;t();var r=i.component.option("columns"),o="",e="";for(f in r)if(h(i,r[f].dataField)&&!i.newData[r[f].dataField]){o=r[f].dataField;e=r[f].caption;u((e?e:o)+" is required");i.isValid=!1;break}for(f in r)if(i.component.columnOption(r[f].dataField,"dataType")=="number"&&i.newData[r[f].dataField]<0){o=r[f].dataField;e=r[f].caption;u((e?e:o)+" must be positive value");i.isValid=!1;break}n.rowValidation(i)},onDataErrorOccurred:function(){setTimeout(function(){t()},5e3)}};return $("#cancelRow").dxButton({onClick:function(){t()}}),{events:n,commands:f,newRow:e,newRowOptions:o,deleteRows:r,deleteRowsOptions:s,dataGrid:i,dataGridOptions:c}};Dismoyo_Ciptoning_Client.CommonIFrame=function(){var t=function(){return $("#commonIFrame_iframe")},n=function(){return DXUtility.getDXInstance(null,"#commonIFrame_loadingPanel","dxLoadPanel")},i=function(){var t=n();t&&t.option("visible",!0)},r=function(){var t=n();t&&t.option("visible",!1)};return{events:{},showLoadingPanel:i,hideLoadingPanel:r,loadingPanel:n,iframe:t}};Dismoyo_Ciptoning_Client.CommonPopupEdit=function(){var n={performOK:function(n){n.commonPopupEdit.popupEditOptions.visible(!1)},performCancel:function(n){n.commonPopupEdit.popupEditOptions.visible(!1)}},t=function(){return DXUtility.getDXInstance(null,"#commonPopupEdit_popupEdit","dxPopup")},i={deferRendering:!1,editingKey:null,showTitle:!0,title:"Title",fullScreen:!0,disabled:ko.observable(!1),visible:ko.observable(!1)},r=function(){return DXUtility.getDXInstance(null,"#commonPopupEdit_validationGroup","dxValidationGroup")},u=function(){return DXUtility.getDXInstance(null,"#commonPopupEdit_popupContent","dxScrollView")},f=function(){return DXUtility.getDXInstance(null,"#commonPopupEdit_form","dxForm")},e={colCount:3,showColonAfterLabel:!1,labelLocation:"left",onEnterKey:function(){n.performSearch()}},o=function(){return $("#commonPopupEdit_extContent")},s=function(){return DXUtility.getDXInstance(null,"#commonPopupEdit_ok","dxButton")},h={text:"OK",type:"apply",onClick:function(){n.performOK(this)}},c=function(){return DXUtility.getDXInstance(null,"#commonPopupEdit_cancel","dxButton")},l={text:"Cancel",onClick:function(){n.performCancel(this)}};return{events:n,popupEdit:t,popupEditOptions:i,popupEditData:ko.observable(),validationGroup:r,popupContent:u,popupContentOptions:{scrollByContent:!0,scrollByThumb:!0},form:f,formOptions:e,extContent:o,ok:s,okOptions:h,cancel:c,cancelOptions:l}};Dismoyo_Ciptoning_Client.CommonPopupIFrame=function(){var n={performOK:function(n){n.commonPopupIFrame.popupEditOptions.visible(!1)},performCancel:function(n){n.commonPopupIFrame.popupEditOptions.visible(!1)}},i=function(){return DXUtility.getDXInstance(null,"#commonPopupIFrame_popupEdit","dxPopup")},r={deferRendering:!1,showTitle:!0,title:"Title",fullScreen:!0,disabled:ko.observable(!1),visible:ko.observable(!1)},u=function(){return DXUtility.getDXInstance(null,"#commonPopupIFrame_validationGroup","dxValidationGroup")},f=function(){return $("#commonPopupIFrame_iframe")},t=function(){return DXUtility.getDXInstance(null,"#commonPopupIFrame_loadingPanel","dxLoadPanel")},e=function(){var n=t();n&&n.option("visible",!0)},o=function(){var n=t();n&&n.option("visible",!1)},s=function(){return DXUtility.getDXInstance(null,"#commonPopupIFrame_ok","dxButton")},h={text:"OK",type:"apply",onClick:function(){n.performOK(this)}},c=function(){return DXUtility.getDXInstance(null,"#commonPopupIFrame_cancel","dxButton")},l={text:"Cancel",onClick:function(){n.performCancel(this)}};return{events:n,popupEdit:i,popupEditOptions:r,popupEditData:ko.observable(),validationGroup:u,showLoadingPanel:e,hideLoadingPanel:o,loadingPanel:t,iframe:f,ok:s,okOptions:h,cancel:c,cancelOptions:l}};Dismoyo_Ciptoning_Client.CommonTreeView=function(){var n={performSearchItem:function(){},itemClick:function(){}},t=function(){return DXUtility.getDXInstance(null,"#commonTreeView_loadingPanel","dxLoadPanel")},r=function(){return DXUtility.getDXInstance(null,"#commonTreeView_search","dxTextBox")},u={placeholder:"Search",mode:"search",valueChangeEvent:"keyup",onValueChanged:function(t){i().option("searchValue",t.value);n.performSearchItem(t.value)}},i=function(){return DXUtility.getDXInstance(null,"#commonTreeView_treeView","dxTreeView")},f={onItemClick:function(t){$(".dx-treeview-item").removeClass("desktop-commonTreeView-focusedItem");$(t.itemElement).addClass("desktop-commonTreeView-focusedItem");t.component.selectedItem=t.itemData;n.itemClick(t)}},e=function(){var n=t();n&&n.option("visible",!0)},o=function(){var n=t();n&&n.option("visible",!1)};return{events:n,loadingPanel:t,showLoadingPanel:e,hideLoadingPanel:o,loadingPanelOptions:{showIndicator:!0,showPane:!0,shading:!1,closeOnOutsideClick:!1},search:r,searchOptions:u,treeView:i,treeViewOptions:f}};Dismoyo_Ciptoning_Client.ProductLotPopupEdit=function(){var u,n={performSave:function(){r.visible(!1)},performCancel:function(){r.visible(!1)},performNewRow:function(){i().addRow();t().option("disabled",!0);u=setInterval(f,500)},performEditingStart:function(){t()&&(t().option("disabled",!0),u=setInterval(f,500))},performDeleteRows:function(n){for(var r=n.option("dataSource"),i=n.getSelectedRowKeys(),t=0;t<i.length;t++)r.store().remove(i[t]).done(function(){t>=i.length-1&&r.load().done(function(){n.refresh()})}).fail(function(){t>=i.length-1&&r.load().done(function(){n.refresh()})})}},o=function(){for(var t=$(".dx-command-edit","#productLotPopupEdit_dataGrid"),n=0;n<t.length;n++)if($(t[n]).text().trim().indexOf("Save")>=0)return!0;return!1},f=function(){o()||t()&&t().option("disabled",!1)},s=function(){return DXUtility.getDXInstance(null,"#productLotPopupEdit_newRow","dxButton")},h={text:"New",icon:"add",onClick:function(){n.performNewRow()}},e=function(){return DXUtility.getDXInstance(null,"#productLotPopupEdit_deleteRows","dxButton")},c={text:"Delete",icon:"remove",disabled:!0,onClick:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(t){if(t){var r=i();n.performDeleteRows(r,r.getSelectedRowsData())}})}},i=function(){return DXUtility.getDXInstance(null,"#productLotPopupEdit_dataGrid","dxDataGrid")},l={showBorders:!0,paging:{enabled:!1},allowColumnResizing:!1,columnAutoWidth:!1,hoverStateEnabled:!0,selection:{mode:"multiple"},editing:{editMode:"row",allowUpdating:!0,allowDeleting:!0,editEnabled:!0,removeEnabled:!0},onSelectionChanged:function(n){e().option("disabled",!n.selectedRowsData.length)},onEditorPrepared:function(){n.performEditingStart()}},a=function(){return DXUtility.getDXInstance(null,"#productLotPopupEdit_popupEdit","dxPopup")},r={editingKey:null,itemStatusID:null,showTitle:!0,width:700,title:"Edit Lot Number",visible:ko.observable(!1)},v=function(){return DXUtility.getDXInstance(null,"#productLotPopupEdit_popupContent","dxScrollView")},y=function(){return DXUtility.getDXInstance(null,"#productLotPopupEdit_form","dxForm")},p={colCount:3,showColonAfterLabel:!1,labelLocation:"left",onEnterKey:function(){n.performSearch()}},t=function(){return DXUtility.getDXInstance(null,"#productLotPopupEdit_save","dxButton")},w={text:"Save",type:"apply",onClick:function(){n.performSave()}},b=function(){return DXUtility.getDXInstance(null,"#productLotPopupEdit_cancel","dxButton")},k={text:"Cancel",onClick:function(){n.performCancel()}};return{events:n,popupEdit:a,popupEditOptions:r,popupEditData:ko.observable(),popupContent:v,popupContentOptions:{scrollByContent:!0,scrollByThumb:!0},form:y,formOptions:p,save:t,saveOptions:w,cancel:b,cancelOptions:k,newRow:s,newRowOptions:h,deleteRows:e,deleteRowsOptions:c,dataGrid:i,dataGridOptions:l}};Dismoyo_Ciptoning_Client.vAreas=function(n,t){"use strict";function h(){e=!0}function c(){f=CommonUtility.configureCommonGridViewLayout("vAreas");f||setTimeout(c,50)}function v(){c();s()?e&&l():(s(u),u.load().always(function(){o.resolve()}))}function y(){Dismoyo_Ciptoning_Client.DB.vAreas.off("modified",h)}function l(){e=!1;u.pageIndex(0);u.load()}var e=!1,a=t.layoutController.name==="split",o=$.Deferred(),s=ko.observable(),u,f,r,i;u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vAreas,map:function(n){return new Dismoyo_Ciptoning_Client.vAreaViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vAreas.on("modified",h);return r=new Dismoyo_Ciptoning_Client.CollapsibleFilter,r.filterOptions.onInitialized=function(){r.filter().element().resize(function(){f&&f.resizeAll()})},r.formOptions.items=[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){r.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(r.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){r.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(r.form(),n.selectedItem,n.value,"Region",["Territory"],[])}}},{name:"Area",dataField:"",label:{text:"Area"},editorOptions:{placeholder:"Code/Name",onEnterKey:function(){r.events.performSearch()}}}],r.events.performSearch=function(){var f=i.dataGrid(),e=r.form(),t=[],n,u;f.clearFilter();n=e.getEditor("TerritoryID").option("value");DXUtility.addFilterExpression(t,"TerritoryID","=",n,"and");n=e.getEditor("RegionID").option("value");DXUtility.addFilterExpression(t,"RegionID","=",n,"and");n=e.getEditor("Area").option("value");u=[];DXUtility.addFilterExpression(u,"Code","contains",n,"or");DXUtility.addFilterExpression(u,"Name","contains",n,"or");DXUtility.addGroupFilterExpression(t,u,"and");t.length>0?f.filter(t):f.refresh()},i=new Dismoyo_Ciptoning_Client.CommonGridView,i.dataGridOptions.dataSource=u,i.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Areas.AddNewArea"),i.dataGridOptions.editing.editEnabled=i.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Areas.EditArea"),i.dataGridOptions.editing.removeEnabled=i.dataGridOptions.editing.allowDeleting=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Areas.DeleteArea"),i.dataGridOptions.onEditorPreparing=function(n){n.parentType=="dataRow"&&n.dataField=="Code"&&(n.row.inserted||(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Code())),n.cancel=!0))},i.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"TerritoryID",caption:"Territory",width:"200px",validationRules:[{type:"required"}],lookup:{dataSource:DataUtility.vTerritories.dataSource(null),displayExpr:"Territory",valueExpr:"ID",allowClearing:!0,sortOrder:"asc"},setCellValue:function(n,t){n.RegionID=null;this.defaultSetCellValue(n,t)}},{dataField:"RegionID",caption:"Region",width:"200px",validationRules:[{type:"required"}],lookup:{dataSource:function(n){return CommonUtility.cascadeLoadLookupDataSource(n.data,"TerritoryID",DataUtility.vRegions.dataSource)},displayExpr:"Region",valueExpr:"ID",allowClearing:!0},setCellValue:function(n,t){CommonUtility.cascadeLookupValueChanged(this.lookup.items,n,"ID",t,["TerritoryID"]);t||(n.TerritoryID=null);this.defaultSetCellValue(n,t)}},{dataField:"Code",width:"70px",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$("#vAreas_commonGridView").find(".dx-datagrid:first-child"),r,f;!u.find(".datagrid-bandedHeader:first").length>0&&(r='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Area<\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',(i.dataGridOptions.editing.allowUpdating||i.dataGridOptions.editing.allowDeleting)&&(r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),r+="<\/tr>",f=u.find(".dx-header-row:first-child"),$(r).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},editorOptions:{maxLength:10}},{dataField:"Name",width:"180px",validationRules:[{type:"required"}],editorOptions:{maxLength:50}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],{isReady:o.promise(),dataSource:u,refreshList:l,viewShowing:v,viewDisposing:y,openCreateViewAsRoot:a,icon:"Images/area_32px.png",collapsibleFilter:r,commonGridView:i}};Dismoyo_Ciptoning_Client.vClosingPeriods=function(n,t){"use strict";function c(){o=!0}function l(){e=CommonUtility.configureCommonGridViewLayout("vClosingPeriods");e?(f.commands().append($('<div class="desktop-commonGridView-commands-item" style="margin-left: 16px; margin-top: 4px; margin-bottom: 4px;">').text("Period:")),f.commands().append($('<div id="vClosingPeriods_periodInput" class="desktop-commonGridView-commands-item">').dxDateBox({width:"150px",showClearButton:!0,min:new Date(2016,6,1),placeholder:"mmm-yyyy",formatString:"MMM-yyyy",maxZoomLevel:"year"})),f.commands().append($('<div id="vClosingPeriods_newAll" class="desktop-commonGridView-commands-item">').dxButton({text:"New All",onClick:function(){p()}})),f.commands().append($('<div id="vClosingPeriods_openAll" class="desktop-commonGridView-commands-item">').dxButton({text:"Open All",onClick:function(){a(!1)}})),f.commands().append($('<div id="vClosingPeriods_closeAll" class="desktop-commonGridView-commands-item">').dxButton({text:"Close All",onClick:function(){a(!0)}}))):setTimeout(l,50)}function p(){var n=f.dataGrid(),i=$("#vClosingPeriods_periodInput").dxDateBox("instance").option("value"),t=i.getFullYear();DevExpress.ui.dialog.confirm("Are you sure want to create new all sites data for year "+t+"?","New All Confirmation").done(function(i){i&&new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSites,select:["ID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSiteViewModel(n)}}).load().done(function(i){var u=i;new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vClosingPeriods,select:["SiteID"],filter:["YearID","=",t],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vClosingPeriodViewModel(n)}}).load().done(function(i){var s=i,e=0,h,o,f;if(s.length>0)while(e<u.length)h=$.grep(s,function(n){return n.SiteID()._value==u[e].ID()._value}),h.length>0?u.splice(e,1):e++;for(u.length>0&&n.beginCustomLoading(),o=0,e=0;e<u.length;e++)f=new Dismoyo_Ciptoning_Client.vClosingPeriodViewModel,f.SiteID(u[e].ID()),f.YearID(t),f.Jan(!1),f.Feb(!1),f.Mar(!1),f.Apr(!1),f.May(!1),f.Jun(!1),f.Jul(!1),f.Aug(!1),f.Sep(!1),f.Oct(!1),f.Nov(!1),f.Dec(!1),r.store().insert(f.toJS()).done(function(){o++;o>=u.length-1&&r.load().done(function(){n.endCustomLoading();n.refresh()}).fail(function(){n.endCustomLoading()})}).fail(function(t){var i=$(".dx-popup-normal>.dx-dialog-content");i.length==0&&DevExpress.ui.dialog.alert(t.message,"Save Failed");o++;o>=u.length-1&&r.load().done(function(){n.endCustomLoading();n.refresh()}).fail(function(){n.endCustomLoading()})})}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load existing closing period data."),"Load Failed")})}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load all sites data."),"Load Failed")})})}function a(n){var f=$("#vClosingPeriods_periodInput").dxDateBox("instance").option("value"),e=f.getFullYear(),t=null,u;switch(f.getMonth()+1){case 1:t="Jan";break;case 2:t="Feb";break;case 3:t="Mar";break;case 4:t="Apr";break;case 5:t="May";break;case 6:t="Jun";break;case 7:t="Jul";break;case 8:t="Aug";break;case 9:t="Sep";break;case 10:t="Oct";break;case 11:t="Nov";break;case 12:t="Dec"}u=n?"Close":"Open";DevExpress.ui.dialog.confirm("Are you sure want to "+u+" all sites for "+t+" "+e+" period?",u+" All Confirmation").done(function(u){u&&new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vClosingPeriods,select:["SiteID","YearID",t],filter:["YearID","=",e],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vClosingPeriodViewModel(n)}}).load().done(function(u){for(var e,o,f=0;f<u.length;f++)u[f][t](n),e=u[f].toJS(),o=r.store(),o.update(o.keyOf(e),e).done(function(){f>=u.length-1&&i.events.performSearch(this)}).fail(function(){f>=u.length-1&&i.events.performSearch(this)})})})}function w(){var n,t;l();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],r.filter(t));h()?o&&v():(h(r),r.load().always(function(){s.resolve()}))}function b(){Dismoyo_Ciptoning_Client.DB.vClosingPeriods.off("modified",c)}function v(){o=!1;r.pageIndex(0);r.load()}function u(n,t){n.text(t.value?"CLOSED":"OPEN");var r=DateTimeUtility.getFirstTimeOfDay(new Date),u=DXUtility.getValue(t.data,"YearID"),i=null;switch(t.column.dataField){case"Jan":i=1;break;case"Feb":i=2;break;case"Mar":i=3;break;case"Apr":i=4;break;case"May":i=5;break;case"Jun":i=6;break;case"Jul":i=7;break;case"Aug":i=8;break;case"Sep":i=9;break;case"Oct":i=10;break;case"Nov":i=11;break;case"Dec":i=12}r.getMonth()+1==i&&r.getFullYear()==u&&n.css("background-color","#CF7E72")}var o=!1,y=t.layoutController.name==="split",s=$.Deferred(),h=ko.observable(),r,e,i,f;r=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vClosingPeriods,select:["SiteID","YearID","TerritoryID","RegionID","AreaID","Company","Site","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","CreatedDate","CreatedByUserName","ModifiedDate","ModifiedByUserName"],map:function(n){return new Dismoyo_Ciptoning_Client.vClosingPeriodViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vClosingPeriods.on("modified",c);return i=new Dismoyo_Ciptoning_Client.CollapsibleFilter,i.filterOptions.onInitialized=function(){i.filter().element().resize(function(){e&&e.resizeAll()})},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area","Site"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],[])}}}]},{itemType:"group",caption:"Closing Period",colCount:3,colSpan:3,items:[{dataField:"YearID",label:{text:"Year"},editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,min:new Date(2016,6,1),placeholder:"yyyy",formatString:"yyyy",maxZoomLevel:"decade",onEnterKey:function(){i.events.performSearch()}}}]}],i.events.performSearch=function(){var u=f.dataGrid(),t=i.form(),n=[],e;u.clearFilter();var r=Dismoyo_Ciptoning_Client.app.CurrentUser,o=r.TerritoryID(),s=r.RegionID(),h=r.AreaID(),c=r.CompanyID(),l=r.SiteID();t.itemOption("Organization").visible&&(o=t.getEditor("TerritoryID").option("value"),s=t.getEditor("RegionID").option("value"),h=t.getEditor("AreaID").option("value"),c=t.getEditor("CompanyID").option("value"),l=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",o,"and");DXUtility.addFilterExpression(n,"RegionID","=",s,"and");DXUtility.addFilterExpression(n,"AreaID","=",h,"and");DXUtility.addFilterExpression(n,"CompanyID","=",c,"and");DXUtility.addFilterExpression(n,"SiteID","=",l,"and");e=i.form().getEditor("YearID").option("value");e instanceof Date&&DXUtility.addFilterExpression(n,"YearID","=",e.getFullYear(),"and");n.length>0?u.filter(n):u.refresh()},f=new Dismoyo_Ciptoning_Client.CommonGridView,f.dataGridOptions.dataSource=r,f.dataGridOptions.columns=[{dataField:"TerritoryID",caption:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),validationRules:[{type:"required"}],lookup:{dataSource:DataUtility.vTerritories.dataSource(null),displayExpr:"Territory",valueExpr:"ID",allowClearing:!0},setCellValue:function(n,t){n.RegionID=null;n.AreaID=null;n.SiteID=null;n.Company=null;this.defaultSetCellValue(n,t)}},{dataField:"RegionID",caption:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),validationRules:[{type:"required"}],lookup:{dataSource:function(n){return CommonUtility.cascadeLoadLookupDataSource(n.data,"TerritoryID",DataUtility.vRegions.dataSource)},displayExpr:"Region",valueExpr:"ID",allowClearing:!0},setCellValue:function(n,t){CommonUtility.cascadeLookupValueChanged(this.lookup.items,n,"ID",t,["TerritoryID"]);n.AreaID=null;n.SiteID=null;n.Company=null;this.defaultSetCellValue(n,t)}},{dataField:"AreaID",caption:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),validationRules:[{type:"required"}],lookup:{dataSource:function(n){return CommonUtility.cascadeLoadLookupDataSource(n.data,"RegionID",DataUtility.vAreas.dataSource)},displayExpr:"Area",valueExpr:"ID",allowClearing:!0},setCellValue:function(n,t){CommonUtility.cascadeLookupValueChanged(this.lookup.items,n,"ID",t,["TerritoryID","RegionID"]);n.SiteID=null;n.Company=null;this.defaultSetCellValue(n,t)}},{dataField:"Company",caption:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),allowEditing:!1},{dataField:"SiteID",caption:"Site",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),validationRules:[{type:"required"}],lookup:{dataSource:function(n){return CommonUtility.cascadeLoadLookupDataSource(n.data,"AreaID",DataUtility.vSites.dataSource)},displayExpr:"Site",valueExpr:"ID",allowClearing:!0},setCellValue:function(n,t){CommonUtility.cascadeLookupGuidValueChanged(this.lookup.items,n,"ID",t,["TerritoryID","RegionID","AreaID","Company"]);this.defaultSetCellValue(n,t)}},{dataField:"YearID",caption:"Year",alignment:"center",width:"70px",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var r=$("#vClosingPeriods_commonGridView").find(".dx-datagrid:first-child"),i,u,f;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines data-grid-banded-header-border-top">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',u=Dismoyo_Ciptoning_Client.app.CurrentUser,u.IsHeadOffice()&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" colspan="13">Period<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+="<\/tr>",f=r.find(".dx-header-row:first-child"),$(i).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"Jan",caption:"Jan",dataType:"boolean",width:"75px",cellTemplate:function(n,t){u(n,t)}},{dataField:"Feb",caption:"Feb",dataType:"boolean",width:"75px",cellTemplate:function(n,t){u(n,t)}},{dataField:"Mar",caption:"Mar",dataType:"boolean",width:"75px",cellTemplate:function(n,t){u(n,t)}},{dataField:"Apr",caption:"Apr",dataType:"boolean",width:"75px",cellTemplate:function(n,t){u(n,t)}},{dataField:"May",caption:"May",dataType:"boolean",width:"75px",cellTemplate:function(n,t){u(n,t)}},{dataField:"Jun",caption:"Jun",dataType:"boolean",width:"75px",cellTemplate:function(n,t){u(n,t)}},{dataField:"Jul",caption:"Jul",dataType:"boolean",width:"75px",cellTemplate:function(n,t){u(n,t)}},{dataField:"Aug",caption:"Aug",dataType:"boolean",width:"75px",cellTemplate:function(n,t){u(n,t)}},{dataField:"Sep",caption:"Sep",dataType:"boolean",width:"75px",cellTemplate:function(n,t){u(n,t)}},{dataField:"Oct",caption:"Oct",dataType:"boolean",width:"75px",cellTemplate:function(n,t){u(n,t)}},{dataField:"Nov",caption:"Nov",dataType:"boolean",width:"75px",cellTemplate:function(n,t){u(n,t)}},{dataField:"Dec",caption:"Dec",dataType:"boolean",width:"75px",cellTemplate:function(n,t){u(n,t)}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],{isReady:s.promise(),dataSource:r,refreshList:v,viewShowing:w,viewDisposing:b,openCreateViewAsRoot:y,icon:"Images/region_32px.png",collapsibleFilter:i,commonGridView:f}};Dismoyo_Ciptoning_Client.vCompanies=function(n,t){"use strict";function h(){e=!0}function c(){f=CommonUtility.configureCommonGridViewLayout("vCompanies");f||setTimeout(c,50)}function v(){c();s()?e&&l():(s(u),u.load().always(function(){o.resolve()}))}function y(){Dismoyo_Ciptoning_Client.DB.vCompanies.off("modified",h)}function l(){e=!1;u.pageIndex(0);u.load()}var e=!1,a=t.layoutController.name==="split",o=$.Deferred(),s=ko.observable(),u,f,r,i;u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCompanies,map:function(n){return new Dismoyo_Ciptoning_Client.vCompanyViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vCompanies.on("modified",h);return r=new Dismoyo_Ciptoning_Client.CollapsibleFilter,r.filterOptions.onInitialized=function(){r.filter().element().resize(function(){f&&f.resizeAll()})},r.formOptions.items=[{name:"Company",dataField:"",label:{text:"Company"},editorOptions:{placeholder:"Code/Name",onEnterKey:function(){r.events.performSearch()}}},{dataField:"",label:{text:"",visible:!1},editorOptions:{visible:!1}}],r.events.performSearch=function(){var n,u,t;i.dataGrid().clearFilter();n=[];u=r.form().getEditor("Company").option("value");t=[];DXUtility.addFilterExpression(t,"Code","contains",u,"or");DXUtility.addFilterExpression(t,"Name","contains",u,"or");DXUtility.addGroupFilterExpression(n,t,"and");n.length>0?i.dataGrid().filter(n):i.dataGrid().refresh()},i=new Dismoyo_Ciptoning_Client.CommonGridView,i.dataGridOptions.dataSource=u,i.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Companies.AddNewCompany"),i.dataGridOptions.editing.editEnabled=i.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Companies.EditCompany"),i.dataGridOptions.editing.removeEnabled=i.dataGridOptions.editing.allowDeleting=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Companies.DeleteCompany"),i.dataGridOptions.onEditorPreparing=function(n){n.parentType=="dataRow"&&n.dataField=="Code"&&(n.row.inserted||(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Code())),n.cancel=!0))},i.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Code",width:"70px",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$("#vCompanies_commonGridView").find(".dx-datagrid:first-child"),r,f;!u.find(".datagrid-bandedHeader:first").length>0&&(r='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Company<\/td>',r+='       <td class="dx-datagrid-action" colspan="3">Address<\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',(i.dataGridOptions.editing.allowUpdating||i.dataGridOptions.editing.allowDeleting)&&(r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),r+="<\/tr>",f=u.find(".dx-header-row:first-child"),$(r).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},editorOptions:{maxLength:10}},{dataField:"Name",width:"180px",validationRules:[{type:"required"}],editorOptions:{maxLength:50}},{dataField:"Address1",caption:"",width:"150px",validationRules:[{type:"required"}],editorOptions:{maxLength:100}},{dataField:"Address2",caption:"",width:"150px",editorOptions:{maxLength:100}},{dataField:"Address3",caption:"",width:"150px",editorOptions:{maxLength:100}},{dataField:"City",width:"120px",validationRules:[{type:"required"}],editorOptions:{maxLength:50}},{dataField:"StateProvince",caption:"State/Province",width:"120px",validationRules:[{type:"required"}],editorOptions:{maxLength:50}},{dataField:"CountryID",caption:"Country",width:"120px",validationRules:[{type:"required"}],lookup:{dataSource:DataUtility.vCountries.dataSource(null),displayExpr:"Name",valueExpr:"ID",allowClearing:!0,sortOrder:"asc"}},{dataField:"ZipCode",caption:"Zip Code",width:"70px",validationRules:[{type:"required"},{type:"numeric"}],editorOptions:{maxLength:10}},{dataField:"TaxNumber",caption:"Tax Number",width:"180px",validationRules:[{type:"required"},{type:"numeric"}],editorOptions:{maxLength:20}},{dataField:"Phone1",caption:"Phone 1",width:"120px",validationRules:[{type:"required"},{type:"numeric"}],editorOptions:{maxLength:20}},{dataField:"Phone2",caption:"Phone 2",width:"120px",validationRules:[{type:"numeric"}],editorOptions:{maxLength:20}},{dataField:"Fax",caption:"Fax",width:"120px",validationRules:[{type:"numeric"}],editorOptions:{maxLength:20}},{dataField:"Email",caption:"Email",width:"150px",validationRules:[{type:"email"}],editorOptions:{maxLength:256}},{dataField:"StatusID",caption:"Status",width:"100px",defaultValue:1,lookup:{dataSource:DataUtility.vSystemLookups.dataSource(["Group","=","CompanyStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",allowClearing:!0}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],{isReady:o.promise(),dataSource:u,refreshList:l,viewShowing:v,viewDisposing:y,openCreateViewAsRoot:a,icon:"Images/company_32px.png",collapsibleFilter:r,commonGridView:i}};Dismoyo_Ciptoning_Client.vCustomers=function(n,t){"use strict";function g(){y=!0}function nt(){l=CommonUtility.configureCommonGridViewLayout("vCustomers");l||setTimeout(nt,50)}function ct(){var n,t;nt();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],s.filter(t));d()?y&&tt():(d(s),s.load().always(function(){k.resolve()}))}function lt(){Dismoyo_Ciptoning_Client.DB.vCustomers.off("modified",g)}function tt(){y=!1;s.pageIndex(0);s.load()}function rt(n){return(n?n:"(Site Code)")+"-YY-20-(Auto Generated)"}function ut(n,t){t||(t=null);var r=DataUtility.GetLookupSalesmanDataSource(["SiteID","=",t]),i=a();i.getEditor("SalesmanID").option("value",null);i.getEditor("SalesmanID").option("dataSource",[]);r.load().done(function(){i.getEditor("SalesmanID").option("dataSource",r)})}function at(n,t){for(var r,i=1;i<=10;i++)r="Category"+i.toString()+"ID",n.getEditor(r)&&n.getEditor(r).option("value",t[r]())}function u(n){var t=Dismoyo_Ciptoning_Client.LocalStore.vSystemParameters.dataByFilter(["ID","=",n]);return t.length>0?t[0].Value():null}function p(n,t,i,r){n.getEditor("Address1").option("value",t[i+"Address1"]());n.getEditor("Address2").option("value",t[i+"Address2"]());n.getEditor("Address3").option("value",t[i+"Address3"]());n.getEditor("City").option("value",t[i+"City"]());n.getEditor("StateProvince").option("value",t[i+"StateProvince"]());n.getEditor("CountryID").option("value",t[i+"CountryID"]());n.getEditor("ZipCode").option("value",t[i+"ZipCode"]());n.getEditor("Phone1").option("value",t[i+"Phone1"]());n.getEditor("Phone2").option("value",t[i+"Phone2"]());n.getEditor("Phone3").option("value",t[i+"Phone3"]());n.getEditor("Fax").option("value",t[i+"Fax"]());n.getEditor("Email").option("value",t[i+"Email"]());n.getEditor("Address1").option("readOnly",r);n.getEditor("Address2").option("readOnly",r);n.getEditor("Address3").option("readOnly",r);n.getEditor("City").option("readOnly",r);n.getEditor("StateProvince").option("readOnly",r);n.getEditor("CountryID").option("readOnly",r);n.getEditor("ZipCode").option("readOnly",r);n.getEditor("Phone1").option("readOnly",r);n.getEditor("Phone2").option("readOnly",r);n.getEditor("Phone3").option("readOnly",r);n.getEditor("Fax").option("readOnly",r);n.getEditor("Email").option("readOnly",r)}function vt(n){var t=v();p(t,n,"",!1);t.getEditor("Longitude").option("value",n.Longitude());t.getEditor("Latitude").option("value",n.Latitude())}function ft(n,t){var i=o();i.getEditor("IsBillSameAsAddress").option("value",n.IsBillSameAsAddress());var f="Bill",r=n.BillName(),u=!1;n.IsBillSameAsAddress()?(f="",r=n.Name(),u=!0):t&&(r=null,n.BillName(null),n.BillAddress1(null),n.BillAddress2(null),n.BillAddress3(null),n.BillCity(null),n.BillStateProvince(null),n.BillCountryID(null),n.BillZipCode(null),n.BillPhone1(null),n.BillPhone2(null),n.BillPhone3(null),n.BillFax(null),n.BillEmail(null));i.getEditor("Name").option("value",r);i.getEditor("Name").option("readOnly",u);p(i,n,f,u)}function h(n,t){var i=r();i.getEditor("IsTaxSameAsAddress").option("value",n.IsTaxSameAsAddress());i.getEditor("IsTaxSameAsBillAddress").option("value",n.IsTaxSameAsBillAddress());var e="Tax",u=n.TaxName(),f=!1;n.IsTaxSameAsAddress()?(e="",u=n.Name(),f=!0):n.IsTaxSameAsBillAddress()?(e="Bill",u=n.BillName(),f=!0):t&&(u=null,n.TaxName(null),n.TaxAddress1(null),n.TaxAddress2(null),n.TaxAddress3(null),n.TaxCity(null),n.TaxStateProvince(null),n.TaxCountryID(null),n.TaxZipCode(null),n.TaxPhone1(null),n.TaxPhone2(null),n.TaxPhone3(null),n.TaxFax(null),n.TaxEmail(null));i.getEditor("Name").option("value",u);i.getEditor("Name").option("readOnly",f);p(i,n,e,f)}function yt(n,t){for(var r,i=1;i<=10;i++)r="AdditionalInfo"+i.toString(),n.getEditor(r)&&n.getEditor(r).option("value",t[r]())}function pt(n,t){for(var r,i=1;i<=10;i++)r="Category"+i.toString()+"ID",t[r](n.getEditor(r).option("value"))}function w(n,t,i){t[i+"Address1"](n.getEditor("Address1").option("value"));t[i+"Address2"](n.getEditor("Address2").option("value"));t[i+"Address3"](n.getEditor("Address3").option("value"));t[i+"City"](n.getEditor("City").option("value"));t[i+"StateProvince"](n.getEditor("StateProvince").option("value"));t[i+"CountryID"](n.getEditor("CountryID").option("value"));t[i+"ZipCode"](n.getEditor("ZipCode").option("value"));t[i+"Phone1"](n.getEditor("Phone1").option("value"));t[i+"Phone2"](n.getEditor("Phone2").option("value"));t[i+"Phone3"](n.getEditor("Phone3").option("value"));t[i+"Fax"](n.getEditor("Fax").option("value"));t[i+"Email"](n.getEditor("Email").option("value"))}function wt(n,t){for(var r,i=1;i<=10;i++)r="AdditionalInfo"+i.toString(),t[r](n.getEditor(r).option("value"))}function et(n,t){showLoadingPanel();Dismoyo_Ciptoning_Client.DB.vCustomers.byKey(n).done(function(n){hideLoadingPanel();c=t;ot(new Dismoyo_Ciptoning_Client.vCustomerViewModel(n))}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function ot(n){var e=!1;n||(n=new Dismoyo_Ciptoning_Client.vCustomerViewModel,n.StatusID(1),e=!0);i.popupEditData(n);i.popupEdit().option("title",(e?"New":"Edit")+" Customer");i.popupEditOptions.editingKey=n.ID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);st().option("selectedIndex",0);var f=Dismoyo_Ciptoning_Client.app.CurrentUser,t=i.form(),u=a(),y=v(),p=o(),s=r(),c=b(),l=n.Code();e&&(n.StatusID(1),f.IsHeadOffice()||(n.TerritoryID(f.TerritoryID()),n.RegionID(f.RegionID()),n.AreaID(f.AreaID()),n.SiteID(f.SiteID()),n.SiteCode(f.SiteCode()),n.CompanyID(f.CompanyID()),n.Company(f.Company())),n.RegisteredDate(new Date),n.IsBillSameAsAddress(!1),n.IsTaxNumberAvailable(!1),n.IsTaxSameAsAddress(!1),n.IsTaxSameAsBillAddress(!1),l=rt(n.SiteCode()));t.itemOption("Organization").visible&&(t.getEditor("TerritoryID").option("value",n.TerritoryID()),t.getEditor("RegionID").option("value",n.RegionID()),t.getEditor("AreaID").option("value",n.AreaID()),t.getEditor("Company").option("value",n.Company()),t.getEditor("SiteID").option("value",n.SiteID()));ut(t,n.SiteID());t.getEditor("Code").option("value",l);t.getEditor("Name").option("value",n.Name());u.getEditor("SalesmanID").option("value",n.SalesmanID());u.getEditor("RegisteredDate").option("value",n.RegisteredDate());u.getEditor("TermOfPaymentID").option("value",n.TermOfPaymentID());u.getEditor("CreditLimit").option("value",n.CreditLimit());u.getEditor("PriceGroupID").option("value",n.PriceGroupID());u.getEditor("DiscountGroupID").option("value",n.DiscountGroupID());at(u,n);yt(c,n);vt(n);ft(n,!1);s.getEditor("IsTaxNumberAvailable").option("value",n.IsTaxNumberAvailable());s.getEditor("TaxNumber").option("value",n.TaxNumber());s.getEditor("TaxSAPCode").option("value",n.TaxSAPCode());h(n,!1);e&&(DXUtility.resetFormValidation(t),DXUtility.resetFormValidation(u),DXUtility.resetFormValidation(y),DXUtility.resetFormValidation(p),DXUtility.resetFormValidation(s),DXUtility.resetFormValidation(c));u.getEditor("StatusID").option("value",n.StatusID());u.getEditor("RegisteredDate").option("value",n.RegisteredDate())}function bt(){var l,it;showLoadingPanel();var rt=e.dataGrid(),ut=rt.option("dataSource"),n=i.popupEditData(),f=i.form(),t=a(),s=v(),h=o(),u=r(),ft=b(),y=f.validate().isValid,p=t.validate().isValid,k=s.validate().isValid,d=h.validate().isValid,g=u.validate().isValid,nt=y&&p&&k&&d&&g?!0:!1,tt=nt?"":"Please specify the required fields.";nt&&(f.itemOption("Organization").visible&&n.SiteID(f.getEditor("SiteID").option("value")),n.Code(f.getEditor("Code").option("value")),n.Name(f.getEditor("Name").option("value")),n.SalesmanID(t.getEditor("SalesmanID").option("value")),n.RegisteredDate(t.getEditor("RegisteredDate").option("value")),n.TermOfPaymentID(t.getEditor("TermOfPaymentID").option("value")),n.CreditLimit(t.getEditor("CreditLimit").option("value")),n.PriceGroupID(t.getEditor("PriceGroupID").option("value")),n.DiscountGroupID(t.getEditor("DiscountGroupID").option("value")),n.StatusID(t.getEditor("StatusID").option("value")),pt(t,n),n.Longitude(s.getEditor("Longitude").option("value")),n.Latitude(s.getEditor("Latitude").option("value")),w(s,n,""),n.IsBillSameAsAddress(h.getEditor("IsBillSameAsAddress").option("value")),n.BillName(h.getEditor("Name").option("value")),w(h,n,"Bill"),n.IsTaxNumberAvailable(u.getEditor("IsTaxNumberAvailable").option("value")),n.TaxSAPCode(u.getEditor("TaxSAPCode").option("value")),n.TaxNumber(u.getEditor("TaxNumber").option("value")),n.IsTaxSameAsAddress(u.getEditor("IsTaxSameAsAddress").option("value")),n.IsTaxSameAsBillAddress(u.getEditor("IsTaxSameAsBillAddress").option("value")),n.TaxName(u.getEditor("Name").option("value")),w(u,n,"Tax"),wt(ft,n));y&&p&&k&&d&&g?(l=ko.toJS(n),l.RegisteredDate.setHours(0,0,0,0),ut.store().insert(l).done(function(){c=!0;i.events.performCancel();hideLoadingPanel()}).fail(function(n){var t=$(".dx-popup-normal>.dx-dialog-content");t.length==0&&DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})):hideLoadingPanel();tt!=""&&(it=$(".dx-popup-normal>.dx-dialog-content"),it.length==0&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(tt),"Save Failed"))}var y=!1,ht=t.layoutController.name==="split",k=$.Deferred(),d=ko.observable(),s,c,l,it,f,e,i;s=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["ID","Territory","Region","Area","Company","Site","Code","Name","Salesman","StatusName","Address1","Address2","Address3","City","Category1","Category2","Category3","StatusName","CreatedDate","CreatedByUserName","ModifiedDate","ModifiedByUserName"],map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vCustomers.on("modified",g);it=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vDiscountGroups,map:function(n){return new Dismoyo_Ciptoning_Client.vDiscountGroupViewModel(n)}});f=new Dismoyo_Ciptoning_Client.CollapsibleFilter;f.filterOptions.onInitialized=function(){f.filter().element().resize(function(){l&&l.resizeAll()})};f.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){f.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(f.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){f.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(f.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){f.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(f.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){f.events.performSearch()}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){f.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(f.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Salesman"])}}}]},{itemType:"group",caption:"Customer",colCount:3,colSpan:3,items:[{dataField:"SalesmanID",label:{text:"Salesman"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSalesmanDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Salesman",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){f.events.performSearch(this)}}},{name:"Customer",dataField:"",label:{text:"Customer"},editorOptions:{placeholder:"Code/Name",onEnterKey:function(){f.events.performSearch()}}},{dataField:"StatusID",label:{text:"Status"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","CustomerStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,onEnterKey:function(){f.events.performSearch(this)}}}]}];f.events.performSearch=function(){var o=e.dataGrid(),r=f.form(),n=[],t,u;o.clearFilter();var i=Dismoyo_Ciptoning_Client.app.CurrentUser,s=i.TerritoryID(),h=i.RegionID(),c=i.AreaID(),l=i.CompanyID(),a=i.SiteID();r.itemOption("Organization").visible&&(s=f.form().getEditor("TerritoryID").option("value"),h=f.form().getEditor("RegionID").option("value"),c=f.form().getEditor("AreaID").option("value"),l=f.form().getEditor("CompanyID").option("value"),a=f.form().getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",s,"and");DXUtility.addFilterExpression(n,"RegionID","=",h,"and");DXUtility.addFilterExpression(n,"AreaID","=",c,"and");DXUtility.addFilterExpression(n,"CompanyID","=",l,"and");DXUtility.addFilterExpression(n,"SiteID","=",a,"and");t=r.getEditor("SalesmanID").option("value");DXUtility.addFilterExpression(n,"SalesmanID","=",t,"and");t=r.getEditor("StatusID").option("value");DXUtility.addFilterExpression(n,"StatusID","=",t,"and");u=[];t=r.getEditor("Customer").option("value");DXUtility.addFilterExpression(u,"Code","contains",t,"or");DXUtility.addFilterExpression(u,"Name","contains",t,"or");DXUtility.addGroupFilterExpression(n,u,"and");n.length>0?o.filter(n):o.refresh()};e=new Dismoyo_Ciptoning_Client.CommonGridView;e.dataGridOptions.dataSource=s;e.dataGridOptions.editing.editEnabled=!1;e.dataGridOptions.editing.removeEnabled=!1;e.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Customers.AddNewCustomer");e.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Customers.EditCustomer");e.dataGridOptions.editing.allowDeleting=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Customers.DeleteCustomer");e.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Territory",caption:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Region",caption:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Area",caption:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Company",caption:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Site",caption:"Site",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Code",Caption:"Code",width:"135px",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var r=$("#vCustomers_commonGridView").find(".dx-datagrid:first-child"),i,u,f;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines data-grid-banded-header-border-top">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',u=Dismoyo_Ciptoning_Client.app.CurrentUser,u.IsHeadOffice()?(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="4">Customer<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>'):(i+='       <td class="dx-datagrid-action" colspan="2">Customer<\/td>',i+='       <td class="dx-datagrid-action" colspan="3">Address<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>'),(e.dataGridOptions.editing.allowUpdating||e.dataGridOptions.editing.allowDeleting)&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",f=r.find(".dx-header-row:first-child"),$(i).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: left;">'),r=$("<b>").text(t.data.Code());e.dataGridOptions.editing.allowUpdating&&(r=$('<a class="dx-link">').text(t.data.Code()).on("dxclick",function(){et(t.data.ID(),!1)}));i.append(r);i.append("&nbsp;");n.append(i)}},{dataField:"Name",width:"180px"},{dataField:"Salesman",caption:"Salesman",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"StatusName",caption:"Status",width:"100px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Address1",caption:"",width:"100px",visible:!Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Address2",caption:"",width:"100px",visible:!Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Address3",caption:"",width:"100px",visible:!Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"City",caption:"City",width:"100px",visible:!Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Category1",caption:"Customer Type",width:"100px",visible:!Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Category2",caption:"Customer Group",width:"100px",visible:!Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Category3",caption:"Customer Location",width:"100px",visible:!Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"StatusName",caption:"Status",width:"100px",visible:!Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Salesman",caption:"Salesman",width:"200px",visible:!Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}];(e.dataGridOptions.editing.allowUpdating||e.dataGridOptions.editing.allowDeleting)&&e.dataGridOptions.columns.push({width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');e.dataGridOptions.editing.allowUpdating&&(i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){et(t.data.ID(),!1)})),i.append("&nbsp;"));e.dataGridOptions.editing.allowDeleting&&(i.append($('<a class="dx-link">').text("Delete").on("dxclick",function(){var n=e.dataGrid(),i=n.option("dataSource"),r=t.data.toJS(),u=r.ID;i.store().remove(u).done(function(){n.refresh()})})),i.append("&nbsp;"));n.append(i)}});i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.popupEditOptions.title="Customer";i.okOptions.text="Save";i.okOptions.icon="icons8-save";var st=function(){return DXUtility.getDXInstance(null,"#vCustomers_infoTabPanel","dxTabPanel")},a=function(){return DXUtility.getDXInstance(null,"#vCustomers_generalInfoForm","dxForm")},v=function(){return DXUtility.getDXInstance(null,"#vCustomers_shipmentInfoForm","dxForm")},o=function(){return DXUtility.getDXInstance(null,"#vCustomers_billingInfoForm","dxForm")},r=function(){return DXUtility.getDXInstance(null,"#vCustomers_taxInfoForm","dxForm")},b=function(){return DXUtility.getDXInstance(null,"#vCustomers_additionalInfoForm","dxForm")};return i.popupEditOptions.onContentReady=function(){var t=$("#commonPopupEdit_extContent"),n=$("<div>"),f=$('<div id="vCustomers_infoTabPanel">').dxTabPanel({deferRendering:!1,dataSource:[{ID:0,Title:"General Information"},{ID:1,Title:"Shipment Information"},{ID:2,Title:"Billing Information"},{ID:3,Title:"Tax Information"},{ID:4,Title:"Additional Information"}],onTitleRendered:function(n){n.itemElement.empty();n.itemElement.append($("<span>").append(n.itemData.Title))},onItemRendered:function(n){n.itemElement.empty();var t=$('<div style="padding: 12px 12px 12px 12px">');switch(n.itemData.ID){case 0:t.append($('<div id="vCustomers_generalInfoForm">').dxForm({deferRendering:!1,colCount:3,colSpan:3,showColonAfterLabel:!1,labelLocation:"left",items:[{dataField:"SalesmanID",label:{text:"Salesman"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSalesmanDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Salesman",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"RegisteredDate",label:{text:"Registered Date"},validationRules:[{type:"required"}],editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"StatusID",validationRules:[{type:"required"}],label:{text:"Status",location:"left"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","CustomerStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"TermOfPaymentID",validationRules:[{type:"required"}],label:{text:"Term of Payment"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","CustomerTermOfPayment"]),displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"CreditLimit",validationRules:[{type:"required"}],label:{text:"Credit Limit"},editorType:"dxNumberBox",editorOptions:{min:0,max:1e9,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1},{dataField:"PriceGroupID",validationRules:[{type:"required"}],label:{text:"Price Group"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","ProductPriceGroup"]),displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DiscountGroupID",validationRules:[{type:"required"}],label:{text:"Discount Group"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupDiscountGroupDataSource(),displayExpr:"DiscountGroup",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1},{itemType:"group",caption:"Categories",cssClass:"form-group-padding",colCount:2,colSpan:2,items:[{dataField:"Category1ID",validationRules:[{type:"required"}],label:{text:u("Customer.Category1")},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCustomerCategoryDataSource(["Group","=",u("Customer.Category1Lookup")]),displayExpr:"Category",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Category2ID",validationRules:[{type:"required"}],label:{text:u("Customer.Category2")},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCustomerCategoryDataSource(["Group","=",u("Customer.Category2Lookup")]),displayExpr:"Category",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Category3ID",validationRules:[{type:"required"}],label:{text:u("Customer.Category3")},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCustomerCategoryDataSource(["Group","=",u("Customer.Category3Lookup")]),displayExpr:"Category",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Category4ID",validationRules:[{type:"required"}],label:{text:u("Customer.Category4")},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCustomerCategoryDataSource(["Group","=",u("Customer.Category4Lookup")]),displayExpr:"Category",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Category5ID",validationRules:[{type:"required"}],label:{text:u("Customer.Category5")},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCustomerCategoryDataSource(["Group","=",u("Customer.Category5Lookup")]),displayExpr:"Category",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Category6ID",label:{text:u("Customer.Category6")},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCustomerCategoryDataSource(["Group","=",u("Customer.Category6Lookup")]),displayExpr:"Category",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Category7ID",label:{text:u("Customer.Category7")},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCustomerCategoryDataSource(["Group","=",u("Customer.Category7Lookup")]),displayExpr:"Category",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Category8ID",label:{text:u("Customer.Category8")},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCustomerCategoryDataSource(["Group","=",u("Customer.Category8Lookup")]),displayExpr:"Category",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Category9ID",label:{text:u("Customer.Category9")},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCustomerCategoryDataSource(["Group","=",u("Customer.Category9Lookup")]),displayExpr:"Category",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Category10ID",label:{text:u("Customer.Category10")},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCustomerCategoryDataSource(["Group","=",u("Customer.Category10Lookup")]),displayExpr:"Category",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}}]}]}));break;case 1:t.append($('<div id="vCustomers_shipmentInfoForm">').dxForm({deferRendering:!1,colCount:3,colSpan:3,showColonAfterLabel:!1,labelLocation:"left",items:[{dataField:"Address1",validationRules:[{type:"required"}],label:{text:"Address"},colSpan:2,editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.Address1(n.value);t.IsBillSameAsAddress()&&o().getEditor("Address1").option("value",n.value);t.IsTaxSameAsAddress()&&r().getEditor("Address1").option("value",n.value)}}},{itemType:"empty"},{dataField:"Address2",label:{text:" "},colSpan:2,editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.Address2(n.value);t.IsBillSameAsAddress()&&o().getEditor("Address2").option("value",n.value);t.IsTaxSameAsAddress()&&r().getEditor("Address2").option("value",n.value)}}},{itemType:"empty"},{dataField:"Address3",label:{text:" "},colSpan:2,editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.Address3(n.value);t.IsBillSameAsAddress()&&o().getEditor("Address3").option("value",n.value);t.IsTaxSameAsAddress()&&r().getEditor("Address3").option("value",n.value)}}},{itemType:"empty"},{dataField:"City",validationRules:[{type:"required"}],label:{text:"City"},editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.City(n.value);t.IsBillSameAsAddress()&&o().getEditor("City").option("value",n.value);t.IsTaxSameAsAddress()&&r().getEditor("City").option("value",n.value)}}},{dataField:"StateProvince",validationRules:[{type:"required"}],label:{text:"Province"},editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.StateProvince(n.value);t.IsBillSameAsAddress()&&o().getEditor("StateProvince").option("value",n.value);t.IsTaxSameAsAddress()&&r().getEditor("StateProvince").option("value",n.value)}}},{itemType:"empty"},{dataField:"CountryID",width:"120px",label:{text:"Country"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCountryDataSource(null),displayExpr:"Name",valueExpr:"ID",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.CountryID(n.value);t.IsBillSameAsAddress()&&o().getEditor("CountryID").option("value",n.value);t.IsTaxSameAsAddress()&&r().getEditor("CountryID").option("value",n.value)}}},{dataField:"ZipCode",validationRules:[{type:"required"},{type:"numeric"}],label:{text:"Zip Code"},editorOptions:{maxLength:10,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.ZipCode(n.value);t.IsBillSameAsAddress()&&o().getEditor("ZipCode").option("value",n.value);t.IsTaxSameAsAddress()&&r().getEditor("ZipCode").option("value",n.value)}}},{itemType:"empty"},{dataField:"Phone1",validationRules:[{type:"required"},{type:"numeric"}],label:{text:"Phone 1"},editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.Phone1(n.value);t.IsBillSameAsAddress()&&o().getEditor("Phone1").option("value",n.value);t.IsTaxSameAsAddress()&&r().getEditor("Phone1").option("value",n.value)}}},{dataField:"Phone2",label:{text:"Phone 2"},validationRules:[{type:"numeric"}],editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.Phone2(n.value);t.IsBillSameAsAddress()&&o().getEditor("Phone2").option("value",n.value);t.IsTaxSameAsAddress()&&r().getEditor("Phone2").option("value",n.value)}}},{itemType:"empty"},{dataField:"Phone3",label:{text:"Phone 3"},validationRules:[{type:"numeric"}],editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.Phone3(n.value);t.IsBillSameAsAddress()&&o().getEditor("Phone3").option("value",n.value);t.IsTaxSameAsAddress()&&r().getEditor("Phone3").option("value",n.value)}}},{dataField:"Fax",label:{text:"Fax"},validationRules:[{type:"numeric"}],editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.Fax(n.value);t.IsBillSameAsAddress()&&o().getEditor("Fax").option("value",n.value);t.IsTaxSameAsAddress()&&r().getEditor("Fax").option("value",n.value)}}},{itemType:"empty"},{dataField:"Email",label:{text:"Email"},validationRules:[{type:"email"}],colSpan:"2",editorOptions:{maxLength:256,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.Email(n.value);t.IsBillSameAsAddress()&&o().getEditor("Email").option("value",n.value);t.IsTaxSameAsAddress()&&r().getEditor("Email").option("value",n.value)}}},{itemType:"empty"},{dataField:"Longitude",label:{text:"Longitude"},editorType:"dxNumberBox",editorOptions:{onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Latitude",label:{text:"Latitude"},editorType:"dxNumberBox",editorOptions:{onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"}]}));break;case 2:t.append($('<div id="vCustomers_billingInfoForm">').dxForm({deferRendering:!1,colCount:3,colSpan:3,showColonAfterLabel:!1,labelLocation:"left",items:[{dataField:"IsBillSameAsAddress",label:{text:"Same as Shipment Address"},colSpan:3,editorType:"dxCheckBox",editorOptions:{onValueChanged:function(n){var t=i.popupEditData();t.IsBillSameAsAddress(n.value);ft(t,!0)}}},{dataField:"Name",validationRules:[{type:"required"}],label:{text:"Name"},colSpan:2,editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.BillName(n.value);t.IsTaxSameAsBillAddress()&&r().getEditor("Name").option("value",n.value)}}},{itemType:"empty"},{dataField:"Address1",validationRules:[{type:"required"}],label:{text:"Address"},colSpan:2,editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.BillAddress1(n.value);t.IsTaxSameAsBillAddress()&&r().getEditor("Address1").option("value",n.value)}}},{itemType:"empty"},{dataField:"Address2",label:{text:" "},colSpan:2,editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.BillAddress2(n.value);t.IsTaxSameAsBillAddress()&&r().getEditor("Address2").option("value",n.value)}}},{itemType:"empty"},{dataField:"Address3",label:{text:" "},colSpan:2,editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.BillAddress3(n.value);t.IsTaxSameAsBillAddress()&&r().getEditor("Address3").option("value",n.value)}}},{itemType:"empty"},{dataField:"City",validationRules:[{type:"required"}],label:{text:"City"},editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.BillCity(n.value);t.IsTaxSameAsBillAddress()&&r().getEditor("City").option("value",n.value)}}},{dataField:"StateProvince",validationRules:[{type:"required"}],label:{text:"Province"},editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.BillStateProvince(n.value);t.IsTaxSameAsBillAddress()&&r().getEditor("StateProvince").option("value",n.value)}}},{itemType:"empty"},{dataField:"CountryID",caption:"Country",width:"120px",validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCountryDataSource(null),displayExpr:"Name",valueExpr:"ID",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.BillCountryID(n.value);t.IsTaxSameAsBillAddress()&&r().getEditor("CountryID").option("value",n.value)}}},{dataField:"ZipCode",validationRules:[{type:"required"},{type:"numeric"}],label:{text:"Zip Code"},editorOptions:{maxLength:10,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.BillZipCode(n.value);t.IsTaxSameAsBillAddress()&&r().getEditor("ZipCode").option("value",n.value)}}},{itemType:"empty"},{dataField:"Phone1",validationRules:[{type:"required"},{type:"numeric"}],label:{text:"Phone 1"},editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.BillPhone1(n.value);t.IsTaxSameAsBillAddress()&&r().getEditor("Phone1").option("value",n.value)}}},{dataField:"Phone2",label:{text:"Phone 2"},validationRules:[{type:"numeric"}],editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.BillPhone2(n.value);t.IsTaxSameAsBillAddress()&&r().getEditor("Phone2").option("value",n.value)}}},{itemType:"empty"},{dataField:"Phone3",label:{text:"Phone 3"},validationRules:[{type:"numeric"}],editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.BillPhone3(n.value);t.IsTaxSameAsBillAddress()&&r().getEditor("Phone3").option("value",n.value)}}},{dataField:"Fax",label:{text:"Fax"},validationRules:[{type:"numeric"}],editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.BillFax(n.value);t.IsTaxSameAsBillAddress()&&r().getEditor("Fax").option("value",n.value)}}},{itemType:"empty"},{dataField:"Email",label:{text:"Email"},validationRules:[{type:"email"}],editorOptions:{maxLength:256,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.BillEmail(n.value);t.IsTaxSameAsBillAddress()&&r().getEditor("Email").option("value",n.value)}}},{itemType:"empty",colSpan:2}]}));break;case 3:t.append($('<div id="vCustomers_taxInfoForm">').dxForm({deferRendering:!1,colCount:3,colSpan:3,showColonAfterLabel:!1,labelLocation:"left",items:[{dataField:"IsTaxNumberAvailable",label:{text:"Have Tax Number"},editorType:"dxCheckBox",editorOptions:{onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var u=i.popupEditData(),t;u.IsTaxNumberAvailable(n.value);t=r();t.itemOption("TaxNumber","isRequired",n.value);t.itemOption(".Name","isRequired",n.value);t.itemOption(".Address1","isRequired",n.value);t.itemOption(".City","isRequired",n.value);t.itemOption(".StateProvince","isRequired",n.value);t.itemOption(".CountryID","isRequired",n.value);t.itemOption(".ZipCode","isRequired",n.value);t.itemOption(".Phone1","isRequired",n.value);n.value||(u.TaxNumber(null),u.TaxSAPCode(null));t.getEditor("TaxNumber").option("value",u.TaxNumber());t.getEditor("TaxSAPCode").option("value",u.TaxSAPCode());t.getEditor("TaxNumber").option("readOnly",!n.value);t.getEditor("TaxSAPCode").option("readOnly",!n.value);(u.IsTaxSameAsAddress()||u.IsTaxSameAsBillAddress())&&h(u,!0)}}},{dataField:"TaxNumber",label:{text:"Tax Number"},editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"TaxSAPCode",label:{text:"Tax SAP Code"},editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"group",caption:" ",cssClass:"form-group-padding",colCount:3,colSpan:3,items:[{dataField:"IsTaxSameAsAddress",label:{text:"Same as Shipment Address"},editorType:"dxCheckBox",editorOptions:{onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData(),u,f;t.IsTaxSameAsAddress(n.value);u=r().getEditor("IsTaxSameAsBillAddress");f=u.option("value");n.value?(f&&u.option("value",!1),t.IsTaxSameAsBillAddress(!n.value),h(t,!0)):f||h(t,!0)}}},{itemType:"empty",colSpan:2},{dataField:"IsTaxSameAsBillAddress",label:{text:"Same as Billing Address"},editorType:"dxCheckBox",editorOptions:{onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData(),u,f;t.IsTaxSameAsBillAddress(n.value);u=r().getEditor("IsTaxSameAsAddress");f=u.option("value");n.value?(f&&u.option("value",!1),t.IsTaxSameAsAddress(!n.value),h(t,!0)):f||h(t,!0)}}},{itemType:"empty",colSpan:2},{dataField:"Name",label:{text:"Name"},validationRules:[{type:"required"}],colSpan:2,editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.TaxName(n.value)}}},{itemType:"empty"},{dataField:"Address1",label:{text:"Address"},validationRules:[{type:"required"}],colSpan:2,editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.TaxAddress1(n.value)}}},{itemType:"empty"},{dataField:"Address2",label:{text:" "},colSpan:2,editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.TaxAddress2(n.value)}}},{itemType:"empty"},{dataField:"Address3",label:{text:" "},colSpan:2,editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.TaxAddress3(n.value)}}},{itemType:"empty"},{dataField:"City",label:{text:"City"},validationRules:[{type:"required"}],editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.TaxCity(n.value)}}},{dataField:"StateProvince",label:{text:"Province"},validationRules:[{type:"required"}],editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.TaxStateProvince(n.value)}}},{itemType:"empty"},{dataField:"CountryID",caption:"Country",width:"120px",editorType:"dxSelectBox",validationRules:[{type:"required"}],editorOptions:{dataSource:DataUtility.GetLookupCountryDataSource(null),displayExpr:"Name",valueExpr:"ID",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.TaxCountryID(n.value)}}},{dataField:"ZipCode",label:{text:"Zip Code"},validationRules:[{type:"required"},{type:"numeric"}],editorOptions:{maxLength:10,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.TaxZipCode(n.value)}}},{itemType:"empty"},{dataField:"Phone1",validationRules:[{type:"required"},{type:"numeric"}],label:{text:"Phone 1"},editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.TaxPhone1(n.value)}}},{dataField:"Phone2",label:{text:"Phone 2"},validationRules:[{type:"numeric"}],editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.TaxPhone2(n.value)}}},{itemType:"empty"},{dataField:"Phone3",label:{text:"Phone 3"},validationRules:[{type:"numeric"}],editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.TaxPhone3(n.value)}}},{dataField:"Fax",label:{text:"Fax"},validationRules:[{type:"numeric"}],editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.TaxFax(n.value)}}},{itemType:"empty"},{dataField:"Email",label:{text:"Email"},validationRules:[{type:"email"}],editorOptions:{maxLength:256,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.TaxEmail(n.value)}}},{itemType:"empty"}]}]}));break;case 4:t.append($('<div id="vCustomers_additionalInfoForm">').dxForm({deferRendering:!1,colCount:2,showColonAfterLabel:!1,labelLocation:"left",items:[{itemType:"group",cssClass:"form-group-padding",colCount:2,colSpan:2,items:[{dataField:"AdditionalInfo1",label:{text:u("Customer.AdditionalInfo1")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo2",label:{text:u("Customer.AdditionalInfo2")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo3",label:{text:u("Customer.AdditionalInfo3")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo4",label:{text:u("Customer.AdditionalInfo4")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo5",label:{text:u("Customer.AdditionalInfo5")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo6",label:{text:u("Customer.AdditionalInfo6")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo7",label:{text:u("Customer.AdditionalInfo7")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo8",label:{text:u("Customer.AdditionalInfo8")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo9",label:{text:u("Customer.AdditionalInfo9")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo10",label:{text:u("Customer.AdditionalInfo10")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}}]}]}))}n.itemElement.append(t)}});n.append(f);t.append(DXUtility.createFormItemGroupWithCaption("").append(n))},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Site",["Area","Region","Territory"],[]);n.selectedItem?(i.form().getEditor("Company").option("value",n.selectedItem.Company()),i.form().getEditor("Code").option("value",rt(n.selectedItem.Code()))):n.previousValue!=null&&i.form().getEditor("Company").option("value",null);ut(i.form(),n.value)}}}]},{itemType:"group",caption:"Customer",colCount:6,colSpan:3,items:[{dataField:"Code",label:{text:"Code"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Name",validationRules:[{type:"required"}],label:{text:"Name"},colSpan:3,editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.popupEditData();t.Name(n.value);t.IsBillSameAsAddress()&&o().getEditor("Name").option("value",n.value);t.IsTaxSameAsAddress()&&r().getEditor("Name").option("value",n.value)}}},{itemType:"empty"}]}],e.events.performNewRow=function(){ot(null)},i.events.performOK=function(){bt()},i.events.performCancel=function(){i.popupEditOptions.visible(!1);c&&(e.dataGrid().refresh(),c=!1)},{isReady:k.promise(),dataSource:s,refreshList:tt,viewShowing:ct,viewDisposing:lt,openCreateViewAsRoot:ht,icon:"/Images/customer_32px.png",dataSource_vDiscountGroup:it,collapsibleFilter:f,commonGridView:e,commonPopupEdit:i,customerInfoTabPanel:st,customerGeneralInfoForm:a,customerShipmentInfoForm:v,customerBillingInfoForm:o,customerTaxInfoForm:r,customerAdditionalInfoForm:b}};Dismoyo_Ciptoning_Client.vCustomerCategories=function(n,t){"use strict";function a(){s=!0}function v(){$("#vCustomerCategories_commonGridView").is(":visible")?($("#vCustomerCategories_viewContent").layout({name:"vCustomerCategoriesViewContent",north:{paneSelector:"#vCustomerCategories_viewContentHeader",resizable:!1,spacing_open:0,spacing_closed:0},center:{paneSelector:"#vCustomerCategories_viewSubContent",onresize:$.layout.callbacks.resizeTabLayout,children:{west:{paneSelector:"#vCustomerCategories_commonTreeView",width:"300px"},center:{paneSelector:"#vCustomerCategories_commonGridView"}}}}),o()):setTimeout(v,50)}function w(){v();u.filter(["ParentID","=",e]);l()?s&&y():(l(u),u.load().always(function(){c.resolve()}))}function b(){Dismoyo_Ciptoning_Client.DB.vCustomerCategories.off("modified",a)}function y(){s=!1;u.pageIndex(0);u.load()}function o(){r.showLoadingPanel();r.treeView().option("dataSource",null);h.load().done(function(){r.treeView().option("dataSource",h);r.hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load data."),"Load Failed");r.hideLoadingPanel()})}var s=!1,p=t.layoutController.name==="split",c=$.Deferred(),l=ko.observable(),u,e=-1,h,f,r,i;u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomerCategories,map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerCategoryViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vCustomerCategories.on("modified",a);return h=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomerCategories,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerCategoryViewModel(n)}}),f=new Dismoyo_Ciptoning_Client.CollapsibleFilter,f.formOptions.items=[{name:"Category",dataField:"",label:{text:"Category"},editorOptions:{placeholder:"Code/Name",onEnterKey:function(){f.events.performSearch()}}},{dataField:"",label:{text:"",visible:!1},editorOptions:{visible:!1}}],f.events.performSearch=function(){var t=i.dataGrid(),e=f.form(),r=[],u,n;t.clearFilter();u=f.form().getEditor("Category").option("value");n=[];DXUtility.addFilterExpression(n,"Code","contains",u,"or");DXUtility.addFilterExpression(n,"Name","contains",u,"or");DXUtility.addGroupFilterExpression(r,n,"and");r.length>0?t.filter(r):t.refresh()},r=new Dismoyo_Ciptoning_Client.CommonTreeView,r.treeViewOptions.dataStructure="plain",r.treeViewOptions.keyExpr="ID",r.treeViewOptions.parentIdExpr="ParentID",r.treeViewOptions.displayExpr="Name",r.loadingPanelOptions.position={of:"#vCustomerCategories_commonTreeView"},r.treeViewOptions.itemTemplate=function(n){return'<div/><img src="Images/file_32px.png" class="dx-icon"><b>'+HtmlUtility.htmlEncode(DXUtility.getValue(n,"Group"))+":<\/b> "+HtmlUtility.htmlEncode(DXUtility.getValue(n,"Name"))+"<\/div>"},r.events.itemClick=function(n){e=DXUtility.getValue(n.itemData,"ID");i.newRow().option("disabled",!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("CustomerCategories.AddNewCustomerCategory"));var t=i.dataGrid();t.clearFilter();t.filter(["ParentID","=",e])},i=new Dismoyo_Ciptoning_Client.CommonGridView,i.dataGridOptions.dataSource=u,i.newRowOptions.disabled=!0,i.dataGridOptions.editing.editEnabled=i.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("CustomerCategories.EditCustomerCategory"),i.dataGridOptions.editing.removeEnabled=i.dataGridOptions.editing.allowDeleting=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("CustomerCategories.DeleteCustomerCategory"),i.dataGridOptions.onInitNewRow=function(n){n.data.ParentID=e},i.dataGridOptions.onEditorPreparing=function(n){if(n.parentType=="data"&&n.row&&n.row.inserted)switch(n.dataField){case"ParentID":n.editorOptions.value=e}},i.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Code",caption:"Code",width:"70px",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$("#vCustomerCategories_commonGridView").find(".dx-datagrid:first-child"),r,f;!u.find(".datagrid-bandedHeader:first").length>0&&(r='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Category<\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',(i.dataGridOptions.editing.allowUpdating||i.dataGridOptions.editing.allowDeleting)&&(r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),r+="<\/tr>",f=u.find(".dx-header-row:first-child"),$(r).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"Name",width:"180px",validationRules:[{type:"required"}]},{dataField:"ParentID",width:"70px",visible:!1},{dataField:"Group",width:"140px",validationRules:[{type:"required"}]},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],i.events.rowInserted=function(){o()},i.events.rowUpdated=function(){o()},i.events.rowRemoved=function(){o()},i.events.rowsRemoved=function(){o()},{isReady:c.promise(),dataSource:u,refreshList:y,viewShowing:w,viewDisposing:b,openCreateViewAsRoot:p,icon:"Images/territory_32px.png",commonTreeView:r,commonGridView:i}};Dismoyo_Ciptoning_Client.vCustomerMasterReports=function(n,t){"use strict";function s(){if(f=CommonUtility.configureCommonIFrameLayout("vCustomerMasterReports"),f){var n=i.form();n.getEditor("ReportPeriod").option("value",2);n.getEditor("ReportDateFrom").option("value",DateTimeUtility.getFirstDayOfMonth(new Date))}else setTimeout(s,50)}function l(){s();o.resolve()}function a(n){var t=e.iframe();e.showLoadingPanel();t.attr("src",Dismoyo_Ciptoning_Client.ReportWebsite.CustomerMasterReport.url(n))}var h=!1,c=t.layoutController.name==="split",o=$.Deferred(),f,u=null,r=null,i=new Dismoyo_Ciptoning_Client.CollapsibleFilter,e;return i.filterOptions.onInitialized=function(){i.filter().element().resize(function(){f&&f.resizeAll()})},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area","Site"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],[])}}}]},{itemType:"group",caption:"Customer Master Report",colCount:3,colSpan:3,items:[{dataField:"ReportPeriod",label:{text:"Period"},editorType:"dxRadioGroup",editorOptions:{width:"100%",displayExpr:"Name",valueExpr:"ID",items:[{ID:1,Name:"Daily"},{ID:2,Name:"Monthly"},{ID:9,Name:"All"},],layout:"horizontal",onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();CommonUtility.reportPeriodValueChanged(n,t,!0);u=null;r=null}}},{dataField:"ReportDateFrom",label:{text:"Report Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,min:new Date(1900,0,1),onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();u=n.value;t.itemOption("CustomerMasterReports.ReportDateTo").visible?(CommonUtility.reportDateFromValueChanged(n,t),r=t.getEditor("ReportDateTo").option("value")):r=n.value?new Date(n.value.getFullYear(),n.value.getMonth()+1,0):null;u instanceof Date&&(u=DateTimeUtility.getFirstTimeOfDay(u));r instanceof Date&&(r=DateTimeUtility.getLastTimeOfDay(r))}}},{dataField:"ReportDateTo",label:{text:"Report Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();CommonUtility.reportDateToValueChanged(n,t);u=t.getEditor("ReportDateFrom").option("value");r=n.value;u instanceof Date&&(u=DateTimeUtility.getFirstTimeOfDay(u));r instanceof Date&&(r=DateTimeUtility.getLastTimeOfDay(r))}}},{dataField:"StatusID",label:{text:"Status"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","ReportCustomerStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,onEnterKey:function(){i.events.performSearch(this)}}}]}],i.events.performSearch=function(){var t=i.form(),o=t.getEditor("ReportDateFrom");if(o&&o.option("visible")){if(u==null||r==null){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Please specify Report Date/Month."),"Search Failed");return}if(u.getFullYear()!=r.getFullYear()||u.getMonth()!=r.getMonth()){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Report Date From and To must be in the same month."),"Search Failed");return}}var n=[],f,e=Dismoyo_Ciptoning_Client.app.CurrentUser,s=e.TerritoryID(),h=e.RegionID(),c=e.AreaID(),l=e.CompanyID(),v=e.SiteID();t.itemOption("Organization").visible&&(s=t.getEditor("TerritoryID").option("value"),h=t.getEditor("RegionID").option("value"),c=t.getEditor("AreaID").option("value"),l=t.getEditor("CompanyID").option("value"),v=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",s,"and");DXUtility.addFilterExpression(n,"RegionID","=",h,"and");DXUtility.addFilterExpression(n,"AreaID","=",c,"and");DXUtility.addFilterExpression(n,"CompanyID","=",l,"and");DXUtility.addFilterExpression(n,"SiteID","=",v,"and");f=t.getEditor("StatusID").option("value");DXUtility.addFilterExpression(n,"StatusID","=",f,"and");f=u;DXUtility.addFilterExpression(n,"ReportDateFrom",">=",f,"and");f=r;DXUtility.addFilterExpression(n,"ReportDateTo","<=",f,"and");a(n)},i.events.performClear=function(){var n=i.form();n.getEditor("ReportDateFrom").option("value",null);n.itemOption("CustomerMasterReports.ReportDateTo").visible&&n.getEditor("ReportDateTo").option("value",null);u=null;r=null},e=new Dismoyo_Ciptoning_Client.CommonIFrame,{isReady:o.promise(),viewShowing:l,openCreateViewAsRoot:c,icon:"Images/customer_master_report_32px.png",collapsibleFilter:i,commonIFrame:e}};Dismoyo_Ciptoning_Client.vDailySalesmanReports=function(n,t){"use strict";function e(){if(r=CommonUtility.configureCommonIFrameLayout("vDailySalesmanReports"),r){var n=i.form();n.getEditor("ReportDate").option("value",DateTimeUtility.getFirstTimeOfDay(new Date))}else setTimeout(e,50)}function h(){e();f.resolve()}function c(n){var t=u.iframe();u.showLoadingPanel();t.attr("src",Dismoyo_Ciptoning_Client.ReportWebsite.DailySalesmanReport.url(n))}var o=!1,s=t.layoutController.name==="split",f=$.Deferred(),r,i=new Dismoyo_Ciptoning_Client.CollapsibleFilter,u;return i.filterOptions.onInitialized=function(){i.filter().element().resize(function(){r&&r.resizeAll()})},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area","Site"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Salesman"])}}}]},{itemType:"group",caption:"Daily Salesman Report",colCount:3,colSpan:3,items:[{dataField:"ReportDate",label:{text:"Report Date"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",formatString:"MM/dd/yyyy",showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)}}},{dataField:"SalesmanID",label:{text:"Salesman"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSalesmanDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Salesman",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)}}}]}],i.events.performSearch=function(){var r=i.form(),n,t;if(r.getEditor("ReportDate").option("value")==null||r.getEditor("SalesmanID").option("value")==null){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Please specify Report Date and Salesman."),"Search Failed");return}n=[];t=r.getEditor("ReportDate").option("value");DXUtility.addFilterExpression(n,"ReportDateFrom",">=",t,"and");DXUtility.addFilterExpression(n,"ReportDateTo","<=",t,"and");t=r.getEditor("SalesmanID").option("value");DXUtility.addFilterExpression(n,"SalesmanID","=",t,"and");c(n)},u=new Dismoyo_Ciptoning_Client.CommonIFrame,{isReady:f.promise(),viewShowing:h,openCreateViewAsRoot:s,icon:"Images/daily_salesman_report_32px.png",collapsibleFilter:i,commonIFrame:u}};Dismoyo_Ciptoning_Client.vDailySalesReports=function(n,t){"use strict";function s(){if(f=CommonUtility.configureCommonIFrameLayout("vDailySalesReports"),f){var n=i.form();n.getEditor("ReportPeriod").option("value",2);n.getEditor("ReportDateFrom").option("value",DateTimeUtility.getFirstDayOfMonth(new Date))}else setTimeout(s,50)}function l(){s();o.resolve()}function a(n){var t=e.iframe();e.showLoadingPanel();t.attr("src",Dismoyo_Ciptoning_Client.ReportWebsite.DailySalesReport.url(n))}var h=!1,c=t.layoutController.name==="split",o=$.Deferred(),f,u=null,r=null,i=new Dismoyo_Ciptoning_Client.CollapsibleFilter,e;return i.filterOptions.onInitialized=function(){i.filter().element().resize(function(){f&&f.resizeAll()})},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area","Site"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],[])}}}]},{itemType:"group",caption:"Daily Sales Report",colCount:3,colSpan:3,items:[{dataField:"ReportPeriod",label:{text:"Period"},editorType:"dxRadioGroup",editorOptions:{width:"100%",displayExpr:"Name",valueExpr:"ID",items:[{ID:1,Name:"Daily"},{ID:2,Name:"Monthly"}],layout:"horizontal",onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();CommonUtility.reportPeriodValueChanged(n,t,!0);u=null;r=null}}},{dataField:"ReportDateFrom",label:{text:"Report Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,min:new Date(2016,6,1),onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();u=n.value;t.itemOption("DailySalesReports.ReportDateTo").visible?(CommonUtility.reportDateFromValueChanged(n,t),r=t.getEditor("ReportDateTo").option("value")):r=n.value?new Date(n.value.getFullYear(),n.value.getMonth()+1,0):null;u instanceof Date&&(u=DateTimeUtility.getFirstTimeOfDay(u));r instanceof Date&&(r=DateTimeUtility.getLastTimeOfDay(r))}}},{dataField:"ReportDateTo",label:{text:"Report Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();CommonUtility.reportDateToValueChanged(n,t);u=t.getEditor("ReportDateFrom").option("value");r=n.value;u instanceof Date&&(u=DateTimeUtility.getFirstTimeOfDay(u));r instanceof Date&&(r=DateTimeUtility.getLastTimeOfDay(r))}}}]}],i.events.performSearch=function(){var t=i.form(),o=t.getEditor("ReportDateFrom");if(o&&o.option("visible")){if(u==null||r==null){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Please specify Report Date/Month."),"Search Failed");return}if(u.getFullYear()!=r.getFullYear()||u.getMonth()!=r.getMonth()){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Report Date From and To must be in the same month."),"Search Failed");return}}var n=[],e,f=Dismoyo_Ciptoning_Client.app.CurrentUser,s=f.TerritoryID(),h=f.RegionID(),c=f.AreaID(),l=f.CompanyID(),v=f.SiteID();t.itemOption("Organization").visible&&(s=t.getEditor("TerritoryID").option("value"),h=t.getEditor("RegionID").option("value"),c=t.getEditor("AreaID").option("value"),l=t.getEditor("CompanyID").option("value"),v=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",s,"and");DXUtility.addFilterExpression(n,"RegionID","=",h,"and");DXUtility.addFilterExpression(n,"AreaID","=",c,"and");DXUtility.addFilterExpression(n,"CompanyID","=",l,"and");DXUtility.addFilterExpression(n,"SiteID","=",v,"and");e=u;DXUtility.addFilterExpression(n,"ReportDateFrom",">=",e,"and");e=r;DXUtility.addFilterExpression(n,"ReportDateTo","<=",e,"and");a(n)},i.events.performClear=function(){var n=i.form();n.getEditor("ReportDateFrom").option("value",null);n.itemOption("DailySalesReports.ReportDateTo").visible&&n.getEditor("ReportDateTo").option("value",null);u=null;r=null},e=new Dismoyo_Ciptoning_Client.CommonIFrame,{isReady:o.promise(),viewShowing:l,openCreateViewAsRoot:c,icon:"Images/daily_sales_report_32px.png",collapsibleFilter:i,commonIFrame:e}};Dismoyo_Ciptoning_Client.vDiscountGroups=function(n,t){"use strict";function v(){s=!0}function y(){e=CommonUtility.configureCommonGridViewLayout("vDiscountGroups");e||setTimeout(y,50)}function k(){y();vDiscountGroupsViewInstance=this;a()?s&&p():(a(f),f.load().always(function(){l.resolve()}))}function d(){Dismoyo_Ciptoning_Client.DB.vDiscountGroups.off("modified",v)}function p(){s=!1;f.pageIndex(0);f.load()}function g(n){return new DevExpress.data.DataSource({store:{type:"array",key:"ProductID",data:ko.toJS(n)},map:function(n){return new Dismoyo_Ciptoning_Client.vDiscountGroupProductViewModel(n)}})}function c(n){var r=!1,t,u;n||(n=new Dismoyo_Ciptoning_Client.vDiscountGroupViewModel,r=!0);i.popupEditData(n);i.popupEdit().option("title",(r?"New":"Edit")+" Discount Group");i.popupEditOptions.editingKey=n.ID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);t=i.form();DXUtility.resetFormValidation(t);r&&n.StatusID(1);t.getEditor("Code").option("value",n.Code());t.getEditor("Name").option("value",n.Name());t.getEditor("Description").option("value",n.Description());t.getEditor("Code").option("readOnly",!r);r&&DXUtility.resetFormValidation(t);t.getEditor("StatusID").option("value",n.StatusID());u=o();u.cancelEditData();u.option("dataSource",g(n.ChildProducts()))}function nt(){var f,n,t,l;showLoadingPanel();var u=i.form().validate().isValid,e=u?"":"Please specify the required fields.",h=r.dataGrid(),a=h.option("dataSource"),c=o().option("dataSource"),s=[];for(f=0;f<c.store()._array.length;f++)s.push(new Dismoyo_Ciptoning_Client.vDiscountGroupProductViewModel(c.store()._array[f]));u&&s.length==0&&(e="Please specify at least one product discount data.",u=!1);u?(n=i.popupEditData(),t=i.form(),n.Code(t.getEditor("Code").option("value")),n.Name(t.getEditor("Name").option("value")),n.Description(t.getEditor("Description").option("value")),n.StatusID(t.getEditor("StatusID").option("value")),n.ChildProducts(s),l=ko.toJS(n),a.store().insert(l).done(function(){hideLoadingPanel();i.popupEditOptions.visible(!1);h.refresh()}).fail(function(n){DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})):hideLoadingPanel();e!=""&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(e),"Save Failed")}var s=!1,b=t.layoutController.name==="split",l=$.Deferred(),a=ko.observable(),f,e,w,h,u,r,i,o;f=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vDiscountGroups,map:function(n){return new Dismoyo_Ciptoning_Client.vDiscountGroupViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vDiscountGroups.on("modified",v);return w=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vDiscountStratas,map:function(n){return new Dismoyo_Ciptoning_Client.vDiscountStrataViewModel(n)}}),h=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vProducts,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vProductViewModel(n)}}),u=new Dismoyo_Ciptoning_Client.CollapsibleFilter,u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){e&&e.resizeAll()})},u.formOptions.items=[{name:"DiscountGroup",dataField:"",label:{text:"Discount Group"},editorOptions:{placeholder:"Code/Name/Description",onEnterKey:function(){u.events.performSearch()}}},{dataField:"",label:{text:"",visible:!1},editorOptions:{visible:!1}}],u.events.performSearch=function(){var t,i,n;r.dataGrid().clearFilter();t=[];i=u.form().getEditor("DiscountGroup").option("value");n=[];DXUtility.addFilterExpression(n,"Code","contains",i,"or");DXUtility.addFilterExpression(n,"Name","contains",i,"or");DXUtility.addFilterExpression(n,"Description","contains",i,"or");DXUtility.addGroupFilterExpression(t,n,"and");t.length>0?r.dataGrid().filter(t):r.dataGrid().refresh()},r=new Dismoyo_Ciptoning_Client.CommonGridView,r.dataGridOptions.dataSource=f,r.dataGridOptions.editing.editEnabled=!1,r.dataGridOptions.editing.removeEnabled=!1,r.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Code",caption:"Code",width:"70px",validationRules:[{type:"required"}],cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: left;">');i.append($('<a class="dx-link">').text(t.data.Code()).on("dxclick",function(){Dismoyo_Ciptoning_Client.DB.vDiscountGroups.byKey(t.data.ID(),{expand:["ChildProducts"]}).done(function(n){var t=new Dismoyo_Ciptoning_Client.vDiscountGroupViewModel(n);c(t)})}));i.append("&nbsp;");n.append(i)},headerCellTemplate:function(n,t){var r=$("#vDiscountGroups_commonGridView").find(".dx-datagrid:first-child"),i,u;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Discount Group<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+="<\/tr>",u=r.find(".dx-header-row:first-child"),$(i).insertBefore(u[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"Name",caption:"Name",width:"180px"},{dataField:"Description",caption:"Description",width:"250px"},{dataField:"StatusName",caption:"Status",width:"100px"},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1},{alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){Dismoyo_Ciptoning_Client.DB.vDiscountGroups.byKey(t.data.ID(),{expand:["ChildProducts"]}).done(function(n){var t=new Dismoyo_Ciptoning_Client.vDiscountGroupViewModel(n);c(t)})}));i.append("&nbsp;");i.append($('<a class="dx-link">').text("Delete").on("dxclick",function(){r.dataGrid().deleteRow(t.rowIndex)}));i.append("&nbsp;");n.append(i)}}],i=new Dismoyo_Ciptoning_Client.CommonPopupEdit,i.okOptions.text="Save",i.okOptions.icon="icons8-save",o=function(){return DXUtility.getDXInstance(null,"#vDiscountGroups_discountGroupProductDataGrid","dxDataGrid")},i.popupEditOptions.onContentReady=function(){var t=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop("Product Discounts"));n.append($('<div id="vDiscountGroups_discountGroupProductDataGrid">').dxDataGrid({deferRendering:!1,dataSource:[],showBorders:!0,paging:{enabled:!1},allowColumnResizing:!0,columnAutoWidth:!1,hoverStateEnabled:!0,editing:{editMode:"row",allowAdding:!0,allowUpdating:!0,allowDeleting:!0},onEditorPreparing:function(n){n.parentType=="dataRow"&&(n.dataField=="DiscountStrata1ID"||n.dataField=="DiscountStrata2ID"||n.dataField=="DiscountStrata3ID"||n.dataField=="DiscountStrata4ID"||n.dataField=="DiscountStrata5ID")&&(n.editorElement.dxLookup({dataSource:DataUtility.GetLookupDiscountStrataDataSource(null),displayExpr:"DiscountStrata",valueExpr:"ID",searchExpr:["Code","Name"],searchPlaceholder:"Code/Name",popupWidth:"482px",showPopupTitle:!1,fieldEditEnabled:!0,showClearButton:!0,value:n.value,onContentReady:function(n){var r="vDiscountGroups_discountStrataIDLookup",u=n.element.find("#"+r),t,i;u.length==0&&(t='<div id="'+r+'" class="dx-datagrid datagrid-columnheader">',t+='       <table class="dx-datagrid-headers dx-datagrid-nowrap">',t+="           <colgroup>",t+='               <col style="width: 200px;">',t+='               <col style="width: 140px;">',t+='               <col style="width: 140px;">',t+="           <\/colgroup><tbody>",t+='           <tr class="dx-row dx-header-row dx-column-lines">',t+='               <td class="dx-datagrid-action" style="border-left-style: none !important;">',t+="<\/td>",t+='               <td class="dx-datagrid-action" style="text-align: left;" colSpan="2">',t+="Valid Date<\/td>",t+="<\/tr>",t+='           <tr class="dx-row dx-header-row dx-column-lines">',t+='               <td class="dx-datagrid-action" style="border-left-style: none !important;">',t+="Discount Strata<\/td>",t+='               <td class="dx-datagrid-action" style="text-align: center; border-top: 1px solid #D3D3D3;">',t+="From<\/td>",t+='               <td class="dx-datagrid-action" style="text-align: center; border-top: 1px solid #D3D3D3;">',t+="To<\/td>",t+="<\/tr><\/tbody><\/table><\/div>",i=n.element.find(".dx-list"),i.attr("style","top: 59px !important"),i.before($(t)))},itemTemplate:function(n,t,i){var u="",r='<div class="dx-datagrid dx-datagrid-rowsview dx-datagrid-nowrap" style="background-color: inherit;">';return r+='       <table class="dx-datagrid-table dx-datagrid-table-fixed" style="border-collapse: initial !important;">',r+="           <colgroup>",r+='               <col style="width: 200px;">',r+='               <col style="width: 140px;">',r+='               <col style="width: 140px;">',r+="           <\/colgroup><tbody>",r+='           <tr class="dx-row dx-data-row dx-column-lines">',r+='               <td class="dx-datagrid-action" title="'+HtmlUtility.htmlEncode(n.DiscountStrata())+'"',r+='                   style="text-align: left; border-left-style: none !important;">',r+=HtmlUtility.htmlEncode(n.DiscountStrata())+"<\/td>",u=HtmlUtility.htmlEncode(DateTimeUtility.convertToLocal(n.ValidDateFrom()).toISOString().substring(0,10)),r+='                <td class="dx-datagrid-action" title="'+u+'" style="text-align: center;">',r+=u+"<\/td>",u=HtmlUtility.htmlEncode(DateTimeUtility.convertToLocal(n.ValidDateTo()).toISOString().substring(0,10)),r+='                <td class="dx-datagrid-action" title="'+u+'" style="text-align: center;">',r+=u+"<\/td>",r+="<\/tr><\/tbody><\/table><\/div>",i.attr("style","padding: 0px"),r},onValueChanged:function(t){n.setValue(t.value)}}),n.cancel=!0);n.parentType=="dataRow"&&n.dataField=="ProductID"&&(n.row.inserted||(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.cells[0].text)),n.cancel=!0))},onDataErrorOccurred:function(n){var t=n.component._controllers.editing._editRowIndex,i=n.component._controllers.data._items[t].cells[1].text;n.error.__id=="E4008"&&(n.error.message="Product value '"+i+"' is already exist.")},onRowInserted:function(){$(".dx-error-row").remove()},columns:[{dataField:"DiscountGroupID",visible:!1},{dataField:"ProductID",caption:"Product",width:"300px",validationRules:[{type:"required"}],lookup:{dataSource:h.store(),displayExpr:"Product",valueExpr:"ID",allowClearing:!0},headerCellTemplate:function(n,t){var r=$(vDiscountGroupsViewInstance.discountGroupProductDataGrid().element()),i,u;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader" style="border-top-style: none !important;">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"> <\/td>',i+='       <td class="dx-datagrid-action" colspan="5">Discount Strata<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+="<\/tr>",u=r.find(".dx-header-row:first-child"),$(i).insertBefore(u[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"DiscountStrata1ID",caption:"1",width:"200px",validationRules:[{type:"required"}],lookup:{dataSource:DataUtility.vDiscountStratas.dataSource(null),displayExpr:"DiscountStrata",valueExpr:"ID",allowClearing:!0}},{dataField:"DiscountStrata2ID",caption:"2",width:"200px",lookup:{dataSource:DataUtility.vDiscountStratas.dataSource(null),displayExpr:"DiscountStrata",valueExpr:"ID",allowClearing:!0}},{dataField:"DiscountStrata3ID",caption:"3",width:"200px",lookup:{dataSource:DataUtility.vDiscountStratas.dataSource(null),displayExpr:"DiscountStrata",valueExpr:"ID",allowClearing:!0}},{dataField:"DiscountStrata4ID",caption:"4",width:"200px",lookup:{dataSource:DataUtility.vDiscountStratas.dataSource(null),displayExpr:"DiscountStrata",valueExpr:"ID",allowClearing:!0}},{dataField:"DiscountStrata5ID",caption:"5",width:"200px",lookup:{dataSource:DataUtility.vDiscountStratas.dataSource(null),displayExpr:"DiscountStrata",valueExpr:"ID",allowClearing:!0}}]}));t.append(DXUtility.createFormItemGroupWithCaption("").append(n))},r.events.performNewRow=function(){c(null)},i.events.performOK=function(){nt()},i.formOptions.items=[{itemType:"group",caption:"Discount Group",colCount:6,colSpan:3,items:[{dataField:"Code",validationRules:[{type:"required"}],label:{text:"Code"},colSpan:2,editorOptions:{maxLength:10,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Name",validationRules:[{type:"required"}],label:{text:"Name"},colSpan:3,editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"Description",validationRules:[{type:"required"}],label:{text:"Description"},colSpan:3,editorOptions:{maxLength:200,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"StatusID",label:{text:"Status"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.vSystemLookups.dataSource(["Group","=","DiscountGroupStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"}]}],{isReady:l.promise(),dataSource:f,refreshList:p,viewShowing:k,viewDisposing:d,openCreateViewAsRoot:b,icon:"Images/discount_group_32px.png",dataSource_vDiscountStrata:w,dataSource_vProduct:h,collapsibleFilter:u,commonGridView:r,commonPopupEdit:i,discountGroupProductDataGrid:o}};Dismoyo_Ciptoning_Client.vDiscountStratas=function(n,t){"use strict";function a(){s=!0}function v(){o=CommonUtility.configureCommonGridViewLayout("vDiscountStratas");o||setTimeout(v,50)}function b(){v();vDiscountStratasViewInstance=this;l()?s&&y():(l(f),f.load().always(function(){c.resolve()}))}function k(){Dismoyo_Ciptoning_Client.DB.vDiscountStratas.off("modified",a)}function y(){s=!1;f.pageIndex(0);f.load()}function d(n){return new DevExpress.data.DataSource({store:{type:"array",key:"ID",data:ko.toJS(n)},map:function(n){return new Dismoyo_Ciptoning_Client.vDiscountStrataDetailsViewModel(n)}})}function g(n){for(var r,t=-1,i=0;i<n.length;i++)r=DXUtility.getValue(n[i],"ID"),r<=t&&(t=r-1);return t}function h(n){var r=!1,t,u;n||(n=new Dismoyo_Ciptoning_Client.vDiscountStrataViewModel,r=!0);i.popupEditData(n);i.popupEdit().option("title",(r?"New":"Edit")+" Discount Strata");i.popupEditOptions.editingKey=n.ID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);t=i.form();DXUtility.resetFormValidation(t);r&&n.StatusID(1);t.getEditor("Code").option("value",n.Code());t.getEditor("Name").option("value",n.Name());t.getEditor("ValidDateFrom").option("value",n.ValidDateFrom());t.getEditor("ValidDateTo").option("value",n.ValidDateTo());t.getEditor("Code").option("readOnly",!r);r&&DXUtility.resetFormValidation(t);t.getEditor("StatusID").option("value",n.StatusID());u=e();u.cancelEditData();u.option("dataSource",d(n.ChildDetails()))}function nt(){var f,n,t,l;showLoadingPanel();var u=i.form().validate().isValid,o=u?"":"Please specify the required fields.",h=r.dataGrid(),a=h.option("dataSource"),c=e().option("dataSource"),s=[];for(f=0;f<c.store()._array.length;f++)s.push(new Dismoyo_Ciptoning_Client.vDiscountStrataDetailsViewModel(c.store()._array[f]));u&&s.length==0&&(o="Please specify at least one strata details data.",u=!1);u?(n=i.popupEditData(),t=i.form(),n.Code(t.getEditor("Code").option("value")),n.Name(t.getEditor("Name").option("value")),n.ValidDateFrom(t.getEditor("ValidDateFrom").option("value")),n.ValidDateTo(t.getEditor("ValidDateTo").option("value")),n.StatusID(t.getEditor("StatusID").option("value")),n.ChildDetails(s),l=ko.toJS(n),a.store().insert(l).done(function(){hideLoadingPanel();i.popupEditOptions.visible(!1);h.refresh()}).fail(function(n){DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})):hideLoadingPanel();o!=""&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(o),"Save Failed")}var s=!1,w=t.layoutController.name==="split",c=$.Deferred(),l=ko.observable(),f,o,p,u,r,i,e;f=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vDiscountStratas,map:function(n){return new Dismoyo_Ciptoning_Client.vDiscountStrataViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vDiscountStratas.on("modified",a);return p=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vDiscountStrataDetails,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vDiscountStrataDetailsViewModel(n)}}),u=new Dismoyo_Ciptoning_Client.CollapsibleFilter,u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){o&&o.resizeAll()})},u.formOptions.items=[{name:"DiscountStrata",dataField:"",label:{text:"Discount Strata"},editorOptions:{placeholder:"Code/Name",onEnterKey:function(){u.events.performSearch()}}},{dataField:"",label:{text:"",visible:!1},editorOptions:{visible:!1}}],u.events.performSearch=function(){var t=vDiscountStratasViewInstance.commonGridView.dataGrid(),f=vDiscountStratasViewInstance.collapsibleFilter.form(),i=[],r,n;t.clearFilter();r=u.form().getEditor("DiscountStrata").option("value");n=[];DXUtility.addFilterExpression(n,"Code","contains",r,"or");DXUtility.addFilterExpression(n,"Name","contains",r,"or");DXUtility.addGroupFilterExpression(i,n,"and");i.length>0?t.filter(i):t.refresh()},r=new Dismoyo_Ciptoning_Client.CommonGridView,r.dataGridOptions.dataSource=f,r.dataGridOptions.editing.editEnabled=!1,r.dataGridOptions.editing.removeEnabled=!1,r.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Code",width:"70px",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: left;">');i.append($('<a class="dx-link">').text(t.data.Code()).on("dxclick",function(){Dismoyo_Ciptoning_Client.DB.vDiscountStratas.byKey(t.data.ID(),{expand:["ChildDetails"]}).done(function(n){var t=new Dismoyo_Ciptoning_Client.vDiscountStrataViewModel(n);h(t)})}));i.append("&nbsp;");n.append(i)},headerCellTemplate:function(n,t){var r=$("#vDiscountStratas_commonGridView").find(".dx-datagrid:first-child"),i,u;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Discount Strata<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Validity Period<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+="<\/tr>",u=r.find(".dx-header-row:first-child"),$(i).insertBefore(u[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"Name",caption:"Name",width:"180px"},{dataField:"ValidDateFrom",caption:"From",width:"140px",dataType:"date"},{dataField:"ValidDateTo",caption:"To",width:"140px",dataType:"date"},{dataField:"StatusName",caption:"Status",width:"100px"},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1},{width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){Dismoyo_Ciptoning_Client.DB.vDiscountStratas.byKey(t.data.ID(),{expand:["ChildDetails"]}).done(function(n){var t=new Dismoyo_Ciptoning_Client.vDiscountStrataViewModel(n);h(t)})}));i.append("&nbsp;");i.append($('<a class="dx-link">').text("Delete").on("dxclick",function(){r.dataGrid().deleteRow(t.rowIndex)}));i.append("&nbsp;");n.append(i)}}],i=new Dismoyo_Ciptoning_Client.CommonPopupEdit,i.okOptions.text="Save",i.okOptions.icon="icons8-save",e=function(){return DXUtility.getDXInstance(null,"#vDiscountStratas_discountStrataDetailsDataGrid","dxDataGrid")},i.popupEditOptions.onContentReady=function(){var t=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop("Strata Details"));n.append($('<div id="vDiscountStratas_discountStrataDetailsDataGrid">').dxDataGrid({deferRendering:!1,dataSource:[],showBorders:!0,paging:{enabled:!1},allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,height:"200px",editing:{editMode:"row",allowAdding:!0,allowUpdating:!0,allowDeleting:!0},onInitNewRow:function(n){var t=n.component.option("dataSource");n.data.ID=g(t.items())},onRowValidating:function(n){var f=function(){$(".dx-error-row").remove()},r,i;if(f(),r=function(n){f();var i=$(".dx-datagrid-table.dx-datagrid-table-fixed","#vDiscountStratas_discountStrataDetailsDataGrid").first(),t="<tr class='dx-error-row'><td colspan='"+$("col",$(i).first()).length+"' role='presentation'><div class='dx-closebutton dx-datagrid-action' onclick='javascript: $(this).parent().parent().remove();'><\/div><div class='dx-error-message'>";t+=n;t+="<\/div><\/td><\/tr>";$("tbody",$(i).first()).append(t)},n.brokenRules.length>0){r(n.brokenRules[0].message);u=!1;return}var s=e(),t=s.option("dataSource").items(),h=function(n,t){return n===undefined?!1:n.ID()==t.ID()&&n.Maximum()==t.Maximum()&&n.Minimum()==t.Minimum()&&n.DiscountPercentage()==t.DiscountPercentage()},u=!0;for(i in t)h(n.oldData,t[i])||(n.newData.Minimum>=(typeof t[i].Minimum=="function"?t[i].Minimum():t[i].Minimum)&&n.newData.Minimum<=(typeof t[i].Maximum=="function"?t[i].Maximum():t[i].Maximum)&&(r("Minimum '"+n.newData.Minimum+"' is already in range"),u=!1),n.newData.Maximum>=(typeof t[i].Minimum=="function"?t[i].Minimum():t[i].Minimum)&&n.newData.Maximum<=(typeof t[i].Maximum=="function"?t[i].Maximum():t[i].Maximum)&&(r("Maximum '"+n.newData.Maximum+"' is already in range"),u=!1),(typeof t[i].Minimum=="function"?t[i].Minimum():t[i].Minimum)>n.newData.Minimum&&(typeof t[i].Minimum=="function"?t[i].Minimum():t[i].Minimum)<n.newData.Maximum&&(typeof t[i].Maximum=="function"?t[i].Maximum():t[i].Maximum)>n.newData.Minimum&&(typeof t[i].Maximum=="function"?t[i].Maximum():t[i].Maximum)<n.newData.Maximum&&(r("The new data range shouldn't be contain the existing data range"),u=!1));var o=n.component._controllers.editing._editRowIndex,c=n.component._controllers.data._items[o].cells[0].value,l=n.component._controllers.data._items[o].cells[1].value;c>l&&(r("Minimum value must be less than Maximum"),u=!1);n.isValid=u},columns:[{dataField:"ID",visible:!1},{dataField:"Minimum",caption:"Minimum",width:"120px",dataType:"number",validationRules:[{type:"required"}],editorOptions:{onKeyDown:DXUtility.preventInputCharacters}},{dataField:"Maximum",caption:"Maximum",width:"120px",dataType:"number",validationRules:[{type:"required"}],editorOptions:{onKeyDown:DXUtility.preventInputCharacters}},{dataField:"DiscountPercentage",caption:"Percentage (%)",width:"150px",dataType:"number",validationRules:[{type:"required"},{type:"range",min:.01,message:"Percentage must be greater than 0."}]}]}));t.append(DXUtility.createFormItemGroupWithCaption("").append(n))},r.events.performNewRow=function(){h(null)},i.events.performOK=function(){nt()},i.formOptions.items=[{itemType:"group",caption:"Discount Strata",colCount:6,colSpan:3,items:[{dataField:"Code",validationRules:[{type:"required"}],label:{text:"Code"},colSpan:2,editorOptions:{maxLength:10,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Name",validationRules:[{type:"required"}],label:{text:"Name"},colSpan:3,editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"ValidDateFrom",label:{text:"Valid Date From"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();t.getEditor("ValidDateTo").option("min",n.value)},max:undefined}},{dataField:"ValidDateTo",label:{text:"To"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();t.getEditor("ValidDateFrom").option("max",n.value)},max:undefined}},{itemType:"empty",colSpan:2},{dataField:"StatusID",label:{text:"Status"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vSystemLookups.dataByFilter(["Group","=","DiscountStrataStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2}]}],{isReady:c.promise(),dataSource:f,refreshList:y,viewShowing:b,viewDisposing:k,openCreateViewAsRoot:w,icon:"Images/discount_strata_32px.png",dataSource_vDiscountStrataDetails:p,collapsibleFilter:u,commonGridView:r,commonPopupEdit:i,discountStrataDetailsDataGrid:e}};Dismoyo_Ciptoning_Client.vPermissionObjects=function(n,t){"use strict";function d(){l=!0}function g(){h=CommonUtility.configureCommonGridViewLayout("vPermissionObjects");h||setTimeout(g,50)}function ut(){g();k()?l&&nt():(k(e),e.load().always(function(){b.resolve()}))}function ft(){Dismoyo_Ciptoning_Client.DB.vPermissionObjects.off("modified",d)}function nt(){l=!1;e.pageIndex(0);e.load()}function it(n,t){var i="dx-icon dx-icon-icons8-role",r="Group";t.data.IsUser()&&(i="dx-icon dx-icon-icons8-user",r="User");n.append($('<span class="'+i+'" title="'+r+'" style="width: 16px; height: 16px; background-size: contain;">&nbsp;<\/span>'))}var l=!1,rt=t.layoutController.name==="split",b=$.Deferred(),k=ko.observable(),e,o,a,h,v,tt,c,f,u,i,p;e=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vPermissionObjects,select:["ID","Description","CreatedDate","CreatedByUserName","ChildUserRolePermissions.PermissionObjectID","ChildUserRolePermissions.UserRoleID","ChildUserRolePermissions.IsUser"],expand:"ChildUserRolePermissions",map:function(n){return new Dismoyo_Ciptoning_Client.vPermissionObjectViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vPermissionObjects.on("modified",d);v=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vUserRolePermissions,select:["PermissionObjectID","UserRoleID","IsUser","UserRoleName","IsUserHeadOffice","UserTerritory","UserRegion","UserArea","UserCompany","UserSite"],map:function(n){return new Dismoyo_Ciptoning_Client.vUserRolePermissionViewModel(n)}});tt=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vUserRoleAlls,select:["UserRoleID","IsUser","UserRoleName","IsUserHeadOffice","UserTerritory","UserRegion","UserArea","UserCompany","UserSite"],map:function(n){return new Dismoyo_Ciptoning_Client.vUserRoleAllViewModel(n)}});f=new Dismoyo_Ciptoning_Client.CollapsibleFilter;f.filterOptions.onInitialized=function(){f.filter().element().resize(function(){h&&h.resizeAll()})};f.formOptions.items=[{name:"PermissionObject",dataField:"",label:{text:"Permission"},editorOptions:{placeholder:"Name/Description",onEnterKey:function(){f.events.performSearch()}}},{dataField:"",label:{text:"",visible:!1},editorOptions:{visible:!1}}];f.events.performSearch=function(){var t=u.dataGrid(),e=f.form(),i=[],r,n;t.clearFilter();r=e.getEditor("PermissionObject").option("value");n=[];DXUtility.addFilterExpression(n,"ID","contains",r,"or");DXUtility.addFilterExpression(n,"Description","contains",r,"or");DXUtility.addGroupFilterExpression(i,n,"and");i.length>0?t.filter(i):t.refresh()};u=new Dismoyo_Ciptoning_Client.CommonGridView;u.dataGridOptions.dataSource=e;u.dataGridOptions.editing.editEnabled=!1;u.dataGridOptions.editing.removeEnabled=!1;u.newRowOptions.visible=!1;u.deleteRowsOptions.visible=!1;u.dataGridOptions.columns=[{dataField:"ID",caption:"Permission Name",width:"180px",headerCellTemplate:function(n,t){var r=$("#vPermissionObjects_commonGridView").find(".dx-datagrid:first-child"),i,u;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+="<\/tr>",u=r.find(".dx-header-row:first-child"),$(i).insertBefore(u[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"Description",caption:"Description",width:"250px"},{dataField:"UserRoleCount",caption:"Groups/Users",width:"100px",allowEditing:!1,alignment:"center",calculateCellValue:function(n){return n.ChildUserRolePermissions?n.ChildUserRolePermissions().length:0},cellTemplate:function(n,t){n.append($("<a>").addClass("dx-link").text(t.value).on("dxclick",function(){ot.performShowUsers(t)}))}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1}];var r=new Dismoyo_Ciptoning_Client.CommonPopupEdit,y=function(){return DXUtility.getDXInstance(null,"#vPermissionObjects_userRolePermissionsPopupEdit_dataGrid","dxDataGrid")},st=function(){return DXUtility.getDXInstance(null,"#vPermissionObjects_userRolePermissionsPopupEdit_new","dxButton")},et=function(){return DXUtility.getDXInstance(null,"#vPermissionObjects_userRolePermissionsPopupEdit_delete","dxButton")};r.popupEditOptions.title="Permission Groups/Users";r.okOptions.visible=!1;r.cancelOptions.text="Close";r.cancelOptions.onClick=function(){w.performCancel()};r.popupEditOptions.onHiding=function(){o&&(u.dataGrid().refresh(),o=!1)};r.popupEditOptions.onContentReady=function(){var t=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append($('<div id="vPermissionObjects_userRolePermissionsPopupEdit_new" style="margin: 7px 4px 7px 0;">').dxButton({text:"New",icon:"add",onClick:function(){w.performNewRow()}}));n.append($('<div id="vPermissionObjects_userRolePermissionsPopupEdit_delete" style="margin: 7px 0 7px 0;">').dxButton({text:"Delete",icon:"remove",disabled:!0,onClick:function(){w.performDeleteRows()}}));n.append($('<div id="vPermissionObjects_userRolePermissionsPopupEdit_dataGrid">').dxDataGrid({dataSource:[],showBorders:!0,allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,paging:{},pager:{showPageSizeSelector:!0,allowedPageSizes:[5,10,20],showInfo:!0,showNavigationButtons:!0},selection:{mode:"multiple"},editing:{editMode:"row",allowUpdating:!1,allowDeleting:!0,editEnabled:!1,removeEnabled:!0},onSelectionChanged:function(n){et().option("disabled",n.selectedRowsData.length<=0)},onRowRemoved:function(){o=!0},columns:[{dataField:"PermissionObjectID",visible:!1},{dataField:"UserRoleID",visible:!1},{dataField:"IsUser",caption:"Type",width:"60px",cellTemplate:it},{dataField:"UserRoleName",caption:"Name",width:"300px"},{dataField:"IsUserHeadOffice",caption:"Head Office",width:"100px",dataType:"boolean"},{dataField:"UserTerritory",caption:"Territory",width:"200px"},{dataField:"UserRegion",caption:"Region",width:"200px"},{dataField:"UserArea",caption:"Area",width:"200px"},{dataField:"UserCompany",caption:"Company",width:"200px"},{dataField:"UserSite",caption:"Site",width:"200px"}]}));t.append(n)};r.formOptions.items=[{itemType:"group",colCount:5,colSpan:3,items:[{dataField:"PermissionObjectID",label:{text:"Permission Name"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:Dismoyo_Ciptoning_Client.DB.vPermissionObjects,displayExpr:"ID",valueExpr:"ID",readOnly:!0}},{dataField:"PermissionObjectDescription",label:{text:"Description"},colSpan:3,editorOptions:{readOnly:!0}}]}];i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.popupEdit=function(){return DXUtility.getDXInstance(null,"#vPermissionObjects_newUserRolePopupEdit","dxPopup")};i.popupContent=function(){return DXUtility.getDXInstance(null,"#vPermissionObjects_newUserRolePopupEdit_popupContent","dxScrollView")};i.form=function(){return DXUtility.getDXInstance(null,"#vPermissionObjects_newUserRolePopupEdit_form","dxForm")};i.extContent=function(){return $("#vPermissionObjects_newUserRolePopupEdit_extContent")};i.ok=function(){return DXUtility.getDXInstance(null,"#vPermissionObjects_newUserRolePopupEdit_ok","dxButton")};i.cancel=function(){return DXUtility.getDXInstance(null,"#vPermissionObjects_newUserRolePopupEdit_cancel","dxButton")};p=function(){return DXUtility.getDXInstance(null,"#vPermissionObjects_newUserRolePopupEdit_dataGrid","dxDataGrid")};i.popupEditOptions.title="New Permission Groups/Users";i.popupEditOptions.fullScreen=!1;i.popupEditOptions.width=1200;i.popupEditOptions.height=600;i.okOptions.disabled=!0;i.okOptions.text="Save";i.okOptions.onClick=function(){s.performSave()};i.cancelOptions.onClick=function(){s.performCancel()};i.popupEditOptions.onHiding=function(){a&&(y().refresh(),a=!1,o=!0)};i.popupEditOptions.onContentReady=function(){var t=$("#vPermissionObjects_newUserRolePopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop(""));n.append($('<div id="vPermissionObjects_newUserRolePopupEdit_dataGrid">').dxDataGrid({dataSource:[],showBorders:!0,allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,paging:{},pager:{showPageSizeSelector:!0,allowedPageSizes:[5,10,20],showInfo:!0,showNavigationButtons:!0},selection:{mode:"multiple"},onSelectionChanged:function(n){i.ok().option("disabled",n.selectedRowsData.length<=0)},columns:[{dataField:"UserRoleID",visible:!1},{dataField:"IsUser",caption:"Type",width:"60px",cellTemplate:it},{dataField:"UserRoleName",caption:"Name",width:"300px"},{dataField:"IsUserHeadOffice",caption:"Head Office",width:"100px",dataType:"boolean"},{dataField:"UserTerritory",caption:"Territory",width:"200px"},{dataField:"UserRegion",caption:"Region",width:"200px"},{dataField:"UserArea",caption:"Area",width:"200px"},{dataField:"UserCompany",caption:"Company",width:"200px"},{dataField:"UserSite",caption:"Site",width:"200px"}]}));t.append(n)};i.formOptions.items=[{dataField:"Search",label:{visible:!1},colSpan:3,editorOptions:{placeholder:"Group/User Name/Territory/Region/Area/Company/Site",mode:"search",onEnterKey:function(){s.performSearch()}}}];var ot={performShowUsers:function(n){var i,u,f,t;r.popupEditData(n.data);r.popupEditOptions.visible(!0);r.popupContent().scrollTo(0);i=r.popupEditData();u=r.form();c=i.ID();u.getEditor("PermissionObjectID").option("value",c);u.getEditor("PermissionObjectDescription").option("value",i.Description());f=["PermissionObjectID","=",c];t=y();t.option("dataSource",[]);t.pageIndex(0);t.refresh().done(function(){t.option("dataSource",v);t.filter(f)})}},w={performNewRow:function(){i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);i.form().getEditor("Search").option("value",null);s.performSearch()},performDeleteRows:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(n){n&&(DXUtility.deleteSelectedRows(y(),u),o=!0)})},performCancel:function(){r.popupEditOptions.visible(!1)}},s={performSave:function(){for(var n,i=p().getSelectedRowsData(),t=0;t<i.length;t++)n=new Dismoyo_Ciptoning_Client.vUserRolePermissionViewModel,n.PermissionObjectID(c),n.UserRoleID(DXUtility.getValue(i[t],"UserRoleID")),n.IsUser(DXUtility.getValue(i[t],"IsUser")),v.store().insert(n.toJS()).done(function(){o=!0;a=!0;s.performCancel()})},performCancel:function(){i.popupEditOptions.visible(!1)},performSearch:function(){var u=i.form(),n=u.getEditor("Search").option("value"),r,t;n==undefined&&(n=null);r=null;n!=null&&(r=[["UserRoleName","contains",n],"or",["UserTerritory","contains",n],"or",["UserRegion","contains",n],"or",["UserArea","contains",n],"or",["UserCompany","contains",n],"or",["UserSite","contains",n]]);t=p();t.option("dataSource",[]);t.pageIndex(0);t.refresh().done(function(){t.option("dataSource",tt);t.filter(r)})}};return{isReady:b.promise(),dataSource:e,refreshList:nt,viewShowing:ut,viewDisposing:ft,openCreateViewAsRoot:rt,icon:"Images/permission_32px.png",collapsibleFilter:f,commonGridView:u,commonPopupEdit:r,newUserRolePopupEdit:i}};Dismoyo_Ciptoning_Client.vProducts=function(n,t){"use strict";function c(){o=!0}function l(){e=CommonUtility.configureCommonGridViewLayout("vProducts");e||setTimeout(l,50)}function y(){l();h()?o&&a():(h(f),f.load().always(function(){s.resolve()}))}function p(){Dismoyo_Ciptoning_Client.DB.vProducts.off("modified",c)}function a(){o=!1;f.pageIndex(0);f.load()}function r(n){var t=Dismoyo_Ciptoning_Client.LocalStore.vSystemParameters.dataByFilter(["ID","=",n]);return t.length>0?t[0].Value():null}var o=!1,v=t.layoutController.name==="split",s=$.Deferred(),h=ko.observable(),f,e,u,i;f=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vProducts,map:function(n){return new Dismoyo_Ciptoning_Client.vProductViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vProducts.on("modified",c);return u=new Dismoyo_Ciptoning_Client.CollapsibleFilter,u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){e&&e.resizeAll()})},u.formOptions.items=[{dataField:"BrandID",label:{text:"Brand"},editorType:"dxSelectBox",editorOptions:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vProductBrands.dataSource(),displayExpr:"Brand",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch()}}},{name:"Product",dataField:"",label:{text:"Product"},editorOptions:{placeholder:"Code/Name",onEnterKey:function(){u.events.performSearch()}}}],u.events.performSearch=function(){var n,t,r;i.dataGrid().clearFilter();n=[];t=u.form().getEditor("BrandID").option("value");DXUtility.addFilterExpression(n,"BrandID","=",t,"and");t=u.form().getEditor("Product").option("value");r=[];DXUtility.addFilterExpression(r,"Code","contains",t,"or");DXUtility.addFilterExpression(r,"Name","contains",t,"or");DXUtility.addGroupFilterExpression(n,r,"and");n.length>0?i.dataGrid().filter(n):i.dataGrid().refresh()},i=new Dismoyo_Ciptoning_Client.CommonGridView,i.dataGridOptions.dataSource=f,i.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Products.AddNewProduct"),i.dataGridOptions.editing.editEnabled=i.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Products.EditProduct"),i.dataGridOptions.editing.removeEnabled=i.dataGridOptions.editing.allowDeleting=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Products.DeleteProduct"),i.events.rowChanged=function(){Dismoyo_Ciptoning_Client.LocalStore.vProducts.loadWithSort("Product")},i.dataGridOptions.onEditorPreparing=function(n){n.parentType=="dataRow"&&n.dataField=="Code"&&(n.row.inserted||(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Code())),n.cancel=!0))},i.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"BrandID",caption:"Brand",width:"200px",validationRules:[{type:"required"}],lookup:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vProductBrands.dataSource().store(),displayExpr:"Brand",valueExpr:"ID",allowClearing:!0,sortOrder:"asc"},editorOptions:{itemTemplate:function(n){typeof n.Brand=="function"&&(n=n.toJS());return"<p title='"+n.Brand+"'>"+n.Brand+"<\/p>"}}},{dataField:"Code",width:"70px",editorOptions:{maxLength:10},validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$("#vProducts_commonGridView").find(".dx-datagrid:first-child"),i,r,f,e,o;!u.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r=Dismoyo_Ciptoning_Client.app.CurrentUser,i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Product<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="3">UOM<\/td>',i+='       <td class="dx-datagrid-action" colspan="3">Conversion<\/td>',i+='       <td class="dx-datagrid-action" colspan="3">Dimension<\/td>',i+='       <td class="dx-datagrid-action" colspan="10">Additional Info<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',f=r.isAuthorized("Products.EditProduct"),e=r.isAuthorized("Products.DeleteProduct"),(f||e)&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",o=u.find(".dx-header-row:first-child"),$(i).insertBefore(o[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"Name",width:"180px",editorOptions:{maxLength:50},validationRules:[{type:"required"}]},{dataField:"ShortName",caption:"Short Name",width:"100px",editorOptions:{maxLength:30},validationRules:[{type:"required"}]},{dataField:"Weight",format:"fixedPoint",precision:2,caption:"Weight (g)",width:"100px",defaultValue:0,validationRules:[{type:"required"}]},{dataField:"UOMLID",caption:"Large",width:"100px",lookup:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vSystemLookups.dataByFilter(["Group","=","ProductUOM"]),displayExpr:"Name",valueExpr:"Value_Int32",allowClearing:!0},editorOptions:{itemTemplate:function(n){typeof n.Name=="function"&&(n=n.toJS());return"<p title='"+n.Name+"'>"+n.Name+"<\/p>"}}},{dataField:"UOMMID",caption:"Medium",width:"100px",lookup:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vSystemLookups.dataByFilter(["Group","=","ProductUOM"]),displayExpr:"Name",valueExpr:"Value_Int32",allowClearing:!0},editorOptions:{itemTemplate:function(n){typeof n.Name=="function"&&(n=n.toJS());return"<p title='"+n.Name+"'>"+n.Name+"<\/p>"}}},{dataField:"UOMSID",caption:"Small",width:"100px",lookup:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vSystemLookups.dataByFilter(["Group","=","ProductUOM"]),displayExpr:"Name",valueExpr:"Value_Int32",allowClearing:!0},editorOptions:{itemTemplate:function(n){typeof n.Name=="function"&&(n=n.toJS());return"<p title='"+n.Name+"'>"+n.Name+"<\/p>"}}},{dataField:"ConversionL",caption:"Large",width:"70px",dataType:"number"},{dataField:"ConversionM",caption:"Medium",width:"70px",dataType:"number"},{dataField:"ConversionS",caption:"Small",width:"70px",dataType:"number"},{dataField:"DimensionL",caption:"Long",width:"70px",defaultValue:0,validationRules:[{type:"required"}]},{dataField:"DimensionW",caption:"Width",width:"70px",defaultValue:0,validationRules:[{type:"required"}]},{dataField:"DimensionH",caption:"Height",width:"70px",defaultValue:0,validationRules:[{type:"required"}]},{dataField:"AdditionalInfo1",caption:r("Product.AdditionalInfo1"),width:"100px",editorOptions:{maxLength:100}},{dataField:"AdditionalInfo2",caption:r("Product.AdditionalInfo2"),width:"100px",editorOptions:{maxLength:100}},{dataField:"AdditionalInfo3",caption:r("Product.AdditionalInfo3"),width:"100px",editorOptions:{maxLength:100}},{dataField:"AdditionalInfo4",caption:r("Product.AdditionalInfo4"),width:"100px",editorOptions:{maxLength:100}},{dataField:"AdditionalInfo5",caption:r("Product.AdditionalInfo5"),width:"100px",editorOptions:{maxLength:100}},{dataField:"AdditionalInfo6",caption:r("Product.AdditionalInfo6"),width:"100px",editorOptions:{maxLength:100}},{dataField:"AdditionalInfo7",caption:r("Product.AdditionalInfo7"),width:"100px",editorOptions:{maxLength:100}},{dataField:"AdditionalInfo8",caption:r("Product.AdditionalInfo8"),width:"100px",editorOptions:{maxLength:100}},{dataField:"AdditionalInfo9",caption:r("Product.AdditionalInfo9"),width:"100px",editorOptions:{maxLength:100}},{dataField:"AdditionalInfo10",caption:r("Product.AdditionalInfo10"),width:"100px",editorOptions:{maxLength:100}},{dataField:"StatusID",caption:"Status",width:"100px",defaultValue:1,validationRules:[{type:"required"}],lookup:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vSystemLookups.dataByFilter(["Group","=","ProductStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",allowClearing:!0},editorOptions:{itemTemplate:function(n){typeof n.Name=="function"&&(n=n.toJS());return"<p title='"+n.Name+"'>"+n.Name+"<\/p>"}}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],{isReady:s.promise(),dataSource:f,refreshList:a,viewShowing:y,viewDisposing:p,openCreateViewAsRoot:v,icon:"Images/product_32px.png",dataSource_vSystemLookup:Dismoyo_Ciptoning_Client.LocalStore.vSystemLookups.dataByFilter(["Group","=","ProductStatus"]),dataSource_vProductBrand:Dismoyo_Ciptoning_Client.LocalStore.vProductBrands.data,collapsibleFilter:u,commonGridView:i}};Dismoyo_Ciptoning_Client.vProductBrands=function(n,t){"use strict";function h(){e=!0}function c(){f=CommonUtility.configureCommonGridViewLayout("vProductBrands");f||setTimeout(c,50)}function v(){c();s()?e&&l():(s(u),u.load().always(function(){o.resolve()}))}function y(){Dismoyo_Ciptoning_Client.DB.vProductBrands.off("modified",h)}function l(){e=!1;u.pageIndex(0);u.load()}var e=!1,a=t.layoutController.name==="split",o=$.Deferred(),s=ko.observable(),u,f,r,i;u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vProductBrands,map:function(n){return new Dismoyo_Ciptoning_Client.vProductBrandViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vProductBrands.on("modified",h);return r=new Dismoyo_Ciptoning_Client.CollapsibleFilter,r.filterOptions.onInitialized=function(){r.filter().element().resize(function(){f&&f.resizeAll()})},r.formOptions.items=[{name:"Brand",dataField:"",label:{text:"Brand"},editorOptions:{placeholder:"Code/Name",onEnterKey:function(){r.events.performSearch()}}},{dataField:"",label:{text:"",visible:!1},editorOptions:{visible:!1}}],r.events.performSearch=function(){var n,u,t;i.dataGrid().clearFilter();n=[];u=r.form().getEditor("Brand").option("value");t=[];DXUtility.addFilterExpression(t,"Code","contains",u,"or");DXUtility.addFilterExpression(t,"Name","contains",u,"or");DXUtility.addGroupFilterExpression(n,t,"and");n.length>0?i.dataGrid().filter(n):i.dataGrid().refresh()},i=new Dismoyo_Ciptoning_Client.CommonGridView,i.dataGridOptions.dataSource=u,i.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("ProductBrands.AddNewProductBrand"),i.dataGridOptions.editing.editEnabled=i.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("ProductBrands.EditProductBrand"),i.dataGridOptions.editing.removeEnabled=i.dataGridOptions.editing.allowDeleting=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("ProductBrands.DeleteProductBrand"),i.events.rowChanged=function(){Dismoyo_Ciptoning_Client.LocalStore.vProductBrands.loadWithSort("Brand")},i.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Code",caption:"Code",width:"70px",validationRules:[{type:"required"}],sortOrder:"asc",editorOptions:{maxLength:10},headerCellTemplate:function(n,t){var u=$("#vProductBrands_commonGridView").find(".dx-datagrid:first-child"),i,r,f,e,o;!u.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r=Dismoyo_Ciptoning_Client.app.CurrentUser,i+='       <td class="dx-datagrid-action" colspan="2">Brand<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',f=r.isAuthorized("ProductBrands.EditProductBrand"),e=r.isAuthorized("ProductBrands.DeleteProductBrand"),(f||e)&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",o=u.find(".dx-header-row:first-child"),$(i).insertBefore(o[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"Name",width:"180px",editorOptions:{maxLength:50},validationRules:[{type:"required"}]},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],{isReady:o.promise(),dataSource:u,refreshList:l,viewShowing:v,viewDisposing:y,openCreateViewAsRoot:a,icon:"Images/product_brand_32px.png",collapsibleFilter:r,commonGridView:i}};Dismoyo_Ciptoning_Client.vProductPrices=function(n,t){"use strict";function h(){e=!0}function c(){f=CommonUtility.configureCommonGridViewLayout("vProductPrices");f||setTimeout(c,50)}function y(){c();s()?e&&l():(s(u),u.load().always(function(){o.resolve()}))}function p(){Dismoyo_Ciptoning_Client.DB.vProductPrices.off("modified",h)}function l(){e=!1;u.pageIndex(0);u.load()}var e=!1,v=t.layoutController.name==="split",o=$.Deferred(),s=ko.observable(),u,f,a,r,i;u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vProductPrices,map:function(n){return new Dismoyo_Ciptoning_Client.vProductPriceViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vProductPrices.on("modified",h);return a=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSystemLookups,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSystemLookupViewModel(n)}}),r=new Dismoyo_Ciptoning_Client.CollapsibleFilter,r.filterOptions.onInitialized=function(){r.filter().element().resize(function(){f&&f.resizeAll()})},r.formOptions.items=[{dataField:"ProductBrandID",label:{text:"Brand"},editorType:"dxSelectBox",editorOptions:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vProductBrands.dataSource(),displayExpr:"Brand",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){r.events.performSearch()},onValueChanged:function(n){var t=r.form().getEditor("ProductID"),i=t.option("selectedItem");i&&i.BrandID()!=n.value&&t.option("value",null);n.selectedItem?t.option("dataSource",Dismoyo_Ciptoning_Client.LocalStore.vProducts.dataByFilter(["BrandID","=",n.value])):r.form().getEditor("ProductID").option("dataSource",Dismoyo_Ciptoning_Client.LocalStore.vProducts.dataSource())}}},{dataField:"ProductID",label:{text:"Product"},editorType:"dxSelectBox",editorOptions:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vProducts.dataSource(),displayExpr:"Product",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){r.events.performSearch()},onValueChanged:function(n){n.selectedItem?r.form().getEditor("ProductBrandID").option("value",n.selectedItem.BrandID()):r.form().getEditor("ProductBrandID").option("value",null);n.component.option("value",n.value)}}},{name:"Code",dataField:"",label:{text:"Code"},editorOptions:{onEnterKey:function(){r.events.performSearch()}}}],r.events.performSearch=function(){i.dataGrid().clearFilter();var t=[],n;n=r.form().getEditor("ProductBrandID").option("value");DXUtility.addFilterExpression(t,"ProductBrandID","=",n,"and");n=r.form().getEditor("ProductID").option("value");DXUtility.addFilterExpression(t,"ProductID","=",n,"and");n=r.form().getEditor("Code").option("value");DXUtility.addFilterExpression(t,"Code","contains",n,"and");t.length>0?i.dataGrid().filter(t):i.dataGrid().refresh()},i=new Dismoyo_Ciptoning_Client.CommonGridView,i.dataGridOptions.dataSource=u,i.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("ProductPrices.AddNewProductPrice"),i.dataGridOptions.editing.editEnabled=i.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("ProductPrices.EditProductPrice"),i.dataGridOptions.editing.removeEnabled=i.dataGridOptions.editing.allowDeleting=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("ProductPrices.DeleteProductPrice"),i.dataGridOptions.onOptionChanged=function(n){var t=i.dataGrid(),r=n.component._controllers.data._editingController._editRowIndex;n.fullName=="columns[5].editorOptions.min"&&t.cellValue(r,"ValidDateFrom",n.value)},i.events.editingStart=function(n){n.component.columnOption("ValidDateTo","editorOptions",{min:n.data.ValidDateFrom()})},i.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"ProductBrand",caption:"Brand",width:"200px",allowEditing:!1},{dataField:"ProductID",caption:"Product",width:"200px",onlyAllowAdd:!0,validationRules:[{type:"required"}],lookup:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vProducts.dataSource().store(),displayExpr:"Product",valueExpr:"ID",sortOrder:"asc"},editorOptions:{onValueChanged:function(n){var t=i.dataGrid()._controllers.data._editingController._editRowIndex;i.dataGrid().cellValue(t,"ProductBrand",n.itemData.Brand);i.dataGrid().cellValue(t,"ProductID",n.value)},itemTemplate:function(n){return"<p title='"+n.Product+"'>"+n.Product+"<\/p>"}}},{dataField:"Code",width:"120px",onlyAllowAdd:!0,validationRules:[{type:"required"}],editorOptions:{maxLength:20},headerCellTemplate:function(n,t){var u=$("#vProductPrices_commonGridView").find(".dx-datagrid:first-child"),i,r,f,e,o;!u.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r=Dismoyo_Ciptoning_Client.app.CurrentUser,i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Validity Period<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',f=r.isAuthorized("ProductPrices.EditProductPrice"),e=r.isAuthorized("ProductPrices.DeleteProductPrice"),(f||e)&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",o=u.find(".dx-header-row:first-child"),$(i).insertBefore(o[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"ValidDateFrom",caption:"From",width:"140px",dataType:"date",validationRules:[{type:"required"}],editorOptions:{onValueChanged:function(n){var t=i.dataGrid(),r=t._controllers.data._editingController._editRowIndex,u=t.cellValue(r,"ValidDateTo");n.value>u&&t.cellValue(r,"ValidDateTo",null);n.value!=null?t.option("columns[5].editorOptions.min",n.value):t.option("columns[5].editorOptions.min",undefined)}}},{dataField:"ValidDateTo",caption:"To",width:"140px",dataType:"date",validationRules:[{type:"required"}],editorOptions:{min:undefined}},{dataField:"PriceGroupID",caption:"Group",width:"120px",validationRules:[{type:"required"}],lookup:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vSystemLookups.dataByFilter(["Group","=","ProductPriceGroup"]),displayExpr:"Name",valueExpr:"Value_Int32"},editorOptions:{itemTemplate:function(n){typeof n.Name=="function"&&(n=n.toJS());return"<p title='"+n.Name+"'>"+n.Name+"<\/p>"}}},{dataField:"GrossPrice",caption:"Gross Price (Rp)",width:"100px",dataType:"number",format:"fixedPoint",precision:2,validationRules:[{type:"required"},{type:"numeric"}],editorOptions:{onValueChanged:function(n){var t=i.dataGrid(),r=t._controllers.data._editingController._editRowIndex,u=t.cellValue(r,"TaxPercentage"),f=n.value+n.value*u/100;t.cellValue(r,"Price",f.toFixed(2));t.cellValue(r,"GrossPrice",n.value)}}},{dataField:"TaxPercentage",caption:"Tax (%)",width:"70px",dataType:"number",format:"fixedPoint",precision:2,validationRules:[{type:"required"},{type:"numeric"}],editorOptions:{onValueChanged:function(){},readOnly:!0},defaultValue:10},{dataField:"Price",caption:"Price (Rp)",width:"100px",dataType:"number",format:"fixedPoint",precision:2,validationRules:[{type:"required"},{type:"numeric"}],editorOptions:{onValueChanged:function(n){var t=i.dataGrid(),r=t._controllers.data._editingController._editRowIndex,u=t.cellValue(r,"TaxPercentage"),f=n.value/((u+100)/100);t.cellValue(r,"GrossPrice",f.toFixed(2));t.cellValue(r,"Price",n.value)}}},{dataField:"StatusID",caption:"Status",width:"80px",validationRules:[{type:"required"}],defaultValue:1,lookup:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vSystemLookups.dataByFilter(["Group","=","ProductPriceStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",allowClearing:!0},editorOptions:{itemTemplate:function(n){typeof n.Name=="function"&&(n=n.toJS());return"<p title='"+n.Name+"'>"+n.Name+"<\/p>"}}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],{isReady:o.promise(),dataSource:u,refreshList:l,viewShowing:y,viewDisposing:p,openCreateViewAsRoot:v,icon:"Images/product_price_32px.png",dataSource_vSystemLookup:a,dataSource_vProductBrand:Dismoyo_Ciptoning_Client.LocalStore.vProductBrands.data,dataSource_vProduct:Dismoyo_Ciptoning_Client.LocalStore.vProducts.data,collapsibleFilter:r,commonGridView:i}};Dismoyo_Ciptoning_Client.vRegions=function(n,t){"use strict";function h(){e=!0}function c(){f=CommonUtility.configureCommonGridViewLayout("vRegions");f||setTimeout(c,50)}function v(){c();s()?e&&l():(s(u),u.load().always(function(){o.resolve()}))}function y(){Dismoyo_Ciptoning_Client.DB.vRegions.off("modified",h)}function l(){e=!1;u.pageIndex(0);u.load()}var e=!1,a=t.layoutController.name==="split",o=$.Deferred(),s=ko.observable(),u,f,r,i;u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vRegions,map:function(n){return new Dismoyo_Ciptoning_Client.vRegionViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vRegions.on("modified",h);return r=new Dismoyo_Ciptoning_Client.CollapsibleFilter,r.filterOptions.onInitialized=function(){r.filter().element().resize(function(){f&&f.resizeAll()})},r.formOptions.items=[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(),displayExpr:"Territory",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){r.events.performSearch()}}},{name:"Region",dataField:"",label:{text:"Region"},editorOptions:{placeholder:"Code/Name",onEnterKey:function(){r.events.performSearch()}}}],r.events.performSearch=function(){var f=i.dataGrid(),e=r.form(),t=[],n,u;f.clearFilter();n=e.getEditor("TerritoryID").option("value");DXUtility.addFilterExpression(t,"TerritoryID","=",n,"and");n=e.getEditor("Region").option("value");u=[];DXUtility.addFilterExpression(u,"Code","contains",n,"or");DXUtility.addFilterExpression(u,"Name","contains",n,"or");DXUtility.addGroupFilterExpression(t,u,"and");t.length>0?f.filter(t):f.refresh()},i=new Dismoyo_Ciptoning_Client.CommonGridView,i.dataGridOptions.dataSource=u,i.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Regions.AddNewRegion"),i.dataGridOptions.editing.editEnabled=i.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Regions.EditRegion"),i.dataGridOptions.editing.removeEnabled=i.dataGridOptions.editing.allowDeleting=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Regions.DeleteRegion"),i.dataGridOptions.onEditorPreparing=function(n){n.parentType=="dataRow"&&n.dataField=="Code"&&(n.row.inserted||(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Code())),n.cancel=!0))},i.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"TerritoryID",caption:"Territory",width:"200px",validationRules:[{type:"required"}],lookup:{dataSource:DataUtility.vTerritories.dataSource(null),displayExpr:"Territory",valueExpr:"ID",allowClearing:!0}},{dataField:"Code",width:"70px",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$("#vRegions_commonGridView").find(".dx-datagrid:first-child"),r,f;!u.find(".datagrid-bandedHeader:first").length>0&&(r='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Region<\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',(i.dataGridOptions.editing.allowUpdating||i.dataGridOptions.editing.allowDeleting)&&(r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),r+="<\/tr>",f=u.find(".dx-header-row:first-child"),$(r).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},editorOptions:{maxLength:10}},{dataField:"Name",width:"180px",validationRules:[{type:"required"}],editorOptions:{maxLength:50}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],{isReady:o.promise(),dataSource:u,refreshList:l,viewShowing:v,viewDisposing:y,openCreateViewAsRoot:a,icon:"Images/region_32px.png",collapsibleFilter:r,commonGridView:i}};Dismoyo_Ciptoning_Client.vRoles=function(n,t){"use strict";function k(){l=!0}function d(){h=CommonUtility.configureCommonGridViewLayout("vRoles");h||setTimeout(d,50)}function it(){d();b()?l&&g():(b(u),u.load().always(function(){w.resolve()}))}function rt(){Dismoyo_Ciptoning_Client.DB.vRoles.off("modified",k)}function g(){l=!1;u.pageIndex(0);u.load()}var l=!1,tt=t.layoutController.name==="split",w=$.Deferred(),b=ko.observable(),u,o,a,h,e,i,y;u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vRoles,select:["ID","Name","Description","CreatedDate","CreatedByUserName","ModifiedDate","ModifiedByUserName","ChildUserRoles.RoleID","ChildUserRoles.UserID"],expand:"ChildUserRoles",map:function(n){return new Dismoyo_Ciptoning_Client.vRoleViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vRoles.on("modified",k);var nt=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vUserRoles,select:["RoleID","UserID","UserName","IsUserHeadOffice","UserTerritory","UserRegion","UserArea","UserCompany","UserSite"],map:function(n){return new Dismoyo_Ciptoning_Client.vUserRoleViewModel(n)}}),ut=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vUsers,select:["ID","Name","IsHeadOffice","Territory","Region","Area","Company","Site"],map:function(n){return new Dismoyo_Ciptoning_Client.vUserViewModel(n)}}),c,f=new Dismoyo_Ciptoning_Client.CollapsibleFilter;f.filterOptions.onInitialized=function(){f.filter().element().resize(function(){h&&h.resizeAll()})};f.formOptions.items=[{name:"Role",dataField:"",label:{text:"Group"},editorOptions:{placeholder:"Name/Description",onEnterKey:function(){f.events.performSearch()}}},{dataField:"",label:{text:"",visible:!1},editorOptions:{visible:!1}}];f.events.performSearch=function(){var t=e.dataGrid(),u=f.form(),i=[],r,n;t.clearFilter();r=u.getEditor("Role").option("value");n=[];DXUtility.addFilterExpression(n,"Name","contains",r,"or");DXUtility.addFilterExpression(n,"Description","contains",r,"or");DXUtility.addGroupFilterExpression(i,n,"and");i.length>0?t.filter(i):t.refresh()};e=new Dismoyo_Ciptoning_Client.CommonGridView;e.dataGridOptions.dataSource=u;e.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Name",caption:"Group Name",width:"180px",validationRules:[{type:"required"}],editorOptions:{maxLength:256},headerCellTemplate:function(n,t){var r=$("#vRoles_commonGridView").find(".dx-datagrid:first-child"),i,u;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+="<\/tr>",u=r.find(".dx-header-row:first-child"),$(i).insertBefore(u[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"Description",caption:"Description",width:"250px",editorOptions:{maxLength:512}},{dataField:"UserCount",caption:"Users",width:"60px",allowEditing:!1,alignment:"center",calculateCellValue:function(n){return n.ChildUserRoles?n.ChildUserRoles().length:0},cellTemplate:function(n,t){t.row.inserted||n.append($("<a>").addClass("dx-link").text(t.value).on("dxclick",function(){et.performShowUsers(t)}))}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}];var r=new Dismoyo_Ciptoning_Client.CommonPopupEdit,v=function(){return DXUtility.getDXInstance(null,"#vRoles_userRolesPopupEdit_dataGrid","dxDataGrid")},ot=function(){return DXUtility.getDXInstance(null,"#vRoles_userRolesPopupEdit_new","dxButton")},ft=function(){return DXUtility.getDXInstance(null,"#vRoles_userRolesPopupEdit_delete","dxButton")};r.popupEditOptions.title="Group Users";r.okOptions.visible=!1;r.cancelOptions.text="Close";r.cancelOptions.onClick=function(){p.performCancel()};r.popupEditOptions.onHiding=function(){o&&(e.dataGrid().refresh(),o=!1)};r.popupEditOptions.onContentReady=function(){var t=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append($('<div id="vRoles_userRolesPopupEdit_new" style="margin: 7px 4px 7px 0;">').dxButton({text:"New",icon:"add",onClick:function(){p.performNewRow()}}));n.append($('<div id="vRoles_userRolesPopupEdit_delete" style="margin: 7px 0 7px 0;">').dxButton({text:"Delete",icon:"remove",disabled:!0,onClick:function(){p.performDeleteRows()}}));n.append($('<div id="vRoles_userRolesPopupEdit_dataGrid">').dxDataGrid({dataSource:[],showBorders:!0,allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,paging:{},pager:{showPageSizeSelector:!0,allowedPageSizes:[5,10,20],showInfo:!0,showNavigationButtons:!0},selection:{mode:"multiple"},editing:{editMode:"row",allowUpdating:!1,allowDeleting:!0,editEnabled:!1,removeEnabled:!0},onSelectionChanged:function(n){ft().option("disabled",n.selectedRowsData.length<=0)},onRowRemoved:function(){o=!0},columns:[{dataField:"RoleID",visible:!1},{dataField:"UserID",visible:!1},{dataField:"UserName",caption:"User Name",width:"300px"},{dataField:"IsUserHeadOffice",caption:"Head Office",width:"100px",dataType:"boolean"},{dataField:"UserTerritory",caption:"Territory",width:"200px"},{dataField:"UserRegion",caption:"Region",width:"200px"},{dataField:"UserArea",caption:"Area",width:"200px"},{dataField:"UserCompany",caption:"Company",width:"200px"},{dataField:"UserSite",caption:"Site",width:"200px"}]}));t.append(n)};r.formOptions.items=[{itemType:"group",colCount:5,colSpan:3,items:[{dataField:"RoleID",label:{text:"Group Name"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:Dismoyo_Ciptoning_Client.DB.vRoles,displayExpr:"Name",valueExpr:"ID",readOnly:!0}},{dataField:"RoleDescription",label:{text:"Description"},colSpan:3,editorOptions:{readOnly:!0}}]}];i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.popupEdit=function(){return DXUtility.getDXInstance(null,"#vRoles_newUserPopupEdit","dxPopup")};i.popupContent=function(){return DXUtility.getDXInstance(null,"#vRoles_newUserPopupEdit_popupContent","dxScrollView")};i.form=function(){return DXUtility.getDXInstance(null,"#vRoles_newUserPopupEdit_form","dxForm")};i.extContent=function(){return $("#vRoles_newUserPopupEdit_extContent")};i.ok=function(){return DXUtility.getDXInstance(null,"#vRoles_newUserPopupEdit_ok","dxButton")};i.cancel=function(){return DXUtility.getDXInstance(null,"#vRoles_newUserPopupEdit_cancel","dxButton")};y=function(){return DXUtility.getDXInstance(null,"#vRoles_newUserPopupEdit_dataGrid","dxDataGrid")};i.popupEditOptions.title="New Group Users";i.popupEditOptions.fullScreen=!1;i.popupEditOptions.width=1200;i.popupEditOptions.height=600;i.okOptions.disabled=!0;i.okOptions.text="Save";i.okOptions.onClick=function(){s.performSave()};i.cancelOptions.onClick=function(){s.performCancel()};i.popupEditOptions.onHiding=function(){a&&(v().refresh(),a=!1,o=!0)};i.popupEditOptions.onContentReady=function(){var t=$("#vRoles_newUserPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop(""));n.append($('<div id="vRoles_newUserPopupEdit_dataGrid">').dxDataGrid({dataSource:[],showBorders:!0,allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,paging:{},pager:{showPageSizeSelector:!0,allowedPageSizes:[5,10,20],showInfo:!0,showNavigationButtons:!0},selection:{mode:"multiple"},onSelectionChanged:function(n){i.ok().option("disabled",n.selectedRowsData.length<=0)},columns:[{dataField:"ID",visible:!1},{dataField:"Name",caption:"User Name",width:"300px"},{dataField:"IsHeadOffice",caption:"Head Office",width:"100px",dataType:"boolean"},{dataField:"Territory",caption:"Territory",width:"200px"},{dataField:"Region",caption:"Region",width:"200px"},{dataField:"Area",caption:"Area",width:"200px"},{dataField:"Company",caption:"Company",width:"200px"},{dataField:"Site",caption:"Site",width:"200px"}]}));t.append(n)};i.formOptions.items=[{dataField:"Search",label:{visible:!1},colSpan:3,editorOptions:{placeholder:"User Name/Territory/Region/Area/Company/Site",mode:"search",onEnterKey:function(){s.performSearch()}}}];var et={performShowUsers:function(n){var i,u,f,t;r.popupEditData(n.data);r.popupEditOptions.visible(!0);r.popupContent().scrollTo(0);i=r.popupEditData();u=r.form();c=i.ID();u.getEditor("RoleID").option("value",c);u.getEditor("RoleDescription").option("value",i.Description());f=["RoleID","=",c];t=v();t.option("dataSource",[]);t.pageIndex(0);t.refresh().done(function(){t.option("dataSource",nt);t.filter(f)})}},p={performNewRow:function(){i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);i.form().getEditor("Search").option("value",null);s.performSearch()},performDeleteRows:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(n){n&&(DXUtility.deleteSelectedRows(v(),e),o=!0)})},performCancel:function(){r.popupEditOptions.visible(!1)}},s={performSave:function(){for(var n,i=y().getSelectedRowsData(),t=0;t<i.length;t++)n=new Dismoyo_Ciptoning_Client.vUserRoleViewModel,n.RoleID(c),n.UserID(DXUtility.getValue(i[t],"ID")),nt.store().insert(n.toJS()).done(function(){o=!0;a=!0;s.performCancel()})},performCancel:function(){i.popupEditOptions.visible(!1)},performSearch:function(){var u=i.form(),n=u.getEditor("Search").option("value"),r,t;n==undefined&&(n=null);r=null;n!=null&&(r=[["Name","contains",n],"or",["Territory","contains",n],"or",["Region","contains",n],"or",["Area","contains",n],"or",["Company","contains",n],"or",["Site","contains",n]]);t=y();t.option("dataSource",[]);t.pageIndex(0);t.refresh().done(function(){t.option("dataSource",ut);t.filter(r)})}};return{isReady:w.promise(),dataSource:u,refreshList:g,viewShowing:it,viewDisposing:rt,openCreateViewAsRoot:tt,icon:"Images/role_32px.png",collapsibleFilter:f,commonGridView:e,commonPopupEdit:r,newUserPopupEdit:i}};Dismoyo_Ciptoning_Client.vRoutePlans=function(n,t){"use strict";function ot(){nt=!0}function st(){w=CommonUtility.configureCommonGridViewLayout("vRoutePlans");w||setTimeout(st,50)}function pt(){var n,t;st();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],o.filter(t));et()?nt&&ht():(et(o),o.load().always(function(){ft.resolve()}))}function wt(){Dismoyo_Ciptoning_Client.DB.vRoutePlans.off("modified",ot)}function ht(){nt=!1;o.pageIndex(0);o.load()}function at(n,t,i){var r,u;t||(t=null);r=DataUtility.GetLookupSalesmanDataSource(["SiteID","=",t]);n.getEditor("OldSalesmanID").option("value",null);n.getEditor("OldSalesmanID").option("dataSource",[]);r.load().done(function(){n.getEditor("OldSalesmanID").option("dataSource",r)});u=DataUtility.GetLookupSiteDataSource(["CompanyID","=",i]);n.getEditor("NewSiteID").option("value",null);n.getEditor("NewSiteID").option("dataSource",[]);u.load().done(function(){n.getEditor("NewSiteID").option("dataSource",u)})}function vt(n,t,i){t||(t=null);i||(i=null);var r=DataUtility.GetLookupSalesmanDataSource([["ID","<>",t],"and",["SiteID","=",i]]);n.getEditor("NewSalesmanID").option("value",null);n.getEditor("NewSalesmanID").option("dataSource",[]);r.load().done(function(){n.getEditor("NewSalesmanID").option("dataSource",r)})}var nt=!1,yt=t.layoutController.name==="split",ft=$.Deferred(),et=ko.observable(),o,v,tt,w,bt,l,b,k,lt,f,u,y,it,d,r,p,i,g;o=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vRoutePlanSalesmen,select:["SalesmanID","Salesman","Territory","Region","Area","Company","SiteID","Site","OddWeek1","OddWeek2","OddWeek3","OddWeek4","OddWeek5","OddWeek6","OddWeek7","EvenWeek1","EvenWeek2","EvenWeek3","EvenWeek4","EvenWeek5","EvenWeek6","EvenWeek7"],map:function(n){return new Dismoyo_Ciptoning_Client.vRoutePlanSalesmanViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vRoutePlans.on("modified",ot);var c=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vRoutePlans,select:["SalesmanID","CustomerID","WeekID","DayID","Salesman","Customer","CustomerAddress","SortIndex"],sort:"SortIndex",map:function(n){return new Dismoyo_Ciptoning_Client.vRoutePlanViewModel(n)}}),ct=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vRoutePlanCustomers,select:["CustomerID","SalesmanID","Customer","CustomerAddress","Salesman","Territory","Region","Area","Company","Site","OddWeek1","OddWeek2","OddWeek3","OddWeek4","OddWeek5","OddWeek6","OddWeek7","EvenWeek1","EvenWeek2","EvenWeek3","EvenWeek4","EvenWeek5","EvenWeek6","EvenWeek7","SortIndex"],sort:"SortIndex",map:function(n){return new Dismoyo_Ciptoning_Client.vRoutePlanCustomerViewModel(n)}}),h=[];for(h[1]="Su",h[2]="Mo",h[3]="Tu",h[4]="We",h[5]="Th",h[6]="Fr",h[7]="Sa",bt=DateTimeUtility.getFirstTimeOfDay(new Date),f=new Dismoyo_Ciptoning_Client.CollapsibleFilter,f.filterOptions.onInitialized=function(){f.filter().element().resize(function(){w&&w.resizeAll()})},f.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){f.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(f.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){f.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(f.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){f.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(f.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){f.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){f.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(f.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Salesman"])}}}]},{itemType:"group",caption:"Route Plan",colCount:3,colSpan:3,items:[{dataField:"SalesmanID",label:{text:"Salesman"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSalesmanDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Salesman",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){f.events.performSearch(this)}}},{dataField:"CustomerID",label:{text:"Customer"},editorType:"dxSelectBox",editorOptions:{dataSource:new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["ID","Customer","SiteID"],map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)},filter:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]}),displayExpr:"Customer",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){f.events.performSearch(this)}}}]}],f.events.performSearch=function(){var e=u.dataGrid(),t=f.form(),n=[],r;e.clearFilter();var i=Dismoyo_Ciptoning_Client.app.CurrentUser,o=i.TerritoryID(),s=i.RegionID(),h=i.AreaID(),c=i.CompanyID(),l=i.SiteID();t.itemOption("Organization").visible&&(o=t.getEditor("TerritoryID").option("value"),s=t.getEditor("RegionID").option("value"),h=t.getEditor("AreaID").option("value"),c=t.getEditor("CompanyID").option("value"),l=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",o,"and");DXUtility.addFilterExpression(n,"RegionID","=",s,"and");DXUtility.addFilterExpression(n,"AreaID","=",h,"and");DXUtility.addFilterExpression(n,"CompanyID","=",c,"and");DXUtility.addFilterExpression(n,"SiteID","=",l,"and");r=t.getEditor("SalesmanID").option("value");DXUtility.addFilterExpression(n,"SalesmanID","=",r,"and");r=t.getEditor("CustomerID").option("value");DXUtility.addFilterExpression(n,"CustomerID","=",r,"and");n.length>0?e.filter(n):e.refresh()},u=new Dismoyo_Ciptoning_Client.CommonGridView,u.dataGridOptions.dataSource=o,u.dataGridOptions.editing.editEnabled=!1,u.dataGridOptions.editing.removeEnabled=!1,u.dataGridOptions.onSelectionChanged=function(n){u.deleteRows().option("disabled",n.selectedRowsData.length<=0)},u.newRowOptions.text="Move Customers",u.newRowOptions.icon=null,u.dataGridOptions.columns=[{dataField:"SalesmanID",visible:!1},{dataField:"Salesman",caption:"Salesman",headerCellTemplate:function(n,t){var r=$("#vRoutePlans_commonGridView").find(".dx-datagrid:first-child"),i,u;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="7">Odd Week<\/td>',i+='       <td class="dx-datagrid-action" colspan="7">Even Week<\/td>',i+="<\/tr>",u=r.find(".dx-header-row:first-child"),$(i).insertBefore(u[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}}],y=1;y<=14;y++)it=y<=7?1:2,d=(y-1)%7+1,u.dataGridOptions.columns.push({dataField:(it==1?"Odd":"Even")+"Week"+d.toString(),caption:h[d],weekID:it,dayID:d,width:"36px",alignment:"center",cellTemplate:function(n,t){new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSystemParameters,filter:["ID","=","RoutePlan.CurrentWeek"],map:function(n){return new Dismoyo_Ciptoning_Client.vSystemParameterViewModel(n)}}).load().done(function(i){var r;if(i.length>0){var u=parseInt(i[0].Value()),f=t.value?t.value:"0",e=DateTimeUtility.getFirstTimeOfDay(new Date);u==t.column.weekID&&(r=e.getDay()+1,r==t.column.dayID&&n.css("background","#92D08C"));n.append($("<a>").addClass("dx-link").text(f).on("dxclick",function(){dt.performShowCustomerCalls(t)}))}}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load current week data."),"Load Failed")})}});var e=new Dismoyo_Ciptoning_Client.CommonPopupEdit,rt=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_customerCallsPopupEdit_dataGrid","dxDataGrid")},gt=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_customerCallsPopupEdit_new","dxButton")},kt=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_customerCallsPopupEdit_delete","dxButton")};e.popupEditOptions.title="Customer Calls";e.okOptions.visible=!1;e.cancelOptions.text="Close";e.cancelOptions.onClick=function(){ut.performCancel()};e.popupEditOptions.onContentReady=function(){var t=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append($('<div id="vRoutePlans_customerCallsPopupEdit_new" style="margin: 7px 4px 7px 0;">').dxButton({text:"New",icon:"add",onClick:function(){ut.performNewRow()}}));n.append($('<div id="vRoutePlans_customerCallsPopupEdit_delete" style="margin: 7px 0 7px 0;">').dxButton({text:"Delete",icon:"remove",disabled:!0,onClick:function(){ut.performDeleteRows()}}));n.append($('<div id="vRoutePlans_customerCallsPopupEdit_dataGrid">').dxDataGrid({dataSource:[],showBorders:!0,allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,paging:{},pager:{showPageSizeSelector:!0,allowedPageSizes:[5,10,20],showInfo:!0,showNavigationButtons:!0},selection:{mode:"multiple"},editing:{editMode:"row",allowUpdating:!1,allowDeleting:!0,editEnabled:!1,removeEnabled:!0},onSelectionChanged:function(n){kt().option("disabled",n.selectedRowsData.length<=0)},onRowPrepared:function(n){n.rowType=="data"&&n.data.SortIndex()==1&&n.rowElement.css("background","#FFD966")},onRowRemoved:function(){v=!0},columns:[{dataField:"CustomerID",visible:!1},{dataField:"Customer",caption:"Customer",width:"300px"},{dataField:"CustomerAddress",caption:"Address"},{dataField:"SortIndex",visible:!1,sortIndex:0}]}));t.append(n)};e.formOptions.items=[{itemType:"group",colCount:5,colSpan:3,items:[{dataField:"SalesmanID",label:{text:"Salesman"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSalesmanDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Salesman",valueExpr:"ID",readOnly:!0}},{dataField:"WeekID",label:{text:"Week"},colSpan:1,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","Week"]),displayExpr:"Name",valueExpr:"Value_Int32",readOnly:!0}},{dataField:"DayID",label:{text:"Day"},colSpan:1,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","Day"]),displayExpr:"Name",valueExpr:"Value_Int32",readOnly:!0}}]}];r=new Dismoyo_Ciptoning_Client.CommonPopupEdit;r.popupEdit=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_newCustomerCallPopupEdit","dxPopup")};r.popupContent=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_newCustomerCallPopupEdit_popupContent","dxScrollView")};r.form=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_newCustomerCallPopupEdit_form","dxForm")};r.extContent=function(){return $("#vRoutePlans_newCustomerCallPopupEdit_extContent")};r.ok=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_newCustomerCallPopupEdit_ok","dxButton")};r.cancel=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_newCustomerCallPopupEdit_cancel","dxButton")};p=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_newCustomerCallPopupEdit_dataGrid","dxDataGrid")};r.popupEditOptions.title="New Customer Calls";r.popupEditOptions.fullScreen=!1;r.popupEditOptions.width=1200;r.popupEditOptions.height=600;r.okOptions.disabled=!0;r.okOptions.text="Save";r.okOptions.onClick=function(){a.performSave()};r.cancelOptions.onClick=function(){a.performCancel()};r.popupEditOptions.onContentReady=function(){var e=$("#vRoutePlans_newCustomerCallPopupEdit_extContent"),t=DXUtility.createFormItemGroupContent(),i,n,f,u;for(t.append(DXUtility.createFormItemLabelTop("")),i=[{dataField:"CustomerID",visible:!1},{dataField:"Customer",caption:"Customer",width:"300px",headerCellTemplate:function(n,t){var r=$(p().element()),i,u;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader" style="border-top-style: none !important;">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="7">Odd Week<\/td>',i+='       <td class="dx-datagrid-action" colspan="7">Even Week<\/td>',i+="<\/tr>",u=r.find(".dx-header-row:first-child"),$(i).insertBefore(u[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"CustomerAddress",caption:"Address"},{dataField:"SortIndex",visible:!1,sortIndex:0}],n=1;n<=14;n++)f=n<=7?1:2,u=(n-1)%7+1,i.push({dataField:(f==1?"Odd":"Even")+"Week"+u.toString(),caption:h[u],width:"36px",alignment:"center",customizeText:function(n){return n.value?"X":""}});t.append($('<div id="vRoutePlans_newCustomerCallPopupEdit_dataGrid">').dxDataGrid({dataSource:[],showBorders:!0,allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,paging:{},pager:{showPageSizeSelector:!0,allowedPageSizes:[5,10,20],showInfo:!0,showNavigationButtons:!0},selection:{mode:"multiple"},editing:{editMode:"row",allowUpdating:!1,allowDeleting:!1,editEnabled:!1,removeEnabled:!1},onSelectionChanged:function(n){r.ok().option("disabled",n.selectedRowsData.length<=0)},onRowPrepared:function(n){n.rowType=="data"&&n.data.SortIndex()==1&&n.rowElement.css("background","#FFD966")},columns:i}));e.append(t)};r.formOptions.items=[{name:"Search",dataField:"",label:{visible:!1},colSpan:2,editorOptions:{placeholder:"Customer/Address",mode:"search",onEnterKey:function(){a.performSearch()}}},{name:"CustomerRouteStatus",dataField:"",label:{text:"Route Status"},editorType:"dxSelectBox",colSpan:1,editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","CustomerRouteStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){a.performSearch()}}}];i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.popupEdit=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_moveCustomersPopupEdit","dxPopup")};i.popupContent=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_moveCustomersPopupEdit_popupContent","dxScrollView")};i.form=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_moveCustomersPopupEdit_form","dxForm")};i.extContent=function(){return $("#vRoutePlans_moveCustomersPopupEdit_extContent")};i.ok=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_moveCustomersPopupEdit_ok","dxButton")};i.cancel=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_moveCustomersPopupEdit_cancel","dxButton")};g=function(){return DXUtility.getDXInstance(null,"#vRoutePlans_moveCustomersPopupEdit_dataGrid","dxDataGrid")};i.popupEditOptions.title="Move Customers";i.okOptions.text="Move";i.okOptions.onClick=function(){s.performMove()};i.cancelOptions.onClick=function(){s.performCancel()};i.popupEditOptions.onContentReady=function(){var t=$("#vRoutePlans_moveCustomersPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop(""));n.append($('<div id="vRoutePlans_moveCustomersPopupEdit_dataGrid">').dxDataGrid({dataSource:[],showBorders:!0,allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,paging:{},pager:{showPageSizeSelector:!0,allowedPageSizes:[5,10,20],showInfo:!0,showNavigationButtons:!0},selection:{mode:"multiple"},onSelectionChanged:function(n){i.ok().option("disabled",n.currentSelectedRowKeys.length<=0)},columns:[{dataField:"ID",visible:!1},{dataField:"Customer",caption:"Customer",width:"300px"},{dataField:"Address",caption:"Address"}]}));t.append(n)};i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){s.performMove()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){s.performMove()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){s.performMove()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){s.performMove()}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){s.performMove()},onValueChanged:function(n){var t=i.form(),r,u;CommonUtility.cascadeValueChanged(t,n.selectedItem,n.value,"Site",["Area","Region","Territory"],[]);r=null;u=null;n.selectedItem&&(r=n.selectedItem.Company(),u=n.selectedItem.CompanyID());t.getEditor("Company").option("value",r);at(t,n.value,u)}}}]},{itemType:"group",caption:"Move Customer",colCount:6,colSpan:3,items:[{dataField:"OldSalesmanID",label:{text:"Old Salesman"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Salesman",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){s.performMove()},onValueChanged:function(n){var r=i.form(),u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["ID","Customer","Address"],filter:["SalesmanID","=",n.value?n.value:null],map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)}}),t=g();t.beginCustomLoading();t.option("dataSource",[]);u.load().done(function(){t.endCustomLoading();t.option("dataSource",u)}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download customers data."),"Download Customers Failed");t.endCustomLoading()});vt(r,n.value,r.getEditor("NewSiteID").option("value"))}}},{itemType:"empty",colSpan:3},{dataField:"NewSiteID",label:{text:"New Site"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Site",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){s.performMove()},onValueChanged:function(n){var t=i.form();vt(t,t.getEditor("OldSalesmanID").option("value"),n.value)}}},{dataField:"NewSalesmanID",label:{text:"New Salesman"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Salesman",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){s.performMove()}}}]}];u.events.performNewRow=function(){var r,t,n;i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);r=g();r.option("dataSource",[]);r.clearSorting();t=Dismoyo_Ciptoning_Client.app.CurrentUser;n=i.form();DXUtility.resetFormValidation(n);var t=Dismoyo_Ciptoning_Client.app.CurrentUser,e=t.TerritoryID(),o=t.RegionID(),s=t.AreaID(),u=t.CompanyID(),f=t.SiteID();n.itemOption("Organization").visible&&(n.getEditor("TerritoryID").option("value",e),n.getEditor("RegionID").option("value",o),n.getEditor("AreaID").option("value",s),n.getEditor("CompanyID")&&n.getEditor("CompanyID").option("value",u),n.getEditor("SiteID").option("value",f));i.ok().option("disabled",!0);at(n,f,u)};u.events.performDeleteRows=function(n){var f,t,r;for(showLoadingPanel(),f=n.getSelectedRowKeys(),t=[],r=0;r<f.length;r++)r>0&&t.push("or"),t.push(["SalesmanID","=",f[r]]);t.length>0?(c.filter(t),c.load().then(function(n){n.length==0&&hideLoadingPanel();for(var t=0;t<n.length;t++)c.store().remove(n[t].ID()).done(function(){t>=n.length-1&&(hideLoadingPanel(),c.load().done(function(){u.dataGrid().refresh()}))}).fail(function(){t>=n.length-1&&(hideLoadingPanel(),c.load().done(function(){u.dataGrid().refresh()}))})})):(i.popupEditOptions.visible(!1),hideLoadingPanel())};var dt={performShowCustomerCalls:function(n){var r,i,u,t;e.popupEditData(n.data);e.popupEditOptions.visible(!0);e.popupContent().scrollTo(0);r=e.popupEditData();i=e.form();l=r.SalesmanID();b=n.column.weekID;k=n.column.dayID;lt=r.SiteID();i.getEditor("SalesmanID").option("value",l);i.getEditor("WeekID").option("value",b);i.getEditor("DayID").option("value",k);u=[["SalesmanID","=",l],"and",["WeekID","=",b],"and",["DayID","=",k],"and",["OrderBySalesmanID","=",l]];t=rt();t.option("dataSource",[]);t.clearSorting();c.sort("SortIndex");t.pageIndex(0);t.refresh().done(function(){t.option("dataSource",c);t.filter(u)})}},ut={performNewRow:function(){r.popupEditOptions.visible(!0);r.popupContent().scrollTo(0);var n=p();n.option("dataSource",[]);n.clearSorting();ct.sort("SortIndex");r.form().getEditor("Search").option("value",null);a.performSearch()},performDeleteRows:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(n){n&&(DXUtility.deleteSelectedRows(rt(),u),v=!0)})},performCancel:function(){e.popupEditOptions.visible(!1);v&&(u.dataGrid().refresh(),v=!1)}},a={performSave:function(){for(var n,i=p().getSelectedRowsData(),t=0;t<i.length;t++)n=new Dismoyo_Ciptoning_Client.vRoutePlanViewModel,n.SalesmanID(l),n.CustomerID(i[t].CustomerID()),n.WeekID(b),n.DayID(k),c.store().insert(n.toJS()).done(function(){v=!0;tt=!0;a.performCancel()})},performCancel:function(){r.popupEditOptions.visible(!1);tt&&(rt().refresh(),tt=!1)},performSearch:function(){var f=r.form(),u=f.getEditor("Search").option("value"),t,i,n;if(u==undefined&&(u=null),t=[["SiteID","=",lt],"and",["OrderBySalesmanID","=",l],"and",["FilterByKeywords","=",u]],i=f.getEditor("CustomerRouteStatus").option("value"),i!=undefined&&i!=null){t.push("and");switch(i){case 1:t.push([["OddWeek1","=",1],"or",["OddWeek2","=",1],"or",["OddWeek3","=",1],"or",["OddWeek4","=",1],"or",["OddWeek5","=",1],"or",["OddWeek6","=",1],"or",["OddWeek7","=",1],"or",["EvenWeek1","=",1],"or",["EvenWeek2","=",1],"or",["EvenWeek3","=",1],"or",["EvenWeek4","=",1],"or",["EvenWeek5","=",1],"or",["EvenWeek6","=",1],"or",["EvenWeek7","=",1],"or"]);break;case 2:t.push([["OddWeek1","<>",1],"and",["OddWeek2","<>",1],"and",["OddWeek3","<>",1],"and",["OddWeek4","<>",1],"and",["OddWeek5","<>",1],"and",["OddWeek6","<>",1],"and",["OddWeek7","<>",1],"and",["EvenWeek1","<>",1],"and",["EvenWeek2","<>",1],"and",["EvenWeek3","<>",1],"and",["EvenWeek4","<>",1],"and",["EvenWeek5","<>",1],"and",["EvenWeek6","<>",1],"and",["EvenWeek7","<>",1],"and"])}}n=p();n.option("dataSource",[]);n.pageIndex(0);n.refresh().done(function(){n.option("dataSource",ct);n.filter(t)})}},s={performMove:function(){var n=i.form().validate().isValid,t=n?"":"Please specify the required fields.";n&&DevExpress.ui.dialog.confirm("Are you sure want to Move the selected customers?","Move Confirmation").done(function(n){var r,c;if(n){showLoadingPanel();var s=i.form(),t=g(),h=s.getEditor("NewSalesmanID").option("value"),f=t.option("dataSource"),e=t.getSelectedRowKeys();for(r=0;r<e.length;r++)c=f.store().byKey(e[r]).done(function(n){n.SalesmanID=h;var i=ko.toJS(n);f.store().insert(i).done(function(){r>=e.length-1&&(hideLoadingPanel(),f.load().done(function(){t.clearSelection();t.refresh()}),o.load().done(function(){u.dataGrid().refresh()}))}).fail(function(n){DevExpress.ui.dialog.alert(n.message,"Move Failed");r>=e.length-1&&(hideLoadingPanel(),f.load().done(function(){t.clearSelection();t.refresh()}),o.load().done(function(){u.dataGrid().refresh()}))})}).fail(function(n){DevExpress.ui.dialog.alert(n.message,"Move Failed");hideLoadingPanel()})}});t!=""&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(t),"Move Failed")},performCancel:function(){i.popupEditOptions.visible(!1)}};return{isReady:ft.promise(),dataSource:o,refreshList:ht,viewShowing:pt,viewDisposing:wt,openCreateViewAsRoot:yt,icon:"/Images/route_plan_32px.png",collapsibleFilter:f,commonGridView:u,commonPopupEdit:e,newCustomerCallPopupEdit:r,moveCustomersPopupEdit:i}};Dismoyo_Ciptoning_Client.vSalesByChannelReports=function(n,t){"use strict";function s(){if(f=CommonUtility.configureCommonIFrameLayout("vSalesByChannelReports"),f){var n=i.form();n.getEditor("ReportGroupBy").option("value",1);n.getEditor("ReportPeriod").option("value",2);n.getEditor("ReportDateFrom").option("value",DateTimeUtility.getFirstDayOfMonth(new Date))}else setTimeout(s,50)}function l(){s();o.resolve()}function a(n){var t=e.iframe();e.showLoadingPanel();t.attr("src",Dismoyo_Ciptoning_Client.ReportWebsite.SalesByChannelReport.url(n))}var h=!1,c=t.layoutController.name==="split",o=$.Deferred(),f,u=null,r=null,i=new Dismoyo_Ciptoning_Client.CollapsibleFilter,e;return i.filterOptions.onInitialized=function(){i.filter().element().resize(function(){f&&f.resizeAll()})},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area","Site"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],[])}}}]},{itemType:"group",caption:"Sales by Channel Report",colCount:3,colSpan:3,items:[{dataField:"ReportPeriod",label:{text:"Period"},editorType:"dxRadioGroup",editorOptions:{width:"100%",displayExpr:"Name",valueExpr:"ID",items:[{ID:1,Name:"Daily"},{ID:2,Name:"Monthly"}],layout:"horizontal",onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();CommonUtility.reportPeriodValueChanged(n,t,!0);u=null;r=null}}},{dataField:"ReportDateFrom",label:{text:"Report Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,min:new Date(2016,6,1),onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();u=n.value;t.itemOption("SalesByChannelReports.ReportDateTo").visible?(CommonUtility.reportDateFromValueChanged(n,t),r=t.getEditor("ReportDateTo").option("value")):r=n.value?new Date(n.value.getFullYear(),n.value.getMonth()+1,0):null;u instanceof Date&&(u=DateTimeUtility.getFirstTimeOfDay(u));r instanceof Date&&(r=DateTimeUtility.getLastTimeOfDay(r))}}},{dataField:"ReportDateTo",label:{text:"Report Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();CommonUtility.reportDateToValueChanged(n,t);u=t.getEditor("ReportDateFrom").option("value");r=n.value;u instanceof Date&&(u=DateTimeUtility.getFirstTimeOfDay(u));r instanceof Date&&(r=DateTimeUtility.getLastTimeOfDay(r))}}},{dataField:"ReportGroupBy",label:{text:"Group by"},editorType:"dxRadioGroup",editorOptions:{width:"100%",displayExpr:"Name",valueExpr:"ID",items:[{ID:1,Name:"Product"},{ID:2,Name:"Brand"}],layout:"horizontal",onEnterKey:function(){i.events.performSearch(this)}}}]}],i.events.performSearch=function(){var t=i.form(),o=t.getEditor("ReportDateFrom");if(o&&o.option("visible")){if(u==null||r==null){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Please specify Report Date/Month."),"Search Failed");return}if(u.getFullYear()!=r.getFullYear()||u.getMonth()!=r.getMonth()){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Report Date From and To must be in the same month."),"Search Failed");return}}var n=[],f,e=Dismoyo_Ciptoning_Client.app.CurrentUser,s=e.TerritoryID(),h=e.RegionID(),c=e.AreaID(),l=e.CompanyID(),v=e.SiteID();t.itemOption("Organization").visible&&(s=t.getEditor("TerritoryID").option("value"),h=t.getEditor("RegionID").option("value"),c=t.getEditor("AreaID").option("value"),l=t.getEditor("CompanyID").option("value"),v=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",s,"and");DXUtility.addFilterExpression(n,"RegionID","=",h,"and");DXUtility.addFilterExpression(n,"AreaID","=",c,"and");DXUtility.addFilterExpression(n,"CompanyID","=",l,"and");DXUtility.addFilterExpression(n,"SiteID","=",v,"and");f=t.getEditor("ReportGroupBy").option("value");DXUtility.addFilterExpression(n,"ReportGroupBy","=",f,"and");f=u;DXUtility.addFilterExpression(n,"ReportDateFrom",">=",f,"and");f=r;DXUtility.addFilterExpression(n,"ReportDateTo","<=",f,"and");a(n)},i.events.performClear=function(){var n=i.form();n.getEditor("ReportDateFrom").option("value",null);n.itemOption("SalesByChannelReports.ReportDateTo").visible&&n.getEditor("ReportDateTo").option("value",null);u=null;r=null},e=new Dismoyo_Ciptoning_Client.CommonIFrame,{isReady:o.promise(),viewShowing:l,openCreateViewAsRoot:c,icon:"Images/sales_by_channel_report_32px.png",collapsibleFilter:i,commonIFrame:e}};Dismoyo_Ciptoning_Client.vSalesByOrderReports=function(n,t){"use strict";function s(){if(f=CommonUtility.configureCommonIFrameLayout("vSalesByOrderReports"),f){var n=i.form();n.getEditor("ReportPeriod").option("value",1);n.getEditor("ReportDateFrom").option("value",DateTimeUtility.getFirstTimeOfDay(new Date));n.getEditor("ReportDateTo").option("value",DateTimeUtility.getFirstTimeOfDay(new Date))}else setTimeout(s,50)}function l(){s();o.resolve()}function a(n){var t=e.iframe();e.showLoadingPanel();t.attr("src",Dismoyo_Ciptoning_Client.ReportWebsite.SalesByOrderReport.url(n))}var h=!1,c=t.layoutController.name==="split",o=$.Deferred(),f,u=null,r=null,i=new Dismoyo_Ciptoning_Client.CollapsibleFilter,e;return i.filterOptions.onInitialized=function(){i.filter().element().resize(function(){f&&f.resizeAll()})},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area","Site"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],[])}}}]},{itemType:"group",caption:"Sales by Order Report",colCount:3,colSpan:3,items:[{dataField:"ReportPeriod",label:{text:"Period"},editorType:"dxRadioGroup",editorOptions:{width:"100%",displayExpr:"Name",valueExpr:"ID",items:[{ID:1,Name:"Daily"},{ID:2,Name:"Monthly"}],layout:"horizontal",onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();CommonUtility.reportPeriodValueChanged(n,t,!0);u=null;r=null}}},{dataField:"ReportDateFrom",label:{text:"Report Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,min:new Date(2016,6,1),onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();u=n.value;t.itemOption("SalesByOrderReports.ReportDateTo").visible?(CommonUtility.reportDateFromValueChanged(n,t),r=t.getEditor("ReportDateTo").option("value")):r=n.value?new Date(n.value.getFullYear(),n.value.getMonth()+1,0):null;u instanceof Date&&(u=DateTimeUtility.getFirstTimeOfDay(u));r instanceof Date&&(r=DateTimeUtility.getLastTimeOfDay(r))}}},{dataField:"ReportDateTo",label:{text:"Report Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();CommonUtility.reportDateToValueChanged(n,t);u=t.getEditor("ReportDateFrom").option("value");r=n.value;u instanceof Date&&(u=DateTimeUtility.getFirstTimeOfDay(u));r instanceof Date&&(r=DateTimeUtility.getLastTimeOfDay(r))}}}]}],i.events.performSearch=function(){var t=i.form(),o=t.getEditor("ReportDateFrom");if(o&&o.option("visible")){if(u==null||r==null){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Please specify Report Date/Month."),"Search Failed");return}if(u.getFullYear()!=r.getFullYear()||u.getMonth()!=r.getMonth()){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Report Date From and To must be in the same month."),"Search Failed");return}}var n=[],e,f=Dismoyo_Ciptoning_Client.app.CurrentUser,s=f.TerritoryID(),h=f.RegionID(),c=f.AreaID(),l=f.CompanyID(),v=f.SiteID();t.itemOption("Organization").visible&&(s=t.getEditor("TerritoryID").option("value"),h=t.getEditor("RegionID").option("value"),c=t.getEditor("AreaID").option("value"),l=t.getEditor("CompanyID").option("value"),v=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",s,"and");DXUtility.addFilterExpression(n,"RegionID","=",h,"and");DXUtility.addFilterExpression(n,"AreaID","=",c,"and");DXUtility.addFilterExpression(n,"CompanyID","=",l,"and");DXUtility.addFilterExpression(n,"SiteID","=",v,"and");e=u;DXUtility.addFilterExpression(n,"ReportDateFrom",">=",e,"and");e=r;DXUtility.addFilterExpression(n,"ReportDateTo","<=",e,"and");a(n)},i.events.performClear=function(){var n=i.form();n.getEditor("ReportDateFrom").option("value",null);n.itemOption("SalesByOrderReports.ReportDateTo").visible&&n.getEditor("ReportDateTo").option("value",null);u=null;r=null},e=new Dismoyo_Ciptoning_Client.CommonIFrame,{isReady:o.promise(),viewShowing:l,openCreateViewAsRoot:c,icon:"Images/sales_by_order_report_32px.png",collapsibleFilter:i,commonIFrame:e}};Dismoyo_Ciptoning_Client.vSalesBySiteReports=function(n,t){"use strict";function s(){if(f=CommonUtility.configureCommonIFrameLayout("vSalesBySiteReports"),f){var n=i.form();n.getEditor("ReportGroupBy").option("value",1);n.getEditor("ReportPeriod").option("value",2);n.getEditor("ReportDateFrom").option("value",DateTimeUtility.getFirstDayOfMonth(new Date))}else setTimeout(s,50)}function l(){s();o.resolve()}function a(n){var t=e.iframe();e.showLoadingPanel();t.attr("src",Dismoyo_Ciptoning_Client.ReportWebsite.SalesBySiteReport.url(n))}var h=!1,c=t.layoutController.name==="split",o=$.Deferred(),f,u=null,r=null,i=new Dismoyo_Ciptoning_Client.CollapsibleFilter,e;return i.filterOptions.onInitialized=function(){i.filter().element().resize(function(){f&&f.resizeAll()})},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area","Site"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],[])}}}]},{itemType:"group",caption:"Sales by Site Report",colCount:3,colSpan:3,items:[{dataField:"ReportPeriod",label:{text:"Period"},editorType:"dxRadioGroup",editorOptions:{width:"100%",displayExpr:"Name",valueExpr:"ID",items:[{ID:1,Name:"Daily"},{ID:2,Name:"Monthly"}],layout:"horizontal",onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();CommonUtility.reportPeriodValueChanged(n,t,!0);u=null;r=null}}},{dataField:"ReportDateFrom",label:{text:"Report Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,min:new Date(2016,6,1),onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();u=n.value;t.itemOption("SalesBySiteReports.ReportDateTo").visible?(CommonUtility.reportDateFromValueChanged(n,t),r=t.getEditor("ReportDateTo").option("value")):r=n.value?new Date(n.value.getFullYear(),n.value.getMonth()+1,0):null;u instanceof Date&&(u=DateTimeUtility.getFirstTimeOfDay(u));r instanceof Date&&(r=DateTimeUtility.getLastTimeOfDay(r))}}},{dataField:"ReportDateTo",label:{text:"Report Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){var t=i.form();CommonUtility.reportDateToValueChanged(n,t);u=t.getEditor("ReportDateFrom").option("value");r=n.value;u instanceof Date&&(u=DateTimeUtility.getFirstTimeOfDay(u));r instanceof Date&&(r=DateTimeUtility.getLastTimeOfDay(r))}}},{dataField:"ReportGroupBy",label:{text:"Group by"},editorType:"dxRadioGroup",editorOptions:{width:"100%",displayExpr:"Name",valueExpr:"ID",items:[{ID:1,Name:"Product"},{ID:2,Name:"Brand"}],layout:"horizontal",onEnterKey:function(){i.events.performSearch(this)}}}]}],i.events.performSearch=function(){var t=i.form(),o=t.getEditor("ReportDateFrom");if(o&&o.option("visible")){if(u==null||r==null){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Please specify Report Date/Month."),"Search Failed");return}if(u.getFullYear()!=r.getFullYear()||u.getMonth()!=r.getMonth()){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Report Date From and To must be in the same month."),"Search Failed");return}}var n=[],f,e=Dismoyo_Ciptoning_Client.app.CurrentUser,s=e.TerritoryID(),h=e.RegionID(),c=e.AreaID(),l=e.CompanyID(),v=e.SiteID();t.itemOption("Organization").visible&&(s=t.getEditor("TerritoryID").option("value"),h=t.getEditor("RegionID").option("value"),c=t.getEditor("AreaID").option("value"),l=t.getEditor("CompanyID").option("value"),v=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",s,"and");DXUtility.addFilterExpression(n,"RegionID","=",h,"and");DXUtility.addFilterExpression(n,"AreaID","=",c,"and");DXUtility.addFilterExpression(n,"CompanyID","=",l,"and");DXUtility.addFilterExpression(n,"SiteID","=",v,"and");f=t.getEditor("ReportGroupBy").option("value");DXUtility.addFilterExpression(n,"ReportGroupBy","=",f,"and");f=u;DXUtility.addFilterExpression(n,"ReportDateFrom",">=",f,"and");f=r;DXUtility.addFilterExpression(n,"ReportDateTo","<=",f,"and");a(n)},i.events.performClear=function(){var n=i.form();n.getEditor("ReportDateFrom").option("value",null);n.itemOption("SalesBySiteReports.ReportDateTo").visible&&n.getEditor("ReportDateTo").option("value",null);u=null;r=null},e=new Dismoyo_Ciptoning_Client.CommonIFrame,{isReady:o.promise(),viewShowing:l,openCreateViewAsRoot:c,icon:"Images/sales_by_site_report_32px.png",collapsibleFilter:i,commonIFrame:e}};Dismoyo_Ciptoning_Client.vSalesmen=function(n,t){"use strict";function y(){s=!0}function p(){o=CommonUtility.configureCommonGridViewLayout("vSalesmen");o||setTimeout(p,50)}function tt(){var n,t;p();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],f.filter(t));v()?s&&w():(v(f),f.load().always(function(){a.resolve()}))}function it(){Dismoyo_Ciptoning_Client.DB.vSalesmen.off("modified",y)}function w(){s=!1;f.pageIndex(0);f.load()}function h(n){var u=i.popupEditData();if(u.ID())return u.Code();var f=i.form(),t=null,r=null;return t=f.getEditor("CategoryID").option("selectedItem"),t&&(r=t.Value_String()),(n?n:"(Site Code)")+"-"+(r?r:"(Salesman Category Code)")+"(Auto Generated)"}function rt(n){for(var t,r,i,u=ko.toJS(n),f=0;f<u.length;f++)for(t=u[f],t.key=t.ID,t.text=t.Brand,t.items=t.ChildProducts,r=0;r<t.items.length;r++)i=t.items[r],i.key=t.ID+"_"+i.ID,i.text=i.Product;return u}function k(n){var r,t;if(n){var u=[],f=i.popupEditData();for(r=0;r<f.ChildProducts().length;r++)t=f.ChildProducts()[r],t.key=t.ProductBrandID()+"_"+t.ProductID(),u.push(t);new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSiteProducts,select:["ProductID","ProductBrand"],filter:["SiteID","=",n],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSiteProductViewModel(n)}}).load().done(function(n){new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vProductBrands,select:["ID","Brand","ChildProducts","ChildProducts.ID","ChildProducts.Product"],expand:["ChildProducts"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vProductBrandViewModel(n)}}).load().done(function(t){for(var r,f,o,s=n,e=[],i=0;i<t.length;i++){for(e=[],r=0;r<t[i].ChildProducts().length;r++)for(f=0;f<s.length;f++)t[i].ChildProducts()[r].ID()==s[f].ProductID()&&e.push(t[i].ChildProducts()[r]);t[i].ChildProducts(e);t[i].ChildProducts().length<1&&(t.splice(i,1),i--)}o=rt(t);DXUtility.setSelectedTreeViewItems(o,u);l().option("dataSource",o)})})}}function c(n,t){t||(t=null);var i=DataUtility.GetLookupWarehouseDataSource([["SiteID","=",t],["StatusID","=",1]]);n.getEditor("WarehouseID").option("value",null);n.getEditor("WarehouseID").option("dataSource",[]);i.load().done(function(){n.getEditor("WarehouseID").option("dataSource",i)})}function d(n,t){showLoadingPanel();Dismoyo_Ciptoning_Client.DB.vSalesmen.byKey(n,{expand:["ChildProducts"]}).done(function(n){hideLoadingPanel();e=t;g(new Dismoyo_Ciptoning_Client.vSalesmanViewModel(n))}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function g(n){var r=!1,u,t,f;n||(n=new Dismoyo_Ciptoning_Client.vSalesmanViewModel,n.StatusID(1),r=!0);i.popupEditData(n);i.popupEdit().option("title",(r?"New":"Edit")+" Salesman");i.popupEditOptions.editingKey=n.ID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);u=Dismoyo_Ciptoning_Client.app.CurrentUser;t=i.form();DXUtility.resetFormValidation(t);f=n.Code();r&&(n.StatusID(1),u.IsHeadOffice()||(n.TerritoryID(u.TerritoryID()),n.RegionID(u.RegionID()),n.AreaID(u.AreaID()),n.SiteID(u.SiteID()),n.SiteCode(u.SiteCode()),n.CompanyID(u.CompanyID()),n.Company(u.Company())),n.SFAFlag(!1),f=h(n.SiteCode()));t.itemOption("Organization").visible&&(t.getEditor("TerritoryID").option("value",n.TerritoryID()),t.getEditor("RegionID").option("value",n.RegionID()),t.getEditor("AreaID").option("value",n.AreaID()),t.getEditor("SiteID").option("value",n.SiteID()),t.getEditor("Company").option("value",n.Company()),t.getEditor("TerritoryID").option("readOnly",!r),t.getEditor("RegionID").option("readOnly",!r),t.getEditor("AreaID").option("readOnly",!r),t.getEditor("SiteID").option("readOnly",!r),t.getEditor("Company").option("readOnly",!r));k(n.SiteID());c(t,n.SiteID());t.getEditor("Name").option("value",n.Name());t.getEditor("Code").option("value",f);t.getEditor("WarehouseID").option("value",n.WarehouseID());t.getEditor("GroupID").option("value",n.GroupID());t.getEditor("CategoryID").option("value",n.CategoryID());t.getEditor("Phone").option("value",n.Phone());t.getEditor("SFAFlag").option("value",n.SFAFlag());t.getEditor("SFA").option("value",n.SFA());t.getEditor("SFA").option("readOnly",!n.SFAFlag());r&&(DXUtility.resetFormValidation(t),t.getEditor("Code").option("value",f));t.getEditor("StatusID").option("value",n.StatusID())}function ut(){var f,o,s,t,a;showLoadingPanel();var v=r.dataGrid(),y=v.option("dataSource"),u=i.popupEditData(),n=i.form(),h=n.validate().isValid,c=h?"":"Please specify the required fields.";if(h)for(n.itemOption("Organization").visible&&u.SiteID(n.getEditor("SiteID").option("value")),u.Code(n.getEditor("Code").option("value")),u.Name(n.getEditor("Name").option("value")),u.WarehouseID(n.getEditor("WarehouseID").option("value")),u.GroupID(n.getEditor("GroupID").option("value")),u.CategoryID(n.getEditor("CategoryID").option("value")),u.Phone(n.getEditor("Phone").option("value")),u.SFAFlag(n.getEditor("SFAFlag").option("value")),u.SFA(n.getEditor("SFA").option("value")),u.StatusID(n.getEditor("StatusID").option("value")),f=[],DXUtility.getSelectedTreeViewItems(l().option("items"),f),t=0;t<f.length;){if(o=f[t],!o.Product){f.splice(t,1);continue}t++}if(h){for(t=0;t<f.length;t++)o=f[t],f[t]=new Dismoyo_Ciptoning_Client.vSalesmanProductViewModel({SalesmanID:u.ID(),ProductID:o.ID});if(f.length<1){DevExpress.ui.dialog.alert("Product is required.","Error");hideLoadingPanel();return}if(n.getEditor("CategoryID").option("value")==1)for(s=n.getEditor("WarehouseID").option("dataSource").items(),t=0;t<s.length;t++)if(s[t].ID().toString()==n.getEditor("WarehouseID").option("value").toString()&&s[t].Warehouse().indexOf("[MAIN]")>=0){DevExpress.ui.dialog.alert("Salesman with Category Direct Sales (DSA) can only choose Warehouse with SALESMAN type","Error");hideLoadingPanel();return}u.ChildProducts(f);a=ko.toJS(u);y.store().insert(a).done(function(){e=!0;i.events.performCancel();hideLoadingPanel()}).fail(function(n){var t=$(".dx-popup-normal>.dx-dialog-content");t.length==0&&DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})}else hideLoadingPanel();c!=""&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(c),"Save Failed")}var s=!1,nt=t.layoutController.name==="split",a=$.Deferred(),v=ko.observable(),f,e,o,b,u,r,i,l;f=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesmen,select:["ID","Territory","Region","Area","Company","Site","Code","Name","Warehouse","GroupName","CategoryName","StatusName","CreatedDate","CreatedByUserName","ModifiedByUserName"],map:function(n){return new Dismoyo_Ciptoning_Client.vSalesmanViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vSalesmen.on("modified",y);return b=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesmanProducts,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesmanProductViewModel(n)}}),u=new Dismoyo_Ciptoning_Client.CollapsibleFilter,u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){o&&o.resizeAll()})},u.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch()}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Warehouse"])}}}]},{itemType:"group",caption:"Salesman",colCount:3,colSpan:3,items:[{dataField:"WarehouseID",label:{text:"Warehouse"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{name:"Salesman",dataField:"",label:{text:"Salesman"},editorOptions:{placeholder:"Code/Name",onEnterKey:function(){u.events.performSearch()}}},{dataField:"GroupID",label:{text:"Group"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","SalesmanGroup"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch()}}},{dataField:"CategoryID",label:{text:"Category"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","SalesmanCategory"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch()}}}]}],u.events.performSearch=function(){var o=r.dataGrid(),i=u.form(),t=[],n,e;o.clearFilter();var f=Dismoyo_Ciptoning_Client.app.CurrentUser,s=f.TerritoryID(),h=f.RegionID(),c=f.AreaID(),l=f.CompanyID(),a=f.SiteID();i.itemOption("Organization").visible&&(s=i.getEditor("TerritoryID").option("value"),h=i.getEditor("RegionID").option("value"),c=i.getEditor("AreaID").option("value"),l=i.getEditor("CompanyID").option("value"),a=i.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(t,"TerritoryID","=",s,"and");DXUtility.addFilterExpression(t,"RegionID","=",h,"and");DXUtility.addFilterExpression(t,"AreaID","=",c,"and");DXUtility.addFilterExpression(t,"CompanyID","=",l,"and");DXUtility.addFilterExpression(t,"SiteID","=",a,"and");n=i.getEditor("WarehouseID").option("value");DXUtility.addFilterExpression(t,"WarehouseID","=",n,"and");n=i.getEditor("GroupID").option("value");DXUtility.addFilterExpression(t,"GroupID","=",n?parseInt(n):n,"and");n=i.getEditor("CategoryID").option("value");DXUtility.addFilterExpression(t,"CategoryID","=",n?parseInt(n):n,"and");n=i.getEditor("Salesman").option("value");e=[];DXUtility.addFilterExpression(e,"Code","contains",n,"or");DXUtility.addFilterExpression(e,"Name","contains",n,"or");DXUtility.addGroupFilterExpression(t,e,"and");t.length>0?o.filter(t):o.refresh()},r=new Dismoyo_Ciptoning_Client.CommonGridView,r.dataGridOptions.dataSource=f,r.dataGridOptions.editing.editEnabled=!1,r.dataGridOptions.editing.removeEnabled=!1,r.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Salesman.AddNewSalesman"),r.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Salesman.EditSalesman"),r.dataGridOptions.editing.allowDeleting=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Salesman.DeleteSalesman"),r.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Territory",caption:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Region",caption:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Area",caption:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Company",caption:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Site",caption:"Site",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Code",Caption:"Code",width:"120px",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$("#vSalesmen_commonGridView").find(".dx-datagrid:first-child"),i,f,e;!u.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines data-grid-banded-header-border-top">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',f=Dismoyo_Ciptoning_Client.app.CurrentUser,f.IsHeadOffice()&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" colspan="2">Salesman<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',(r.dataGridOptions.editing.allowUpdating||r.dataGridOptions.editing.allowDeleting)&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",e=u.find(".dx-header-row:first-child"),$(i).insertBefore(e[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: left;">'),u=$("<b>").text(t.data.Code());r.dataGridOptions.editing.allowUpdating&&(u=$('<a class="dx-link">').text(t.data.Code()).on("dxclick",function(){d(t.data.ID(),!1)}));i.append(u);i.append("&nbsp;");n.append(i)}},{dataField:"Name",width:"180px"},{dataField:"Warehouse",caption:"Warehouse",width:"200px"},{dataField:"GroupName",caption:"Group",width:"150px"},{dataField:"CategoryName",caption:"Category",width:"150px"},{dataField:"StatusName",caption:"Status",width:"100px"},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],(r.dataGridOptions.editing.allowUpdating||r.dataGridOptions.editing.allowDeleting)&&r.dataGridOptions.columns.push({width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');r.dataGridOptions.editing.allowUpdating&&(i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){d(t.data.ID(),!1)})),i.append("&nbsp;"));r.dataGridOptions.editing.allowDeleting&&(i.append($('<a class="dx-link">').text("Delete").on("dxclick",function(){var n=r.dataGrid(),i=n.option("dataSource"),u=t.data.toJS(),f=u.ID;i.store().remove(f).done(function(){n.refresh()})})),i.append("&nbsp;"));n.append(i)}}),i=new Dismoyo_Ciptoning_Client.CommonPopupEdit,i.popupEditOptions.title="Salesman",i.okOptions.text="Save",i.okOptions.icon="icons8-save",l=function(){return DXUtility.getDXInstance(null,"#vSalesmen_salesmanProductTreeView","dxTreeView")},i.popupEditOptions.onContentReady=function(){var r=$("#commonPopupEdit_extContent"),t=$("<div>"),i=$('<table width="100%">'),n=$("<tr>");n.append($('<td width="50%" style="vertical-align: top;">').append(DXUtility.createFormItemGroupWithCaption("Products").css("padding","0px 12px 0px 0px").append(DXUtility.createFormItemGroupContent().css("padding","16px 12px 0px 0px")).append($('<div id="vSalesmen_salesmanProductTreeView">').dxTreeView({dataSource:[],dataStructure:"tree",keyExpr:"key",displayExpr:"text",rootValue:null,showCheckBoxesMode:"normal"}))));n.append($('<td width="50%" style="vertical-align: top;">'));i.append(n);t.append(i);r.append(DXUtility.createFormItemGroupWithCaption("").append(t))},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Site",["Area","Region","Territory"],["Warehouse"]);c(i.form(),n.value);n.selectedItem?(k(n.value),i.form().getEditor("Company").option("value",n.selectedItem.Company()),i.form().getEditor("Code").option("value",h(n.selectedItem.Code()))):n.previousValue!=null&&i.form().getEditor("Company").option("value",null);c(i.form(),n.value)}}}]},{itemType:"group",caption:"Salesman",colCount:6,colSpan:3,items:[{dataField:"Code",validationRules:[{type:"required"}],label:{text:"Code"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Name",validationRules:[{type:"required"}],label:{text:"Name"},colSpan:3,editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"WarehouseID",label:{text:"Warehouse"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?["StatusID","=",1]:[["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()],["StatusID","=",1]]),displayExpr:"Warehouse",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"StatusID",validationRules:[{type:"required"}],label:{text:"Status"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","SalesmanStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"GroupID",label:{text:"Group"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","SalesmanGroup"]),displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"CategoryID",validationRules:[{type:"required"}],label:{text:"Category"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","SalesmanCategory"]),displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t,r,u;n.selectedItem&&(t=null,r=Dismoyo_Ciptoning_Client.app.CurrentUser,r.IsHeadOffice()?(u=i.form().getEditor("SiteID").option("selectedItem"),u&&(t=u.Code())):t=r.SiteCode(),i.form().getEditor("Code").option("value",h(t)))}}},{itemType:"empty",colSpan:2},{dataField:"Phone",label:{text:"Phone"},validationRules:[{type:"numeric"}],colSpan:2,editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:4},{dataField:"SFAFlag",label:{text:"SFA Flag"},editorType:"dxCheckBox",editorOptions:{onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var u=i.popupEditData(),t=i.form(),r;t.itemOption("Salesman.SFA","isRequired",n.value);r=t.itemOption("Salesman.SFA").editorOptions;r.readOnly=!n.value;t.itemOption("Salesman.SFA","editorOptions",r)}}},{dataField:"SFA",label:{text:"SFA Password"},editorOptions:{mode:"password",maxLength:50,onEnterKey:function(){i.events.performOK(this)}}}]}],r.events.performNewRow=function(){g(null)},i.events.performOK=function(){ut()},i.events.performCancel=function(){i.popupEditOptions.visible(!1);e&&(r.dataGrid().refresh(),e=!1)},{isReady:a.promise(),dataSource:f,refreshList:w,viewShowing:tt,viewDisposing:it,openCreateViewAsRoot:nt,icon:"/Images/salesman_32px.png",dataSource_vSalesmanProduct:b,collapsibleFilter:u,commonGridView:r,commonPopupEdit:i}};Dismoyo_Ciptoning_Client.vSalesmanActivityReports=function(n,t){"use strict";function h(){e=!0}function c(){f=CommonUtility.configureCommonGridViewLayout("vSalesmanActivityReports");f||setTimeout(c,50)}function v(){var n,t;c();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],u.filter(t));s()?e&&l():(s(u),u.load().always(function(){o.resolve()}))}function y(){Dismoyo_Ciptoning_Client.DB.vSalesmanActivityReports.off("modified",h)}function l(){e=!1;u.pageIndex(0);u.load()}var e=!1,a=t.layoutController.name==="split",o=$.Deferred(),s=ko.observable(),u,f,i,r;u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesmanActivityReports,select:["CustomerID","CallDate","CheckInDate","CheckOutDate","CustomerType","Customer","SalesmanID","Latitude","Longitude","RouteTypeID","RouteTypeName","Activity","DocumentCode"],sort:["CallDate","Customer"]});Dismoyo_Ciptoning_Client.DB.vSalesmanActivityReports.on("modified",h);return i=new Dismoyo_Ciptoning_Client.CollapsibleFilter,i.filterOptions.onInitialized=function(){i.filter().element().resize(function(){f&&f.resizeAll()})},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Warehouse"])}}}]},{itemType:"group",caption:"Salesman Activity Report",colCount:3,colSpan:3,items:[{dataField:"SalesmanID",label:{text:"Salesman"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSalesmanDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Salesman",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)}}},{dataField:"CallDateFrom",label:{text:"Call Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)}}},{dataField:"CallDateTo",label:{text:"Call Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)}}},{dataField:"RouteTypeID",label:{text:"Route Type"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","RouteType"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch()}}}]}],i.events.performSearch=function(){var s=r.dataGrid(),t=i.form(),y=t.getEditor("SalesmanID").option("value"),e=t.getEditor("CallDateFrom").option("value"),o=t.getEditor("CallDateTo").option("value"),n,u;if(y==null||e==null||o==null){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Please specify Salesman and Call Date."),"Search Failed");return}if(e.getFullYear()!=o.getFullYear()||e.getMonth()!=o.getMonth()){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Call Date From and To must be in the same month."),"Search Failed");return}n=[];s.clearFilter();var f=Dismoyo_Ciptoning_Client.app.CurrentUser,h=f.TerritoryID(),c=f.RegionID(),l=f.AreaID(),a=f.CompanyID(),v=f.SiteID();t.itemOption("Organization").visible&&(h=t.getEditor("TerritoryID").option("value"),c=t.getEditor("RegionID").option("value"),l=t.getEditor("AreaID").option("value"),a=t.getEditor("CompanyID").option("value"),v=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",h,"and");DXUtility.addFilterExpression(n,"RegionID","=",c,"and");DXUtility.addFilterExpression(n,"AreaID","=",l,"and");DXUtility.addFilterExpression(n,"CompanyID","=",a,"and");DXUtility.addFilterExpression(n,"SiteID","=",v,"and");u=t.getEditor("SalesmanID").option("value");DXUtility.addFilterExpression(n,"SalesmanID","=",u,"and");u=e;DXUtility.addFilterExpression(n,"CallDate",">=",u,"and");u=o;DXUtility.addFilterExpression(n,"CallDate","<=",u,"and");u=t.getEditor("RouteTypeID").option("value");DXUtility.addFilterExpression(n,"RouteTypeID","=",u,"and");n.length>0?s.filter(n):s.refresh()},r=new Dismoyo_Ciptoning_Client.CommonGridView,r.dataGridOptions.dataSource=u,r.dataGridOptions.selection.mode="single",r.dataGridOptions.columnAutoWidth=!1,r.dataGridOptions.editing.editEnabled=!1,r.dataGridOptions.editing.removeEnabled=!1,r.newRowOptions.visible=!1,r.deleteRowsOptions.visible=!1,r.dataGridOptions.grouping={autoExpandAll:!1},r.dataGridOptions.columns=[{dataField:"CallDate",caption:"Call Date",headerCellTemplate:function(n,t){var r=$("#vSalesmanActivityReports_commonGridView").find(".dx-datagrid:first-child"),i,u;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Check<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Location<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+="<\/tr>",u=r.find(".dx-header-row:first-child"),$(i).insertBefore(u[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"CheckInDate",caption:"IN"},{dataField:"CheckOutDate",caption:"OUT"},{dataField:"CustomerType",caption:"Customer Type",width:"100px"},{dataField:"Customer",caption:"Customer",width:"100px"},{dataField:"Latitude",caption:"Latitude",width:"100px"},{dataField:"Longitude",caption:"Longitude",width:"100px"},{dataField:"RouteTypeName",caption:"Route Type",width:"100px"},{dataField:"Activity",caption:"Activity",width:"100px"},{dataField:"DocumentCode",caption:"Document No",width:"100px"}],r.dataGridOptions.customizeColumns=function(n){$.each(n,function(n,t){t.groupCellTemplate=function(n,t){n.append($("<div>").html(t.text).css("font-weight","normal").css("font-style","normal"))}})},{isReady:o.promise(),dataSource:u,refreshList:l,viewShowing:v,viewDisposing:y,openCreateViewAsRoot:a,icon:"Images/stock_view_32px.png",collapsibleFilter:i,commonGridView:r}};Dismoyo_Ciptoning_Client.vSalesmanTargets=function(n,t){"use strict";function k(){l=!0}function d(){h=CommonUtility.configureCommonGridViewLayout("vSalesmanTargets");h||setTimeout(d,50)}function et(){var n,t;d();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],f.filter(t));b()?l&&g():(b(f),f.load().always(function(){w.resolve()}))}function ot(){Dismoyo_Ciptoning_Client.DB.vSalesmanTargets.off("modified",k)}function g(){l=!1;f.pageIndex(0);f.load()}function v(n,t,r){var u=i.popupEditData(),o=i.form(),f;showLoadingPanel();f=e();f.cancelEditData();o.getEditor("TotalRegisteredCustomer").option("value",0);(n!=undefined||n!=null)&&t instanceof Date?new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesmanProducts,select:["ProductID","Product"],filter:["SalesmanID","=",n],sort:["Product"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesmanProductViewModel(n)}}).load().done(function(i){new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["StatusID"],filter:[["SalesmanID","=",n],"and",["StatusID",">=",1],"and",["RegisteredDate","<",DateTimeUtility.getFirstDayOfMonth(t)]],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)}}).load().done(function(n){var s=n.length,e,t;for(o.getEditor("TotalRegisteredCustomer").option("value",s),e=[],t=0;t<i.length;t++)e.push(new Dismoyo_Ciptoning_Client.vSalesmanProductTargetViewModel),e[t].ProductID(i[t].ProductID()),e[t].Product(i[t].Product()),e[t].SalesOrderQty(0),e[t].EffectiveCall(0),e[t].CustomerTransaction(0),e[t].EffectiveCallValue(0),e[t].CustomerTransactionValue(0);r&&e.length==u.ChildProductTargets().length||u.ChildProductTargets(e);ct(u.ChildProductTargets(),s);f.option("dataSource",c(u.ChildProductTargets()));hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download RO."),"Download RO Failed");u.ChildProductTargets([]);f.option("dataSource",c(u.ChildProductTargets()));hideLoadingPanel()})}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download salesman product data."),"Download Salesman Product Failed");u.ChildProductTargets([]);f.option("dataSource",c(u.ChildProductTargets()));hideLoadingPanel()}):(u.ChildProductTargets([]),f.option("dataSource",c(u.ChildProductTargets())),hideLoadingPanel())}function st(n){return ht(n.component,n.row.rowIndex,n.row.data,i.form().getEditor("TotalRegisteredCustomer").option("value"))}function ht(n,t,i,r){var e=DXUtility.getValue(i,"CustomerTransaction"),o=DXUtility.getValue(i,"EffectiveCall"),u=e/100*r,f=o*u;DXUtility.setValue(i,"CustomerTransactionValue",u);DXUtility.setValue(i,"EffectiveCallValue",f);n.cellValue(t,"CustomerTransactionValue",u);n.cellValue(t,"EffectiveCallValue",f)}function ct(n,t){for(var i=0;i<n.length;i++){var r=n[i],u=r.CustomerTransaction()/100*t,f=r.EffectiveCall()*u;r.CustomerTransactionValue(u);r.EffectiveCallValue(f)}}function tt(n,t){t||(t=null);var r=DataUtility.GetLookupSalesmanDataSource(["SiteID","=",t]),n=i.form();n.getEditor("SalesmanID").option("value",null);n.getEditor("SalesmanID").option("dataSource",[]);r.load().done(function(){n.getEditor("SalesmanID").option("dataSource",r)})}function c(n){return CommonUtility.createArrayDataSource("vSalesmanProductTargetViewModel",["SalesmanID","PeriodID","ProductID"],n)}function it(n,t,i){showLoadingPanel();new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesmanTargets,expand:["ChildProductTargets"],filter:[["SalesmanID","=",n],"and",["PeriodID","=",t]],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesmanTargetViewModel(n)}}).load().done(function(n){n.length>0?(hideLoadingPanel(),a=i,rt(n[0])):(DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("The selected data is not found."),"Load Failed"),hideLoadingPanel())}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function rt(n){var u=!1,r,t,f;n||(n=new Dismoyo_Ciptoning_Client.vSalesmanTargetViewModel,u=!0);i.popupEditData(n);i.popupEdit().option("title",(u?"New":"Edit")+" Salesman Target");i.popupEditOptions.editingKey=[n.SalesmanID(),n.PeriodID()];i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);r=Dismoyo_Ciptoning_Client.app.CurrentUser;t=i.form();DXUtility.resetFormValidation(t);u&&(n.SalesmanID(null),n.PeriodID(null),n.TerritoryID(r.TerritoryID()),n.RegionID(r.RegionID()),n.AreaID(r.AreaID()),n.SiteID(r.SiteID()),n.SiteCode(r.SiteCode()),n.CompanyID(r.CompanyID()),n.Company(r.Company()));t.itemOption("Organization").visible&&(t.getEditor("TerritoryID").option("value",n.TerritoryID()),t.getEditor("RegionID").option("value",n.RegionID()),t.getEditor("AreaID").option("value",n.AreaID()),t.getEditor("SiteID").option("value",n.SiteID()),t.getEditor("Company").option("value",n.Company()));tt(t,n.SiteID());o=!0;s=!0;t.getEditor("SalesmanID").option("value",n.SalesmanID());t.getEditor("PeriodID").option("value",n.PeriodID());t.getEditor("SalesOrderAmount").option("value",n.SalesOrderAmount());t.getEditor("NewCustomer").option("value",n.NewCustomer());t.getEditor("Visibility").option("value",n.Visibility());t.getEditor("SalesmanID").option("readOnly",!u);t.getEditor("PeriodID").option("readOnly",!u);u&&DXUtility.resetFormValidation(t);f=e();v(t.getEditor("SalesmanID").option("value"),t.getEditor("PeriodID").option("value"),!0);o=!1;s=!1}function lt(){var f;showLoadingPanel();var t=i.form(),r=i.form().validate().isValid,o=r?"":"Please specify the required fields.",h=u.dataGrid(),v=h.option("dataSource"),c=e().option("dataSource"),s=[];for(f=0;f<c.store()._array.length;f++)s.push(new Dismoyo_Ciptoning_Client.vSalesmanProductTargetViewModel(c.store()._array[f]));if(r&&s.length==0&&(o="The selected Salesman does not have any reference products.",r=!1),r){var n=i.popupEditData(),t=i.form(),l=t.getEditor("SalesmanID").option("value"),a=t.getEditor("PeriodID").option("value");new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesmanTargets,select:["PeriodID"],filter:[["SalesmanID","=",l],"and",["PeriodID","=",DateTimeUtility.getFirstDayOfMonth(a)],],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesmanTargetViewModel(n)}}).load().done(function(r){var u,f;if(n.SalesmanID()==null&&n.PeriodID()==null&&r.length>0)DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("The selected salesman target is already exist."),"Save Failed"),hideLoadingPanel();else{for(n.SalesmanID(l),n.PeriodID(a),n.SalesOrderAmount(t.getEditor("SalesOrderAmount").option("value")),n.NewCustomer(t.getEditor("NewCustomer").option("value")),n.Visibility(t.getEditor("Visibility").option("value")),n.ChildProductTargets(s),u=ko.toJS(n),u.PeriodID=DateTimeUtility.getFirstDayOfMonth(u.PeriodID),f=0;f<u.ChildProductTargets.length;f++)delete u.ChildProductTargets[f].EffectiveCallValue,delete u.ChildProductTargets[f].CustomerTransactionValue;v.store().insert(u).done(function(){hideLoadingPanel();i.popupEditOptions.visible(!1);h.refresh()}).fail(function(t){n.SalesmanID(null);n.PeriodID(null);DevExpress.ui.dialog.alert(t.message,"Save Failed");hideLoadingPanel()})}}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to verify data."),"Save Failed");hideLoadingPanel()})}else hideLoadingPanel();o!=""&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(o),"Save Failed")}var l=!1,ft=t.layoutController.name==="split",w=$.Deferred(),b=ko.observable(),f,a,o=!1,s=!1,h,nt,r,u,i;f=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesmanTargets,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesmanTargetViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vSalesmanTargets.on("modified",k);nt=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vProducts,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vProductViewModel(n)}});r=new Dismoyo_Ciptoning_Client.CollapsibleFilter;r.filterOptions.onInitialized=function(){r.filter().element().resize(function(){h&&h.resizeAll()})};r.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){r.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(r.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){r.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(r.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){r.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(r.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){r.events.performSearch()}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){r.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(r.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Salesman"])}}}]},{itemType:"group",caption:"Salesman Target",colCount:3,colSpan:3,items:[{dataField:"SalesmanID",label:{text:"Salesman"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSalesmanDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Salesman",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){r.events.performSearch(this)}}},{dataField:"PeriodID",label:{text:"Period"},editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,placeholder:"mmm-yyyy",formatString:"MMM-yyyy",maxZoomLevel:"year",onEnterKey:function(){r.events.performSearch(this)}}}]}];r.events.performSearch=function(){var e=u.dataGrid(),t=r.form(),n=[],i;e.clearFilter();var f=Dismoyo_Ciptoning_Client.app.CurrentUser,o=f.TerritoryID(),s=f.RegionID(),h=f.AreaID(),c=f.CompanyID(),l=f.SiteID();t.itemOption("Organization").visible&&(o=t.getEditor("TerritoryID").option("value"),s=t.getEditor("RegionID").option("value"),h=t.getEditor("AreaID").option("value"),c=t.getEditor("CompanyID").option("value"),l=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",o,"and");DXUtility.addFilterExpression(n,"RegionID","=",s,"and");DXUtility.addFilterExpression(n,"AreaID","=",h,"and");DXUtility.addFilterExpression(n,"CompanyID","=",c,"and");DXUtility.addFilterExpression(n,"SiteID","=",l,"and");i=r.form().getEditor("SalesmanID").option("value");DXUtility.addFilterExpression(n,"SalesmanID","=",i,"and");i=r.form().getEditor("PeriodID").option("value");i instanceof Date&&DXUtility.addFilterExpression(n,"PeriodID","=",DateTimeUtility.getFirstDayOfMonth(i),"and");n.length>0?e.filter(n):e.refresh()};u=new Dismoyo_Ciptoning_Client.CommonGridView;u.dataGridOptions.dataSource=f;u.newRowOptions.disabled=!1;u.dataGridOptions.editing.editEnabled=!1;u.dataGridOptions.editing.allowUpdating=!0;u.dataGridOptions.editing.removeEnabled=!1;u.dataGridOptions.editing.allowDeleting=!0;u.dataGridOptions.columns=[{dataField:"SalesmanID",visible:!1},{dataField:"Salesman",width:"200px",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: left;">');i.append($('<a class="dx-link">').text(t.data.Salesman()).on("dxclick",function(){it(t.data.SalesmanID(),t.data.PeriodID(),!1)}));i.append("&nbsp;");n.append(i)},headerCellTemplate:function(n,t){var r=$("#vSalesmanTargets_commonGridView").find(".dx-datagrid:first-child"),i,u;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="3">Target<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+="<\/tr>",u=r.find(".dx-header-row:first-child"),$(i).insertBefore(u[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"PeriodID",caption:"Period",width:"140px",customizeText:function(n){if(n.value){var t=n.value;return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()]+" "+t.getFullYear()}return null}},{dataField:"SalesOrderAmount",caption:"Amount",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"NewCustomer",caption:"NOO",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:0},{dataField:"Visibility",caption:"Visibility",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:0},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1},{width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){it(t.data.SalesmanID(),t.data.PeriodID(),!1)}));i.append("&nbsp;");i.append($('<a class="dx-link">').text("Delete").on("dxclick",function(){u.dataGrid().deleteRow(t.rowIndex)}));i.append("&nbsp;");n.append(i)}}];i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.okOptions.text="Save";i.okOptions.icon="icons8-save";var e=function(){return DXUtility.getDXInstance(null,"#vSalesmanTargets_productTargetsDataGrid","dxDataGrid")},y=function(){return DXUtility.getDXInstance(null,"#commonPopupEdit_ok","dxButton")},p,at=function(){for(var t=$(".dx-command-edit","[id$=productTargetsDataGrid]"),n=0;n<t.length;n++)if($(t[n]).text().trim().indexOf("Save")>=0)return!0;return!1},ut=function(){at()||(y().option("disabled",!1),clearInterval(p))};return i.popupEditOptions.onContentReady=function(){var t=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop("Product Target","9px"));n.append($('<div id="vSalesmanTargets_productTargetsDataGrid">').dxDataGrid({deferRendering:!1,dataSource:[],showBorders:!0,paging:{enabled:!1},allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,editing:{editMode:"row",allowAdding:!1,allowUpdating:!0,allowDeleting:!0},onInitNewRow:function(n){y().option("disabled",!0);p=setInterval(ut,500);n.data.SalesOrderQty=0;n.data.EffectiveCall=0;n.data.CustomerTransaction=0},onEditorPreparing:function(n){if(n.parentType=="dataRow"&&(n.row!=undefined&&n.row.rowIndex!=undefined&&(n.component.editRowIndex=n.row.rowIndex),n.dataField=="EffectiveCall"||n.dataField=="CustomerTransaction")){var t="";n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==190||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onEnterKey:function(){e().saveEditData()},onValueChanged:function(t){(t.value==null||t.value=="")&&(t.value=0);t.component.option("value",t.value);n.setValue(t.value);DXUtility.setValue(n.row.data,n.dataField,t.value);st(n)}});n.cancel=!0}},onRowUpdated:function(){for(var u=i.popupEditData(),t=e().option("dataSource").store(),r=[],n=0;n<t._array.length;n++)r.push(new Dismoyo_Ciptoning_Client.vSalesmanProductTargetViewModel(t._array[n]));u.ChildProductTargets(r)},onEditingStart:function(){y().option("disabled",!0);p=setInterval(ut,500)},columns:[{dataField:"SalesmanID",visible:!1},{dataField:"PeriodID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"Product",caption:"Product",allowEditing:!1,editorOptions:{readOnly:!0},headerCellTemplate:function(n,t){var r=$(e().element()),i,u;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader" style="border-top-style: none !important;">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colSpan="2">OT<\/td>',i+='       <td class="dx-datagrid-action" colSpan="2">EC<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+="<\/tr>",u=r.find(".dx-header-row:first-child"),$(i).insertBefore(u[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"SalesOrderQty",caption:"Qty",width:"80px",dataType:"number",validationRules:[{type:"required"}],editorOptions:{onKeyDown:DXUtility.preventInputCharacters}},{dataField:"CustomerTransaction",caption:"Param (% of RO)",width:"100px",dataType:"number",format:"fixedPoint",precision:2,validationRules:[{type:"required"}]},{dataField:"CustomerTransactionValue",caption:"Target",width:"70px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"EffectiveCall",caption:"Param (x of OT)",width:"100px",dataType:"number",format:"fixedPoint",precision:2,validationRules:[{type:"required"}]},{dataField:"EffectiveCallValue",caption:"Target",width:"70px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2}]}));t.append(DXUtility.createFormItemGroupWithCaption("").append(n))},u.events.performNewRow=function(){rt(null)},i.events.performOK=function(){lt()},i.events.performCancel=function(){i.popupEditOptions.visible(!1);a&&(u.dataGrid().refresh(),a=!1)},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();CommonUtility.cascadeValueChanged(t,n.selectedItem,n.value,"Site",["Area","Region","Territory"],[]);n.selectedItem?t.getEditor("Company").option("value",n.selectedItem.Company()):n.previousValue!=null&&t.getEditor("Company").option("value",null);tt(t,n.value)}}}]},{itemType:"group",caption:"Salesman Target",colCount:6,colSpan:3,items:[{dataField:"SalesmanID",label:{text:"Salesman"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSalesmanDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Salesman",valueExpr:"ID",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();n.value&&!o&&v(n.value,t.getEditor("PeriodID").option("value"));o=!1}}},{dataField:"PeriodID",label:{text:"Period"},validationRules:[{type:"required"}],editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mmm-yyyy",formatString:"MMM-yyyy",maxZoomLevel:"year",onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();n.value&&!s&&v(t.getEditor("SalesmanID").option("value"),n.value,!0);s=!1}}},{dataField:"TotalRegisteredCustomer",label:{text:"RO"},editorType:"dxNumberBox",editorOptions:{value:0,readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2},{dataField:"SalesOrderAmount",validationRules:[{type:"required"}],label:{text:"Amount"},editorType:"dxNumberBox",editorOptions:{min:0,max:1e11,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"NewCustomer",validationRules:[{type:"required"}],label:{text:"NOO"},editorType:"dxNumberBox",editorOptions:{min:0,max:1e3,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Visibility",validationRules:[{type:"required"}],label:{text:"Visibility"},editorType:"dxNumberBox",editorOptions:{min:0,max:1e3,onEnterKey:function(){i.events.performOK(this)}}}]}],{isReady:w.promise(),dataSource:f,refreshList:g,viewShowing:et,viewDisposing:ot,openCreateViewAsRoot:ft,icon:"Images/salesman_target_32px.png",dataSource_vProducts:nt,collapsibleFilter:r,commonGridView:u,commonPopupEdit:i,productTargetsDataGrid:e}};Dismoyo_Ciptoning_Client.vSalesOrders=function(n,t){"use strict";function at(){ut=!0}function vt(){nt=CommonUtility.configureCommonGridViewLayout("vSalesOrders");nt||setTimeout(vt,50)}function ri(){var n,t;vt();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],o.filter(t));lt()?ut&&yt():(lt(o),o.load().always(function(){ct.resolve()}))}function ui(){Dismoyo_Ciptoning_Client.DB.vSalesOrders.off("modified",at)}function yt(){ut=!1;o.pageIndex(0);o.load()}function wt(n){return(n?n:"(Site Code)")+"-YY-01-(Auto Generated)"}function bt(n){return(n?n:"(Site Code)")+"-YY-10-(Auto Generated)"}function kt(n,t){t?Dismoyo_Ciptoning_Client.DB.vSites.byKey(t).done(function(n){c=n.IsLotNumberEntryRequired}):(t=null,c=undefined);var i=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["ID","Customer","Address","Category1","SalesmanID","Salesman","WarehouseID","TermOfPaymentID","PriceGroupID","DiscountGroupID","SiteID"],filter:[["IsDeleted","=",!1],"and",["StatusID","=",1],"and",["SiteID","=",t]],map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)}}),r=DataUtility.GetLookupSalesmanDataSource([["IsDeleted","=",!1],"and",["StatusID","=",1],"and",["SiteID","=",t]]);n.getEditor("CustomerID").option("value",null);n.getEditor("CustomerID").option("dataSource",i);i.load();n.getEditor("SalesmanID").option("value",null);n.getEditor("SalesmanID").option("dataSource",r);r.load()}function dt(n,t){var i=[["Group","=","CustomerTermOfPayment"]],r;t!=undefined&&t!=null&&(i.push("and"),i.push(["Value_Int32","<=",t]));r=DataUtility.GetLookupSystemLookupDataSource(i);n.getEditor("TermOfPaymentID").option("value",null);n.getEditor("TermOfPaymentID").option("dataSource",r);n.getEditor("TermOfPaymentID").option("value",t);r.load()}function oi(n){var t=Dismoyo_Ciptoning_Client.LocalStore.vSystemParameters.dataByFilter(["ID","=",n]);return t.length>0?t[0].Value():null}function rt(n){return CommonUtility.calcProductPriceAndDiscount(i.form().getEditor("TransactionDate").option("value"),n.component,n.row.rowIndex,n.row.data,tt,it,!1)}function gt(n){CommonUtility.updateSummariesArrayStore(f().option("dataSource").store(),n)}function si(n,t){CommonUtility.updateDeferSummariesArrayStore(f().option("dataSource").store(),n,t)}function hi(n){return CommonUtility.validateSummaryArrayStore(f().option("dataSource").store(),"vSalesOrderSummaryViewModel",n)}function ft(n){return CommonUtility.createArrayDataSource("vSalesOrderSummaryViewModel",["ProductID"],n)}function ci(n,t,i){var r=$('<div class="dx-command-edit" style="text-align: right; padding-right: 5px;">'),o;if(r.append($('<a style="color: inherit;">').text(n[t]())),r.append("&nbsp;"),c){var u=t.replace("Conv",""),s=n[u](),f=n.ChildDetails(),e=0;for(o in f)e+=f[o][u]();r.append($('<a class="dx-link dxcustom-linkbutton dx-icon-icons8-view-details" title="Edit Lot Number">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<\/a><span id="LotMark_'+n.ProductID()+"_"+t+'" class="dx-icon-overflow '+(e==s?"hidden":"")+'" style="color:red; font-size: 14px; margin-left: -6px;"><\/span>').on("dxclick",function(){st(function(){vi(n,i)})}));r.append("&nbsp;")}return r}function li(n){var t=f().option("editing"),i=f().option("selection");i.mode=n?"multiple":"none";t.allowUpdating=n;t.allowDeleting=n;f().option("editing",t);f().option("selection",i);wi().option("disabled",!n);bi().option("disabled",!0);f().repaint()}function et(n,t){showLoadingPanel();Dismoyo_Ciptoning_Client.DB.vSalesOrders.byKey(n,{expand:["ChildSummaries/ChildDetails"]}).done(function(n){hideLoadingPanel();g=t;ot(new Dismoyo_Ciptoning_Client.vSalesOrderViewModel(n))}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function ot(n){var e=!1,s,h,l,p;n||(n=new Dismoyo_Ciptoning_Client.vSalesOrderViewModel,e=!0);i.popupEditData(n);i.popupEdit().option("title",(e?"New":"Edit")+" Sales Order");i.popupEditOptions.editingKey=n.DocumentID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);var u=Dismoyo_Ciptoning_Client.app.CurrentUser,t=i.form(),o=b();DXUtility.resetFormValidation(t);var w=n.DocumentCode(),d=n.DODocumentCode(),r=!1,g=[];c=n.IsSiteLotNumberEntryRequired();e?(n.DocumentID(new DevExpress.data.Guid),n.DocumentStatusID(null),u.IsHeadOffice()||(n.TerritoryID(u.TerritoryID()),n.RegionID(u.RegionID()),n.AreaID(u.AreaID()),n.SiteID(u.SiteID()),n.SiteCode(u.SiteCode()),n.CompanyID(u.CompanyID()),n.Company(u.Company())),w=wt(n.SiteCode()),d=bt(n.SiteCode())):(g=n.ChildSummaries(),(n.DocumentStatusID()!=1||c)&&(n.DocumentStatusID()==2||n.DocumentStatusID()==3||n.DocumentStatusID()==4)&&(r=!0));li(!r);pi().option("disabled",e);a().option("disabled",e||r);k().option("disabled",e||r);v().option("disabled",n.DocumentStatusID()!=2);y().option("disabled",r);i.ok().option("disabled",r);s=n.PriceGroupID();h=n.DiscountGroupID();t.itemOption("Organization").visible&&(t.getEditor("TerritoryID").option("value",n.TerritoryID()),t.getEditor("RegionID").option("value",n.RegionID()),t.getEditor("AreaID").option("value",n.AreaID()),t.getEditor("SiteID").option("value",n.SiteID()),t.getEditor("Company").option("value",n.Company()),t.getEditor("TerritoryID").option("readOnly",r),t.getEditor("RegionID").option("readOnly",r),t.getEditor("AreaID").option("readOnly",r),t.getEditor("SiteID").option("readOnly",r));kt(t,n.SiteID());dt(t,n.TermOfPaymentID());t.getEditor("DocumentCode").option("value",w);t.getEditor("TransactionDate").option("value",n.TransactionDate());t.getEditor("CustomerID").option("value",n.CustomerID());t.getEditor("SalesmanID").option("value",n.SalesmanID());t.getEditor("WarehouseID").option("value",n.WarehouseID());t.getEditor("TermOfPaymentID").option("value",n.TermOfPaymentID());t.getEditor("ReferenceNumber").option("value",n.ReferenceNumber());t.getEditor("DocumentStatusID").option("value",n.DocumentStatusID());t.getEditor("PODocumentCode").option("value",n.PODocumentCode());t.getEditor("POTransactionDate").option("value",n.POTransactionDate());t.getEditor("DODocumentCode").option("value",d);t.getEditor("DOShipmentDate").option("value",n.DOShipmentDate());t.getEditor("DOReceivedDate").option("value",n.DOReceivedDate());t.getEditor("DOPrintedCount").option("value",n.DOPrintedCount());t.getEditor("DOLastPrintedDate").option("value",n.DOLastPrintedDate());o.getEditor("TotalGross").option("value",CommonUtility.getNumberFormat(n.TotalGross()));o.getEditor("TotalTax").option("value",CommonUtility.getNumberFormat(n.TotalTax()));o.getEditor("Total").option("value",CommonUtility.getNumberFormat(n.Total()));t.getEditor("TransactionDate").option("readOnly",r);t.getEditor("CustomerID").option("readOnly",r);t.getEditor("SalesmanID").option("readOnly",r);t.getEditor("TermOfPaymentID").option("readOnly",r);t.getEditor("ReferenceNumber").option("readOnly",r);t.getEditor("PODocumentCode").option("readOnly",r);t.getEditor("POTransactionDate").option("readOnly",r);t.getEditor("DOShipmentDate").option("readOnly",r);t.getEditor("DOReceivedDate").option("readOnly",r);l=new Date;e?(DXUtility.resetFormValidation(t),t.getEditor("TransactionDate").option("value",l),t.getEditor("DOShipmentDate").option("value",l)):(s&&n.PriceGroupID(s),h&&n.DiscountGroupID(h),tt=Dismoyo_Ciptoning_Client.LocalStore.vProductPrices.dataByFilter(["PriceGroupID","=",n.PriceGroupID()]),it=Dismoyo_Ciptoning_Client.LocalStore.vDiscountGroups.expandedDataByKey(n.DiscountGroupID()));p=f();p.cancelEditData();n.ChildSummaries(g);p.option("dataSource",ft(n.ChildSummaries()))}function p(n,t){var p,ri,r,o,h,u,c,v,ui;showLoadingPanel();var s=i.form(),oi=b(),a=s.validate().isValid,l=a?"":"Please specify the required fields.",fi=e.dataGrid(),ei=fi.option("dataSource"),w=f().option("dataSource"),y=[];for(h=0;h<w.store()._array.length;h++)y.push(new Dismoyo_Ciptoning_Client.vSalesOrderSummaryViewModel(w.store()._array[h]));a&&y.length<=0&&(l="Please specify at least one item in Order Details.",a=!1);var k=0,d=0,nt=0,tt=0,it=0,rt=0,ut=0,ft=0,st=0,ht=0,ct=0,lt=0,at=0,vt=0,yt=0,pt=0,wt=0,bt=0,kt=0,dt=0,gt=0,ni=0,ti=0,ii=0;if(a)for(h=0;h<y.length;h++){for(u=y[h],p=0,k+=u.RawSubtotalGrossPrice(),d+=u.RawSubtotalPrice(),nt+=u.RawDiscountStrata1Amount(),tt+=u.RawDiscountStrata2Amount(),it+=u.RawDiscountStrata3Amount(),rt+=u.RawDiscountStrata4Amount(),ut+=u.RawDiscountStrata5Amount(),ft+=u.RawAddDiscountStrataAmount(),st+=u.RawSubtotalGross(),ht+=u.RawSubtotalTax(),ct+=u.RawSubtotal(),lt+=u.SubtotalGrossPrice(),at+=u.SubtotalPrice(),vt+=u.DiscountStrata1Amount(),yt+=u.DiscountStrata2Amount(),pt+=u.DiscountStrata3Amount(),wt+=u.DiscountStrata4Amount(),bt+=u.DiscountStrata5Amount(),kt+=u.AddDiscountStrataAmount(),dt+=u.SubtotalGross(),gt+=u.SubtotalTax(),ni+=u.Subtotal(),ti+=u.SubtotalWeight(),ii+=u.SubtotalDimension(),c=0;c<u.ChildDetails().length;c++)v=u.ChildDetails()[c],p+=v.QtyOrder();u.QtyOrder()!=p&&(l==""?l="Following products quantity of Order Details items is not matched: ":l+=", ",l+=u.Product(),a=!1)}if(ri=Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID(),s.itemOption("Organization").visible&&(ri=s.getEditor("SiteID").option("value")),a){for(r=i.popupEditData(),r.TransactionDate(s.getEditor("TransactionDate").option("value")),r.CustomerID(s.getEditor("CustomerID").option("value")),r.SalesmanID(s.getEditor("SalesmanID").option("value")),r.WarehouseID(s.getEditor("WarehouseID").option("value")),r.TermOfPaymentID(s.getEditor("TermOfPaymentID").option("value")),r.ReferenceNumber(s.getEditor("ReferenceNumber").option("value")),r.PODocumentCode(s.getEditor("PODocumentCode").option("value")),r.POTransactionDate(s.getEditor("POTransactionDate").option("value")),r.DOShipmentDate(s.getEditor("DOShipmentDate").option("value")),r.DOReceivedDate(s.getEditor("DOReceivedDate").option("value")),r.DOPrintedCount(s.getEditor("DOPrintedCount").option("value")),r.DOLastPrintedDate(s.getEditor("DOLastPrintedDate").option("value")),r.RawTotalGrossPrice(k),r.RawTotalPrice(d),r.RawTotalDiscountStrata1Amount(nt),r.RawTotalDiscountStrata2Amount(tt),r.RawTotalDiscountStrata3Amount(it),r.RawTotalDiscountStrata4Amount(rt),r.RawTotalDiscountStrata5Amount(ut),r.RawTotalAddDiscountStrataAmount(ft),r.RawTotalGross(st),r.RawTotalTax(ht),r.RawTotal(ct),r.TotalGrossPrice(lt),r.TotalPrice(at),r.TotalDiscountStrata1Amount(vt),r.TotalDiscountStrata2Amount(yt),r.TotalDiscountStrata3Amount(pt),r.TotalDiscountStrata4Amount(wt),r.TotalDiscountStrata5Amount(bt),r.TotalAddDiscountStrataAmount(kt),r.TotalGross(dt),r.TotalTax(gt),r.Total(ni),r.TotalWeight(ti),r.TotalDimension(ii),r.ChildSummaries(y),o=ko.toJS(r),n&&(o.DocumentStatusID=n),o.DocumentStatusID||(o.DocumentStatusID=1),o.TransactionDate=DateTimeUtility.getFirstTimeOfDay(o.TransactionDate),o.POTransactionDate&&(o.POTransactionDate=DateTimeUtility.getFirstTimeOfDay(o.POTransactionDate)),o.DOShipmentDate=DateTimeUtility.getFirstTimeOfDay(o.DOShipmentDate),o.DOReceivedDate=DateTimeUtility.getFirstTimeOfDay(o.DOReceivedDate),h=0;h<o.ChildSummaries.length;h++){for(u=o.ChildSummaries[h],u.DocumentID=o.DocumentID,c=0;c<u.ChildDetails.length;c++)v=u.ChildDetails[c],v.DocumentID=o.DocumentID,v.Qty=v.QtyOrder*-1;u.Qty=u.QtyOrder*-1}ei.store().insert(o).done(function(n){CommonUtility.documentSuccessMessage(n.DocumentStatusID,function(){});g=!0;switch(t){case 1:i.events.performCancel();hideLoadingPanel();break;case 2:ot(null);hideLoadingPanel();break;case 3:et(r.DocumentID(),!0)}}).fail(function(n){var t=$(".dx-popup-normal>.dx-dialog-content");t.length==0&&DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})}else hideLoadingPanel();l!=""&&(ui=$(".dx-popup-normal>.dx-dialog-content"),ui.length==0&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(l),"Save Failed"))}function ai(n){h.popupEdit().option("title","Print Delivery Order");h.popupEditOptions.visible(!0);var t=h.iframe();h.showLoadingPanel();t.attr("src",Dismoyo_Ciptoning_Client.ReportWebsite.ExtDeliveryOrderReport.url([["DocumentID","=",n]]))}function ni(n,t){var a,e,v,o,r,l,h;if(!c){var p=i.popupEditData(),y=f(),u=[];if(t){for(r=0;r<t.length;r++)t[r].ChildDetails([]);u=t}else for(a=y.option("dataSource").store(),r=0;r<a._array.length;r++)u.push(new Dismoyo_Ciptoning_Client.vSalesOrderSummaryViewModel(a._array[r]));if(e=n.data,v=$.grep(s,function(n){return n.ProductID()==DXUtility.getValue(e,"ProductID")&&n.ProductLotCode().indexOf("DUMMY")>=0}),v.length>0)for(o=v[0],DXUtility.setValue(e,"ProductLotID",o.ProductLotID()),DXUtility.setValue(e,"ProductLotCode",o.ProductLotCode()),DXUtility.setValue(e,"QtyOnHandGood",o.QtyOnHandGood()),DXUtility.setValue(e,"QtyOnHandHold",o.QtyOnHandHold()),DXUtility.setValue(e,"QtyOnHandBad",o.QtyOnHandBad()),r=0;r<u.length;r++)u[r].ProductID()==DXUtility.getValue(e,"ProductID")&&(l=$.grep(u[r].ChildDetails(),function(n){return n.ProductLotID()==DXUtility.getValue(e,"ProductLotID")}),l.length==0&&(l=[new Dismoyo_Ciptoning_Client.vSalesOrderDetailsViewModel(e)],u[r].ChildDetails().push(l[0])),h=l[0],h.QtyConvL(DXUtility.getValue(u[r],"QtyConvL")),h.QtyConvM(DXUtility.getValue(u[r],"QtyConvM")),h.QtyConvS(DXUtility.getValue(u[r],"QtyConvS")),h.QtyOrder(DXUtility.getValue(u[r],"QtyOrder")),h.QtyOrderConv(DXUtility.getValue(u[r],"QtyOrderConv")),gt(u[r]));else DevExpress.ui.dialog.alert("DUMMY Lot Number for the selected product is not available.","Save Failed")}}function w(n){var t=null;switch(n){case 1:t="Good";break;case 2:t="Hold";break;case 3:t="Bad"}var i="QtyOnHand"+t,r="QtyConvL"+t,u="QtyConvM"+t,f="QtyConvS"+t,e="QtyOrder"+t,o="QtyOrderConv"+t;return{itemStatusName:t,qtyOnHandColumn:i,qtyConvLColumn:r,qtyConvMColumn:u,qtyConvSColumn:f,qtyOrderColumn:e,qtyOrderConvColumn:o}}function vi(n,t){var o=i.popupEditData(),f,h,c;r.popupEditData(n);r.popupEditOptions.editingKey=n.ProductID();r.popupEditOptions.itemStatusID=t;r.popupEditOptions.visible(!0);var s=r.dataGrid(),e=r.form(),u=!1;(o.DocumentStatusID()==2||o.DocumentStatusID()==3||o.DocumentStatusID()==4)&&(u=!0);f=r.dataGrid().option("editing");f.allowUpdating=!u;f.allowDeleting=!u;f.editEnabled=!u;f.removeEnabled=!u;r.dataGrid().option("editing",f);r.dataGrid().option("selection",{mode:u?"none":"multiple"});r.newRow().option("disabled",u);r.dataGrid().repaint();e.getEditor("Product").option("value",n.Product());e.getEditor("QtyOnHand").option("value",n.QtyOnHand());e.getEditor("QtyOrderConv").option("value",n.QtyOrderConv());h=CommonUtility.getConversion(n.QtyOrderConv(),DXUtility.getValue(n,"ProductConversionL"),DXUtility.getValue(n,"ProductConversionM"),DXUtility.getValue(n,"ProductConversionS"));e.getEditor("QtyOrder").option("value",h.qtyTransaction);n=hi(n);c=CommonUtility.createArrayDataSource("vSalesOrderDetailsViewModel",["ProductID","ProductLotID"],n.ChildDetails());s.cancelEditData();s.option("dataSource",c)}function yi(){var n=r.popupEditData(),t=r.popupEditOptions.itemStatusID,i=w(t);CommonUtility.validateProductLotEditing(n,r.dataGrid().option("dataSource"),r.form().getEditor("QtyOrder").option("value"),"Order","vSalesOrderDetailsViewModel","QtyConvL","QtyConvM","QtyConvS","QtyOrderConv","QtyOrder",!1)&&(gt(n),r.popupEditOptions.visible(!1),f().refresh())}function st(n){if(s.length==0&&l.length==0){showLoadingPanel();var t=i.form(),r=t.getEditor("SalesmanID").option("value");new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesmanProducts,select:["ProductID","ProductCode","Product","ProductUOMLID","ProductUOMMID","ProductUOMSID","ProductConversionL","ProductConversionM","ProductConversionS"],filter:[["SalesmanID","=",r],"and",["ProductName","notcontains","SAMPLE"]],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesmanProductViewModel(n)}}).load().done(function(i){var u,e;if(i.length>0){var h=i,o=t.getEditor("WarehouseID").option("value"),r=[],f=[];for(u=0;u<i.length;u++)DXUtility.addFilterExpression(f,"ProductID","=",i[u].ProductID(),"or");DXUtility.addGroupFilterExpression(r,f,"and");DXUtility.addFilterExpression(r,"WarehouseID","=",o,"and");DXUtility.addFilterExpression(r,"QtyOnHandGood",">",0,"and");e=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOnHandAvailables,select:["ProductID","ProductLotID","ProductLotCode","ProductLot","ProductLotExpiredDate","QtyOnHandGood"],filter:r,sort:["WarehouseID","ProductID","ProductLotID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(n)}});e.load().done(function(t){for(var e,h,u=null,o=[],r=[],f=0;f<t.length;f++)o.push(new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(t[f].toJS())),e=r.length-1,h=t[f].ProductID(),f==0||r[e].ProductID()!=h?(r.push(new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(t[f].toJS())),e++,u=$.grep(i,function(n){return n.ProductID()==h})):(r[e].QtyOnHandGood(r[e].QtyOnHandGood()+t[f].QtyOnHandGood()),r[e].QtyOnHandHold(r[e].QtyOnHandHold()+t[f].QtyOnHandHold()),r[e].QtyOnHandBad(r[e].QtyOnHandBad()+t[f].QtyOnHandBad())),o[f].ProductCode(u[0].ProductCode()),o[f].Product(u[0].Product()),o[f].ProductUOMLID(u[0].ProductUOMLID()),o[f].ProductUOMMID(u[0].ProductUOMMID()),o[f].ProductUOMSID(u[0].ProductUOMSID()),o[f].ProductConversionL(u[0].ProductConversionL()),o[f].ProductConversionM(u[0].ProductConversionM()),o[f].ProductConversionS(u[0].ProductConversionS()),r[e].ProductCode(u[0].ProductCode()),r[e].Product(u[0].Product()),r[e].ProductUOMLID(u[0].ProductUOMLID()),r[e].ProductUOMMID(u[0].ProductUOMMID()),r[e].ProductUOMSID(u[0].ProductUOMSID()),r[e].ProductConversionL(u[0].ProductConversionL()),r[e].ProductConversionM(u[0].ProductConversionM()),r[e].ProductConversionS(u[0].ProductConversionS());s=o;l=r;s.length==0?DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Product lot stock with item status Good for the selected warehouse is empty."),"New Order Details Failed"):n();hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product lot data."),"Download Product Lot Failed");hideLoadingPanel()})}else DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("The selected Salesman does not have any reference products."),"New Order Details Failed"),hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product data."),"Download Product Failed");hideLoadingPanel()})}else n()}var ut=!1,ii=t.layoutController.name==="split",ct=$.Deferred(),lt=ko.observable(),o,g,c,nt,u,e,i,h,r;o=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrders,select:["DocumentID","DocumentCode","TransactionDate","Territory","Region","Area","Company","Site","Customer","Salesman","Warehouse","TotalGross","TotalTax","Total","ReferenceNumber","DocumentStatusName","PostedDate","CreatedDate","CreatedByUserName","ModifiedDate","ModifiedByUserName"],map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vSalesOrders.on("modified",at);var fi=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderDetails,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderDetailsViewModel(n)}}),ei=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderSummaries,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderSummaryViewModel(n)}}),s,l,tt,it,pt={type:"pattern",pattern:"(^[0-9]*$)|(^[0-9]*/[0-9]*$)|(^[0-9]*/[0-9]*/[0-9]*$)",message:"Format must be L/M/S or M/S or S."};u=new Dismoyo_Ciptoning_Client.CollapsibleFilter;u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){nt&&nt.resizeAll()})};u.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Region",["Territory"],["Area","Site"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Salesman","Warehouse"])}}}]},{itemType:"group",caption:"Sales Order",colCount:3,colSpan:3,items:[{name:"DocumentCode",dataField:"",label:{text:"Document Number"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateFrom",label:{text:"Transaction Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateTo",label:{text:"Transaction Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"SalesmanID",label:{text:"Salesman"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSalesmanDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Salesman",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Salesman",["Warehouse"],[])}}},{dataField:"WarehouseID",label:{text:"Warehouse"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){var i=null,t,r;i=Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?u.form().getEditor("SiteID").option("value"):Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID();t=u.form().getEditor("SalesmanID");r=t.option("selectedItem");r&&r.WarehouseID()!=n.value&&t.option("value",null);i==undefined?t.option("dataSource",DataUtility.GetLookupSalesmanDataSource(n.value?["WarehouseID","=",n.value]:null)):t.option("dataSource",DataUtility.GetLookupSalesmanDataSource(n.value?[["WarehouseID","=",n.value],"and",["SiteID","=",i]]:["SiteID","=",i]))}}},{dataField:"CustomerID",label:{text:"Customer"},editorType:"dxSelectBox",editorOptions:{dataSource:new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["ID","Customer","SiteID"],map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)},filter:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]}),displayExpr:"Customer",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}}]}];u.events.performSearch=function(){var f=e.dataGrid(),i=u.form(),n=[],t;f.clearFilter();var r=Dismoyo_Ciptoning_Client.app.CurrentUser,o=r.TerritoryID(),s=r.RegionID(),h=r.AreaID(),c=r.CompanyID(),l=r.SiteID();i.itemOption("Organization").visible&&(o=i.getEditor("TerritoryID").option("value"),s=i.getEditor("RegionID").option("value"),h=i.getEditor("AreaID").option("value"),c=i.getEditor("CompanyID").option("value"),l=i.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",o,"and");DXUtility.addFilterExpression(n,"RegionID","=",s,"and");DXUtility.addFilterExpression(n,"AreaID","=",h,"and");DXUtility.addFilterExpression(n,"CompanyID","=",c,"and");DXUtility.addFilterExpression(n,"SiteID","=",l,"and");t=i.getEditor("SalesmanID").option("value");DXUtility.addFilterExpression(n,"SalesmanID","=",t,"and");t=i.getEditor("WarehouseID").option("value");DXUtility.addFilterExpression(n,"WarehouseID","=",t,"and");t=i.getEditor("DocumentCode").option("value");DXUtility.addFilterExpression(n,"DocumentCode","contains",t,"and");t=i.getEditor("TransactionDateFrom").option("value");DXUtility.addFilterExpression(n,"TransactionDate",">=",t,"and");t=i.getEditor("TransactionDateTo").option("value");DXUtility.addFilterExpression(n,"TransactionDate","<=",t,"and");t=i.getEditor("CustomerID").option("value");DXUtility.addFilterExpression(n,"CustomerID","=",t,"and");t=i.getEditor("DocumentStatusID").option("value");DXUtility.addFilterExpression(n,"DocumentStatusID","=",t,"and");n.length>0?f.filter(n):f.refresh()};e=new Dismoyo_Ciptoning_Client.CommonGridView;e.dataGridOptions.dataSource=o;e.dataGridOptions.editing.editEnabled=!1;e.dataGridOptions.editing.removeEnabled=!1;e.dataGridOptions.selection.mode="single";e.deleteRowsOptions.visible=!1;e.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("SalesOrders.AddNewSalesOrder");e.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("SalesOrders.EditSalesOrder");e.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Territory",caption:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Region",caption:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Area",caption:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Company",caption:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Site",caption:"Site",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"DocumentCode",caption:"Document Number",width:"140px",sortOrder:"desc",headerCellTemplate:function(n,t){var r=$("#vSalesOrders_commonGridView").find(".dx-datagrid:first-child"),i,u,f;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',u=Dismoyo_Ciptoning_Client.app.CurrentUser,u.IsHeadOffice()&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',e.dataGridOptions.editing.allowUpdating&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",f=r.find(".dx-header-row:first-child"),$(i).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: left;">'),r=$("<b>").text(t.data.DocumentCode());e.dataGridOptions.editing.allowUpdating&&(r=$('<a class="dx-link">').text(t.data.DocumentCode()).on("dxclick",function(){et(t.data.DocumentID(),!1)}));i.append(r);i.append("&nbsp;");n.append(i)}},{dataField:"TransactionDate",caption:"Transaction Date",width:"100px",customizeText:function(n){return n.value?n.value.toLocaleDateString():null}},{dataField:"Customer",caption:"Customer",width:"200px"},{dataField:"Salesman",caption:"Salesman",width:"200px"},{dataField:"Warehouse",caption:"Warehouse",width:"200px"},{dataField:"TotalGross",caption:"Total DPP",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"TotalTax",caption:"Total VAT",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"Total",caption:"Total",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"ReferenceNumber",caption:"Reference Number",width:"120px",validationRules:[{type:"required"}]},{dataField:"DocumentStatusName",caption:"Status",width:"80px"},{dataField:"PostedDate",caption:"Posted Date",width:"100px",customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleDateString():null}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}];e.dataGridOptions.editing.allowUpdating&&e.dataGridOptions.columns.push({width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){et(t.data.DocumentID(),!1)}));i.append("&nbsp;");n.append(i)}});i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.okOptions.text="Save";i.okOptions.icon="icons8-save";var f=function(){return DXUtility.getDXInstance(null,"#vSalesOrders_salesOrderSummaryDataGrid","dxDataGrid")},b=function(){return DXUtility.getDXInstance(null,"#vSalesOrders_salesOrderSummaryForm","dxForm")},pi=function(){return DXUtility.getDXInstance(null,"#vSalesOrders_salesOrderPrintDO","dxButton")},a=function(){return DXUtility.getDXInstance(null,"#vSalesOrders_salesOrderPost","dxButton")},k=function(){return DXUtility.getDXInstance(null,"#vSalesOrders_salesOrderDiscard","dxButton")},v=function(){return DXUtility.getDXInstance(null,"#vSalesOrders_salesOrderVoid","dxButton")},y=function(){return DXUtility.getDXInstance(null,"#vSalesOrders_salesOrderSaveAsDraftAndNew","dxButton")},d=function(){return DXUtility.getDXInstance(null,"#commonPopupEdit_ok","dxButton")},wi=function(){return DXUtility.getDXInstance(null,"#vSalesOrders_salesOrderSummaryNewRow","dxButton")},bi=function(){return DXUtility.getDXInstance(null,"#vSalesOrders_salesOrderSummaryDeleteRows","dxButton")},ht,ki=function(){for(var t=$(".dx-command-edit","[id$=SummaryDataGrid]"),n=0;n<t.length;n++)if($(t[n]).text().trim().indexOf("Save")>=0)return!0;return!1},ti=function(){var n=!1,r=!0,t=i.popupEditData();t.DocumentStatusID()&&(r=!1);(t.DocumentStatusID()==2||t.DocumentStatusID()==3||t.DocumentStatusID()==4)&&(n=!0);ki()||(d()&&a()&&v()&y()&&d().option("disabled",n),d().option("disabled",n),a().option("disabled",r||n),k().option("disabled",r||n),v().option("disabled",t.DocumentStatusID()!=2),y().option("disabled",n),clearInterval(ht))};return i.popupEditOptions.onContentReady=function(){var u=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop("Order Details"));var r=$('<div class="desktop-commonGridView-commands">'),e=$('<div id="vSalesOrders_salesOrderSummaryNewRow">').dxButton({text:"New",icon:"add",onClick:function(){var n=i.form().validate().isValid;n?st(function(){f().addRow()}):DevExpress.ui.dialog.alert("Please specify the required fields.","New Order Details Failed")}}),o=$('<div id="vSalesOrders_salesOrderSummaryDeleteRows">').dxButton({text:"Delete",icon:"remove",disabled:!0,onClick:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(n){n&&DXUtility.deleteSelectedRows(f())})}});r.append(e);r.append(o);n.append(r);n.append($('<div id="vSalesOrders_salesOrderSummaryDataGrid">').dxDataGrid({dataSource:[],showBorders:!0,paging:{enabled:!1},allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,editing:{editMode:"row",allowAdding:!1,allowUpdating:!0,allowDeleting:!0},onInitNewRow:function(n){d().option("disabled",!0);a().option("disabled",!0);k().option("disabled",!0);v().option("disabled",!0);y().option("disabled",!0);ht=setInterval(ti,500);n.data.QtyOrder=0;n.data.QtyOrderConv="0/0/0";n.data.AddDiscountStrataPercentage=0},onEditorPreparing:function(n){var t;n.parentType=="dataRow"&&(n.row!=undefined&&n.row.rowIndex!=undefined&&(n.component.editRowIndex=n.row.rowIndex),n.dataField=="Product"?(n.row.inserted?n.editorElement.dxLookup({dataSource:l,displayExpr:"Product",valueExpr:"Product",searchExpr:"Product",searchPlaceholder:"Product",popupWidth:"712px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){CommonUtility.createProductLookupHeader("vSalesOrders_productIDLookup",n.element,1)},itemTemplate:function(n,t,i){return CommonUtility.createProductLookupItem(n,i,1)},onValueChanged:function(t){var i,r;t.value&&(i=this.option("selectedItem"),i&&(n.component.cellValue(n.row.rowIndex,"QtyOnHand",i.QtyOnHand()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),r=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyOrderConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyOrder",r.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",r.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",r.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",r.qtyConvS),rt(n)));n.component.cellValue(n.row.rowIndex,"Product",t.value);n.setValue(t.value)}}):(st(function(){}),n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Product()))),n.cancel=!0):n.dataField=="PriceDate"?(n.editorElement.dxDateBox({showClearButton:!0,placeholder:"Transaction Date",value:n.value,onValueChanged:function(t){t.component.option("value",t.value);n.setValue(t.value);rt(n)}}),n.cancel=!0):n.dataField=="QtyOrderConv"?(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onEnterKey:function(){f().saveEditData()},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyOrder",i.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvL",i.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvM",i.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvS",i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value);rt(n)}}),n.cancel=!0):n.dataField=="AddDiscountStrataPercentage"&&(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==190||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onValueChanged:function(t){(t.value==null||t.value=="")&&(t.value=0);t.component.option("value",t.value);n.setValue(t.value);rt(n)}}),n.cancel=!0))},onRowInserted:function(n){CommonUtility.validateDataGridInsertedTransactionSummary(n.component,new Dismoyo_Ciptoning_Client.vSalesOrderSummaryViewModel(n.data).toJS());ni(n);CommonUtility.updateSalesOrderSummaryForm(b(),n.component);f().clearSelection()},onRowUpdated:function(n){n.data.ProductID=n.key.ProductID;ni(n);CommonUtility.updateSalesOrderSummaryForm(b(),n.component);f().clearSelection()},onRowRemoved:function(n){CommonUtility.validateDataGridRemovedTransactionSummary(n.component,n.data.toJS());CommonUtility.updateSalesOrderSummaryForm(b(),n.component)},onEditingStart:function(){d().option("disabled",!0);a().option("disabled",!0);k().option("disabled",!0);v().option("disabled",!0);y().option("disabled",!0);ht=setInterval(ti,500)},onRowUpdating:function(n){if(n.newData.QtyOrderConv){var t=CommonUtility.getConversion(n.newData.QtyOrderConv,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS"));n.newData.QtyConvL=t.qtyConvL;n.newData.QtyConvM=t.qtyConvM;n.newData.QtyConvS=t.qtyConvS;n.newData.QtyOrder=t.qtyTransaction}n.newData.SubtotalWeight=DXUtility.getValue(n.oldData,"SubtotalWeight");n.newData.SubtotalDimension=DXUtility.getValue(n.oldData,"SubtotalDimension");n.newData.UnitGrossPrice=DXUtility.getValue(n.oldData,"UnitGrossPrice");n.newData.RawSubtotalGrossPrice=DXUtility.getValue(n.oldData,"RawSubtotalGrossPrice");n.newData.RawSubtotalPrice=DXUtility.getValue(n.oldData,"RawSubtotalPrice");n.newData.RawDiscountStrata1Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata1Amount");n.newData.RawDiscountStrata2Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata2Amount");n.newData.RawDiscountStrata3Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata3Amount");n.newData.RawDiscountStrata4Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata4Amount");n.newData.RawDiscountStrata5Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata5Amount");n.newData.RawAddDiscountStrataAmount=DXUtility.getValue(n.oldData,"RawAddDiscountStrataAmount");n.newData.RawSubtotalDiscountStrata1=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata1");n.newData.RawSubtotalDiscountStrata2=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata2");n.newData.RawSubtotalDiscountStrata3=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata3");n.newData.RawSubtotalDiscountStrata4=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata4");n.newData.RawSubtotalDiscountStrata5=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata5");n.newData.RawSubtotalGross=DXUtility.getValue(n.oldData,"RawSubtotalGross");n.newData.RawSubtotal=DXUtility.getValue(n.oldData,"RawSubtotal");n.newData.SubtotalDiscountStrata1=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata1");n.newData.SubtotalDiscountStrata2=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata2");n.newData.SubtotalDiscountStrata3=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata3");n.newData.SubtotalDiscountStrata4=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata4");n.newData.SubtotalDiscountStrata5=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata5");n.newData.TaxPercentage=DXUtility.getValue(n.oldData,"TaxPercentage");n.newData.SubtotalGrossPrice=DXUtility.getValue(n.oldData,"SubtotalGrossPrice");n.newData.SubtotalPrice=DXUtility.getValue(n.oldData,"SubtotalPrice");n.newData.UnitPrice=n.component.cellValue(n.component.editRowIndex,"UnitPrice");n.newData.DiscountStrata1Percentage=DXUtility.getValue(n.oldData,"DiscountStrata1Percentage");n.newData.DiscountStrata1Amount=DXUtility.getValue(n.oldData,"DiscountStrata1Amount");n.newData.DiscountStrata2Percentage=DXUtility.getValue(n.oldData,"DiscountStrata2Percentage");n.newData.DiscountStrata2Amount=DXUtility.getValue(n.oldData,"DiscountStrata2Amount");n.newData.DiscountStrata3Percentage=DXUtility.getValue(n.oldData,"DiscountStrata3Percentage");n.newData.DiscountStrata3Amount=DXUtility.getValue(n.oldData,"DiscountStrata3Amount");n.newData.DiscountStrata4Percentage=DXUtility.getValue(n.oldData,"DiscountStrata4Percentage");n.newData.DiscountStrata4Amount=DXUtility.getValue(n.oldData,"DiscountStrata4Amount");n.newData.DiscountStrata5Percentage=DXUtility.getValue(n.oldData,"DiscountStrata5Percentage");n.newData.DiscountStrata5Amount=DXUtility.getValue(n.oldData,"DiscountStrata5Amount");n.newData.AddDiscountStrataAmount=n.component.cellValue(n.component.editRowIndex,"AddDiscountStrataAmount");n.newData.SubtotalGross=n.component.cellValue(n.component.editRowIndex,"SubtotalGross");n.newData.SubtotalTax=n.component.cellValue(n.component.editRowIndex,"SubtotalTax");n.newData.Subtotal=n.component.cellValue(n.component.editRowIndex,"Subtotal");si(n.oldData.ProductID(),n.newData)},onRowValidating:function(n){var i=DXUtility.getValue(n.newData,"QtyOnHand"),t;i==undefined&&(i=DXUtility.getValue(n.oldData,"QtyOnHand"));t=DXUtility.getValue(n.newData,"QtyOrder");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyOrder"));t<=0&&(n.errorText="Order Qty must be greater than 0.",n.isValid=!1);n.isValid&&t>i&&(n.errorText="Order Qty must be less than or equal to On Hand Qty.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},onDataErrorOccurred:function(n){var t=n.component._controllers.editing._editData[0].data.Product;switch(n.error.__id){case"E4008":n.error.message="Product '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},columns:[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"Product",caption:"Product",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$(f().element()),r,i,e;!u.find(".datagrid-bandedHeader:first").length>0&&(r=f().option("selection").mode=="none"?!1:!0,i='<tr class="dx-row dx-column-lines datagrid-bandedHeader" style="border-top-style: none !important;">',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colSpan="1">Disc 1-5<\/td>',i+='       <td class="dx-datagrid-action" colSpan="2">Additional Disc<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",e=u.find(".dx-header-row:first-child"),$(i).insertBefore(e[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"120px",allowEditing:!1,dataType:"number"},{dataField:"PriceDate",caption:"Price Date",width:"140px",dataType:"date"},{dataField:"UnitPrice",caption:"Unit Price",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"QtyOrderConv",caption:"Qty (L/M/S)",width:"100px",alignment:"right",validationRules:[{type:"required"},pt],cellTemplate:function(n,t){n.append(ci(t.data,"QtyOrderConv",1))}},{dataField:"DiscountStrataDefaultAmount",caption:"Amount",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2,calculateCellValue:function(n){var t=DXUtility.getValue(n,"DiscountStrata1Amount"),i=DXUtility.getValue(n,"DiscountStrata2Amount"),r=DXUtility.getValue(n,"DiscountStrata3Amount"),u=DXUtility.getValue(n,"DiscountStrata4Amount"),f=DXUtility.getValue(n,"DiscountStrata5Amount");return isNaN(t)&&(t=0),isNaN(i)&&(i=0),isNaN(r)&&(r=0),isNaN(u)&&(u=0),isNaN(f)&&(f=0),t+i+r+u+f}},{dataField:"AddDiscountStrataPercentage",caption:"%",width:"40px",dataType:"number",format:"fixedPoint",precision:2},{dataField:"AddDiscountStrataAmount",caption:"Amount",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"SubtotalGross",caption:"DPP",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"SubtotalTax",caption:"VAT",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"Subtotal",caption:"Subtotal",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2}]}));n.append($('<div id="vSalesOrders_salesOrderSummaryForm" style="margin-top: 9px;">').dxForm({deferRendering:!1,colCount:4,showColonAfterLabel:!1,labelLocation:"left",alignItemLabels:!0,items:[{itemType:"empty",colSpan:3},{dataField:"TotalGross",label:{text:"Total DPP"},colSpan:1,cssClass:"salesOrderSummaryForm-item-label salesOrderSummaryForm-item-textInput",editorOptions:{readOnly:!0}},{itemType:"empty",colSpan:2},{itemType:"empty",colSpan:1},{dataField:"TotalTax",label:{text:"Total VAT"},colSpan:1,cssClass:"salesOrderSummaryForm-item-label salesOrderSummaryForm-item-textInput",editorOptions:{readOnly:!0}},{itemType:"empty",colSpan:3},{dataField:"Total",label:{text:"Total"},colSpan:1,cssClass:"salesOrderSummaryForm-item-label salesOrderSummaryForm-item-textInput",editorOptions:{readOnly:!0}}]}));var t=$("#commonPopupEdit_extCommands"),s=$('<div id="vSalesOrders_salesOrderPrintDO" style="margin-right: 32px;">').dxButton({text:"Print DO",icon:"icons8-print",onClick:function(){i.events.performPrintDO(this)}}),h=$('<div id="vSalesOrders_salesOrderPost">').dxButton({text:"Post",icon:"icons8-check-green",onClick:function(){i.events.performPost(this)}}),c=$('<div id="vSalesOrders_salesOrderDiscard">').dxButton({text:"Discard",icon:"icons8-trash-red",onClick:function(){i.events.performDiscard(this)}}),p=$('<div id="vSalesOrders_salesOrderVoid" style="margin-right: 16px;">').dxButton({text:"Void",icon:"icons8-delete-red",onClick:function(){i.events.performVoid(this)}}),w=$('<div id="vSalesOrders_salesOrderSaveAsDraftAndNew">').dxButton({text:"Save & New",icon:"icons8-save",onClick:function(){i.events.performSaveAsDraftAndNew(this)}});u.append(DXUtility.createFormItemGroupWithCaption("").append(n));t.append(s);t.append(h);t.append(c);t.append(p);t.append(w)},e.events.performNewRow=function(){ot(null)},i.events.performOK=function(){p(null,3)},i.events.performPrintDO=function(){var n=i.popupEditData();ai(n.DODocumentID())},i.events.performPost=function(){DevExpress.ui.dialog.confirm("Are you sure want to Post this transaction?","Post Confirmation").done(function(n){n&&p(2,3)})},i.events.performDiscard=function(){DevExpress.ui.dialog.confirm("Are you sure want to Discard this transaction?","Discard Confirmation").done(function(n){n&&p(3,3)})},i.events.performVoid=function(){DevExpress.ui.dialog.confirm("Are you sure want to Void this transaction?","Void Confirmation").done(function(n){n&&p(4,3)})},i.events.performSaveAsDraftAndNew=function(){p(1,2)},i.events.performCancel=function(){i.popupEditOptions.visible(!1);g&&(e.dataGrid().refresh(),g=!1)},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area","Site"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form(),r,u;CommonUtility.cascadeValueChanged(t,n.selectedItem,n.value,"Site",["Area","Region","Territory"],[]);r="";u="";n.selectedItem?(r=wt(n.selectedItem.Code()),u=bt(n.selectedItem.Code()),t.getEditor("Company").option("value",n.selectedItem.Company())):n.previousValue!=null&&t.getEditor("Company").option("value",null);kt(t,n.value);t.getEditor("DocumentCode").option("value",r);t.getEditor("DODocumentCode").option("value",u)}}}]},{itemType:"group",caption:"Sales Order",colCount:6,colSpan:3,items:[{dataField:"DocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"TransactionDate",label:{text:"Transaction Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();t.getEditor("DOShipmentDate").option("min",n.value)}}},{dataField:"DocumentStatusID",label:{text:"Status"},colSpan:1,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"NEW",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"CustomerID",label:{text:"Customer"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxLookup",editorOptions:{dataSource:[],displayExpr:"Customer",valueExpr:"ID",searchExpr:["Code","Name","Address1","Address2","Address3"],searchPlaceholder:"Customer/Address",searchEnabled:!1,popupWidth:"1082px",showPopupTitle:!1,fieldEditEnabled:!0,onOpened:function(){},onClosed:function(){},onContentReady:function(n){var t=i.form(),r=Dismoyo_Ciptoning_Client.app.CurrentUser;CommonUtility.createCustomerLookupHeader("vSalesOrders_customerIDLookup",n.element,oi("Customer.Category1"),r.SiteID(),t)},itemTemplate:function(n,t,i){return CommonUtility.createCustomerLookupItem(n,i)},onValueChanged:function(n){var t;if(n.value&&(t=n.selectedItem,t)){var r=i.popupEditData(),u=i.form(),f=null,e=null,o=null;tt=undefined;it=undefined;r.PriceGroupID(undefined);r.DiscountGroupID(undefined);t&&(f=t.SalesmanID(),e=t.WarehouseID(),o=t.TermOfPaymentID(),tt=Dismoyo_Ciptoning_Client.LocalStore.vProductPrices.dataByFilter(["PriceGroupID","=",t.PriceGroupID()]),it=Dismoyo_Ciptoning_Client.LocalStore.vDiscountGroups.expandedDataByKey(t.DiscountGroupID()),r.PriceGroupID(t.PriceGroupID()),r.DiscountGroupID(t.DiscountGroupID()));n.component.option("value",n.value);u.getEditor("SalesmanID").option("value",f);u.getEditor("WarehouseID").option("value",e);dt(u,o)}}}},{itemType:"empty",colSpan:3},{dataField:"SalesmanID",label:{text:"Salesman"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Salesman",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var u=i.form(),t=null,r=i.popupEditData();n.selectedItem&&(t=n.selectedItem.WarehouseID());u.getEditor("WarehouseID").option("value",t);s=[];l=[];n.value&&(f().cancelEditData(),r.ChildSummaries([]),f().option("dataSource",ft(r.ChildSummaries())))}}},{dataField:"WarehouseID",label:{text:"Warehouse"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"",readOnly:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){if(s=[],l=[],n.value){var t=i.popupEditData(),r=f();r.cancelEditData();t.ChildSummaries([]);r.option("dataSource",ft(t.ChildSummaries()))}}}},{itemType:"empty",colSpan:1},{dataField:"TermOfPaymentID",validationRules:[{type:"required"}],label:{text:"Term of Payment"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"ReferenceNumber",label:{text:"Reference Number"},colSpan:3,editorOptions:{maxLength:30,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1}]},{itemType:"group",caption:"Purchase Order",colCount:6,colSpan:3,items:[{dataField:"PODocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{maxLength:30,onEnterKey:function(){commSonPopupEdit.events.performOK(this)}}},{dataField:"POTransactionDate",label:{text:"Transaction Date"},colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(){var n=i.form()}}},{itemType:"empty"}]},{itemType:"group",caption:"Delivery Order",colCount:6,colSpan:3,items:[{dataField:"DODocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){commSonPopupEdit.events.performOK(this)}}},{dataField:"DOShipmentDate",label:{text:"Shipment Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();t.getEditor("DOReceivedDate").option("min",n.value)}}},{itemType:"empty"},{dataField:"DOPrintedCount",label:{text:"Printed Count"},colSpan:1,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DOLastPrintedDate",label:{text:"Last Printed Date"},colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DOReceivedDate",label:{text:"Received Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],h=new Dismoyo_Ciptoning_Client.CommonPopupIFrame,h.okOptions.visible=!1,h.cancelOptions.text="Close",r=new Dismoyo_Ciptoning_Client.ProductLotPopupEdit,r.formOptions.colCount=4,r.saveOptions.icon="icons8-save",r.events.performSave=function(){yi()},r.dataGridOptions.onInitNewRow=function(n){n.data.QtyOrder=0;n.data.QtyOrderConv="0/0/0"},r.dataGridOptions.onEditorPreparing=function(n){var i,u,t;n.parentType=="dataRow"&&(n.dataField=="ProductLotCode"?(n.row.inserted?(i=r.popupEditOptions.itemStatusID,u=w(i),n.editorElement.dxLookup({dataSource:new DevExpress.data.DataSource({store:s,filter:[["ProductID","=",r.popupEditData().ProductID()],"and",[u.qtyOnHandColumn,">",0]],sort:[{getter:"ProductLotExpiredDate",desc:!0}]}),displayExpr:"ProductLotCode",valueExpr:"ProductLotCode",searchExpr:"ProductLotCode",searchPlaceholder:"Lot Number",popupWidth:"582px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){var t=r.popupEditOptions.itemStatusID;CommonUtility.createProductLotLookupHeader("vSalesOrders_productLotIDLookup",n.element,t)},itemTemplate:function(n,t,i){var u=r.popupEditOptions.itemStatusID,f=w(u);return CommonUtility.createProductLotLookupItem(n,i,f.qtyOnHandColumn)},onValueChanged:function(t){var i,e,f,u;t.value&&(i=this.option("selectedItem"),i&&(e=r.popupEditOptions.itemStatusID,f=w(e),n.component.cellValue(n.row.rowIndex,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductLotID",i.ProductLotID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductLotCode",i.ProductLotCode()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),u=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyOrderConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyOrder",u.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",u.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",u.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",u.qtyConvS)));n.component.cellValue(n.row.rowIndex,"ProductLotCode",t.value);n.setValue(t.value)}})):(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.ProductLotCode()))),n.cancel=!0):n.dataField=="QtyOrderConv"&&(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onEnterKey:function(){f().saveEditData()},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyOrder",i.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvL",i.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvM",i.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvS",i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}}),n.cancel=!0))},r.dataGridOptions.onRowInserted=function(n){CommonUtility.validateDataGridInsertedTransactionDetails(n.component,new Dismoyo_Ciptoning_Client.vSalesOrderDetailsViewModel(n.data).toJS())},r.dataGridOptions.onRowRemoved=function(n){CommonUtility.validateDataGridRemovedTransactionDetails(n.component,n.data.toJS())},r.dataGridOptions.onRowUpdating=function(n){CommonUtility.validateDataGridUpdatingTransactionDetails(n,"QtyConvL","QtyConvM","QtyConvS","QtyOrderConv","QtyOrder")},r.dataGridOptions.onRowValidating=function(n){var u=r.popupEditOptions.itemStatusID,f=w(u),i=DXUtility.getValue(n.newData,"QtyOnHand"),t;i==undefined&&(i=DXUtility.getValue(n.oldData,"QtyOnHand"));t=DXUtility.getValue(n.newData,"QtyOrder");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyOrder"));t<=0&&(n.errorText="Order Qty must be greater than 0.",n.isValid=!1);n.isValid&&t>i&&(n.errorText="Order Qty must be less than or equal to On Hand Qty.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.onDataErrorOccurred=function(n){var t=n.component._controllers.editing._editData[0].data.ProductLotCode;switch(n.error.__id){case"E4008":n.error.message="Lot Number '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.summary={totalItems:[{name:"TotalQtyPcs",showInColumn:"QtyOrderConv",displayFormat:"Total Qty (Pcs): {0}",valueFormat:"decimal",summaryType:"custom"},{name:"TotalQtyLMS",showInColumn:"QtyOrderConv",displayFormat:"(L/M/S): {0}",valueFormat:"string",summaryType:"custom"}],calculateCustomSummary:function(n){CommonUtility.updateProductLotEditingSummary(n,"QtyOrderConv","QtyOrder")}},r.dataGridOptions.columns=[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"ProductLotID",visible:!1},{dataField:"ProductLotCode",caption:"Lot Number",validationRules:[{type:"required"}]},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"120px",allowEditing:!1,dataType:"number"},{dataField:"QtyOrderConv",caption:"Order Qty (L/M/S)",width:"150px",alignment:"right",validationRules:[{type:"required"},pt]}],r.formOptions.items=[{itemType:"group",caption:"Product",colCount:4,colSpan:4,items:[{dataField:"Product",label:{text:"Product"},colSpan:4,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOnHand",label:{text:"On Hand Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2},{dataField:"QtyOrder",label:{text:"Order Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOrderConv",label:{text:"(L/M/S)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],{isReady:ct.promise(),dataSource:o,refreshList:yt,viewShowing:ri,viewDisposing:ui,openCreateViewAsRoot:ii,icon:"Images/sales_order_32px.png",dataSource_vSalesOrderDetails:fi,dataSource_vSalesOrderSummary:ei,dataSource_vStockOnHandAvailable:s,dataSource_vStockOnHandAvailableByProduct:l,collapsibleFilter:u,commonGridView:e,commonPopupEdit:i,commonPopupIFrame:h,productLotPopupEdit:r,salesOrderSummaryDataGrid:f,salesOrderPost:a,salesOrderDiscard:k,salesOrderVoid:v,salesOrderSaveAsDraftAndNew:y,isLotNumberEntryRequired:c}};Dismoyo_Ciptoning_Client.vSalesOrderFOCs=function(n,t){"use strict";function vt(){ft=!0}function yt(){nt=CommonUtility.configureCommonGridViewLayout("vSalesOrderFOCs");nt||setTimeout(yt,50)}function ri(){var n,t;yt();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],s.filter(t));at()?ft&&pt():(at(s),s.load().always(function(){lt.resolve()}))}function ui(){Dismoyo_Ciptoning_Client.DB.vSalesOrderFOCs.off("modified",vt)}function pt(){ft=!1;s.pageIndex(0);s.load()}function bt(n){return(n?n:"(Site Code)")+"-YY-05-(Auto Generated)"}function kt(n){return(n?n:"(Site Code)")+"-YY-10-(Auto Generated)"}function dt(n,t){t?Dismoyo_Ciptoning_Client.DB.vSites.byKey(t).done(function(n){c=n.IsLotNumberEntryRequired}):(t=null,c=undefined);var i=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["ID","Customer","Address","Category1","SalesmanID","Salesman","WarehouseID","TermOfPaymentID","PriceGroupID","DiscountGroupID","SiteID"],filter:[["IsDeleted","=",!1],"and",["StatusID","=",1],"and",["SiteID","=",t]],map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)}}),r=DataUtility.GetLookupSalesmanDataSource([["IsDeleted","=",!1],"and",["StatusID","=",1],"and",["SiteID","=",t]]);n.getEditor("CustomerID").option("value",null);n.getEditor("CustomerID").option("dataSource",i);i.load();n.getEditor("SalesmanID").option("value",null);n.getEditor("SalesmanID").option("dataSource",r);r.load()}function gt(n,t){var i=[["Group","=","CustomerTermOfPayment"]],r;t!=undefined&&t!=null&&(i.push("and"),i.push(["Value_Int32","<=",t]));r=DataUtility.GetLookupSystemLookupDataSource(i);n.getEditor("TermOfPaymentID").option("value",null);n.getEditor("TermOfPaymentID").option("dataSource",r);n.getEditor("TermOfPaymentID").option("value",t);r.load()}function oi(n){var t=Dismoyo_Ciptoning_Client.LocalStore.vSystemParameters.dataByFilter(["ID","=",n]);return t.length>0?t[0].Value():null}function rt(n){return CommonUtility.calcProductPriceAndDiscount(i.form().getEditor("TransactionDate").option("value"),n.component,n.row.rowIndex,n.row.data,tt,it,!0)}function ni(n){CommonUtility.updateSummariesArrayStore(f().option("dataSource").store(),n)}function si(n,t){CommonUtility.updateDeferSummariesArrayStore(f().option("dataSource").store(),n,t)}function hi(n){return CommonUtility.validateSummaryArrayStore(f().option("dataSource").store(),"vSalesOrderFOCSummaryViewModel",n)}function et(n){return CommonUtility.createArrayDataSource("vSalesOrderFOCSummaryViewModel",["ProductID"],n)}function ci(n,t,i){var r=$('<div class="dx-command-edit" style="text-align: right; padding-right: 5px;">'),o;if(r.append($('<a style="color: inherit;">').text(n[t]())),r.append("&nbsp;"),c){var u=t.replace("Conv",""),s=n[u](),f=n.ChildDetails(),e=0;for(o in f)e+=f[o][u]();r.append($('<a class="dx-link dxcustom-linkbutton dx-icon-icons8-view-details" title="Edit Lot Number">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<\/a><span id="LotMark_'+n.ProductID()+"_"+t+'" class="dx-icon-overflow '+(e==s?"hidden":"")+'" style="color:red; font-size: 14px; margin-left: -6px;"><\/span>').on("dxclick",function(){ut(function(){vi(n,i)})}));r.append("&nbsp;")}return r}function li(n){var t=f().option("editing"),i=f().option("selection");i.mode=n?"multiple":"none";t.allowUpdating=n;t.allowDeleting=n;f().option("editing",t);f().option("selection",i);wi().option("disabled",!n);bi().option("disabled",!0);f().repaint()}function ot(n,t){showLoadingPanel();new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderFOCs,select:["DocumentID","DocumentCode","TransactionDate","PODocumentID","PODocumentCode","POTransactionDate","SalesmanID","WarehouseID","SiteID","CompanyID","Company","AreaID","RegionID","TerritoryID","CustomerID","PriceGroupID","DiscountGroupID","TermOfPaymentID","ReferenceNumber","DODocumentID","DODocumentCode","DOShipmentDate","DOReceivedDate","DOPrintedCount","DOLastPrintedDate","RawTotalGrossPrice","RawTotalPrice","RawTotalDiscountStrata1Amount","RawTotalDiscountStrata2Amount","RawTotalDiscountStrata3Amount","RawTotalDiscountStrata4Amount","RawTotalDiscountStrata5Amount","RawTotalAddDiscountStrataAmount","RawTotalGross","RawTotalTax","RawTotal","TotalGrossPrice","TotalPrice","TotalDiscountStrata1Amount","TotalDiscountStrata2Amount","TotalDiscountStrata3Amount","TotalDiscountStrata4Amount","TotalDiscountStrata5Amount","TotalAddDiscountStrataAmount","TotalGross","TotalTax","Total","TotalWeight","TotalDimension","AddDiscountStrataReason","DocumentStatusID","DocumentStatusReason"],filter:["DocumentID","=",n],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderFOCViewModel(n)}}).load().done(function(i){i.length>0?new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderFOCSummaries,select:["DocumentID","ProductID","ProductCode","Product","ProductUOMLID","ProductUOMMID","ProductUOMSID","ProductWeight","ProductDimensionL","ProductDimensionW","ProductDimensionH","ProductConversionL","ProductConversionM","ProductConversionS","QtyOnHand","QtyConvL","QtyConvM","QtyConvS","Qty","QtyOrderConv","QtyOrder","UnitGrossPrice","UnitPrice","DiscountStrata1Percentage","DiscountStrata2Percentage","DiscountStrata3Percentage","DiscountStrata4Percentage","DiscountStrata5Percentage","AddDiscountStrataPercentage","TaxPercentage","RawSubtotalGrossPrice","RawSubtotalPrice","RawSubtotalDiscountStrata1","RawDiscountStrata1Amount","RawSubtotalDiscountStrata2","RawDiscountStrata2Amount","RawSubtotalDiscountStrata3","RawDiscountStrata3Amount","RawSubtotalDiscountStrata4","RawDiscountStrata4Amount","RawSubtotalDiscountStrata5","RawDiscountStrata5Amount","RawAddDiscountStrataAmount","RawSubtotalGross","RawSubtotalTax","RawSubtotal","SubtotalGrossPrice","SubtotalPrice","SubtotalDiscountStrata1","DiscountStrata1Amount","SubtotalDiscountStrata2","DiscountStrata2Amount","SubtotalDiscountStrata3","DiscountStrata3Amount","SubtotalDiscountStrata4","DiscountStrata4Amount","SubtotalDiscountStrata5","DiscountStrata5Amount","AddDiscountStrataAmount","SubtotalGross","SubtotalTax","Subtotal","SubtotalWeight","SubtotalDimension"],filter:["DocumentID","=",n],sort:["ProductID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderFOCSummaryViewModel(n)}}).load().done(function(r){r.length>0?new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderFOCDetails,select:["DocumentID","ProductID","ProductLotID","ProductLotCode","QtyOnHand","QtyConvL","QtyConvM","QtyConvS","Qty","QtyOrderConv","QtyOrder"],filter:["DocumentID","=",n],sort:["ProductID","ProductLotID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderFOCDetailsViewModel(n)}}).load().done(function(n){var u,f,o,e;if(n.length>0){for(u=r,f=-1,o=0;o<n.length;o++)e=n[o],(o==0||u[f].ProductID()!=e.ProductID())&&(f++,u[f].ChildDetails=ko.observableArray([])),e.ProductCode(u[f].ProductCode()),e.Product(u[f].Product()),e.ProductUOMLID(u[f].ProductUOMLID()),e.ProductUOMMID(u[f].ProductUOMMID()),e.ProductUOMSID(u[f].ProductUOMSID()),e.ProductConversionL(u[f].ProductConversionL()),e.ProductConversionM(u[f].ProductConversionM()),e.ProductConversionS(u[f].ProductConversionS()),u[f].ChildDetails().push(e);i[0].ChildSummaries(u);hideLoadingPanel();g=t;st(i[0])}else DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("The details of selected data is not found."),"Load Failed"),hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load details of selected data."),"Load Failed");hideLoadingPanel()}):(DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("The summary of selected data is not found."),"Load Failed"),hideLoadingPanel())}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load summary of selected data."),"Load Failed");hideLoadingPanel()}):(DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("The selected data is not found."),"Load Failed"),hideLoadingPanel())}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function st(n){var e=!1,s,g,p,nt,rt,w,ft,ot,st,ct;n||(n=new Dismoyo_Ciptoning_Client.vSalesOrderFOCViewModel,e=!0);i.popupEditData(n);i.popupEdit().option("title",(e?"New":"Edit")+" Sales Order FOC");i.popupEditOptions.editingKey=n.DocumentID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);var u=Dismoyo_Ciptoning_Client.app.CurrentUser,t=i.form(),d=b();DXUtility.resetFormValidation(t);var lt=n.DocumentCode(),at=n.DODocumentCode(),r=!1,h=[];if(c=n.IsSiteLotNumberEntryRequired(),e)n.DocumentID(new DevExpress.data.Guid),n.DocumentStatusID(null),u.IsHeadOffice()||(n.TerritoryID(u.TerritoryID()),n.RegionID(u.RegionID()),n.AreaID(u.AreaID()),n.SiteID(u.SiteID()),n.SiteCode(u.SiteCode()),n.CompanyID(u.CompanyID()),n.Company(u.Company())),lt=bt(n.SiteCode()),at=kt(n.SiteCode());else if(h=n.ChildSummaries(),n.DocumentStatusID()!=1||c)(n.DocumentStatusID()==2||n.DocumentStatusID()==3||n.DocumentStatusID()==4)&&(r=!0);else{for(s=[],g=0,p=0;p<h.length;p++){for(nt=h[p].ChildDetails(),rt=0,w=0;w<nt.length;w++)nt[w].ProductLotCode().indexOf("DUMMY")<0&&rt++;rt>0&&(s[g]=h[p],g++)}s.length>0&&(o=[],l=[],t.getEditor("SalesmanID").option("value",n.SalesmanID()),ut(function(){for(var t,n=0;n<s.length;n++)t={data:s[n].toJS()},ht(t,s)}))}li(!r);pi().option("disabled",e);a().option("disabled",e||r);k().option("disabled",e||r);v().option("disabled",n.DocumentStatusID()!=2);y().option("disabled",r);i.ok().option("disabled",r);ft=n.PriceGroupID();ot=n.DiscountGroupID();t.itemOption("Organization").visible&&(t.getEditor("TerritoryID").option("value",n.TerritoryID()),t.getEditor("RegionID").option("value",n.RegionID()),t.getEditor("AreaID").option("value",n.AreaID()),t.getEditor("SiteID").option("value",n.SiteID()),t.getEditor("Company").option("value",n.Company()),t.getEditor("TerritoryID").option("readOnly",r),t.getEditor("RegionID").option("readOnly",r),t.getEditor("AreaID").option("readOnly",r),t.getEditor("SiteID").option("readOnly",r));dt(t,n.SiteID());gt(t,n.TermOfPaymentID());t.getEditor("DocumentCode").option("value",lt);t.getEditor("TransactionDate").option("value",n.TransactionDate());t.getEditor("CustomerID").option("value",n.CustomerID());t.getEditor("SalesmanID").option("value",n.SalesmanID());t.getEditor("WarehouseID").option("value",n.WarehouseID());t.getEditor("TermOfPaymentID").option("value",n.TermOfPaymentID());t.getEditor("ReferenceNumber").option("value",n.ReferenceNumber());t.getEditor("DocumentStatusID").option("value",n.DocumentStatusID());t.getEditor("PODocumentCode").option("value",n.PODocumentCode());t.getEditor("POTransactionDate").option("value",n.POTransactionDate());t.getEditor("DODocumentCode").option("value",at);t.getEditor("DOShipmentDate").option("value",n.DOShipmentDate());t.getEditor("DOReceivedDate").option("value",n.DOReceivedDate());t.getEditor("DOPrintedCount").option("value",n.DOPrintedCount());t.getEditor("DOLastPrintedDate").option("value",n.DOLastPrintedDate());d.getEditor("TotalGross").option("value",CommonUtility.getNumberFormat(n.TotalGross()));d.getEditor("TotalTax").option("value",CommonUtility.getNumberFormat(n.TotalTax()));d.getEditor("Total").option("value",CommonUtility.getNumberFormat(n.Total()));t.getEditor("TransactionDate").option("readOnly",r);t.getEditor("CustomerID").option("readOnly",r);t.getEditor("SalesmanID").option("readOnly",r);t.getEditor("TermOfPaymentID").option("readOnly",r);t.getEditor("ReferenceNumber").option("readOnly",r);t.getEditor("PODocumentCode").option("readOnly",r);t.getEditor("POTransactionDate").option("readOnly",r);t.getEditor("DOShipmentDate").option("readOnly",r);t.getEditor("DOReceivedDate").option("readOnly",r);st=new Date;e?(DXUtility.resetFormValidation(t),t.getEditor("TransactionDate").option("value",st),t.getEditor("DOShipmentDate").option("value",st)):(ft&&n.PriceGroupID(ft),ot&&n.DiscountGroupID(ot),tt=Dismoyo_Ciptoning_Client.LocalStore.vProductPrices.dataByFilter(["PriceGroupID","=",n.PriceGroupID()]),it=Dismoyo_Ciptoning_Client.LocalStore.vDiscountGroups.expandedDataByKey(n.DiscountGroupID()));ct=f();ct.cancelEditData();n.ChildSummaries(h);ct.option("dataSource",et(n.ChildSummaries()))}function p(n,t){var p,ri,r,o,h,u,c,v,ui;showLoadingPanel();var s=i.form(),oi=b(),a=s.validate().isValid,l=a?"":"Please specify the required fields.",fi=e.dataGrid(),ei=fi.option("dataSource"),w=f().option("dataSource"),y=[];for(h=0;h<w.store()._array.length;h++)y.push(new Dismoyo_Ciptoning_Client.vSalesOrderFOCSummaryViewModel(w.store()._array[h]));a&&y.length<=0&&(l="Please specify at least one item in Order Details.",a=!1);var k=0,d=0,nt=0,tt=0,it=0,rt=0,ut=0,ft=0,et=0,ht=0,ct=0,lt=0,at=0,vt=0,yt=0,pt=0,wt=0,bt=0,kt=0,dt=0,gt=0,ni=0,ti=0,ii=0;if(a)for(h=0;h<y.length;h++){for(u=y[h],p=0,k+=u.RawSubtotalGrossPrice(),d+=u.RawSubtotalPrice(),nt+=u.RawDiscountStrata1Amount(),tt+=u.RawDiscountStrata2Amount(),it+=u.RawDiscountStrata3Amount(),rt+=u.RawDiscountStrata4Amount(),ut+=u.RawDiscountStrata5Amount(),ft+=u.RawAddDiscountStrataAmount(),et+=u.RawSubtotalGross(),ht+=u.RawSubtotalTax(),ct+=u.RawSubtotal(),lt+=u.SubtotalGrossPrice(),at+=u.SubtotalPrice(),vt+=u.DiscountStrata1Amount(),yt+=u.DiscountStrata2Amount(),pt+=u.DiscountStrata3Amount(),wt+=u.DiscountStrata4Amount(),bt+=u.DiscountStrata5Amount(),kt+=u.AddDiscountStrataAmount(),dt+=u.SubtotalGross(),gt+=u.SubtotalTax(),ni+=u.Subtotal(),ti+=u.SubtotalWeight(),ii+=u.SubtotalDimension(),c=0;c<u.ChildDetails().length;c++)v=u.ChildDetails()[c],p+=v.QtyOrder();u.QtyOrder()!=p&&(l==""?l="Following products quantity of Order Details items is not matched: ":l+=", ",l+=u.Product(),a=!1)}if(ri=Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID(),s.itemOption("Organization").visible&&(ri=s.getEditor("SiteID").option("value")),a){for(r=i.popupEditData(),r.TransactionDate(s.getEditor("TransactionDate").option("value")),r.CustomerID(s.getEditor("CustomerID").option("value")),r.SalesmanID(s.getEditor("SalesmanID").option("value")),r.WarehouseID(s.getEditor("WarehouseID").option("value")),r.TermOfPaymentID(s.getEditor("TermOfPaymentID").option("value")),r.ReferenceNumber(s.getEditor("ReferenceNumber").option("value")),r.PODocumentCode(s.getEditor("PODocumentCode").option("value")),r.POTransactionDate(s.getEditor("POTransactionDate").option("value")),r.DOShipmentDate(s.getEditor("DOShipmentDate").option("value")),r.DOReceivedDate(s.getEditor("DOReceivedDate").option("value")),r.DOPrintedCount(s.getEditor("DOPrintedCount").option("value")),r.DOLastPrintedDate(s.getEditor("DOLastPrintedDate").option("value")),r.RawTotalGrossPrice(k),r.RawTotalPrice(d),r.RawTotalDiscountStrata1Amount(nt),r.RawTotalDiscountStrata2Amount(tt),r.RawTotalDiscountStrata3Amount(it),r.RawTotalDiscountStrata4Amount(rt),r.RawTotalDiscountStrata5Amount(ut),r.RawTotalAddDiscountStrataAmount(ft),r.RawTotalGross(et),r.RawTotalTax(ht),r.RawTotal(ct),r.TotalGrossPrice(lt),r.TotalPrice(at),r.TotalDiscountStrata1Amount(vt),r.TotalDiscountStrata2Amount(yt),r.TotalDiscountStrata3Amount(pt),r.TotalDiscountStrata4Amount(wt),r.TotalDiscountStrata5Amount(bt),r.TotalAddDiscountStrataAmount(kt),r.TotalGross(dt),r.TotalTax(gt),r.Total(ni),r.TotalWeight(ti),r.TotalDimension(ii),r.ChildSummaries(y),o=ko.toJS(r),n&&(o.DocumentStatusID=n),o.DocumentStatusID||(o.DocumentStatusID=1),o.TransactionDate=DateTimeUtility.getFirstTimeOfDay(o.TransactionDate),o.POTransactionDate&&(o.POTransactionDate=DateTimeUtility.getFirstTimeOfDay(o.POTransactionDate)),o.DOShipmentDate=DateTimeUtility.getFirstTimeOfDay(o.DOShipmentDate),o.DOReceivedDate=DateTimeUtility.getFirstTimeOfDay(o.DOReceivedDate),h=0;h<o.ChildSummaries.length;h++){for(u=o.ChildSummaries[h],u.DocumentID=o.DocumentID,c=0;c<u.ChildDetails.length;c++)v=u.ChildDetails[c],v.DocumentID=o.DocumentID,v.Qty=v.QtyOrder*-1;u.Qty=u.QtyOrder*-1}ei.store().insert(o).done(function(n){CommonUtility.documentSuccessMessage(n.DocumentStatusID,function(){});g=!0;switch(t){case 1:i.events.performCancel();hideLoadingPanel();break;case 2:st(null);hideLoadingPanel();break;case 3:ot(r.DocumentID(),!0)}}).fail(function(n){var t=$(".dx-popup-normal>.dx-dialog-content");t.length==0&&DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})}else hideLoadingPanel();l!=""&&(ui=$(".dx-popup-normal>.dx-dialog-content"),ui.length==0&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(l),"Save Failed"))}function ai(n){h.popupEdit().option("title","Print Delivery Order");h.popupEditOptions.visible(!0);var t=h.iframe();h.showLoadingPanel();t.attr("src",Dismoyo_Ciptoning_Client.ReportWebsite.ExtDeliveryOrderReport.url([["DocumentID","=",n]]))}function ht(n,t){var a,e,v,s,r,l,h;if(!c){var p=i.popupEditData(),y=f(),u=[];if(t){for(r=0;r<t.length;r++)t[r].ChildDetails([]);u=t}else for(a=y.option("dataSource").store(),r=0;r<a._array.length;r++)u.push(new Dismoyo_Ciptoning_Client.vSalesOrderFOCSummaryViewModel(a._array[r]));if(e=n.data,v=$.grep(o,function(n){return n.ProductID()==DXUtility.getValue(e,"ProductID")&&n.ProductLotCode().indexOf("DUMMY")>=0}),v.length>0)for(s=v[0],DXUtility.setValue(e,"ProductLotID",s.ProductLotID()),DXUtility.setValue(e,"ProductLotCode",s.ProductLotCode()),DXUtility.setValue(e,"QtyOnHandGood",s.QtyOnHandGood()),DXUtility.setValue(e,"QtyOnHandHold",s.QtyOnHandHold()),DXUtility.setValue(e,"QtyOnHandBad",s.QtyOnHandBad()),r=0;r<u.length;r++)u[r].ProductID()==DXUtility.getValue(e,"ProductID")&&(l=$.grep(u[r].ChildDetails(),function(n){return n.ProductLotID()==DXUtility.getValue(e,"ProductLotID")}),l.length==0&&(l=[new Dismoyo_Ciptoning_Client.vSalesOrderFOCDetailsViewModel(e)],u[r].ChildDetails().push(l[0])),h=l[0],h.QtyConvL(DXUtility.getValue(u[r],"QtyConvL")),h.QtyConvM(DXUtility.getValue(u[r],"QtyConvM")),h.QtyConvS(DXUtility.getValue(u[r],"QtyConvS")),h.QtyOrder(DXUtility.getValue(u[r],"QtyOrder")),h.QtyOrderConv(DXUtility.getValue(u[r],"QtyOrderConv")),ni(u[r]));else DevExpress.ui.dialog.alert("DUMMY Lot Number for the selected product is not available.","Save Failed")}}function w(n){var t=null;switch(n){case 1:t="Good";break;case 2:t="Hold";break;case 3:t="Bad"}var i="QtyOnHand"+t,r="QtyConvL"+t,u="QtyConvM"+t,f="QtyConvS"+t,e="QtyOrder"+t,o="QtyOrderConv"+t;return{itemStatusName:t,qtyOnHandColumn:i,qtyConvLColumn:r,qtyConvMColumn:u,qtyConvSColumn:f,qtyOrderColumn:e,qtyOrderConvColumn:o}}function vi(n,t){var o=i.popupEditData(),f,h,c;r.popupEditData(n);r.popupEditOptions.editingKey=n.ProductID();r.popupEditOptions.itemStatusID=t;r.popupEditOptions.visible(!0);var s=r.dataGrid(),e=r.form(),u=!1;(o.DocumentStatusID()==2||o.DocumentStatusID()==3||o.DocumentStatusID()==4)&&(u=!0);f=r.dataGrid().option("editing");f.allowUpdating=!u;f.allowDeleting=!u;f.editEnabled=!u;f.removeEnabled=!u;r.dataGrid().option("editing",f);r.dataGrid().option("selection",{mode:u?"none":"multiple"});r.newRow().option("disabled",u);r.dataGrid().repaint();e.getEditor("Product").option("value",n.Product());e.getEditor("QtyOnHand").option("value",n.QtyOnHand());e.getEditor("QtyOrderConv").option("value",n.QtyOrderConv());h=CommonUtility.getConversion(n.QtyOrderConv(),DXUtility.getValue(n,"ProductConversionL"),DXUtility.getValue(n,"ProductConversionM"),DXUtility.getValue(n,"ProductConversionS"));e.getEditor("QtyOrder").option("value",h.qtyTransaction);n=hi(n);c=CommonUtility.createArrayDataSource("vSalesOrderFOCDetailsViewModel",["ProductID","ProductLotID"],n.ChildDetails());s.cancelEditData();s.option("dataSource",c)}function yi(){var n=r.popupEditData(),t=r.popupEditOptions.itemStatusID,i=w(t);CommonUtility.validateProductLotEditing(n,r.dataGrid().option("dataSource"),r.form().getEditor("QtyOrder").option("value"),"Order","vSalesOrderFOCDetailsViewModel","QtyConvL","QtyConvM","QtyConvS","QtyOrderConv","QtyOrder",!1)&&(ni(n),r.popupEditOptions.visible(!1),f().refresh())}function ut(n){if(o.length==0&&l.length==0){showLoadingPanel();var t=i.form(),r=t.getEditor("SalesmanID").option("value");new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesmanProducts,select:["ProductID","ProductCode","Product","ProductUOMLID","ProductUOMMID","ProductUOMSID","ProductConversionL","ProductConversionM","ProductConversionS"],filter:[["SalesmanID","=",r],"and",["ProductName","notcontains","SAMPLE"]],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesmanProductViewModel(n)}}).load().done(function(i){var u,e;if(i.length>0){var h=i,s=t.getEditor("WarehouseID").option("value"),r=[],f=[];for(u=0;u<i.length;u++)DXUtility.addFilterExpression(f,"ProductID","=",i[u].ProductID(),"or");DXUtility.addGroupFilterExpression(r,f,"and");DXUtility.addFilterExpression(r,"WarehouseID","=",s,"and");DXUtility.addFilterExpression(r,"QtyOnHandGood",">",0,"and");e=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOnHandAvailables,select:["ProductID","ProductLotID","ProductLotCode","ProductLot","ProductLotExpiredDate","QtyOnHandGood"],filter:r,sort:["WarehouseID","ProductID","ProductLotID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(n)}});e.load().done(function(t){for(var e,h,u=null,s=[],r=[],f=0;f<t.length;f++)s.push(new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(t[f].toJS())),e=r.length-1,h=t[f].ProductID(),f==0||r[e].ProductID()!=h?(r.push(new Dismoyo_Ciptoning_Client.vStockOnHandAllViewModel(t[f].toJS())),e++,u=$.grep(i,function(n){return n.ProductID()==h})):(r[e].QtyOnHandGood(r[e].QtyOnHandGood()+t[f].QtyOnHandGood()),r[e].QtyOnHandHold(r[e].QtyOnHandHold()+t[f].QtyOnHandHold()),r[e].QtyOnHandBad(r[e].QtyOnHandBad()+t[f].QtyOnHandBad())),s[f].ProductCode(u[0].ProductCode()),s[f].Product(u[0].Product()),s[f].ProductUOMLID(u[0].ProductUOMLID()),s[f].ProductUOMMID(u[0].ProductUOMMID()),s[f].ProductUOMSID(u[0].ProductUOMSID()),s[f].ProductConversionL(u[0].ProductConversionL()),s[f].ProductConversionM(u[0].ProductConversionM()),s[f].ProductConversionS(u[0].ProductConversionS()),r[e].ProductCode(u[0].ProductCode()),r[e].Product(u[0].Product()),r[e].ProductUOMLID(u[0].ProductUOMLID()),r[e].ProductUOMMID(u[0].ProductUOMMID()),r[e].ProductUOMSID(u[0].ProductUOMSID()),r[e].ProductConversionL(u[0].ProductConversionL()),r[e].ProductConversionM(u[0].ProductConversionM()),r[e].ProductConversionS(u[0].ProductConversionS());o=s;l=r;o.length==0?DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Product lot stock with item status Good for the selected warehouse is empty."),"New Order Details Failed"):n();hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product lot data."),"Download Product Lot Failed");hideLoadingPanel()})}else DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("The selected Salesman does not have any reference products."),"New Order Details Failed"),hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product data."),"Download Product Failed");hideLoadingPanel()})}else n()}var ft=!1,ii=t.layoutController.name==="split",lt=$.Deferred(),at=ko.observable(),s,g,c,nt,u,e,i,h,r;s=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderFOCs,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderFOCViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vSalesOrderFOCs.on("modified",vt);var fi=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderFOCDetails,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderFOCDetailsViewModel(n)}}),ei=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderFOCSummaries,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderFOCSummaryViewModel(n)}}),o,l,tt,it,wt={type:"pattern",pattern:"(^[0-9]*$)|(^[0-9]*/[0-9]*$)|(^[0-9]*/[0-9]*/[0-9]*$)",message:"Format must be L/M/S or M/S or S."};u=new Dismoyo_Ciptoning_Client.CollapsibleFilter;u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){nt&&nt.resizeAll()})};u.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Salesman","Warehouse"])}}}]},{itemType:"group",caption:"Sales Order FOC",colCount:3,colSpan:3,items:[{name:"DocumentCode",dataField:"",label:{text:"Document Number"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateFrom",label:{text:"Transaction Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateTo",label:{text:"Transaction Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"SalesmanID",label:{text:"Salesman"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSalesmanDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Salesman",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Salesman",["Warehouse"],[])}}},{dataField:"WarehouseID",label:{text:"Warehouse"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){var i=null,t,r;i=Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?u.form().getEditor("SiteID").option("value"):Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID();t=u.form().getEditor("SalesmanID");r=t.option("selectedItem");r&&r.WarehouseID()!=n.value&&t.option("value",null);i==undefined?t.option("dataSource",DataUtility.GetLookupSalesmanDataSource(n.value?["WarehouseID","=",n.value]:null)):t.option("dataSource",DataUtility.GetLookupSalesmanDataSource(n.value?[["WarehouseID","=",n.value],"and",["SiteID","=",i]]:["SiteID","=",i]))}}},{dataField:"CustomerID",label:{text:"Customer"},editorType:"dxSelectBox",editorOptions:{dataSource:new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["ID","Customer","SiteID"],map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)},filter:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]}),displayExpr:"Customer",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}}]}];u.events.performSearch=function(){var f=e.dataGrid(),i=u.form(),n=[],t;f.clearFilter();var r=Dismoyo_Ciptoning_Client.app.CurrentUser,o=r.TerritoryID(),s=r.RegionID(),h=r.AreaID(),c=r.CompanyID(),l=r.SiteID();i.itemOption("Organization").visible&&(o=i.getEditor("TerritoryID").option("value"),s=i.getEditor("RegionID").option("value"),h=i.getEditor("AreaID").option("value"),c=i.getEditor("CompanyID").option("value"),l=i.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",o,"and");DXUtility.addFilterExpression(n,"RegionID","=",s,"and");DXUtility.addFilterExpression(n,"AreaID","=",h,"and");DXUtility.addFilterExpression(n,"CompanyID","=",c,"and");DXUtility.addFilterExpression(n,"SiteID","=",l,"and");t=i.getEditor("SalesmanID").option("value");DXUtility.addFilterExpression(n,"SalesmanID","=",t,"and");t=i.getEditor("WarehouseID").option("value");DXUtility.addFilterExpression(n,"WarehouseID","=",t,"and");t=i.getEditor("DocumentCode").option("value");DXUtility.addFilterExpression(n,"DocumentCode","contains",t,"and");t=i.getEditor("TransactionDateFrom").option("value");DXUtility.addFilterExpression(n,"TransactionDate",">=",t,"and");t=i.getEditor("TransactionDateTo").option("value");DXUtility.addFilterExpression(n,"TransactionDate","<=",t,"and");t=i.getEditor("CustomerID").option("value");DXUtility.addFilterExpression(n,"CustomerID","=",t,"and");t=i.getEditor("DocumentStatusID").option("value");DXUtility.addFilterExpression(n,"DocumentStatusID","=",t,"and");n.length>0?f.filter(n):f.refresh()};e=new Dismoyo_Ciptoning_Client.CommonGridView;e.dataGridOptions.dataSource=s;e.dataGridOptions.editing.editEnabled=!1;e.dataGridOptions.editing.removeEnabled=!1;e.dataGridOptions.selection.mode="single";e.deleteRowsOptions.visible=!1;e.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("SalesOrderFOC.AddNewSalesOrderFOC");e.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("SalesOrderFOC.EditSalesOrderFOC");e.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Territory",caption:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Region",caption:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Area",caption:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Company",caption:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Site",caption:"Site",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"DocumentCode",caption:"Document Number",width:"140px",sortOrder:"desc",headerCellTemplate:function(n,t){var r=$("#vSalesOrderFOCs_commonGridView").find(".dx-datagrid:first-child"),i,u,f;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',u=Dismoyo_Ciptoning_Client.app.CurrentUser,u.IsHeadOffice()&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',e.dataGridOptions.editing.allowUpdating&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",f=r.find(".dx-header-row:first-child"),$(i).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},cellTemplate:function(n,t){var u=Dismoyo_Ciptoning_Client.app.CurrentUser,f=u.isAuthorized("SalesOrderFOC.EditSalesOrderFOC"),i=$('<div class="dx-command-edit" style="text-align: left;">'),r=$("<b>").text(t.data.DocumentCode());f&&(r=$('<a class="dx-link">').text(t.data.DocumentCode()).on("dxclick",function(){ot(t.data.DocumentID(),!1)}));i.append(r);i.append("&nbsp;");n.append(i)}},{dataField:"TransactionDate",caption:"Transaction Date",width:"100px",customizeText:function(n){return n.value?n.value.toLocaleDateString():null}},{dataField:"Customer",caption:"Customer",width:"200px"},{dataField:"Salesman",caption:"Salesman",width:"200px"},{dataField:"Warehouse",caption:"Warehouse",width:"200px"},{dataField:"TotalGross",caption:"Total DPP",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"TotalTax",caption:"Total VAT",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"Total",caption:"Total",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"ReferenceNumber",caption:"Reference Number",width:"120px",validationRules:[{type:"required"}]},{dataField:"DocumentStatusName",caption:"Status",width:"80px"},{dataField:"PostedDate",caption:"Posted Date",width:"100px",customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleDateString():null}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}];e.dataGridOptions.editing.allowUpdating&&e.dataGridOptions.columns.push({width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){ot(t.data.DocumentID(),!1)}));i.append("&nbsp;");n.append(i)}});i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.okOptions.text="Save";i.okOptions.icon="icons8-save";var f=function(){return DXUtility.getDXInstance(null,"#vSalesOrderFOCs_salesOrderFOCSummaryDataGrid","dxDataGrid")},b=function(){return DXUtility.getDXInstance(null,"#vSalesOrderFOCs_salesOrderFOCSummaryForm","dxForm")},pi=function(){return DXUtility.getDXInstance(null,"#vSalesOrderFOCs_salesOrderFOCPrintDO","dxButton")},a=function(){return DXUtility.getDXInstance(null,"#vSalesOrderFOCs_salesOrderFOCPost","dxButton")},k=function(){return DXUtility.getDXInstance(null,"#vSalesOrderFOCs_salesOrderFOCDiscard","dxButton")},v=function(){return DXUtility.getDXInstance(null,"#vSalesOrderFOCs_salesOrderFOCVoid","dxButton")},y=function(){return DXUtility.getDXInstance(null,"#vSalesOrderFOCs_salesOrderFOCSaveAsDraftAndNew","dxButton")},d=function(){return DXUtility.getDXInstance(null,"#commonPopupEdit_ok","dxButton")},wi=function(){return DXUtility.getDXInstance(null,"#vSalesOrderFOCs_salesOrderFOCSummaryNewRow","dxButton")},bi=function(){return DXUtility.getDXInstance(null,"#vSalesOrderFOCs_salesOrderFOCSummaryDeleteRows","dxButton")},ct,ki=function(){for(var t=$(".dx-command-edit","[id$=SummaryDataGrid]"),n=0;n<t.length;n++)if($(t[n]).text().trim().indexOf("Save")>=0)return!0;return!1},ti=function(){var n=!1,r=!0,t=i.popupEditData();t.DocumentStatusID()&&(r=!1);(t.DocumentStatusID()==2||t.DocumentStatusID()==3||t.DocumentStatusID()==4)&&(n=!0);ki()||(d()&&a()&&v()&y()&&d().option("disabled",n),d().option("disabled",n),a().option("disabled",r||n),k().option("disabled",r||n),v().option("disabled",t.DocumentStatusID()!=2),y().option("disabled",n),clearInterval(ct))};return i.popupEditOptions.onContentReady=function(){var u=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop("Order Details"));var r=$('<div class="desktop-commonGridView-commands">'),e=$('<div id="vSalesOrderFOCs_salesOrderFOCSummaryNewRow">').dxButton({text:"New",icon:"add",onClick:function(){var n=i.form().validate().isValid;n?ut(function(){f().addRow()}):DevExpress.ui.dialog.alert("Please specify the required fields.","New Order Details Failed")}}),o=$('<div id="vSalesOrderFOCs_salesOrderFOCSummaryDeleteRows">').dxButton({text:"Delete",icon:"remove",disabled:!0,onClick:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(n){n&&DXUtility.deleteSelectedRows(f())})}});r.append(e);r.append(o);n.append(r);n.append($('<div id="vSalesOrderFOCs_salesOrderFOCSummaryDataGrid">').dxDataGrid({dataSource:[],showBorders:!0,paging:{enabled:!1},allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,editing:{editMode:"row",allowAdding:!1,allowUpdating:!0,allowDeleting:!0},onInitNewRow:function(n){d().option("disabled",!0);a().option("disabled",!0);k().option("disabled",!0);v().option("disabled",!0);y().option("disabled",!0);ct=setInterval(ti,500);n.data.QtyOrder=0;n.data.QtyOrderConv="0/0/0";n.data.AddDiscountStrataPercentage=0},onEditorPreparing:function(n){var t;n.parentType=="dataRow"&&(n.row!=undefined&&n.row.rowIndex!=undefined&&(n.component.editRowIndex=n.row.rowIndex),n.dataField=="Product"?(n.row.inserted?n.editorElement.dxLookup({dataSource:l,displayExpr:"Product",valueExpr:"Product",searchExpr:"Product",searchPlaceholder:"Product",popupWidth:"712px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){CommonUtility.createProductLookupHeader("vSalesOrderFOCs_productIDLookup",n.element,1)},itemTemplate:function(n,t,i){return CommonUtility.createProductLookupItem(n,i,1)},onValueChanged:function(t){var i,r;t.value&&(i=this.option("selectedItem"),i&&(n.component.cellValue(n.row.rowIndex,"QtyOnHand",i.QtyOnHand()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),r=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyOrderConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyOrder",r.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",r.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",r.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",r.qtyConvS),rt(n)));n.component.cellValue(n.row.rowIndex,"Product",t.value);n.setValue(t.value)}}):(ut(function(){}),n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Product()))),n.cancel=!0):n.dataField=="PriceDate"?(n.editorElement.dxDateBox({showClearButton:!0,placeholder:"Transaction Date",value:n.value,onValueChanged:function(t){t.component.option("value",t.value);n.setValue(t.value);rt(n)}}),n.cancel=!0):n.dataField=="QtyOrderConv"?(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onEnterKey:function(){f().saveEditData()},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyOrder",i.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvL",i.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvM",i.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvS",i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value);rt(n)}}),n.cancel=!0):n.dataField=="AddDiscountStrataPercentage"&&(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==190||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onValueChanged:function(t){(t.value==null||t.value=="")&&(t.value=0);t.component.option("value",t.value);n.setValue(t.value);rt(n)}}),n.cancel=!0))},onRowInserted:function(n){CommonUtility.validateDataGridInsertedTransactionSummary(n.component,new Dismoyo_Ciptoning_Client.vSalesOrderFOCSummaryViewModel(n.data).toJS());ht(n);CommonUtility.updateSalesOrderSummaryForm(b(),n.component);f().clearSelection()},onRowUpdated:function(n){n.data.ProductID=n.key.ProductID;ht(n);CommonUtility.updateSalesOrderSummaryForm(b(),n.component);f().clearSelection()},onRowRemoved:function(n){CommonUtility.validateDataGridRemovedTransactionSummary(n.component,n.data.toJS());CommonUtility.updateSalesOrderSummaryForm(b(),n.component)},onEditingStart:function(){d().option("disabled",!0);a().option("disabled",!0);k().option("disabled",!0);v().option("disabled",!0);y().option("disabled",!0);ct=setInterval(ti,500)},onRowUpdating:function(n){if(n.newData.QtyOrderConv){var t=CommonUtility.getConversion(n.newData.QtyOrderConv,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS"));n.newData.QtyConvL=t.qtyConvL;n.newData.QtyConvM=t.qtyConvM;n.newData.QtyConvS=t.qtyConvS;n.newData.QtyOrder=t.qtyTransaction}n.newData.SubtotalWeight=DXUtility.getValue(n.oldData,"SubtotalWeight");n.newData.SubtotalDimension=DXUtility.getValue(n.oldData,"SubtotalDimension");n.newData.UnitGrossPrice=DXUtility.getValue(n.oldData,"UnitGrossPrice");n.newData.RawSubtotalGrossPrice=DXUtility.getValue(n.oldData,"RawSubtotalGrossPrice");n.newData.RawSubtotalPrice=DXUtility.getValue(n.oldData,"RawSubtotalPrice");n.newData.RawDiscountStrata1Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata1Amount");n.newData.RawDiscountStrata2Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata2Amount");n.newData.RawDiscountStrata3Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata3Amount");n.newData.RawDiscountStrata4Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata4Amount");n.newData.RawDiscountStrata5Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata5Amount");n.newData.RawAddDiscountStrataAmount=DXUtility.getValue(n.oldData,"RawAddDiscountStrataAmount");n.newData.RawSubtotalDiscountStrata1=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata1");n.newData.RawSubtotalDiscountStrata2=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata2");n.newData.RawSubtotalDiscountStrata3=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata3");n.newData.RawSubtotalDiscountStrata4=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata4");n.newData.RawSubtotalDiscountStrata5=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata5");n.newData.RawSubtotalGross=DXUtility.getValue(n.oldData,"RawSubtotalGross");n.newData.RawSubtotal=DXUtility.getValue(n.oldData,"RawSubtotal");n.newData.SubtotalDiscountStrata1=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata1");n.newData.SubtotalDiscountStrata2=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata2");n.newData.SubtotalDiscountStrata3=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata3");n.newData.SubtotalDiscountStrata4=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata4");n.newData.SubtotalDiscountStrata5=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata5");n.newData.TaxPercentage=DXUtility.getValue(n.oldData,"TaxPercentage");n.newData.SubtotalGrossPrice=DXUtility.getValue(n.oldData,"SubtotalGrossPrice");n.newData.SubtotalPrice=DXUtility.getValue(n.oldData,"SubtotalPrice");n.newData.UnitPrice=n.component.cellValue(n.component.editRowIndex,"UnitPrice");n.newData.DiscountStrata1Percentage=DXUtility.getValue(n.oldData,"DiscountStrata1Percentage");n.newData.DiscountStrata1Amount=DXUtility.getValue(n.oldData,"DiscountStrata1Amount");n.newData.DiscountStrata2Percentage=DXUtility.getValue(n.oldData,"DiscountStrata2Percentage");n.newData.DiscountStrata2Amount=DXUtility.getValue(n.oldData,"DiscountStrata2Amount");n.newData.DiscountStrata3Percentage=DXUtility.getValue(n.oldData,"DiscountStrata3Percentage");n.newData.DiscountStrata3Amount=DXUtility.getValue(n.oldData,"DiscountStrata3Amount");n.newData.DiscountStrata4Percentage=DXUtility.getValue(n.oldData,"DiscountStrata4Percentage");n.newData.DiscountStrata4Amount=DXUtility.getValue(n.oldData,"DiscountStrata4Amount");n.newData.DiscountStrata5Percentage=DXUtility.getValue(n.oldData,"DiscountStrata5Percentage");n.newData.DiscountStrata5Amount=DXUtility.getValue(n.oldData,"DiscountStrata5Amount");n.newData.AddDiscountStrataAmount=n.component.cellValue(n.component.editRowIndex,"AddDiscountStrataAmount");n.newData.SubtotalGross=n.component.cellValue(n.component.editRowIndex,"SubtotalGross");n.newData.SubtotalTax=n.component.cellValue(n.component.editRowIndex,"SubtotalTax");n.newData.Subtotal=n.component.cellValue(n.component.editRowIndex,"Subtotal");si(n.oldData.ProductID(),n.newData)},onRowValidating:function(n){var i=DXUtility.getValue(n.newData,"QtyOnHand"),t;i==undefined&&(i=DXUtility.getValue(n.oldData,"QtyOnHand"));t=DXUtility.getValue(n.newData,"QtyOrder");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyOrder"));t<=0&&(n.errorText="Order Qty must be greater than 0.",n.isValid=!1);n.isValid&&t>i&&(n.errorText="Order Qty must be less than or equal to On Hand Qty.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},onDataErrorOccurred:function(n){var t=n.component._controllers.editing._editData[0].data.Product;switch(n.error.__id){case"E4008":n.error.message="Product '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},columns:[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"Product",caption:"Product",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$(f().element()),r,i,e;!u.find(".datagrid-bandedHeader:first").length>0&&(r=f().option("selection").mode=="none"?!1:!0,i='<tr class="dx-row dx-column-lines datagrid-bandedHeader" style="border-top-style: none !important;">',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colSpan="1">Disc 1-5<\/td>',i+='       <td class="dx-datagrid-action" colSpan="2">Additional Disc<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",e=u.find(".dx-header-row:first-child"),$(i).insertBefore(e[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"120px",allowEditing:!1,dataType:"number"},{dataField:"PriceDate",caption:"Price Date",width:"140px",dataType:"date"},{dataField:"UnitPrice",caption:"Unit Price",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"QtyOrderConv",caption:"Qty (L/M/S)",width:"100px",alignment:"right",validationRules:[{type:"required"},wt],cellTemplate:function(n,t){n.append(ci(t.data,"QtyOrderConv",1))}},{dataField:"DiscountStrataDefaultAmount",caption:"Amount",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2,calculateCellValue:function(n){var t=DXUtility.getValue(n,"DiscountStrata1Amount"),i=DXUtility.getValue(n,"DiscountStrata2Amount"),r=DXUtility.getValue(n,"DiscountStrata3Amount"),u=DXUtility.getValue(n,"DiscountStrata4Amount"),f=DXUtility.getValue(n,"DiscountStrata5Amount");return isNaN(t)&&(t=0),isNaN(i)&&(i=0),isNaN(r)&&(r=0),isNaN(u)&&(u=0),isNaN(f)&&(f=0),t+i+r+u+f}},{dataField:"AddDiscountStrataPercentage",caption:"%",width:"40px",dataType:"number",format:"fixedPoint",precision:2},{dataField:"AddDiscountStrataAmount",caption:"Amount",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"SubtotalGross",caption:"DPP",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"SubtotalTax",caption:"VAT",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"Subtotal",caption:"Subtotal",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2}]}));n.append($('<div id="vSalesOrderFOCs_salesOrderFOCSummaryForm" style="margin-top: 9px;">').dxForm({deferRendering:!1,colCount:4,showColonAfterLabel:!1,labelLocation:"left",alignItemLabels:!0,items:[{itemType:"empty",colSpan:3},{dataField:"TotalGross",label:{text:"Total DPP"},colSpan:1,cssClass:"salesOrderSummaryForm-item-label salesOrderSummaryForm-item-textInput",editorOptions:{readOnly:!0}},{itemType:"empty",colSpan:2},{itemType:"empty",colSpan:1},{dataField:"TotalTax",label:{text:"Total VAT"},colSpan:1,cssClass:"salesOrderSummaryForm-item-label salesOrderSummaryForm-item-textInput",editorOptions:{readOnly:!0}},{itemType:"empty",colSpan:3},{dataField:"Total",label:{text:"Total"},colSpan:1,cssClass:"salesOrderSummaryForm-item-label salesOrderSummaryForm-item-textInput",editorOptions:{readOnly:!0}}]}));var t=$("#commonPopupEdit_extCommands"),s=$('<div id="vSalesOrderFOCs_salesOrderFOCPrintDO" style="margin-right: 32px;">').dxButton({text:"Print DO",icon:"icons8-print",onClick:function(){i.events.performPrintDO(this)}}),h=$('<div id="vSalesOrderFOCs_salesOrderFOCPost">').dxButton({text:"Post",icon:"icons8-check-green",onClick:function(){i.events.performPost(this)}}),c=$('<div id="vSalesOrderFOCs_salesOrderFOCDiscard">').dxButton({text:"Discard",icon:"icons8-trash-red",onClick:function(){i.events.performDiscard(this)}}),p=$('<div id="vSalesOrderFOCs_salesOrderFOCVoid" style="margin-right: 16px;">').dxButton({text:"Void",icon:"icons8-delete-red",onClick:function(){i.events.performVoid(this)}}),w=$('<div id="vSalesOrderFOCs_salesOrderFOCSaveAsDraftAndNew">').dxButton({text:"Save & New",icon:"icons8-save",onClick:function(){i.events.performSaveAsDraftAndNew(this)}});u.append(DXUtility.createFormItemGroupWithCaption("").append(n));t.append(s);t.append(h);t.append(c);t.append(p);t.append(w)},e.events.performNewRow=function(){st(null)},i.events.performOK=function(){p(null,3)},i.events.performPrintDO=function(){var n=i.popupEditData();ai(n.DODocumentID())},i.events.performPost=function(){DevExpress.ui.dialog.confirm("Are you sure want to Post this transaction?","Post Confirmation").done(function(n){n&&p(2,3)})},i.events.performDiscard=function(){DevExpress.ui.dialog.confirm("Are you sure want to Discard this transaction?","Discard Confirmation").done(function(n){n&&p(3,3)})},i.events.performVoid=function(){DevExpress.ui.dialog.confirm("Are you sure want to Void this transaction?","Void Confirmation").done(function(n){n&&p(4,3)})},i.events.performSaveAsDraftAndNew=function(){p(1,2)},i.events.performCancel=function(){i.popupEditOptions.visible(!1);g&&(e.dataGrid().refresh(),g=!1)},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form(),r,u;CommonUtility.cascadeValueChanged(t,n.selectedItem,n.value,"Site",["Area","Region","Territory"],[]);r="";u="";n.selectedItem?(r=bt(n.selectedItem.Code()),u=kt(n.selectedItem.Code()),t.getEditor("Company").option("value",n.selectedItem.Company())):n.previousValue!=null&&t.getEditor("Company").option("value",null);dt(t,n.value);t.getEditor("DocumentCode").option("value",r);t.getEditor("DODocumentCode").option("value",u)}}}]},{itemType:"group",caption:"Sales Order FOC",colCount:6,colSpan:3,items:[{dataField:"DocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"TransactionDate",label:{text:"Transaction Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();t.getEditor("DOShipmentDate").option("min",n.value)}}},{dataField:"DocumentStatusID",label:{text:"Status"},colSpan:1,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"NEW",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"CustomerID",label:{text:"Customer"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxLookup",editorOptions:{dataSource:[],displayExpr:"Customer",valueExpr:"ID",searchExpr:["Code","Name","Address1","Address2","Address3"],searchPlaceholder:"Customer/Address",searchEnabled:!1,popupWidth:"1082px",showPopupTitle:!1,fieldEditEnabled:!0,onOpened:function(){},onClosed:function(){},onContentReady:function(n){var t=i.form(),r=Dismoyo_Ciptoning_Client.app.CurrentUser;CommonUtility.createCustomerLookupHeader("vSalesOrderFOCs_customerIDLookup",n.element,oi("Customer.Category1"),r.SiteID(),t)},itemTemplate:function(n,t,i){return CommonUtility.createCustomerLookupItem(n,i)},onValueChanged:function(n){var t;if(n.value&&(t=n.selectedItem,t)){var r=i.popupEditData(),u=i.form(),f=null,e=null,o=null;tt=undefined;it=undefined;r.PriceGroupID(undefined);r.DiscountGroupID(undefined);t&&(f=t.SalesmanID(),e=t.WarehouseID(),o=t.TermOfPaymentID(),tt=Dismoyo_Ciptoning_Client.LocalStore.vProductPrices.dataByFilter(["PriceGroupID","=",t.PriceGroupID()]),it=Dismoyo_Ciptoning_Client.LocalStore.vDiscountGroups.expandedDataByKey(t.DiscountGroupID()),r.PriceGroupID(t.PriceGroupID()),r.DiscountGroupID(t.DiscountGroupID()));n.component.option("value",n.value);u.getEditor("SalesmanID").option("value",f);u.getEditor("WarehouseID").option("value",e);gt(u,o)}}}},{itemType:"empty",colSpan:3},{dataField:"SalesmanID",label:{text:"Salesman"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Salesman",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t,u,r;o=[];l=[];n.value?(t=i.popupEditData(),f().cancelEditData(),t.ChildSummaries([]),f().option("dataSource",et(t.ChildSummaries()))):f().endCustomLoading();u=i.form();r=null;n.selectedItem&&(r=n.selectedItem.WarehouseID());u.getEditor("WarehouseID").option("value",r)}}},{dataField:"WarehouseID",label:{text:"Warehouse"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"",readOnly:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){if(o=[],l=[],n.value){var t=i.popupEditData(),r=f();r.cancelEditData();t.ChildSummaries([]);r.option("dataSource",et(t.ChildSummaries()))}}}},{itemType:"empty",colSpan:1},{dataField:"TermOfPaymentID",validationRules:[{type:"required"}],label:{text:"Term of Payment"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"ReferenceNumber",label:{text:"Reference Number"},colSpan:3,editorOptions:{maxLength:30,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1}]},{itemType:"group",caption:"Purchase Order",colCount:6,colSpan:3,items:[{dataField:"PODocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{maxLength:30,onEnterKey:function(){commSonPopupEdit.events.performOK(this)}}},{dataField:"POTransactionDate",label:{text:"Transaction Date"},colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(){var n=i.form()}}},{itemType:"empty"}]},{itemType:"group",caption:"Delivery Order",colCount:6,colSpan:3,items:[{dataField:"DODocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){commSonPopupEdit.events.performOK(this)}}},{dataField:"DOShipmentDate",label:{text:"Shipment Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();t.getEditor("DOReceivedDate").option("min",n.value)}}},{itemType:"empty"},{dataField:"DOPrintedCount",label:{text:"Printed Count"},colSpan:1,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DOLastPrintedDate",label:{text:"Last Printed Date"},colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DOReceivedDate",label:{text:"Received Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],h=new Dismoyo_Ciptoning_Client.CommonPopupIFrame,h.okOptions.visible=!1,h.cancelOptions.text="Close",r=new Dismoyo_Ciptoning_Client.ProductLotPopupEdit,r.formOptions.colCount=4,r.saveOptions.icon="icons8-save",r.events.performSave=function(){yi()},r.dataGridOptions.onInitNewRow=function(n){n.data.QtyOrder=0;n.data.QtyOrderConv="0/0/0"},r.dataGridOptions.onEditorPreparing=function(n){var i,u,t;n.parentType=="dataRow"&&(n.dataField=="ProductLotCode"?(n.row.inserted?(i=r.popupEditOptions.itemStatusID,u=w(i),n.editorElement.dxLookup({dataSource:new DevExpress.data.DataSource({store:o,filter:[["ProductID","=",r.popupEditData().ProductID()],"and",[u.qtyOnHandColumn,">",0]],sort:[{getter:"ProductLotExpiredDate",desc:!0}]}),displayExpr:"ProductLotCode",valueExpr:"ProductLotCode",searchExpr:"ProductLotCode",searchPlaceholder:"Lot Number",popupWidth:"582px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){var t=r.popupEditOptions.itemStatusID;CommonUtility.createProductLotLookupHeader("vSalesOrderFOCs_productLotIDLookup",n.element,t)},itemTemplate:function(n,t,i){var u=r.popupEditOptions.itemStatusID,f=w(u);return CommonUtility.createProductLotLookupItem(n,i,f.qtyOnHandColumn)},onValueChanged:function(t){var i,e,f,u;t.value&&(i=this.option("selectedItem"),i&&(e=r.popupEditOptions.itemStatusID,f=w(e),n.component.cellValue(n.row.rowIndex,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductLotID",i.ProductLotID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductLotCode",i.ProductLotCode()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),u=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyOrderConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyOrder",u.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",u.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",u.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",u.qtyConvS)));n.component.cellValue(n.row.rowIndex,"ProductLotCode",t.value);n.setValue(t.value)}})):(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.ProductLotCode()))),n.cancel=!0):n.dataField=="QtyOrderConv"&&(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyOrder",i.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvL",i.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvM",i.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvS",i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}}),n.cancel=!0))},r.dataGridOptions.onRowInserted=function(n){CommonUtility.validateDataGridInsertedTransactionDetails(n.component,new Dismoyo_Ciptoning_Client.vSalesOrderFOCDetailsViewModel(n.data).toJS())},r.dataGridOptions.onRowRemoved=function(n){CommonUtility.validateDataGridRemovedTransactionDetails(n.component,n.data.toJS())},r.dataGridOptions.onRowUpdating=function(n){CommonUtility.validateDataGridUpdatingTransactionDetails(n,"QtyConvL","QtyConvM","QtyConvS","QtyOrderConv","QtyOrder")},r.dataGridOptions.onRowValidating=function(n){var u=r.popupEditOptions.itemStatusID,f=w(u),i=DXUtility.getValue(n.newData,"QtyOnHand"),t;i==undefined&&(i=DXUtility.getValue(n.oldData,"QtyOnHand"));t=DXUtility.getValue(n.newData,"QtyOrder");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyOrder"));t<=0&&(n.errorText="Order Qty must be greater than 0.",n.isValid=!1);n.isValid&&t>i&&(n.errorText="Order Qty must be less than or equal to On Hand Qty.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.onDataErrorOccurred=function(n){var t=n.component._controllers.editing._editData[0].data.ProductLotCode;switch(n.error.__id){case"E4008":n.error.message="Lot Number '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.summary={totalItems:[{name:"TotalQtyPcs",showInColumn:"QtyOrderConv",displayFormat:"Total Qty (Pcs): {0}",valueFormat:"decimal",summaryType:"custom"},{name:"TotalQtyLMS",showInColumn:"QtyOrderConv",displayFormat:"(L/M/S): {0}",valueFormat:"string",summaryType:"custom"}],calculateCustomSummary:function(n){CommonUtility.updateProductLotEditingSummary(n,"QtyOrderConv","QtyOrder")}},r.dataGridOptions.columns=[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"ProductLotID",visible:!1},{dataField:"ProductLotCode",caption:"Lot Number",validationRules:[{type:"required"}]},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"120px",allowEditing:!1,dataType:"number"},{dataField:"QtyOrderConv",caption:"Order Qty (L/M/S)",width:"150px",alignment:"right",validationRules:[{type:"required"},wt]}],r.formOptions.items=[{itemType:"group",caption:"Product",colCount:4,colSpan:4,items:[{dataField:"Product",label:{text:"Product"},colSpan:4,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOnHand",label:{text:"On Hand Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2},{dataField:"QtyOrder",label:{text:"Order Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOrderConv",label:{text:"(L/M/S)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],{isReady:lt.promise(),dataSource:s,refreshList:pt,viewShowing:ri,viewDisposing:ui,openCreateViewAsRoot:ii,icon:"Images/sales_order_foc_32px.png",dataSource_vSalesOrderFOCDetails:fi,dataSource_vSalesOrderFOCSummary:ei,dataSource_vStockOnHandAvailable:o,dataSource_vStockOnHandAvailableByProduct:l,collapsibleFilter:u,commonGridView:e,commonPopupEdit:i,commonPopupIFrame:h,productLotPopupEdit:r,salesOrderFOCSummaryDataGrid:f,salesOrderFOCPost:a,salesOrderFOCDiscard:k,salesOrderFOCVoid:v,salesOrderFOCSaveAsDraftAndNew:y,isLotNumberEntryRequired:c}};Dismoyo_Ciptoning_Client.vSalesOrderReturns=function(n,t){"use strict";function vt(){ft=!0}function yt(){g=CommonUtility.configureCommonGridViewLayout("vSalesOrderReturns");g||setTimeout(yt,50)}function ri(){var n,t;yt();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],o.filter(t));at()?ft&&pt():(at(o),o.load().always(function(){lt.resolve()}))}function ui(){Dismoyo_Ciptoning_Client.DB.vSalesOrderReturns.off("modified",vt)}function pt(){ft=!1;o.pageIndex(0);o.load()}function bt(n){return(n?n:"(Site Code)")+"-YY-02-(Auto Generated)"}function kt(n){return(n?n:"(Site Code)")+"-YY-10-(Auto Generated)"}function dt(n,t){t?Dismoyo_Ciptoning_Client.DB.vSites.byKey(t).done(function(n){c=n.IsLotNumberEntryRequired}):(t=null,c=undefined);var i=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["ID","Customer","Address","Category1","SalesmanID","Salesman","WarehouseID","TermOfPaymentID","PriceGroupID","DiscountGroupID","SiteID"],filter:[["IsDeleted","=",!1],"and",["StatusID","=",1],"and",["SiteID","=",t]],map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)}}),r=DataUtility.GetLookupSalesmanDataSource([["IsDeleted","=",!1],"and",["StatusID","=",1],"and",["SiteID","=",t]]);n.getEditor("CustomerID").option("value",null);n.getEditor("CustomerID").option("dataSource",i);i.load();n.getEditor("SalesmanID").option("value",null);n.getEditor("SalesmanID").option("dataSource",r);r.load()}function gt(n,t){var i=[["Group","=","CustomerTermOfPayment"]],r;t!=undefined&&t!=null&&(i.push("and"),i.push(["Value_Int32","<=",t]));r=DataUtility.GetLookupSystemLookupDataSource(i);n.getEditor("TermOfPaymentID").option("value",null);n.getEditor("TermOfPaymentID").option("dataSource",r);n.getEditor("TermOfPaymentID").option("value",t);r.load()}function oi(n){var t=Dismoyo_Ciptoning_Client.LocalStore.vSystemParameters.dataByFilter(["ID","=",n]);return t.length>0?t[0].Value():null}function it(n){return CommonUtility.calcProductPriceAndDiscountBase(i.form().getEditor("TransactionDate").option("value"),n.component,n.row.rowIndex,n.row.data,nt,tt,!1,!0)}function ni(n){CommonUtility.updateSummariesArrayStore(f().option("dataSource").store(),n)}function si(n,t){CommonUtility.updateDeferSummariesArrayStore(f().option("dataSource").store(),n,t)}function hi(n){return CommonUtility.validateSummaryArrayStore(f().option("dataSource").store(),"vSalesOrderReturnSummaryViewModel",n)}function et(n){return CommonUtility.createArrayDataSource("vSalesOrderReturnSummaryViewModel",["ProductID"],n)}function ci(n,t,i){var r=$('<div class="dx-command-edit" style="text-align: right; padding-right: 5px;">'),o;if(r.append($('<a style="color: inherit;">').text(n[t]())),r.append("&nbsp;"),c){var u=t.replace("Conv",""),s=n[u](),f=n.ChildDetails(),e=0;for(o in f)e+=f[o][u]();r.append($('<a class="dx-link dxcustom-linkbutton dx-icon-icons8-view-details" title="Edit Lot Number">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<\/a><span id="LotMark_'+n.ProductID()+"_"+t+'" class="dx-icon-overflow '+(e==s?"hidden":"")+'" style="color:red; font-size: 14px; margin-left: -6px;"><\/span>').on("dxclick",function(){ut(function(){vi(n,i)})}));r.append("&nbsp;")}return r}function li(n){var t=f().option("editing"),i=f().option("selection");i.mode=n?"multiple":"none";t.allowUpdating=n;t.allowDeleting=n;f().option("editing",t);f().option("selection",i);wi().option("disabled",!n);bi().option("disabled",!0);f().repaint()}function ot(n,t){showLoadingPanel();Dismoyo_Ciptoning_Client.DB.vSalesOrderReturns.byKey(n,{expand:["ChildSummaries/ChildDetails"]}).done(function(n){hideLoadingPanel();d=t;st(new Dismoyo_Ciptoning_Client.vSalesOrderReturnViewModel(n))}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function st(n){var e=!1,o,g,p,it,rt,k,ft,ot,at,st;n||(n=new Dismoyo_Ciptoning_Client.vSalesOrderReturnViewModel,e=!0);i.popupEditData(n);i.popupEdit().option("title",(e?"New":"Edit")+" Sales Order Return");i.popupEditOptions.editingKey=n.DocumentID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);var u=Dismoyo_Ciptoning_Client.app.CurrentUser,t=i.form(),d=w();DXUtility.resetFormValidation(t);var ct=n.DocumentCode(),lt=n.DODocumentCode(),r=!1,h=[];if(c=n.IsSiteLotNumberEntryRequired(),e)n.DocumentID(new DevExpress.data.Guid),n.DocumentStatusID(null),u.IsHeadOffice()||(n.TerritoryID(u.TerritoryID()),n.RegionID(u.RegionID()),n.AreaID(u.AreaID()),n.SiteID(u.SiteID()),n.SiteCode(u.SiteCode()),n.CompanyID(u.CompanyID()),n.Company(u.Company())),ct=bt(n.SiteCode()),lt=kt(n.SiteCode());else if(h=n.ChildSummaries(),n.DocumentStatusID()!=1||c)(n.DocumentStatusID()==2||n.DocumentStatusID()==3||n.DocumentStatusID()==4)&&(r=!0);else{for(o=[],g=0,p=0;p<h.length;p++){for(it=h[p].ChildDetails(),rt=0,k=0;k<it.length;k++)it[k].ProductLotCode().indexOf("DUMMY")<0&&rt++;rt>0&&(o[g]=h[p],g++)}o.length>0&&(s=[],l=[],t.getEditor("SalesmanID").option("value",n.SalesmanID()),ut(function(){for(var t,n=0;n<o.length;n++)t={data:o[n].toJS()},ht(t,o)}))}li(!r);pi().option("disabled",e);a().option("disabled",e||r);b().option("disabled",e||r);v().option("disabled",n.DocumentStatusID()!=2);y().option("disabled",r);i.ok().option("disabled",r);ft=n.PriceGroupID();ot=n.DiscountGroupID();t.itemOption("Organization").visible&&(t.getEditor("TerritoryID").option("value",n.TerritoryID()),t.getEditor("RegionID").option("value",n.RegionID()),t.getEditor("AreaID").option("value",n.AreaID()),t.getEditor("SiteID").option("value",n.SiteID()),t.getEditor("Company").option("value",n.Company()),t.getEditor("TerritoryID").option("readOnly",r),t.getEditor("RegionID").option("readOnly",r),t.getEditor("AreaID").option("readOnly",r),t.getEditor("SiteID").option("readOnly",r));dt(t,n.SiteID());gt(t,n.TermOfPaymentID());t.getEditor("DocumentCode").option("value",ct);t.getEditor("TransactionDate").option("value",n.TransactionDate());t.getEditor("CustomerID").option("value",n.CustomerID());t.getEditor("SalesmanID").option("value",n.SalesmanID());t.getEditor("WarehouseID").option("value",n.WarehouseID());t.getEditor("TermOfPaymentID").option("value",n.TermOfPaymentID());t.getEditor("ReferenceNumber").option("value",n.ReferenceNumber());t.getEditor("ReasonID").option("value",n.ReasonID());t.getEditor("DocumentStatusID").option("value",n.DocumentStatusID());t.getEditor("DODocumentCode").option("value",lt);t.getEditor("DOReceivedDate").option("value",n.DOReceivedDate());t.getEditor("DOPrintedCount").option("value",n.DOPrintedCount());t.getEditor("DOLastPrintedDate").option("value",n.DOLastPrintedDate());d.getEditor("TotalGross").option("value",CommonUtility.getNumberFormat(n.TotalGross()));d.getEditor("TotalTax").option("value",CommonUtility.getNumberFormat(n.TotalTax()));d.getEditor("Total").option("value",CommonUtility.getNumberFormat(n.Total()));t.getEditor("TransactionDate").option("readOnly",r);t.getEditor("CustomerID").option("readOnly",r);t.getEditor("SalesmanID").option("readOnly",r);t.getEditor("TermOfPaymentID").option("readOnly",r);t.getEditor("ReferenceNumber").option("readOnly",r);t.getEditor("ReasonID").option("readOnly",r);t.getEditor("DOReceivedDate").option("readOnly",r);at=new Date;e?(DXUtility.resetFormValidation(t),t.getEditor("TransactionDate").option("value",at)):(ft&&n.PriceGroupID(ft),ot&&n.DiscountGroupID(ot),nt=Dismoyo_Ciptoning_Client.LocalStore.vProductPrices.dataByFilter(["PriceGroupID","=",n.PriceGroupID()]),tt=Dismoyo_Ciptoning_Client.LocalStore.vDiscountGroups.expandedDataByKey(n.DiscountGroupID()));st=f();st.cancelEditData();n.ChildSummaries(h);st.option("dataSource",et(n.ChildSummaries()))}function p(n,t){var p,ri,r,o,h,u,c,v,ui;showLoadingPanel();var s=i.form(),oi=w(),a=s.validate().isValid,l=a?"":"Please specify the required fields.",fi=e.dataGrid(),ei=fi.option("dataSource"),b=f().option("dataSource"),y=[];for(h=0;h<b.store()._array.length;h++)y.push(new Dismoyo_Ciptoning_Client.vSalesOrderReturnSummaryViewModel(b.store()._array[h]));a&&y.length<=0&&(l="Please specify at least one item in Order Details.",a=!1);var k=0,g=0,nt=0,tt=0,it=0,rt=0,ut=0,ft=0,et=0,ht=0,ct=0,lt=0,at=0,vt=0,yt=0,pt=0,wt=0,bt=0,kt=0,dt=0,gt=0,ni=0,ti=0,ii=0;if(a)for(h=0;h<y.length;h++){for(u=y[h],p=0,k+=u.RawSubtotalGrossPrice(),g+=u.RawSubtotalPrice(),nt+=u.RawDiscountStrata1Amount(),tt+=u.RawDiscountStrata2Amount(),it+=u.RawDiscountStrata3Amount(),rt+=u.RawDiscountStrata4Amount(),ut+=u.RawDiscountStrata5Amount(),ft+=u.RawAddDiscountStrataAmount(),et+=u.RawSubtotalGross(),ht+=u.RawSubtotalTax(),ct+=u.RawSubtotal(),lt+=u.SubtotalGrossPrice(),at+=u.SubtotalPrice(),vt+=u.DiscountStrata1Amount(),yt+=u.DiscountStrata2Amount(),pt+=u.DiscountStrata3Amount(),wt+=u.DiscountStrata4Amount(),bt+=u.DiscountStrata5Amount(),kt+=u.AddDiscountStrataAmount(),dt+=u.SubtotalGross(),gt+=u.SubtotalTax(),ni+=u.Subtotal(),ti+=u.SubtotalWeight(),ii+=u.SubtotalDimension(),c=0;c<u.ChildDetails().length;c++)v=u.ChildDetails()[c],p+=v.QtyOrder();u.QtyOrder()!=p&&(l==""?l="Following products quantity of Order Details items is not matched: ":l+=", ",l+=u.Product(),a=!1)}if(ri=Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID(),s.itemOption("Organization").visible&&(ri=s.getEditor("SiteID").option("value")),a){for(r=i.popupEditData(),r.TransactionDate(s.getEditor("TransactionDate").option("value")),r.CustomerID(s.getEditor("CustomerID").option("value")),r.SalesmanID(s.getEditor("SalesmanID").option("value")),r.WarehouseID(s.getEditor("WarehouseID").option("value")),r.TermOfPaymentID(s.getEditor("TermOfPaymentID").option("value")),r.ReferenceNumber(s.getEditor("ReferenceNumber").option("value")),r.ReasonID(s.getEditor("ReasonID").option("value")),r.DOReceivedDate(s.getEditor("DOReceivedDate").option("value")),r.DOPrintedCount(s.getEditor("DOPrintedCount").option("value")),r.DOLastPrintedDate(s.getEditor("DOLastPrintedDate").option("value")),r.RawTotalGrossPrice(k),r.RawTotalPrice(g),r.RawTotalDiscountStrata1Amount(nt),r.RawTotalDiscountStrata2Amount(tt),r.RawTotalDiscountStrata3Amount(it),r.RawTotalDiscountStrata4Amount(rt),r.RawTotalDiscountStrata5Amount(ut),r.RawTotalAddDiscountStrataAmount(ft),r.RawTotalGross(et),r.RawTotalTax(ht),r.RawTotal(ct),r.TotalGrossPrice(lt),r.TotalPrice(at),r.TotalDiscountStrata1Amount(vt),r.TotalDiscountStrata2Amount(yt),r.TotalDiscountStrata3Amount(pt),r.TotalDiscountStrata4Amount(wt),r.TotalDiscountStrata5Amount(bt),r.TotalAddDiscountStrataAmount(kt),r.TotalGross(dt),r.TotalTax(gt),r.Total(ni),r.TotalWeight(ti),r.TotalDimension(ii),r.ChildSummaries(y),o=ko.toJS(r),n&&(o.DocumentStatusID=n),o.DocumentStatusID||(o.DocumentStatusID=1),o.TransactionDate=DateTimeUtility.getFirstTimeOfDay(o.TransactionDate),o.POTransactionDate&&(o.POTransactionDate=DateTimeUtility.getFirstTimeOfDay(o.POTransactionDate)),o.DOReceivedDate=DateTimeUtility.getFirstTimeOfDay(o.DOReceivedDate),h=0;h<o.ChildSummaries.length;h++){for(u=o.ChildSummaries[h],u.DocumentID=o.DocumentID,c=0;c<u.ChildDetails.length;c++)v=u.ChildDetails[c],v.DocumentID=o.DocumentID,v.Qty=v.QtyOrder*-1;u.Qty=u.QtyOrder*-1}ei.store().insert(o).done(function(n){CommonUtility.documentSuccessMessage(n.DocumentStatusID,function(){});d=!0;switch(t){case 1:i.events.performCancel();hideLoadingPanel();break;case 2:st(null);hideLoadingPanel();break;case 3:ot(r.DocumentID(),!0)}}).fail(function(n){var t=$(".dx-popup-normal>.dx-dialog-content");t.length==0&&DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})}else hideLoadingPanel();l!=""&&(ui=$(".dx-popup-normal>.dx-dialog-content"),ui.length==0&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(l),"Save Failed"))}function ai(n){h.popupEdit().option("title","Print Delivery Order");h.popupEditOptions.visible(!0);var t=h.iframe();h.showLoadingPanel();t.attr("src",Dismoyo_Ciptoning_Client.ReportWebsite.ExtDeliveryOrderReport.url([["DocumentID","=",n]]))}function ht(n,t){var a,e,v,o,r,l,h;if(!c){var p=i.popupEditData(),y=f(),u=[];if(t){for(r=0;r<t.length;r++)t[r].ChildDetails([]);u=t}else for(a=y.option("dataSource").store(),r=0;r<a._array.length;r++)u.push(new Dismoyo_Ciptoning_Client.vSalesOrderReturnSummaryViewModel(a._array[r]));if(e=n.data,v=$.grep(s,function(n){return n.ProductID()==DXUtility.getValue(e,"ProductID")&&n.ProductLotCode().indexOf("DUMMY")>=0}),v.length>0)for(o=v[0],DXUtility.setValue(e,"ProductLotID",o.ProductLotID()),DXUtility.setValue(e,"ProductLotCode",o.ProductLotCode()),DXUtility.setValue(e,"QtyOnHandGood",o.QtyOnHandGood()),DXUtility.setValue(e,"QtyOnHandHold",o.QtyOnHandHold()),DXUtility.setValue(e,"QtyOnHandBad",o.QtyOnHandBad()),r=0;r<u.length;r++)u[r].ProductID()==DXUtility.getValue(e,"ProductID")&&(l=$.grep(u[r].ChildDetails(),function(n){return n.ProductLotID()==DXUtility.getValue(e,"ProductLotID")}),l.length==0&&(l=[new Dismoyo_Ciptoning_Client.vSalesOrderReturnDetailsViewModel(e)],u[r].ChildDetails().push(l[0])),h=l[0],h.QtyConvL(DXUtility.getValue(u[r],"QtyConvL")),h.QtyConvM(DXUtility.getValue(u[r],"QtyConvM")),h.QtyConvS(DXUtility.getValue(u[r],"QtyConvS")),h.QtyOrder(DXUtility.getValue(u[r],"QtyOrder")),h.QtyOrderConv(DXUtility.getValue(u[r],"QtyOrderConv")),ni(u[r]));else DevExpress.ui.dialog.alert("DUMMY Lot Number for the selected product is not available.","Save Failed")}}function rt(n){var t=null;switch(n){case 1:t="Good";break;case 2:t="Hold";break;case 3:t="Bad"}var i="QtyOnHand"+t,r="QtyConvL"+t,u="QtyConvM"+t,f="QtyConvS"+t,e="QtyOrder"+t,o="QtyOrderConv"+t;return{itemStatusName:t,qtyOnHandColumn:i,qtyConvLColumn:r,qtyConvMColumn:u,qtyConvSColumn:f,qtyOrderColumn:e,qtyOrderConvColumn:o}}function vi(n,t){var o=i.popupEditData(),f,h;r.popupEditData(n);r.popupEditOptions.editingKey=n.ProductID();r.popupEditOptions.itemStatusID=t;r.popupEditOptions.visible(!0);var s=r.dataGrid(),e=r.form(),u=!1;(o.DocumentStatusID()==2||o.DocumentStatusID()==3||o.DocumentStatusID()==4)&&(u=!0);f=r.dataGrid().option("editing");f.allowUpdating=!u;f.allowDeleting=!u;f.editEnabled=!u;f.removeEnabled=!u;r.dataGrid().option("editing",f);r.dataGrid().option("selection",{mode:u?"none":"multiple"});r.newRow().option("disabled",u);r.dataGrid().repaint();e.getEditor("Product").option("value",n.Product());e.getEditor("QtyOnHand").option("value",n.QtyOnHand());e.getEditor("QtyOrderConv").option("value",n.QtyOrderConv());e.getEditor("QtyOrder").option("value",n.QtyOrder());n=hi(n);h=CommonUtility.createArrayDataSource("vSalesOrderReturnDetailsViewModel",["ProductID","ProductLotID"],n.ChildDetails());s.cancelEditData();s.option("dataSource",h)}function yi(){var n=r.popupEditData(),t=r.popupEditOptions.itemStatusID,i=rt(t);CommonUtility.validateProductLotEditing(n,r.dataGrid().option("dataSource"),r.form().getEditor("QtyOrder").option("value"),"Order","vSalesOrderReturnDetailsViewModel","QtyConvL","QtyConvM","QtyConvS","QtyOrderConv","QtyOrder",!1)&&(ni(n),r.popupEditOptions.visible(!1),f().refresh())}function ut(n){if(s.length==0&&l.length==0){showLoadingPanel();var t=i.form(),r=t.getEditor("SalesmanID").option("value");new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesmanProducts,select:["ProductID","ProductCode","Product","ProductUOMLID","ProductUOMMID","ProductUOMSID","ProductConversionL","ProductConversionM","ProductConversionS"],filter:[["SalesmanID","=",r],"and",["ProductName","notcontains","SAMPLE"]],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesmanProductViewModel(n)}}).load().done(function(i){var r,o;if(i.length>0){var c=i,h=t.getEditor("WarehouseID").option("value"),u=[],e=[];for(r=0;r<i.length;r++)DXUtility.addFilterExpression(e,"ProductID","=",i[r].ProductID(),"or");DXUtility.addGroupFilterExpression(u,e,"and");DXUtility.addFilterExpression(u,"WarehouseID","=",h,"and");o=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOnHandAlls,select:["ProductID","ProductLotID","ProductLotCode","ProductLot","ProductLotExpiredDate","QtyOnHandGood","QtyOnHandHold","QtyOnHandBad"],filter:u,sort:["WarehouseID","ProductID","ProductLotID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOnHandAllViewModel(n)}});o.load().done(function(t){for(var o,c,u=null,h=[],r=[],e=0;e<t.length;e++)h.push(new Dismoyo_Ciptoning_Client.vStockOnHandAllViewModel(t[e].toJS())),o=r.length-1,c=t[e].ProductID(),e==0||r[o].ProductID()!=c?(r.push(new Dismoyo_Ciptoning_Client.vStockOnHandAllViewModel(t[e].toJS())),o++,u=$.grep(i,function(n){return n.ProductID()==c})):(r[o].QtyOnHandGood(r[o].QtyOnHandGood()+t[e].QtyOnHandGood()),r[o].QtyOnHandHold(r[o].QtyOnHandHold()+t[e].QtyOnHandHold()),r[o].QtyOnHandBad(r[o].QtyOnHandBad()+t[e].QtyOnHandBad())),h[e].ProductCode(u[0].ProductCode()),h[e].Product(u[0].Product()),h[e].ProductUOMLID(u[0].ProductUOMLID()),h[e].ProductUOMMID(u[0].ProductUOMMID()),h[e].ProductUOMSID(u[0].ProductUOMSID()),h[e].ProductConversionL(u[0].ProductConversionL()),h[e].ProductConversionM(u[0].ProductConversionM()),h[e].ProductConversionS(u[0].ProductConversionS()),r[o].ProductCode(u[0].ProductCode()),r[o].Product(u[0].Product()),r[o].ProductUOMLID(u[0].ProductUOMLID()),r[o].ProductUOMMID(u[0].ProductUOMMID()),r[o].ProductUOMSID(u[0].ProductUOMSID()),r[o].ProductConversionL(u[0].ProductConversionL()),r[o].ProductConversionM(u[0].ProductConversionM()),r[o].ProductConversionS(u[0].ProductConversionS());s=h;l=r;f().endCustomLoading();n();hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product lot data."),"Download Product Lot Failed");hideLoadingPanel()})}else DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("The selected Salesman does not have any reference products."),"New Order Details Failed"),hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product data."),"Download Product Failed");hideLoadingPanel()})}else n()}var ft=!1,ii=t.layoutController.name==="split",lt=$.Deferred(),at=ko.observable(),o,d,c,g,u,e,i,h,r;o=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderReturns,select:["DocumentID","DocumentCode","TransactionDate","Territory","Region","Area","Company","Site","Customer","Salesman","Warehouse","TotalGross","TotalTax","Total","ReferenceNumber","DocumentStatusName","PostedDate","CreatedDate","CreatedByUserName","ModifiedDate","ModifiedByUserName"],map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderReturnViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vSalesOrderReturns.on("modified",vt);var fi=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderReturnDetails,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderReturnDetailsViewModel(n)}}),ei=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderReturnSummaries,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderReturnSummaryViewModel(n)}}),s,l,nt,tt,wt={type:"pattern",pattern:"(^[0-9]*$)|(^[0-9]*/[0-9]*$)|(^[0-9]*/[0-9]*/[0-9]*$)",message:"Format must be L/M/S or M/S or S."};u=new Dismoyo_Ciptoning_Client.CollapsibleFilter;u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){g&&g.resizeAll()})};u.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Salesman","Warehouse"])}}}]},{itemType:"group",caption:"Sales Order Return",colCount:3,colSpan:3,items:[{name:"DocumentCode",dataField:"",label:{text:"Document Number"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateFrom",label:{text:"Transaction Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateTo",label:{text:"Transaction Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"SalesmanID",label:{text:"Salesman"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSalesmanDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Salesman",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Salesman",["Warehouse"],[])}}},{dataField:"WarehouseID",label:{text:"Warehouse"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){var i=null,t,r;i=Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?u.form().getEditor("SiteID").option("value"):Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID();t=u.form().getEditor("SalesmanID");r=t.option("selectedItem");r&&r.WarehouseID()!=n.value&&t.option("value",null);i==undefined?t.option("dataSource",DataUtility.GetLookupSalesmanDataSource(n.value?["WarehouseID","=",n.value]:null)):t.option("dataSource",DataUtility.GetLookupSalesmanDataSource(n.value?[["WarehouseID","=",n.value],"and",["SiteID","=",i]]:["SiteID","=",i]))}}},{dataField:"CustomerID",label:{text:"Customer"},editorType:"dxSelectBox",editorOptions:{dataSource:new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["ID","Customer","SiteID"],map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)},filter:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]}),displayExpr:"Customer",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}}]}];u.events.performSearch=function(){var f=e.dataGrid(),i=u.form(),n=[],t;f.clearFilter();var r=Dismoyo_Ciptoning_Client.app.CurrentUser,o=r.TerritoryID(),s=r.RegionID(),h=r.AreaID(),c=r.CompanyID(),l=r.SiteID();i.itemOption("Organization").visible&&(o=i.getEditor("TerritoryID").option("value"),s=i.getEditor("RegionID").option("value"),h=i.getEditor("AreaID").option("value"),c=i.getEditor("CompanyID").option("value"),l=i.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",o,"and");DXUtility.addFilterExpression(n,"RegionID","=",s,"and");DXUtility.addFilterExpression(n,"AreaID","=",h,"and");DXUtility.addFilterExpression(n,"CompanyID","=",c,"and");DXUtility.addFilterExpression(n,"SiteID","=",l,"and");t=i.getEditor("SalesmanID").option("value");DXUtility.addFilterExpression(n,"SalesmanID","=",t,"and");t=i.getEditor("WarehouseID").option("value");DXUtility.addFilterExpression(n,"WarehouseID","=",t,"and");t=i.getEditor("DocumentCode").option("value");DXUtility.addFilterExpression(n,"DocumentCode","contains",t,"and");t=i.getEditor("TransactionDateFrom").option("value");DXUtility.addFilterExpression(n,"TransactionDate",">=",t,"and");t=i.getEditor("TransactionDateTo").option("value");DXUtility.addFilterExpression(n,"TransactionDate","<=",t,"and");t=i.getEditor("CustomerID").option("value");DXUtility.addFilterExpression(n,"CustomerID","=",t,"and");t=i.getEditor("DocumentStatusID").option("value");DXUtility.addFilterExpression(n,"DocumentStatusID","=",t,"and");n.length>0?f.filter(n):f.refresh()};e=new Dismoyo_Ciptoning_Client.CommonGridView;e.dataGridOptions.dataSource=o;e.dataGridOptions.editing.editEnabled=!1;e.dataGridOptions.editing.removeEnabled=!1;e.dataGridOptions.selection.mode="single";e.deleteRowsOptions.visible=!1;e.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("SalesOrderReturns.AddNewSalesOrderReturn");e.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("SalesOrderReturns.EditSalesOrderReturn");e.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Territory",caption:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Region",caption:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Area",caption:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Company",caption:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Site",caption:"Site",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"DocumentCode",caption:"Document Number",width:"140px",sortOrder:"desc",headerCellTemplate:function(n,t){var r=$("#vSalesOrderReturns_commonGridView").find(".dx-datagrid:first-child"),i,u,f;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',u=Dismoyo_Ciptoning_Client.app.CurrentUser,u.IsHeadOffice()&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',e.dataGridOptions.editing.allowUpdating&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",f=r.find(".dx-header-row:first-child"),$(i).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},cellTemplate:function(n,t){var u=Dismoyo_Ciptoning_Client.app.CurrentUser,f=u.isAuthorized("SalesOrderReturns.EditSalesOrderReturn"),i=$('<div class="dx-command-edit" style="text-align: left;">'),r=$("<b>").text(t.data.DocumentCode());f&&(r=$('<a class="dx-link">').text(t.data.DocumentCode()).on("dxclick",function(){ot(t.data.DocumentID(),!1)}));i.append(r);i.append("&nbsp;");n.append(i)}},{dataField:"TransactionDate",caption:"Transaction Date",width:"100px",customizeText:function(n){return n.value?n.value.toLocaleDateString():null}},{dataField:"Customer",caption:"Customer",width:"200px"},{dataField:"Salesman",caption:"Salesman",width:"200px"},{dataField:"Warehouse",caption:"Warehouse",width:"200px"},{dataField:"TotalGross",caption:"Total DPP",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"TotalTax",caption:"Total VAT",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"Total",caption:"Total",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"ReferenceNumber",caption:"Reference Number",width:"120px",validationRules:[{type:"required"}]},{dataField:"DocumentStatusName",caption:"Status",width:"80px"},{dataField:"PostedDate",caption:"Posted Date",width:"100px",customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleDateString():null}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}];e.dataGridOptions.editing.allowUpdating&&e.dataGridOptions.columns.push({width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){ot(t.data.DocumentID(),!1)}));i.append("&nbsp;");n.append(i)}});i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.okOptions.text="Save";i.okOptions.icon="icons8-save";var f=function(){return DXUtility.getDXInstance(null,"#vSalesOrderReturns_salesOrderReturnSummaryDataGrid","dxDataGrid")},w=function(){return DXUtility.getDXInstance(null,"#vSalesOrderReturns_salesOrderReturnSummaryForm","dxForm")},pi=function(){return DXUtility.getDXInstance(null,"#vSalesOrderReturns_salesOrderReturnPrintDO","dxButton")},a=function(){return DXUtility.getDXInstance(null,"#vSalesOrderReturns_salesOrderReturnPost","dxButton")},b=function(){return DXUtility.getDXInstance(null,"#vSalesOrderReturns_salesOrderReturnDiscard","dxButton")},v=function(){return DXUtility.getDXInstance(null,"#vSalesOrderReturns_salesOrderReturnVoid","dxButton")},y=function(){return DXUtility.getDXInstance(null,"#vSalesOrderReturns_salesOrderReturnSaveAsDraftAndNew","dxButton")},k=function(){return DXUtility.getDXInstance(null,"#commonPopupEdit_ok","dxButton")},wi=function(){return DXUtility.getDXInstance(null,"#vSalesOrderReturns_salesOrderReturnSummaryNewRow","dxButton")},bi=function(){return DXUtility.getDXInstance(null,"#vSalesOrderReturns_salesOrderReturnSummaryDeleteRows","dxButton")},ct,ki=function(){for(var t=$(".dx-command-edit","[id$=SummaryDataGrid]"),n=0;n<t.length;n++)if($(t[n]).text().trim().indexOf("Save")>=0)return!0;return!1},ti=function(){var n=!1,r=!0,t=i.popupEditData();t.DocumentStatusID()&&(r=!1);(t.DocumentStatusID()==2||t.DocumentStatusID()==3||t.DocumentStatusID()==4)&&(n=!0);ki()||(k()&&a()&&v()&y()&&k().option("disabled",n),k().option("disabled",n),a().option("disabled",r||n),b().option("disabled",r||n),v().option("disabled",t.DocumentStatusID()!=2),y().option("disabled",n),clearInterval(ct))};return i.popupEditOptions.onContentReady=function(){var u=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop("Order Details"));var r=$('<div class="desktop-commonGridView-commands">'),e=$('<div id="vSalesOrderReturns_salesOrderReturnSummaryNewRow">').dxButton({text:"New",icon:"add",onClick:function(){var n=i.form().validate().isValid;n?ut(function(){f().addRow()}):DevExpress.ui.dialog.alert("Please specify the required fields.","New Order Details Failed")}}),o=$('<div id="vSalesOrderReturns_salesOrderReturnSummaryDeleteRows">').dxButton({text:"Delete",icon:"remove",disabled:!0,onClick:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(n){n&&DXUtility.deleteSelectedRows(f())})}});r.append(e);r.append(o);n.append(r);n.append($('<div id="vSalesOrderReturns_salesOrderReturnSummaryDataGrid">').dxDataGrid({dataSource:[],showBorders:!0,paging:{enabled:!1},allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,editing:{editMode:"row",allowAdding:!1,allowUpdating:!0,allowDeleting:!0},onInitNewRow:function(n){k().option("disabled",!0);a().option("disabled",!0);b().option("disabled",!0);v().option("disabled",!0);y().option("disabled",!0);ct=setInterval(ti,500);n.data.QtyOrder=0;n.data.QtyOrderConv="0/0/0";n.data.AddDiscountStrataPercentage=0},onEditorPreparing:function(n){var t;n.parentType=="dataRow"&&(n.row!=undefined&&n.row.rowIndex!=undefined&&(n.component.editRowIndex=n.row.rowIndex),n.dataField=="Product"?(n.row.inserted?n.editorElement.dxLookup({dataSource:l,displayExpr:"Product",valueExpr:"Product",searchExpr:"Product",searchPlaceholder:"Product",popupWidth:"712px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){CommonUtility.createProductLookupHeader("vSalesOrderReturns_productIDLookup",n.element,2)},itemTemplate:function(n,t,i){return CommonUtility.createProductLookupItem(n,i,2)},onValueChanged:function(t){var i,r;t.value&&(i=this.option("selectedItem"),i&&(n.component.cellValue(n.row.rowIndex,"QtyOnHand",i.QtyOnHand()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),r=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyOrderConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyOrder",r.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",r.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",r.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",r.qtyConvS),it(n)));n.component.cellValue(n.row.rowIndex,"Product",t.value);n.setValue(t.value)}}):(ut(function(){}),n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Product()))),n.cancel=!0):n.dataField=="PriceDate"?(n.editorElement.dxDateBox({showClearButton:!0,placeholder:"Transaction Date",value:n.value,onValueChanged:function(t){t.component.option("value",t.value);n.setValue(t.value);it(n)}}),n.cancel=!0):n.dataField=="QtyOrderConv"?(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onEnterKey:function(){f().saveEditData()},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyOrder",i.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvL",i.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvM",i.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvS",i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value);it(n)}}),n.cancel=!0):n.dataField=="AddDiscountStrataPercentage"&&(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==190||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onValueChanged:function(t){(t.value==null||t.value=="")&&(t.value=0);t.component.option("value",t.value);n.setValue(t.value);it(n)}}),n.cancel=!0))},onRowInserted:function(n){CommonUtility.validateDataGridInsertedTransactionSummary(n.component,new Dismoyo_Ciptoning_Client.vSalesOrderReturnSummaryViewModel(n.data).toJS());ht(n);CommonUtility.updateSalesOrderSummaryForm(w(),n.component);f().clearSelection()},onRowUpdated:function(n){n.data.ProductID=n.key.ProductID;ht(n);CommonUtility.updateSalesOrderSummaryForm(w(),n.component);f().clearSelection()},onRowRemoved:function(n){CommonUtility.validateDataGridRemovedTransactionSummary(n.component,n.data.toJS());CommonUtility.updateSalesOrderSummaryForm(w(),n.component)},onEditingStart:function(){k().option("disabled",!0);a().option("disabled",!0);b().option("disabled",!0);v().option("disabled",!0);y().option("disabled",!0);ct=setInterval(ti,500)},onRowUpdating:function(n){if(n.newData.QtyOrderConv){var t=CommonUtility.getConversion(n.newData.QtyOrderConv,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS"));n.newData.QtyConvL=t.qtyConvL;n.newData.QtyConvM=t.qtyConvM;n.newData.QtyConvS=t.qtyConvS;n.newData.QtyOrder=t.qtyTransaction}n.newData.SubtotalWeight=DXUtility.getValue(n.oldData,"SubtotalWeight");n.newData.SubtotalDimension=DXUtility.getValue(n.oldData,"SubtotalDimension");n.newData.UnitGrossPrice=DXUtility.getValue(n.oldData,"UnitGrossPrice");n.newData.RawSubtotalGrossPrice=DXUtility.getValue(n.oldData,"RawSubtotalGrossPrice");n.newData.RawSubtotalPrice=DXUtility.getValue(n.oldData,"RawSubtotalPrice");n.newData.RawDiscountStrata1Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata1Amount");n.newData.RawDiscountStrata2Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata2Amount");n.newData.RawDiscountStrata3Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata3Amount");n.newData.RawDiscountStrata4Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata4Amount");n.newData.RawDiscountStrata5Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata5Amount");n.newData.RawAddDiscountStrataAmount=DXUtility.getValue(n.oldData,"RawAddDiscountStrataAmount");n.newData.RawSubtotalDiscountStrata1=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata1");n.newData.RawSubtotalDiscountStrata2=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata2");n.newData.RawSubtotalDiscountStrata3=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata3");n.newData.RawSubtotalDiscountStrata4=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata4");n.newData.RawSubtotalDiscountStrata5=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata5");n.newData.RawSubtotalGross=DXUtility.getValue(n.oldData,"RawSubtotalGross");n.newData.RawSubtotal=DXUtility.getValue(n.oldData,"RawSubtotal");n.newData.SubtotalDiscountStrata1=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata1");n.newData.SubtotalDiscountStrata2=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata2");n.newData.SubtotalDiscountStrata3=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata3");n.newData.SubtotalDiscountStrata4=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata4");n.newData.SubtotalDiscountStrata5=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata5");n.newData.TaxPercentage=DXUtility.getValue(n.oldData,"TaxPercentage");n.newData.SubtotalGrossPrice=DXUtility.getValue(n.oldData,"SubtotalGrossPrice");n.newData.SubtotalPrice=DXUtility.getValue(n.oldData,"SubtotalPrice");n.newData.UnitPrice=n.component.cellValue(n.component.editRowIndex,"UnitPrice");n.newData.DiscountStrata1Percentage=DXUtility.getValue(n.oldData,"DiscountStrata1Percentage");n.newData.DiscountStrata1Amount=DXUtility.getValue(n.oldData,"DiscountStrata1Amount");n.newData.DiscountStrata2Percentage=DXUtility.getValue(n.oldData,"DiscountStrata2Percentage");n.newData.DiscountStrata2Amount=DXUtility.getValue(n.oldData,"DiscountStrata2Amount");n.newData.DiscountStrata3Percentage=DXUtility.getValue(n.oldData,"DiscountStrata3Percentage");n.newData.DiscountStrata3Amount=DXUtility.getValue(n.oldData,"DiscountStrata3Amount");n.newData.DiscountStrata4Percentage=DXUtility.getValue(n.oldData,"DiscountStrata4Percentage");n.newData.DiscountStrata4Amount=DXUtility.getValue(n.oldData,"DiscountStrata4Amount");n.newData.DiscountStrata5Percentage=DXUtility.getValue(n.oldData,"DiscountStrata5Percentage");n.newData.DiscountStrata5Amount=DXUtility.getValue(n.oldData,"DiscountStrata5Amount");n.newData.AddDiscountStrataAmount=n.component.cellValue(n.component.editRowIndex,"AddDiscountStrataAmount");n.newData.SubtotalGross=n.component.cellValue(n.component.editRowIndex,"SubtotalGross");n.newData.SubtotalTax=n.component.cellValue(n.component.editRowIndex,"SubtotalTax");n.newData.Subtotal=n.component.cellValue(n.component.editRowIndex,"Subtotal");si(n.oldData.ProductID(),n.newData)},onRowValidating:function(n){var t=DXUtility.getValue(n.newData,"QtyOrder");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyOrder"));t<=0&&(n.errorText="Order Qty must be greater than 0.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},onDataErrorOccurred:function(n){var t=n.component._controllers.editing._editData[0].data.Product;switch(n.error.__id){case"E4008":n.error.message="Product '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},columns:[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"Product",caption:"Product",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$(f().element()),r,i,e;!u.find(".datagrid-bandedHeader:first").length>0&&(r=f().option("selection").mode=="none"?!1:!0,i='<tr class="dx-row dx-column-lines datagrid-bandedHeader" style="border-top-style: none !important;">',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colSpan="1">Disc 1-5<\/td>',i+='       <td class="dx-datagrid-action" colSpan="2">Additional Disc<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",e=u.find(".dx-header-row:first-child"),$(i).insertBefore(e[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"120px",allowEditing:!1,dataType:"number"},{dataField:"PriceDate",caption:"Price Date",width:"140px",dataType:"date"},{dataField:"UnitPrice",caption:"Unit Price",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"QtyOrderConv",caption:"Qty (L/M/S)",width:"100px",alignment:"right",validationRules:[{type:"required"},wt],cellTemplate:function(n,t){n.append(ci(t.data,"QtyOrderConv",2))}},{dataField:"DiscountStrataDefaultAmount",caption:"Amount",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2,calculateCellValue:function(n){var t=DXUtility.getValue(n,"DiscountStrata1Amount"),i=DXUtility.getValue(n,"DiscountStrata2Amount"),r=DXUtility.getValue(n,"DiscountStrata3Amount"),u=DXUtility.getValue(n,"DiscountStrata4Amount"),f=DXUtility.getValue(n,"DiscountStrata5Amount");return isNaN(t)&&(t=0),isNaN(i)&&(i=0),isNaN(r)&&(r=0),isNaN(u)&&(u=0),isNaN(f)&&(f=0),t+i+r+u+f}},{dataField:"AddDiscountStrataPercentage",caption:"%",width:"40px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"AddDiscountStrataAmount",caption:"Amount",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"SubtotalGross",caption:"DPP",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"SubtotalTax",caption:"VAT",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"Subtotal",caption:"Subtotal",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2}]}));n.append($('<div id="vSalesOrderReturns_salesOrderReturnSummaryForm" style="margin-top: 9px;">').dxForm({deferRendering:!1,colCount:4,showColonAfterLabel:!1,labelLocation:"left",alignItemLabels:!0,items:[{itemType:"empty",colSpan:3},{dataField:"TotalGross",label:{text:"Total DPP"},colSpan:1,cssClass:"salesOrderSummaryForm-item-label salesOrderSummaryForm-item-textInput",editorOptions:{readOnly:!0}},{itemType:"empty",colSpan:2},{itemType:"empty",colSpan:1},{dataField:"TotalTax",label:{text:"Total VAT"},colSpan:1,cssClass:"salesOrderSummaryForm-item-label salesOrderSummaryForm-item-textInput",editorOptions:{readOnly:!0}},{itemType:"empty",colSpan:3},{dataField:"Total",label:{text:"Total"},colSpan:1,cssClass:"salesOrderSummaryForm-item-label salesOrderSummaryForm-item-textInput",editorOptions:{readOnly:!0}}]}));var t=$("#commonPopupEdit_extCommands"),s=$('<div id="vSalesOrderReturns_salesOrderReturnPrintDO" style="margin-right: 32px;">').dxButton({text:"Print DO",icon:"icons8-print",onClick:function(){i.events.performPrintDO(this)}}),h=$('<div id="vSalesOrderReturns_salesOrderReturnPost">').dxButton({text:"Post",icon:"icons8-check-green",onClick:function(){i.events.performPost(this)}}),c=$('<div id="vSalesOrderReturns_salesOrderReturnDiscard">').dxButton({text:"Discard",icon:"icons8-trash-red",onClick:function(){i.events.performDiscard(this)}}),p=$('<div id="vSalesOrderReturns_salesOrderReturnVoid" style="margin-right: 16px;">').dxButton({text:"Void",icon:"icons8-delete-red",onClick:function(){i.events.performVoid(this)}}),d=$('<div id="vSalesOrderReturns_salesOrderReturnSaveAsDraftAndNew">').dxButton({text:"Save & New",icon:"icons8-save",onClick:function(){i.events.performSaveAsDraftAndNew(this)}});u.append(DXUtility.createFormItemGroupWithCaption("").append(n));t.append(s);t.append(h);t.append(c);t.append(p);t.append(d)},e.events.performNewRow=function(){st(null)},i.events.performOK=function(){p(null,3)},i.events.performPrintDO=function(){var n=i.popupEditData();ai(n.DODocumentID())},i.events.performPost=function(){DevExpress.ui.dialog.confirm("Are you sure want to Post this transaction?","Post Confirmation").done(function(n){n&&p(2,3)})},i.events.performDiscard=function(){DevExpress.ui.dialog.confirm("Are you sure want to Discard this transaction?","Discard Confirmation").done(function(n){n&&p(3,3)})},i.events.performVoid=function(){DevExpress.ui.dialog.confirm("Are you sure want to Void this transaction?","Void Confirmation").done(function(n){n&&p(4,3)})},i.events.performSaveAsDraftAndNew=function(){p(1,2)},i.events.performCancel=function(){i.popupEditOptions.visible(!1);d&&(e.dataGrid().refresh(),d=!1)},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form(),r,u;CommonUtility.cascadeValueChanged(t,n.selectedItem,n.value,"Site",["Area","Region","Territory"],[]);r="";u="";n.selectedItem?(r=bt(n.selectedItem.Code()),u=kt(n.selectedItem.Code()),t.getEditor("Company").option("value",n.selectedItem.Company())):n.previousValue!=null&&t.getEditor("Company").option("value",null);dt(t,n.value);t.getEditor("DocumentCode").option("value",r);t.getEditor("DODocumentCode").option("value",u)}}}]},{itemType:"group",caption:"Sales Order Return",colCount:6,colSpan:3,items:[{dataField:"DocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"TransactionDate",label:{text:"Transaction Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();n.component.option("max",null);t.getEditor("DOReceivedDate").option("min",n.value)}}},{dataField:"DocumentStatusID",label:{text:"Status"},colSpan:1,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"NEW",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"CustomerID",label:{text:"Customer"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxLookup",editorOptions:{dataSource:[],displayExpr:"Customer",valueExpr:"ID",searchExpr:["Code","Name","Address1","Address2","Address3"],searchPlaceholder:"Customer/Address",searchEnabled:!1,popupWidth:"1082px",showPopupTitle:!1,fieldEditEnabled:!0,onOpened:function(){},onClosed:function(){},onContentReady:function(n){var t=i.form(),r=Dismoyo_Ciptoning_Client.app.CurrentUser;CommonUtility.createCustomerLookupHeader("vSalesOrderReturns_customerIDLookup",n.element,oi("Customer.Category1"),r.SiteID(),t)},itemTemplate:function(n,t,i){return CommonUtility.createCustomerLookupItem(n,i)},onValueChanged:function(n){var t;if(n.value&&(t=n.selectedItem,t)){var r=i.popupEditData(),u=i.form(),f=null,e=null,o=null;nt=undefined;tt=undefined;r.PriceGroupID(undefined);r.DiscountGroupID(undefined);t&&(f=t.SalesmanID(),e=t.WarehouseID(),o=t.TermOfPaymentID(),nt=Dismoyo_Ciptoning_Client.LocalStore.vProductPrices.dataByFilter(["PriceGroupID","=",t.PriceGroupID()]),tt=Dismoyo_Ciptoning_Client.LocalStore.vDiscountGroups.expandedDataByKey(t.DiscountGroupID()),r.PriceGroupID(t.PriceGroupID()),r.DiscountGroupID(t.DiscountGroupID()));n.component.option("value",n.value);u.getEditor("SalesmanID").option("value",f);u.getEditor("WarehouseID").option("value",e);gt(u,o)}}}},{itemType:"empty",colSpan:3},{dataField:"SalesmanID",label:{text:"Salesman"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Salesman",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t,u,r;s=[];l=[];n.value&&(t=i.popupEditData(),f().cancelEditData(),t.ChildSummaries([]),f().option("dataSource",et(t.ChildSummaries())));u=i.form();r=null;n.selectedItem&&(r=n.selectedItem.WarehouseID());u.getEditor("WarehouseID").option("value",r)}}},{dataField:"WarehouseID",label:{text:"Warehouse"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"",readOnly:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){if(s=[],l=[],n.value){var t=i.popupEditData(),r=f();r.cancelEditData();t.ChildSummaries([]);r.option("dataSource",et(t.ChildSummaries()))}}}},{itemType:"empty",colSpan:1},{dataField:"TermOfPaymentID",validationRules:[{type:"required"}],label:{text:"Term of Payment"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"ReferenceNumber",label:{text:"Reference Number"},colSpan:3,editorOptions:{maxLength:30,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1},{dataField:"ReasonID",validationRules:[{type:"required"}],label:{text:"Reason"},colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","SOReturnReason"]),displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)}}}]},{itemType:"group",caption:"Delivery Order",colCount:6,colSpan:3,items:[{dataField:"DODocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){commSonPopupEdit.events.performOK(this)}}},{itemType:"empty",colSpan:3},{dataField:"DOPrintedCount",label:{text:"Printed Count"},colSpan:1,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DOLastPrintedDate",label:{text:"Last Printed Date"},colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DOReceivedDate",label:{text:"Received Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();n.component.option("min",null);t.getEditor("TransactionDate").option("max",n.value)}}}]}],h=new Dismoyo_Ciptoning_Client.CommonPopupIFrame,h.okOptions.visible=!1,h.cancelOptions.text="Close",r=new Dismoyo_Ciptoning_Client.ProductLotPopupEdit,r.formOptions.colCount=4,r.saveOptions.icon="icons8-save",r.events.performSave=function(){yi()},r.dataGridOptions.onInitNewRow=function(n){n.data.QtyOrder=0;n.data.QtyOrderConv="0/0/0"},r.dataGridOptions.onEditorPreparing=function(n){if(n.parentType=="dataRow")if(n.dataField=="ProductLotCode")n.row.inserted?n.editorElement.dxLookup({dataSource:new DevExpress.data.DataSource({store:s,filter:["ProductID","=",r.popupEditData().ProductID()]}),displayExpr:"ProductLotCode",valueExpr:"ProductLotCode",searchExpr:"ProductLotCode",searchPlaceholder:"Lot Number",popupWidth:"582px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){var t=r.popupEditOptions.itemStatusID;CommonUtility.createProductLotLookupHeader("vSalesOrderReturns_productLotIDLookup",n.element,t)},itemTemplate:function(n,t,i){var u=r.popupEditOptions.itemStatusID,f=rt(u);return CommonUtility.createProductLotLookupItem(n,i,f.qtyOnHandColumn)},onValueChanged:function(t){var i,e,f,u;t.value&&(i=this.option("selectedItem"),i&&(e=r.popupEditOptions.itemStatusID,f=rt(e),n.component.cellValue(n.row.rowIndex,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductLotID",i.ProductLotID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductLotCode",i.ProductLotCode()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),u=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyOrderConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyOrder",u.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",u.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",u.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",u.qtyConvS)));n.component.cellValue(n.row.rowIndex,"ProductLotCode",t.value);n.setValue(t.value)}}):(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.ProductLotCode()))),n.cancel=!0;else if(n.dataField=="QtyOrderConv"){var t="";n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyOrder",i.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvL",i.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvM",i.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvS",i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}});n.cancel=!0}},r.dataGridOptions.onRowInserted=function(n){CommonUtility.validateDataGridInsertedTransactionDetails(n.component,new Dismoyo_Ciptoning_Client.vSalesOrderReturnDetailsViewModel(n.data).toJS())},r.dataGridOptions.onRowRemoved=function(n){CommonUtility.validateDataGridRemovedTransactionDetails(n.component,n.data.toJS())},r.dataGridOptions.onRowUpdating=function(n){CommonUtility.validateDataGridUpdatingTransactionDetails(n,"QtyConvL","QtyConvM","QtyConvS","QtyOrderConv","QtyOrder")},r.dataGridOptions.onRowValidating=function(n){var i=r.popupEditOptions.itemStatusID,u=rt(i),t=DXUtility.getValue(n.newData,"QtyOrder");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyOrder"));t<=0&&(n.errorText="Order Qty must be greater than 0.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.onDataErrorOccurred=function(n){var t=n.component._controllers.editing._editData[0].data.ProductLotCode;switch(n.error.__id){case"E4008":n.error.message="Lot Number '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.summary={totalItems:[{name:"TotalQtyPcs",showInColumn:"QtyOrderConv",displayFormat:"Total Qty (Pcs): {0}",valueFormat:"decimal",summaryType:"custom"},{name:"TotalQtyLMS",showInColumn:"QtyOrderConv",displayFormat:"(L/M/S): {0}",valueFormat:"string",summaryType:"custom"}],calculateCustomSummary:function(n){CommonUtility.updateProductLotEditingSummary(n,"QtyOrderConv","QtyOrder")}},r.dataGridOptions.columns=[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"ProductLotID",visible:!1},{dataField:"ProductLotCode",caption:"Lot Number",validationRules:[{type:"required"}]},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"120px",allowEditing:!1,dataType:"number"},{dataField:"QtyOrderConv",caption:"Order Qty (L/M/S)",width:"150px",alignment:"right",validationRules:[{type:"required"},wt]}],r.formOptions.items=[{itemType:"group",caption:"Product",colCount:4,colSpan:4,items:[{dataField:"Product",label:{text:"Product"},colSpan:4,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOnHand",label:{text:"On Hand Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2},{dataField:"QtyOrder",label:{text:"Order Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOrderConv",label:{text:"(L/M/S)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],{isReady:lt.promise(),dataSource:o,refreshList:pt,viewShowing:ri,viewDisposing:ui,openCreateViewAsRoot:ii,icon:"Images/sales_order_return_32px.png",dataSource_vSalesOrderReturnDetails:fi,dataSource_vSalesOrderReturnSummary:ei,dataSource_vStockOnHandAll:s,dataSource_vStockOnHandAllByProduct:l,collapsibleFilter:u,commonGridView:e,commonPopupEdit:i,commonPopupIFrame:h,productLotPopupEdit:r,salesOrderReturnSummaryDataGrid:f,salesOrderReturnPost:a,salesOrderReturnDiscard:b,salesOrderReturnVoid:v,salesOrderReturnSaveAsDraftAndNew:y,isLotNumberEntryRequired:c}};Dismoyo_Ciptoning_Client.vSalesOrderSamples=function(n,t){"use strict";function vt(){ft=!0}function yt(){nt=CommonUtility.configureCommonGridViewLayout("vSalesOrderSamples");nt||setTimeout(yt,50)}function ri(){var n,t;yt();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],s.filter(t));at()?ft&&pt():(at(s),s.load().always(function(){lt.resolve()}))}function ui(){Dismoyo_Ciptoning_Client.DB.vSalesOrderSamples.off("modified",vt)}function pt(){ft=!1;s.pageIndex(0);s.load()}function bt(n){return(n?n:"(Site Code)")+"-YY-04-(Auto Generated)"}function kt(n){return(n?n:"(Site Code)")+"-YY-10-(Auto Generated)"}function dt(n,t){t?Dismoyo_Ciptoning_Client.DB.vSites.byKey(t).done(function(n){c=n.IsLotNumberEntryRequired}):(t=null,c=undefined);var i=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["ID","Customer","Address","Category1","SalesmanID","Salesman","WarehouseID","TermOfPaymentID","PriceGroupID","DiscountGroupID","SiteID"],filter:[["IsDeleted","=",!1],"and",["StatusID","=",1],"and",["SiteID","=",t]],map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)}}),r=DataUtility.GetLookupSalesmanDataSource([["IsDeleted","=",!1],"and",["StatusID","=",1],"and",["SiteID","=",t]]);n.getEditor("CustomerID").option("value",null);n.getEditor("CustomerID").option("dataSource",i);i.load();n.getEditor("SalesmanID").option("value",null);n.getEditor("SalesmanID").option("dataSource",r);r.load()}function gt(n,t){var i=[["Group","=","CustomerTermOfPayment"]],r;t!=undefined&&t!=null&&(i.push("and"),i.push(["Value_Int32","<=",t]));r=DataUtility.GetLookupSystemLookupDataSource(i);n.getEditor("TermOfPaymentID").option("value",null);n.getEditor("TermOfPaymentID").option("dataSource",r);n.getEditor("TermOfPaymentID").option("value",t);r.load()}function oi(n){var t=Dismoyo_Ciptoning_Client.LocalStore.vSystemParameters.dataByFilter(["ID","=",n]);return t.length>0?t[0].Value():null}function rt(n){return CommonUtility.calcProductPriceAndDiscount(i.form().getEditor("TransactionDate").option("value"),n.component,n.row.rowIndex,n.row.data,tt,it,!0)}function ni(n){CommonUtility.updateSummariesArrayStore(f().option("dataSource").store(),n)}function si(n,t){CommonUtility.updateDeferSummariesArrayStore(f().option("dataSource").store(),n,t)}function hi(n){return CommonUtility.validateSummaryArrayStore(f().option("dataSource").store(),"vSalesOrderSampleSummaryViewModel",n)}function et(n){return CommonUtility.createArrayDataSource("vSalesOrderSampleSummaryViewModel",["ProductID"],n)}function ci(n,t,i){var r=$('<div class="dx-command-edit" style="text-align: right; padding-right: 5px;">'),o;if(r.append($('<a style="color: inherit;">').text(n[t]())),r.append("&nbsp;"),c){var u=t.replace("Conv",""),s=n[u](),f=n.ChildDetails(),e=0;for(o in f)e+=f[o][u]();r.append($('<a class="dx-link dxcustom-linkbutton dx-icon-icons8-view-details" title="Edit Lot Number">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<\/a><span id="LotMark_'+n.ProductID()+"_"+t+'" class="dx-icon-overflow '+(e==s?"hidden":"")+'" style="color:red; font-size: 14px; margin-left: -6px;"><\/span>').on("dxclick",function(){ut(function(){vi(n,i)})}));r.append("&nbsp;")}return r}function li(n){var t=f().option("editing"),i=f().option("selection");i.mode=n?"multiple":"none";t.allowUpdating=n;t.allowDeleting=n;f().option("editing",t);f().option("selection",i);wi().option("disabled",!n);bi().option("disabled",!0);f().repaint()}function ot(n,t){showLoadingPanel();new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderSamples,select:["DocumentID","DocumentCode","TransactionDate","PODocumentID","PODocumentCode","POTransactionDate","SalesmanID","WarehouseID","SiteID","CompanyID","Company","AreaID","RegionID","TerritoryID","CustomerID","PriceGroupID","DiscountGroupID","TermOfPaymentID","ReferenceNumber","DODocumentID","DODocumentCode","DOShipmentDate","DOReceivedDate","DOPrintedCount","DOLastPrintedDate","RawTotalGrossPrice","RawTotalPrice","RawTotalDiscountStrata1Amount","RawTotalDiscountStrata2Amount","RawTotalDiscountStrata3Amount","RawTotalDiscountStrata4Amount","RawTotalDiscountStrata5Amount","RawTotalAddDiscountStrataAmount","RawTotalGross","RawTotalTax","RawTotal","TotalGrossPrice","TotalPrice","TotalDiscountStrata1Amount","TotalDiscountStrata2Amount","TotalDiscountStrata3Amount","TotalDiscountStrata4Amount","TotalDiscountStrata5Amount","TotalAddDiscountStrataAmount","TotalGross","TotalTax","Total","TotalWeight","TotalDimension","AddDiscountStrataReason","DocumentStatusID","DocumentStatusReason"],filter:["DocumentID","=",n],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderSampleViewModel(n)}}).load().done(function(i){i.length>0?new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderSampleSummaries,select:["DocumentID","ProductID","ProductCode","Product","ProductUOMLID","ProductUOMMID","ProductUOMSID","ProductWeight","ProductDimensionL","ProductDimensionW","ProductDimensionH","ProductConversionL","ProductConversionM","ProductConversionS","QtyOnHand","QtyConvL","QtyConvM","QtyConvS","Qty","QtyOrderConv","QtyOrder","UnitGrossPrice","UnitPrice","DiscountStrata1Percentage","DiscountStrata2Percentage","DiscountStrata3Percentage","DiscountStrata4Percentage","DiscountStrata5Percentage","AddDiscountStrataPercentage","TaxPercentage","RawSubtotalGrossPrice","RawSubtotalPrice","RawSubtotalDiscountStrata1","RawDiscountStrata1Amount","RawSubtotalDiscountStrata2","RawDiscountStrata2Amount","RawSubtotalDiscountStrata3","RawDiscountStrata3Amount","RawSubtotalDiscountStrata4","RawDiscountStrata4Amount","RawSubtotalDiscountStrata5","RawDiscountStrata5Amount","RawAddDiscountStrataAmount","RawSubtotalGross","RawSubtotalTax","RawSubtotal","SubtotalGrossPrice","SubtotalPrice","SubtotalDiscountStrata1","DiscountStrata1Amount","SubtotalDiscountStrata2","DiscountStrata2Amount","SubtotalDiscountStrata3","DiscountStrata3Amount","SubtotalDiscountStrata4","DiscountStrata4Amount","SubtotalDiscountStrata5","DiscountStrata5Amount","AddDiscountStrataAmount","SubtotalGross","SubtotalTax","Subtotal","SubtotalWeight","SubtotalDimension"],filter:["DocumentID","=",n],sort:["ProductID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderSampleSummaryViewModel(n)}}).load().done(function(r){r.length>0?new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderSampleDetails,select:["DocumentID","ProductID","ProductLotID","ProductLotCode","QtyOnHand","QtyConvL","QtyConvM","QtyConvS","Qty","QtyOrderConv","QtyOrder"],filter:["DocumentID","=",n],sort:["ProductID","ProductLotID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderSampleDetailsViewModel(n)}}).load().done(function(n){var u,f,o,e;if(n.length>0){for(u=r,f=-1,o=0;o<n.length;o++)e=n[o],(o==0||u[f].ProductID()!=e.ProductID())&&(f++,u[f].ChildDetails=ko.observableArray([])),e.ProductCode(u[f].ProductCode()),e.Product(u[f].Product()),e.ProductUOMLID(u[f].ProductUOMLID()),e.ProductUOMMID(u[f].ProductUOMMID()),e.ProductUOMSID(u[f].ProductUOMSID()),e.ProductConversionL(u[f].ProductConversionL()),e.ProductConversionM(u[f].ProductConversionM()),e.ProductConversionS(u[f].ProductConversionS()),u[f].ChildDetails().push(e);i[0].ChildSummaries(u);hideLoadingPanel();g=t;st(i[0])}else DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("The details of selected data is not found."),"Load Failed"),hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load details of selected data."),"Load Failed");hideLoadingPanel()}):(DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("The summary of selected data is not found."),"Load Failed"),hideLoadingPanel())}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load summary of selected data."),"Load Failed");hideLoadingPanel()}):(DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("The selected data is not found."),"Load Failed"),hideLoadingPanel())}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function st(n){var e=!1,s,g,p,nt,rt,w,ft,ot,st,ct;n||(n=new Dismoyo_Ciptoning_Client.vSalesOrderSampleViewModel,e=!0);i.popupEditData(n);i.popupEdit().option("title",(e?"New":"Edit")+" Sales Order Sample");i.popupEditOptions.editingKey=n.DocumentID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);var u=Dismoyo_Ciptoning_Client.app.CurrentUser,t=i.form(),d=b();DXUtility.resetFormValidation(t);var lt=n.DocumentCode(),at=n.DODocumentCode(),r=!1,h=[];if(c=n.IsSiteLotNumberEntryRequired(),e)n.DocumentID(new DevExpress.data.Guid),n.DocumentStatusID(null),u.IsHeadOffice()||(n.TerritoryID(u.TerritoryID()),n.RegionID(u.RegionID()),n.AreaID(u.AreaID()),n.SiteID(u.SiteID()),n.SiteCode(u.SiteCode()),n.CompanyID(u.CompanyID()),n.Company(u.Company())),lt=bt(n.SiteCode()),at=kt(n.SiteCode());else if(h=n.ChildSummaries(),n.DocumentStatusID()!=1||c)(n.DocumentStatusID()==2||n.DocumentStatusID()==3||n.DocumentStatusID()==4)&&(r=!0);else{for(s=[],g=0,p=0;p<h.length;p++){for(nt=h[p].ChildDetails(),rt=0,w=0;w<nt.length;w++)nt[w].ProductLotCode().indexOf("DUMMY")<0&&rt++;rt>0&&(s[g]=h[p],g++)}s.length>0&&(o=[],l=[],t.getEditor("SalesmanID").option("value",n.SalesmanID()),ut(function(){for(var t,n=0;n<s.length;n++)t={data:s[n].toJS()},ht(t,s)}))}li(!r);pi().option("disabled",e);a().option("disabled",e||r);k().option("disabled",e||r);v().option("disabled",n.DocumentStatusID()!=2);y().option("disabled",r);i.ok().option("disabled",r);ft=n.PriceGroupID();ot=n.DiscountGroupID();t.itemOption("Organization").visible&&(t.getEditor("TerritoryID").option("value",n.TerritoryID()),t.getEditor("RegionID").option("value",n.RegionID()),t.getEditor("AreaID").option("value",n.AreaID()),t.getEditor("SiteID").option("value",n.SiteID()),t.getEditor("Company").option("value",n.Company()),t.getEditor("TerritoryID").option("readOnly",r),t.getEditor("RegionID").option("readOnly",r),t.getEditor("AreaID").option("readOnly",r),t.getEditor("SiteID").option("readOnly",r));dt(t,n.SiteID());gt(t,n.TermOfPaymentID());t.getEditor("DocumentCode").option("value",lt);t.getEditor("TransactionDate").option("value",n.TransactionDate());t.getEditor("CustomerID").option("value",n.CustomerID());t.getEditor("SalesmanID").option("value",n.SalesmanID());t.getEditor("WarehouseID").option("value",n.WarehouseID());t.getEditor("TermOfPaymentID").option("value",n.TermOfPaymentID());t.getEditor("ReferenceNumber").option("value",n.ReferenceNumber());t.getEditor("DocumentStatusID").option("value",n.DocumentStatusID());t.getEditor("PODocumentCode").option("value",n.PODocumentCode());t.getEditor("POTransactionDate").option("value",n.POTransactionDate());t.getEditor("DODocumentCode").option("value",at);t.getEditor("DOShipmentDate").option("value",n.DOShipmentDate());t.getEditor("DOReceivedDate").option("value",n.DOReceivedDate());t.getEditor("DOPrintedCount").option("value",n.DOPrintedCount());t.getEditor("DOLastPrintedDate").option("value",n.DOLastPrintedDate());d.getEditor("TotalGross").option("value",CommonUtility.getNumberFormat(n.TotalGross()));d.getEditor("TotalTax").option("value",CommonUtility.getNumberFormat(n.TotalTax()));d.getEditor("Total").option("value",CommonUtility.getNumberFormat(n.Total()));t.getEditor("TransactionDate").option("readOnly",r);t.getEditor("CustomerID").option("readOnly",r);t.getEditor("SalesmanID").option("readOnly",r);t.getEditor("TermOfPaymentID").option("readOnly",r);t.getEditor("ReferenceNumber").option("readOnly",r);t.getEditor("PODocumentCode").option("readOnly",r);t.getEditor("POTransactionDate").option("readOnly",r);t.getEditor("DOShipmentDate").option("readOnly",r);t.getEditor("DOReceivedDate").option("readOnly",r);st=new Date;e?(DXUtility.resetFormValidation(t),t.getEditor("TransactionDate").option("value",st),t.getEditor("DOShipmentDate").option("value",st)):(ft&&n.PriceGroupID(ft),ot&&n.DiscountGroupID(ot),tt=Dismoyo_Ciptoning_Client.LocalStore.vProductPrices.dataByFilter(["PriceGroupID","=",n.PriceGroupID()]),it=Dismoyo_Ciptoning_Client.LocalStore.vDiscountGroups.expandedDataByKey(n.DiscountGroupID()));ct=f();ct.cancelEditData();n.ChildSummaries(h);ct.option("dataSource",et(n.ChildSummaries()))}function p(n,t){var p,ri,r,o,h,u,c,v,ui;showLoadingPanel();var s=i.form(),oi=b(),a=s.validate().isValid,l=a?"":"Please specify the required fields.",fi=e.dataGrid(),ei=fi.option("dataSource"),w=f().option("dataSource"),y=[];for(h=0;h<w.store()._array.length;h++)y.push(new Dismoyo_Ciptoning_Client.vSalesOrderSampleSummaryViewModel(w.store()._array[h]));a&&y.length<=0&&(l="Please specify at least one item in Order Details.",a=!1);var k=0,d=0,nt=0,tt=0,it=0,rt=0,ut=0,ft=0,et=0,ht=0,ct=0,lt=0,at=0,vt=0,yt=0,pt=0,wt=0,bt=0,kt=0,dt=0,gt=0,ni=0,ti=0,ii=0;if(a)for(h=0;h<y.length;h++){for(u=y[h],p=0,k+=u.RawSubtotalGrossPrice(),d+=u.RawSubtotalPrice(),nt+=u.RawDiscountStrata1Amount(),tt+=u.RawDiscountStrata2Amount(),it+=u.RawDiscountStrata3Amount(),rt+=u.RawDiscountStrata4Amount(),ut+=u.RawDiscountStrata5Amount(),ft+=u.RawAddDiscountStrataAmount(),et+=u.RawSubtotalGross(),ht+=u.RawSubtotalTax(),ct+=u.RawSubtotal(),lt+=u.SubtotalGrossPrice(),at+=u.SubtotalPrice(),vt+=u.DiscountStrata1Amount(),yt+=u.DiscountStrata2Amount(),pt+=u.DiscountStrata3Amount(),wt+=u.DiscountStrata4Amount(),bt+=u.DiscountStrata5Amount(),kt+=u.AddDiscountStrataAmount(),dt+=u.SubtotalGross(),gt+=u.SubtotalTax(),ni+=u.Subtotal(),ti+=u.SubtotalWeight(),ii+=u.SubtotalDimension(),c=0;c<u.ChildDetails().length;c++)v=u.ChildDetails()[c],p+=v.QtyOrder();u.QtyOrder()!=p&&(l==""?l="Following products quantity of Order Details items is not matched: ":l+=", ",l+=u.Product(),a=!1)}if(ri=Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID(),s.itemOption("Organization").visible&&(ri=s.getEditor("SiteID").option("value")),a){for(r=i.popupEditData(),r.TransactionDate(s.getEditor("TransactionDate").option("value")),r.CustomerID(s.getEditor("CustomerID").option("value")),r.SalesmanID(s.getEditor("SalesmanID").option("value")),r.WarehouseID(s.getEditor("WarehouseID").option("value")),r.TermOfPaymentID(s.getEditor("TermOfPaymentID").option("value")),r.ReferenceNumber(s.getEditor("ReferenceNumber").option("value")),r.PODocumentCode(s.getEditor("PODocumentCode").option("value")),r.POTransactionDate(s.getEditor("POTransactionDate").option("value")),r.DOShipmentDate(s.getEditor("DOShipmentDate").option("value")),r.DOReceivedDate(s.getEditor("DOReceivedDate").option("value")),r.DOPrintedCount(s.getEditor("DOPrintedCount").option("value")),r.DOLastPrintedDate(s.getEditor("DOLastPrintedDate").option("value")),r.RawTotalGrossPrice(k),r.RawTotalPrice(d),r.RawTotalDiscountStrata1Amount(nt),r.RawTotalDiscountStrata2Amount(tt),r.RawTotalDiscountStrata3Amount(it),r.RawTotalDiscountStrata4Amount(rt),r.RawTotalDiscountStrata5Amount(ut),r.RawTotalAddDiscountStrataAmount(ft),r.RawTotalGross(et),r.RawTotalTax(ht),r.RawTotal(ct),r.TotalGrossPrice(lt),r.TotalPrice(at),r.TotalDiscountStrata1Amount(vt),r.TotalDiscountStrata2Amount(yt),r.TotalDiscountStrata3Amount(pt),r.TotalDiscountStrata4Amount(wt),r.TotalDiscountStrata5Amount(bt),r.TotalAddDiscountStrataAmount(kt),r.TotalGross(dt),r.TotalTax(gt),r.Total(ni),r.TotalWeight(ti),r.TotalDimension(ii),r.ChildSummaries(y),o=ko.toJS(r),n&&(o.DocumentStatusID=n),o.DocumentStatusID||(o.DocumentStatusID=1),o.TransactionDate=DateTimeUtility.getFirstTimeOfDay(o.TransactionDate),o.POTransactionDate&&(o.POTransactionDate=DateTimeUtility.getFirstTimeOfDay(o.POTransactionDate)),o.DOShipmentDate=DateTimeUtility.getFirstTimeOfDay(o.DOShipmentDate),o.DOReceivedDate=DateTimeUtility.getFirstTimeOfDay(o.DOReceivedDate),h=0;h<o.ChildSummaries.length;h++){for(u=o.ChildSummaries[h],u.DocumentID=o.DocumentID,c=0;c<u.ChildDetails.length;c++)v=u.ChildDetails[c],v.DocumentID=o.DocumentID,v.Qty=v.QtyOrder*-1;u.Qty=u.QtyOrder*-1}ei.store().insert(o).done(function(n){CommonUtility.documentSuccessMessage(n.DocumentStatusID,function(){});g=!0;switch(t){case 1:i.events.performCancel();hideLoadingPanel();break;case 2:st(null);hideLoadingPanel();break;case 3:ot(r.DocumentID(),!0)}}).fail(function(n){var t=$(".dx-popup-normal>.dx-dialog-content");t.length==0&&DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})}else hideLoadingPanel();l!=""&&(ui=$(".dx-popup-normal>.dx-dialog-content"),ui.length==0&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(l),"Save Failed"))}function ai(n){h.popupEdit().option("title","Print Delivery Order");h.popupEditOptions.visible(!0);var t=h.iframe();h.showLoadingPanel();t.attr("src",Dismoyo_Ciptoning_Client.ReportWebsite.ExtDeliveryOrderReport.url([["DocumentID","=",n]]))}function ht(n,t){var a,e,v,s,r,l,h;if(!c){var p=i.popupEditData(),y=f(),u=[];if(t){for(r=0;r<t.length;r++)t[r].ChildDetails([]);u=t}else for(a=y.option("dataSource").store(),r=0;r<a._array.length;r++)u.push(new Dismoyo_Ciptoning_Client.vSalesOrderSampleSummaryViewModel(a._array[r]));if(e=n.data,v=$.grep(o,function(n){return n.ProductID()==DXUtility.getValue(e,"ProductID")&&n.ProductLotCode().indexOf("DUMMY")>=0}),v.length>0)for(s=v[0],DXUtility.setValue(e,"ProductLotID",s.ProductLotID()),DXUtility.setValue(e,"ProductLotCode",s.ProductLotCode()),DXUtility.setValue(e,"QtyOnHandGood",s.QtyOnHandGood()),DXUtility.setValue(e,"QtyOnHandHold",s.QtyOnHandHold()),DXUtility.setValue(e,"QtyOnHandBad",s.QtyOnHandBad()),r=0;r<u.length;r++)u[r].ProductID()==DXUtility.getValue(e,"ProductID")&&(l=$.grep(u[r].ChildDetails(),function(n){return n.ProductLotID()==DXUtility.getValue(e,"ProductLotID")}),l.length==0&&(l=[new Dismoyo_Ciptoning_Client.vSalesOrderSampleDetailsViewModel(e)],u[r].ChildDetails().push(l[0])),h=l[0],h.QtyConvL(DXUtility.getValue(u[r],"QtyConvL")),h.QtyConvM(DXUtility.getValue(u[r],"QtyConvM")),h.QtyConvS(DXUtility.getValue(u[r],"QtyConvS")),h.QtyOrder(DXUtility.getValue(u[r],"QtyOrder")),h.QtyOrderConv(DXUtility.getValue(u[r],"QtyOrderConv")),ni(u[r]));else DevExpress.ui.dialog.alert("DUMMY Lot Number for the selected product is not available.","Save Failed")}}function w(n){var t=null;switch(n){case 1:t="Good";break;case 2:t="Hold";break;case 3:t="Bad"}var i="QtyOnHand"+t,r="QtyConvL"+t,u="QtyConvM"+t,f="QtyConvS"+t,e="QtyOrder"+t,o="QtyOrderConv"+t;return{itemStatusName:t,qtyOnHandColumn:i,qtyConvLColumn:r,qtyConvMColumn:u,qtyConvSColumn:f,qtyOrderColumn:e,qtyOrderConvColumn:o}}function vi(n,t){var o=i.popupEditData(),f,h,c;r.popupEditData(n);r.popupEditOptions.editingKey=n.ProductID();r.popupEditOptions.itemStatusID=t;r.popupEditOptions.visible(!0);var s=r.dataGrid(),e=r.form(),u=!1;(o.DocumentStatusID()==2||o.DocumentStatusID()==3||o.DocumentStatusID()==4)&&(u=!0);f=r.dataGrid().option("editing");f.allowUpdating=!u;f.allowDeleting=!u;f.editEnabled=!u;f.removeEnabled=!u;r.dataGrid().option("editing",f);r.dataGrid().option("selection",{mode:u?"none":"multiple"});r.newRow().option("disabled",u);r.dataGrid().repaint();e.getEditor("Product").option("value",n.Product());e.getEditor("QtyOnHand").option("value",n.QtyOnHand());e.getEditor("QtyOrderConv").option("value",n.QtyOrderConv());h=CommonUtility.getConversion(n.QtyOrderConv(),DXUtility.getValue(n,"ProductConversionL"),DXUtility.getValue(n,"ProductConversionM"),DXUtility.getValue(n,"ProductConversionS"));e.getEditor("QtyOrder").option("value",h.qtyTransaction);n=hi(n);c=CommonUtility.createArrayDataSource("vSalesOrderSampleDetailsViewModel",["ProductID","ProductLotID"],n.ChildDetails());s.cancelEditData();s.option("dataSource",c)}function yi(){var n=r.popupEditData(),t=r.popupEditOptions.itemStatusID,i=w(t);CommonUtility.validateProductLotEditing(n,r.dataGrid().option("dataSource"),r.form().getEditor("QtyOrder").option("value"),"Order","vSalesOrderSampleDetailsViewModel","QtyConvL","QtyConvM","QtyConvS","QtyOrderConv","QtyOrder",!1)&&(ni(n),r.popupEditOptions.visible(!1),f().refresh())}function ut(n){if(o.length==0&&l.length==0){showLoadingPanel();var t=i.form(),r=t.getEditor("SalesmanID").option("value");new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesmanProducts,select:["ProductID","ProductCode","Product","ProductUOMLID","ProductUOMMID","ProductUOMSID","ProductConversionL","ProductConversionM","ProductConversionS"],filter:[["SalesmanID","=",r],"and",["ProductName","contains","SAMPLE"]],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesmanProductViewModel(n)}}).load().done(function(i){var u,e;if(i.length>0){var h=i,s=t.getEditor("WarehouseID").option("value"),r=[],f=[];for(u=0;u<i.length;u++)DXUtility.addFilterExpression(f,"ProductID","=",i[u].ProductID(),"or");DXUtility.addGroupFilterExpression(r,f,"and");DXUtility.addFilterExpression(r,"WarehouseID","=",s,"and");DXUtility.addFilterExpression(r,"QtyOnHandGood",">",0,"and");e=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOnHandAvailables,select:["ProductID","ProductLotID","ProductLotCode","ProductLot","ProductLotExpiredDate","QtyOnHandGood"],filter:r,sort:["WarehouseID","ProductID","ProductLotID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(n)}});e.load().done(function(t){for(var e,h,u=null,s=[],r=[],f=0;f<t.length;f++)s.push(new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(t[f].toJS())),e=r.length-1,h=t[f].ProductID(),f==0||r[e].ProductID()!=h?(r.push(new Dismoyo_Ciptoning_Client.vStockOnHandAllViewModel(t[f].toJS())),e++,u=$.grep(i,function(n){return n.ProductID()==h})):(r[e].QtyOnHandGood(r[e].QtyOnHandGood()+t[f].QtyOnHandGood()),r[e].QtyOnHandHold(r[e].QtyOnHandHold()+t[f].QtyOnHandHold()),r[e].QtyOnHandBad(r[e].QtyOnHandBad()+t[f].QtyOnHandBad())),s[f].ProductCode(u[0].ProductCode()),s[f].Product(u[0].Product()),s[f].ProductUOMLID(u[0].ProductUOMLID()),s[f].ProductUOMMID(u[0].ProductUOMMID()),s[f].ProductUOMSID(u[0].ProductUOMSID()),s[f].ProductConversionL(u[0].ProductConversionL()),s[f].ProductConversionM(u[0].ProductConversionM()),s[f].ProductConversionS(u[0].ProductConversionS()),r[e].ProductCode(u[0].ProductCode()),r[e].Product(u[0].Product()),r[e].ProductUOMLID(u[0].ProductUOMLID()),r[e].ProductUOMMID(u[0].ProductUOMMID()),r[e].ProductUOMSID(u[0].ProductUOMSID()),r[e].ProductConversionL(u[0].ProductConversionL()),r[e].ProductConversionM(u[0].ProductConversionM()),r[e].ProductConversionS(u[0].ProductConversionS());o=s;l=r;o.length==0?DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Product (Sample) lot stock with item status Good for the selected warehouse is empty."),"New Order Details Failed"):n();hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product lot data."),"Download Product Lot Failed");hideLoadingPanel()})}else DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("The selected Salesman does not have any reference products."),"New Order Details Failed"),hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product data."),"Download Product Failed");hideLoadingPanel()})}else n()}var ft=!1,ii=t.layoutController.name==="split",lt=$.Deferred(),at=ko.observable(),s,g,c,nt,u,e,i,h,r;s=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderSamples,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderSampleViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vSalesOrderSamples.on("modified",vt);var fi=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderSampleDetails,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderSampleDetailsViewModel(n)}}),ei=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderSampleSummaries,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderSampleSummaryViewModel(n)}}),o,l,tt,it,wt={type:"pattern",pattern:"(^[0-9]*$)|(^[0-9]*/[0-9]*$)|(^[0-9]*/[0-9]*/[0-9]*$)",message:"Format must be L/M/S or M/S or S."};u=new Dismoyo_Ciptoning_Client.CollapsibleFilter;u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){nt&&nt.resizeAll()})};u.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Salesman","Warehouse"])}}}]},{itemType:"group",caption:"Sales Order Sample",colCount:3,colSpan:3,items:[{name:"DocumentCode",dataField:"",label:{text:"Document Number"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateFrom",label:{text:"Transaction Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateTo",label:{text:"Transaction Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"SalesmanID",label:{text:"Salesman"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSalesmanDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Salesman",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Salesman",["Warehouse"],[])}}},{dataField:"WarehouseID",label:{text:"Warehouse"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){var i=null,t,r;i=Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?u.form().getEditor("SiteID").option("value"):Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID();t=u.form().getEditor("SalesmanID");r=t.option("selectedItem");r&&r.WarehouseID()!=n.value&&t.option("value",null);i==undefined?t.option("dataSource",DataUtility.GetLookupSalesmanDataSource(n.value?["WarehouseID","=",n.value]:null)):t.option("dataSource",DataUtility.GetLookupSalesmanDataSource(n.value?[["WarehouseID","=",n.value],"and",["SiteID","=",i]]:["SiteID","=",i]))}}},{dataField:"CustomerID",label:{text:"Customer"},editorType:"dxSelectBox",editorOptions:{dataSource:new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["ID","Customer","SiteID"],map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)},filter:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]}),displayExpr:"Customer",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}}]}];u.events.performSearch=function(){var f=e.dataGrid(),i=u.form(),n=[],t;f.clearFilter();var r=Dismoyo_Ciptoning_Client.app.CurrentUser,o=r.TerritoryID(),s=r.RegionID(),h=r.AreaID(),c=r.CompanyID(),l=r.SiteID();i.itemOption("Organization").visible&&(o=i.getEditor("TerritoryID").option("value"),s=i.getEditor("RegionID").option("value"),h=i.getEditor("AreaID").option("value"),c=i.getEditor("CompanyID").option("value"),l=i.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",o,"and");DXUtility.addFilterExpression(n,"RegionID","=",s,"and");DXUtility.addFilterExpression(n,"AreaID","=",h,"and");DXUtility.addFilterExpression(n,"CompanyID","=",c,"and");DXUtility.addFilterExpression(n,"SiteID","=",l,"and");t=i.getEditor("SalesmanID").option("value");DXUtility.addFilterExpression(n,"SalesmanID","=",t,"and");t=i.getEditor("WarehouseID").option("value");DXUtility.addFilterExpression(n,"WarehouseID","=",t,"and");t=i.getEditor("DocumentCode").option("value");DXUtility.addFilterExpression(n,"DocumentCode","contains",t,"and");t=i.getEditor("TransactionDateFrom").option("value");DXUtility.addFilterExpression(n,"TransactionDate",">=",t,"and");t=i.getEditor("TransactionDateTo").option("value");DXUtility.addFilterExpression(n,"TransactionDate","<=",t,"and");t=i.getEditor("CustomerID").option("value");DXUtility.addFilterExpression(n,"CustomerID","=",t,"and");t=i.getEditor("DocumentStatusID").option("value");DXUtility.addFilterExpression(n,"DocumentStatusID","=",t,"and");n.length>0?f.filter(n):f.refresh()};e=new Dismoyo_Ciptoning_Client.CommonGridView;e.dataGridOptions.dataSource=s;e.dataGridOptions.editing.editEnabled=!1;e.dataGridOptions.editing.removeEnabled=!1;e.dataGridOptions.selection.mode="single";e.deleteRowsOptions.visible=!1;e.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("SalesOrderSamples.AddNewSalesOrderSample");e.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("SalesOrderSamples.EditSalesOrderSample");e.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Territory",caption:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Region",caption:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Area",caption:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Company",caption:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Site",caption:"Site",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"DocumentCode",caption:"Document Number",width:"140px",sortOrder:"desc",headerCellTemplate:function(n,t){var r=$("#vSalesOrderSamples_commonGridView").find(".dx-datagrid:first-child"),i,u,f;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',u=Dismoyo_Ciptoning_Client.app.CurrentUser,u.IsHeadOffice()&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',e.dataGridOptions.editing.allowUpdating&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",f=r.find(".dx-header-row:first-child"),$(i).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},cellTemplate:function(n,t){var u=Dismoyo_Ciptoning_Client.app.CurrentUser,f=u.isAuthorized("SalesOrderSamples.EditSalesOrderSample"),i=$('<div class="dx-command-edit" style="text-align: left;">'),r=$("<b>").text(t.data.DocumentCode());f&&(r=$('<a class="dx-link">').text(t.data.DocumentCode()).on("dxclick",function(){ot(t.data.DocumentID(),!1)}));i.append(r);i.append("&nbsp;");n.append(i)}},{dataField:"TransactionDate",caption:"Transaction Date",width:"100px",customizeText:function(n){return n.value?n.value.toLocaleDateString():null}},{dataField:"Customer",caption:"Customer",width:"200px"},{dataField:"Salesman",caption:"Salesman",width:"200px"},{dataField:"Warehouse",caption:"Warehouse",width:"200px"},{dataField:"TotalGross",caption:"Total DPP",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"TotalTax",caption:"Total VAT",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"Total",caption:"Total",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"ReferenceNumber",caption:"Reference Number",width:"120px",validationRules:[{type:"required"}]},{dataField:"DocumentStatusName",caption:"Status",width:"80px"},{dataField:"PostedDate",caption:"Posted Date",width:"100px",customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleDateString():null}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}];e.dataGridOptions.editing.allowUpdating&&e.dataGridOptions.columns.push({width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){ot(t.data.DocumentID(),!1)}));i.append("&nbsp;");n.append(i)}});i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.okOptions.text="Save";i.okOptions.icon="icons8-save";var f=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSamples_salesOrderSampleSummaryDataGrid","dxDataGrid")},b=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSamples_salesOrderSampleSummaryForm","dxForm")},pi=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSamples_salesOrderSamplePrintDO","dxButton")},a=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSamples_salesOrderSamplePost","dxButton")},k=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSamples_salesOrderSampleDiscard","dxButton")},v=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSamples_salesOrderSampleVoid","dxButton")},y=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSamples_salesOrderSampleSaveAsDraftAndNew","dxButton")},d=function(){return DXUtility.getDXInstance(null,"#commonPopupEdit_ok","dxButton")},wi=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSamples_salesOrderSampleSummaryNewRow","dxButton")},bi=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSamples_salesOrderSampleSummaryDeleteRows","dxButton")},ct,ki=function(){for(var t=$(".dx-command-edit","[id$=SummaryDataGrid]"),n=0;n<t.length;n++)if($(t[n]).text().trim().indexOf("Save")>=0)return!0;return!1},ti=function(){var n=!1,r=!0,t=i.popupEditData();t.DocumentStatusID()&&(r=!1);(t.DocumentStatusID()==2||t.DocumentStatusID()==3||t.DocumentStatusID()==4)&&(n=!0);ki()||(d()&&a()&&v()&y()&&d().option("disabled",n),d().option("disabled",n),a().option("disabled",r||n),k().option("disabled",r||n),v().option("disabled",t.DocumentStatusID()!=2),y().option("disabled",n),clearInterval(ct))};return i.popupEditOptions.onContentReady=function(){var u=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop("Order Details"));var r=$('<div class="desktop-commonGridView-commands">'),e=$('<div id="vSalesOrderSamples_salesOrderSampleSummaryNewRow">').dxButton({text:"New",icon:"add",onClick:function(){var n=i.form().validate().isValid;n?ut(function(){f().addRow()}):DevExpress.ui.dialog.alert("Please specify the required fields.","New Order Details Failed")}}),o=$('<div id="vSalesOrderSamples_salesOrderSampleSummaryDeleteRows">').dxButton({text:"Delete",icon:"remove",disabled:!0,onClick:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(n){n&&DXUtility.deleteSelectedRows(f())})}});r.append(e);r.append(o);n.append(r);n.append($('<div id="vSalesOrderSamples_salesOrderSampleSummaryDataGrid">').dxDataGrid({dataSource:[],showBorders:!0,paging:{enabled:!1},allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,editing:{editMode:"row",allowAdding:!1,allowUpdating:!0,allowDeleting:!0},onInitNewRow:function(n){d().option("disabled",!0);a().option("disabled",!0);k().option("disabled",!0);v().option("disabled",!0);y().option("disabled",!0);ct=setInterval(ti,500);n.data.QtyOrder=0;n.data.QtyOrderConv="0/0/0";n.data.AddDiscountStrataPercentage=0},onEditorPreparing:function(n){var t;n.parentType=="dataRow"&&(n.row!=undefined&&n.row.rowIndex!=undefined&&(n.component.editRowIndex=n.row.rowIndex),n.dataField=="Product"?(n.row.inserted?n.editorElement.dxLookup({dataSource:l,displayExpr:"Product",valueExpr:"Product",searchExpr:"Product",searchPlaceholder:"Product",popupWidth:"712px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){CommonUtility.createProductLookupHeader("vSalesOrderSamples_productIDLookup",n.element,1)},itemTemplate:function(n,t,i){return CommonUtility.createProductLookupItem(n,i,1)},onValueChanged:function(t){var i,r;t.value&&(i=this.option("selectedItem"),i&&(n.component.cellValue(n.row.rowIndex,"QtyOnHand",i.QtyOnHand()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),r=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyOrderConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyOrder",r.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",r.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",r.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",r.qtyConvS),rt(n)));n.component.cellValue(n.row.rowIndex,"Product",t.value);n.setValue(t.value)}}):(ut(function(){}),n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Product()))),n.cancel=!0):n.dataField=="PriceDate"?(n.editorElement.dxDateBox({showClearButton:!0,placeholder:"Transaction Date",value:n.value,onValueChanged:function(t){t.component.option("value",t.value);n.setValue(t.value);rt(n)}}),n.cancel=!0):n.dataField=="QtyOrderConv"?(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onEnterKey:function(){f().saveEditData()},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyOrder",i.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvL",i.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvM",i.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvS",i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value);rt(n)}}),n.cancel=!0):n.dataField=="AddDiscountStrataPercentage"&&(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==190||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onValueChanged:function(t){(t.value==null||t.value=="")&&(t.value=0);t.component.option("value",t.value);n.setValue(t.value);rt(n)}}),n.cancel=!0))},onRowInserted:function(n){CommonUtility.validateDataGridInsertedTransactionSummary(n.component,new Dismoyo_Ciptoning_Client.vSalesOrderSampleSummaryViewModel(n.data).toJS());ht(n);CommonUtility.updateSalesOrderSummaryForm(b(),n.component);f().clearSelection()},onRowUpdated:function(n){n.data.ProductID=n.key.ProductID;ht(n);CommonUtility.updateSalesOrderSummaryForm(b(),n.component);f().clearSelection()},onRowRemoved:function(n){CommonUtility.validateDataGridRemovedTransactionSummary(n.component,n.data.toJS());CommonUtility.updateSalesOrderSummaryForm(b(),n.component)},onEditingStart:function(){d().option("disabled",!0);a().option("disabled",!0);k().option("disabled",!0);v().option("disabled",!0);y().option("disabled",!0);ct=setInterval(ti,500)},onRowUpdating:function(n){if(n.newData.QtyOrderConv){var t=CommonUtility.getConversion(n.newData.QtyOrderConv,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS"));n.newData.QtyConvL=t.qtyConvL;n.newData.QtyConvM=t.qtyConvM;n.newData.QtyConvS=t.qtyConvS;n.newData.QtyOrder=t.qtyTransaction}n.newData.SubtotalWeight=DXUtility.getValue(n.oldData,"SubtotalWeight");n.newData.SubtotalDimension=DXUtility.getValue(n.oldData,"SubtotalDimension");n.newData.UnitGrossPrice=DXUtility.getValue(n.oldData,"UnitGrossPrice");n.newData.RawSubtotalGrossPrice=DXUtility.getValue(n.oldData,"RawSubtotalGrossPrice");n.newData.RawSubtotalPrice=DXUtility.getValue(n.oldData,"RawSubtotalPrice");n.newData.RawDiscountStrata1Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata1Amount");n.newData.RawDiscountStrata2Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata2Amount");n.newData.RawDiscountStrata3Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata3Amount");n.newData.RawDiscountStrata4Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata4Amount");n.newData.RawDiscountStrata5Amount=DXUtility.getValue(n.oldData,"RawDiscountStrata5Amount");n.newData.RawAddDiscountStrataAmount=DXUtility.getValue(n.oldData,"RawAddDiscountStrataAmount");n.newData.RawSubtotalDiscountStrata1=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata1");n.newData.RawSubtotalDiscountStrata2=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata2");n.newData.RawSubtotalDiscountStrata3=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata3");n.newData.RawSubtotalDiscountStrata4=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata4");n.newData.RawSubtotalDiscountStrata5=DXUtility.getValue(n.oldData,"RawSubtotalDiscountStrata5");n.newData.RawSubtotalGross=DXUtility.getValue(n.oldData,"RawSubtotalGross");n.newData.RawSubtotal=DXUtility.getValue(n.oldData,"RawSubtotal");n.newData.SubtotalDiscountStrata1=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata1");n.newData.SubtotalDiscountStrata2=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata2");n.newData.SubtotalDiscountStrata3=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata3");n.newData.SubtotalDiscountStrata4=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata4");n.newData.SubtotalDiscountStrata5=DXUtility.getValue(n.oldData,"SubtotalDiscountStrata5");n.newData.TaxPercentage=DXUtility.getValue(n.oldData,"TaxPercentage");n.newData.SubtotalGrossPrice=DXUtility.getValue(n.oldData,"SubtotalGrossPrice");n.newData.SubtotalPrice=DXUtility.getValue(n.oldData,"SubtotalPrice");n.newData.UnitPrice=n.component.cellValue(n.component.editRowIndex,"UnitPrice");n.newData.DiscountStrata1Percentage=DXUtility.getValue(n.oldData,"DiscountStrata1Percentage");n.newData.DiscountStrata1Amount=DXUtility.getValue(n.oldData,"DiscountStrata1Amount");n.newData.DiscountStrata2Percentage=DXUtility.getValue(n.oldData,"DiscountStrata2Percentage");n.newData.DiscountStrata2Amount=DXUtility.getValue(n.oldData,"DiscountStrata2Amount");n.newData.DiscountStrata3Percentage=DXUtility.getValue(n.oldData,"DiscountStrata3Percentage");n.newData.DiscountStrata3Amount=DXUtility.getValue(n.oldData,"DiscountStrata3Amount");n.newData.DiscountStrata4Percentage=DXUtility.getValue(n.oldData,"DiscountStrata4Percentage");n.newData.DiscountStrata4Amount=DXUtility.getValue(n.oldData,"DiscountStrata4Amount");n.newData.DiscountStrata5Percentage=DXUtility.getValue(n.oldData,"DiscountStrata5Percentage");n.newData.DiscountStrata5Amount=DXUtility.getValue(n.oldData,"DiscountStrata5Amount");n.newData.AddDiscountStrataAmount=n.component.cellValue(n.component.editRowIndex,"AddDiscountStrataAmount");n.newData.SubtotalGross=n.component.cellValue(n.component.editRowIndex,"SubtotalGross");n.newData.SubtotalTax=n.component.cellValue(n.component.editRowIndex,"SubtotalTax");n.newData.Subtotal=n.component.cellValue(n.component.editRowIndex,"Subtotal");si(n.oldData.ProductID(),n.newData)},onRowValidating:function(n){var i=DXUtility.getValue(n.newData,"QtyOnHand"),t;i==undefined&&(i=DXUtility.getValue(n.oldData,"QtyOnHand"));t=DXUtility.getValue(n.newData,"QtyOrder");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyOrder"));t<=0&&(n.errorText="Order Qty must be greater than 0.",n.isValid=!1);n.isValid&&t>i&&(n.errorText="Order Qty must be less than or equal to On Hand Qty.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},onDataErrorOccurred:function(n){var t=n.component._controllers.editing._editData[0].data.Product;switch(n.error.__id){case"E4008":n.error.message="Product '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},columns:[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"Product",caption:"Product",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$(f().element()),r,i,e;!u.find(".datagrid-bandedHeader:first").length>0&&(r=f().option("selection").mode=="none"?!1:!0,i='<tr class="dx-row dx-column-lines datagrid-bandedHeader" style="border-top-style: none !important;">',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colSpan="1">Disc 1-5<\/td>',i+='       <td class="dx-datagrid-action" colSpan="2">Additional Disc<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",e=u.find(".dx-header-row:first-child"),$(i).insertBefore(e[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"120px",allowEditing:!1,dataType:"number"},{dataField:"PriceDate",caption:"Price Date",width:"140px",dataType:"date"},{dataField:"UnitPrice",caption:"Unit Price",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"QtyOrderConv",caption:"Qty (L/M/S)",width:"100px",alignment:"right",validationRules:[{type:"required"},wt],cellTemplate:function(n,t){n.append(ci(t.data,"QtyOrderConv",1))}},{dataField:"DiscountStrataDefaultAmount",caption:"Amount",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2,calculateCellValue:function(n){var t=DXUtility.getValue(n,"DiscountStrata1Amount"),i=DXUtility.getValue(n,"DiscountStrata2Amount"),r=DXUtility.getValue(n,"DiscountStrata3Amount"),u=DXUtility.getValue(n,"DiscountStrata4Amount"),f=DXUtility.getValue(n,"DiscountStrata5Amount");return isNaN(t)&&(t=0),isNaN(i)&&(i=0),isNaN(r)&&(r=0),isNaN(u)&&(u=0),isNaN(f)&&(f=0),t+i+r+u+f}},{dataField:"AddDiscountStrataPercentage",caption:"%",width:"40px",dataType:"number",format:"fixedPoint",precision:2},{dataField:"AddDiscountStrataAmount",caption:"Amount",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"SubtotalGross",caption:"DPP",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"SubtotalTax",caption:"VAT",width:"80px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2},{dataField:"Subtotal",caption:"Subtotal",width:"100px",allowEditing:!1,dataType:"number",format:"fixedPoint",precision:2}]}));n.append($('<div id="vSalesOrderSamples_salesOrderSampleSummaryForm" style="margin-top: 9px;">').dxForm({deferRendering:!1,colCount:4,showColonAfterLabel:!1,labelLocation:"left",alignItemLabels:!0,items:[{itemType:"empty",colSpan:3},{dataField:"TotalGross",label:{text:"Total DPP"},colSpan:1,cssClass:"salesOrderSummaryForm-item-label salesOrderSummaryForm-item-textInput",editorOptions:{readOnly:!0}},{itemType:"empty",colSpan:2},{itemType:"empty",colSpan:1},{dataField:"TotalTax",label:{text:"Total VAT"},colSpan:1,cssClass:"salesOrderSummaryForm-item-label salesOrderSummaryForm-item-textInput",editorOptions:{readOnly:!0}},{itemType:"empty",colSpan:3},{dataField:"Total",label:{text:"Total"},colSpan:1,cssClass:"salesOrderSummaryForm-item-label salesOrderSummaryForm-item-textInput",editorOptions:{readOnly:!0}}]}));var t=$("#commonPopupEdit_extCommands"),s=$('<div id="vSalesOrderSamples_salesOrderSamplePrintDO" style="margin-right: 32px;">').dxButton({text:"Print DO",icon:"icons8-print",onClick:function(){i.events.performPrintDO(this)}}),h=$('<div id="vSalesOrderSamples_salesOrderSamplePost">').dxButton({text:"Post",icon:"icons8-check-green",onClick:function(){i.events.performPost(this)}}),c=$('<div id="vSalesOrderSamples_salesOrderSampleDiscard">').dxButton({text:"Discard",icon:"icons8-trash-red",onClick:function(){i.events.performDiscard(this)}}),p=$('<div id="vSalesOrderSamples_salesOrderSampleVoid" style="margin-right: 16px;">').dxButton({text:"Void",icon:"icons8-delete-red",onClick:function(){i.events.performVoid(this)}}),w=$('<div id="vSalesOrderSamples_salesOrderSampleSaveAsDraftAndNew">').dxButton({text:"Save & New",icon:"icons8-save",onClick:function(){i.events.performSaveAsDraftAndNew(this)}});u.append(DXUtility.createFormItemGroupWithCaption("").append(n));t.append(s);t.append(h);t.append(c);t.append(p);t.append(w)},e.events.performNewRow=function(){st(null)},i.events.performOK=function(){p(null,3)},i.events.performPrintDO=function(){var n=i.popupEditData();ai(n.DODocumentID())},i.events.performPost=function(){DevExpress.ui.dialog.confirm("Are you sure want to Post this transaction?","Post Confirmation").done(function(n){n&&p(2,3)})},i.events.performDiscard=function(){DevExpress.ui.dialog.confirm("Are you sure want to Discard this transaction?","Discard Confirmation").done(function(n){n&&p(3,3)})},i.events.performVoid=function(){DevExpress.ui.dialog.confirm("Are you sure want to Void this transaction?","Void Confirmation").done(function(n){n&&p(4,3)})},i.events.performSaveAsDraftAndNew=function(){p(1,2)},i.events.performCancel=function(){i.popupEditOptions.visible(!1);g&&(e.dataGrid().refresh(),g=!1)},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form(),r,u;CommonUtility.cascadeValueChanged(t,n.selectedItem,n.value,"Site",["Area","Region","Territory"],[]);r="";u="";n.selectedItem?(r=bt(n.selectedItem.Code()),u=kt(n.selectedItem.Code()),t.getEditor("Company").option("value",n.selectedItem.Company())):n.previousValue!=null&&t.getEditor("Company").option("value",null);dt(t,n.value);t.getEditor("DocumentCode").option("value",r);t.getEditor("DODocumentCode").option("value",u)}}}]},{itemType:"group",caption:"Sales Order Sample",colCount:6,colSpan:3,items:[{dataField:"DocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"TransactionDate",label:{text:"Transaction Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();t.getEditor("DOShipmentDate").option("min",n.value)}}},{dataField:"DocumentStatusID",label:{text:"Status"},colSpan:1,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"NEW",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"CustomerID",label:{text:"Customer"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxLookup",editorOptions:{dataSource:[],displayExpr:"Customer",valueExpr:"ID",searchExpr:["Code","Name","Address1","Address2","Address3"],searchPlaceholder:"Customer/Address",searchEnabled:!1,popupWidth:"1082px",showPopupTitle:!1,fieldEditEnabled:!0,onOpened:function(){},onClosed:function(){},onContentReady:function(n){var t=i.form(),r=Dismoyo_Ciptoning_Client.app.CurrentUser;CommonUtility.createCustomerLookupHeader("vSalesOrderSamples_customerIDLookup",n.element,oi("Customer.Category1"),r.SiteID(),t)},itemTemplate:function(n,t,i){return CommonUtility.createCustomerLookupItem(n,i)},onValueChanged:function(n){var t;if(n.value&&(t=n.selectedItem,t)){var r=i.popupEditData(),u=i.form(),f=null,e=null,o=null;tt=undefined;it=undefined;r.PriceGroupID(undefined);r.DiscountGroupID(undefined);t&&(f=t.SalesmanID(),e=t.WarehouseID(),o=t.TermOfPaymentID(),tt=Dismoyo_Ciptoning_Client.LocalStore.vProductPrices.dataByFilter(["PriceGroupID","=",t.PriceGroupID()]),it=Dismoyo_Ciptoning_Client.LocalStore.vDiscountGroups.expandedDataByKey(t.DiscountGroupID()),r.PriceGroupID(t.PriceGroupID()),r.DiscountGroupID(t.DiscountGroupID()));n.component.option("value",n.value);u.getEditor("SalesmanID").option("value",f);u.getEditor("WarehouseID").option("value",e);gt(u,o)}}}},{itemType:"empty",colSpan:3},{dataField:"SalesmanID",label:{text:"Salesman"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Salesman",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t,u,r;o=[];l=[];n.value?(t=i.popupEditData(),f().cancelEditData(),t.ChildSummaries([]),f().option("dataSource",et(t.ChildSummaries()))):f().endCustomLoading();u=i.form();r=null;n.selectedItem&&(r=n.selectedItem.WarehouseID());u.getEditor("WarehouseID").option("value",r)}}},{dataField:"WarehouseID",label:{text:"Warehouse"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"",readOnly:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){if(o=[],l=[],n.value){var t=i.popupEditData(),r=f();r.cancelEditData();t.ChildSummaries([]);r.option("dataSource",et(t.ChildSummaries()))}}}},{itemType:"empty",colSpan:1},{dataField:"TermOfPaymentID",validationRules:[{type:"required"}],label:{text:"Term of Payment"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"ReferenceNumber",label:{text:"Reference Number"},colSpan:3,editorOptions:{maxLength:30,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1}]},{itemType:"group",caption:"Purchase Order",colCount:6,colSpan:3,items:[{dataField:"PODocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{maxLength:30,onEnterKey:function(){commSonPopupEdit.events.performOK(this)}}},{dataField:"POTransactionDate",label:{text:"Transaction Date"},colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(){var n=i.form()}}},{itemType:"empty"}]},{itemType:"group",caption:"Delivery Order",colCount:6,colSpan:3,items:[{dataField:"DODocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){commSonPopupEdit.events.performOK(this)}}},{dataField:"DOShipmentDate",label:{text:"Shipment Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();t.getEditor("DOReceivedDate").option("min",n.value)}}},{itemType:"empty"},{dataField:"DOPrintedCount",label:{text:"Printed Count"},colSpan:1,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DOLastPrintedDate",label:{text:"Last Printed Date"},colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DOReceivedDate",label:{text:"Received Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],h=new Dismoyo_Ciptoning_Client.CommonPopupIFrame,h.okOptions.visible=!1,h.cancelOptions.text="Close",r=new Dismoyo_Ciptoning_Client.ProductLotPopupEdit,r.formOptions.colCount=4,r.saveOptions.icon="icons8-save",r.events.performSave=function(){yi()},r.dataGridOptions.onInitNewRow=function(n){n.data.QtyOrder=0;n.data.QtyOrderConv="0/0/0"},r.dataGridOptions.onEditorPreparing=function(n){var i,u,t;n.parentType=="dataRow"&&(n.dataField=="ProductLotCode"?(n.row.inserted?(i=r.popupEditOptions.itemStatusID,u=w(i),n.editorElement.dxLookup({dataSource:new DevExpress.data.DataSource({store:o,filter:[["ProductID","=",r.popupEditData().ProductID()],"and",[u.qtyOnHandColumn,">",0]],sort:[{getter:"ProductLotExpiredDate",desc:!0}]}),displayExpr:"ProductLotCode",valueExpr:"ProductLotCode",searchExpr:"ProductLotCode",searchPlaceholder:"Lot Number",popupWidth:"582px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){var t=r.popupEditOptions.itemStatusID;CommonUtility.createProductLotLookupHeader("vSalesOrderSamples_productLotIDLookup",n.element,t)},itemTemplate:function(n,t,i){var u=r.popupEditOptions.itemStatusID,f=w(u);return CommonUtility.createProductLotLookupItem(n,i,f.qtyOnHandColumn)},onValueChanged:function(t){var i,e,f,u;t.value&&(i=this.option("selectedItem"),i&&(e=r.popupEditOptions.itemStatusID,f=w(e),n.component.cellValue(n.row.rowIndex,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductLotID",i.ProductLotID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductLotCode",i.ProductLotCode()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),u=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyOrderConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyOrder",u.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",u.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",u.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",u.qtyConvS)));n.component.cellValue(n.row.rowIndex,"ProductLotCode",t.value);n.setValue(t.value)}})):(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.ProductLotCode()))),n.cancel=!0):n.dataField=="QtyOrderConv"&&(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyOrder",i.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvL",i.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvM",i.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvS",i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}}),n.cancel=!0))},r.dataGridOptions.onRowInserted=function(n){CommonUtility.validateDataGridInsertedTransactionDetails(n.component,new Dismoyo_Ciptoning_Client.vSalesOrderSampleDetailsViewModel(n.data).toJS())},r.dataGridOptions.onRowRemoved=function(n){CommonUtility.validateDataGridRemovedTransactionDetails(n.component,n.data.toJS())},r.dataGridOptions.onRowUpdating=function(n){CommonUtility.validateDataGridUpdatingTransactionDetails(n,"QtyConvL","QtyConvM","QtyConvS","QtyOrderConv","QtyOrder")},r.dataGridOptions.onRowValidating=function(n){var u=r.popupEditOptions.itemStatusID,f=w(u),i=DXUtility.getValue(n.newData,"QtyOnHand"),t;i==undefined&&(i=DXUtility.getValue(n.oldData,"QtyOnHand"));t=DXUtility.getValue(n.newData,"QtyOrder");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyOrder"));t<=0&&(n.errorText="Order Qty must be greater than 0.",n.isValid=!1);n.isValid&&t>i&&(n.errorText="Order Qty must be less than or equal to On Hand Qty.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.onDataErrorOccurred=function(n){var t=n.component._controllers.editing._editData[0].data.ProductLotCode;switch(n.error.__id){case"E4008":n.error.message="Lot Number '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.summary={totalItems:[{name:"TotalQtyPcs",showInColumn:"QtyOrderConv",displayFormat:"Total Qty (Pcs): {0}",valueFormat:"decimal",summaryType:"custom"},{name:"TotalQtyLMS",showInColumn:"QtyOrderConv",displayFormat:"(L/M/S): {0}",valueFormat:"string",summaryType:"custom"}],calculateCustomSummary:function(n){CommonUtility.updateProductLotEditingSummary(n,"QtyOrderConv","QtyOrder")}},r.dataGridOptions.columns=[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"ProductLotID",visible:!1},{dataField:"ProductLotCode",caption:"Lot Number",validationRules:[{type:"required"}]},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"120px",allowEditing:!1,dataType:"number"},{dataField:"QtyOrderConv",caption:"Order Qty (L/M/S)",width:"150px",alignment:"right",validationRules:[{type:"required"},wt]}],r.formOptions.items=[{itemType:"group",caption:"Product",colCount:4,colSpan:4,items:[{dataField:"Product",label:{text:"Product"},colSpan:4,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOnHand",label:{text:"On Hand Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2},{dataField:"QtyOrder",label:{text:"Order Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOrderConv",label:{text:"(L/M/S)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],{isReady:lt.promise(),dataSource:s,refreshList:pt,viewShowing:ri,viewDisposing:ui,openCreateViewAsRoot:ii,icon:"Images/sales_order_sample_32px.png",dataSource_vSalesOrderSampleDetails:fi,dataSource_vSalesOrderSampleSummary:ei,dataSource_vStockOnHandAvailable:o,dataSource_vStockOnHandAvailableByProduct:l,collapsibleFilter:u,commonGridView:e,commonPopupEdit:i,commonPopupIFrame:h,productLotPopupEdit:r,salesOrderSampleSummaryDataGrid:f,salesOrderSamplePost:a,salesOrderSampleDiscard:k,salesOrderSampleVoid:v,salesOrderSampleSaveAsDraftAndNew:y,isLotNumberEntryRequired:c}};Dismoyo_Ciptoning_Client.vSalesOrderSwaps=function(n,t){"use strict";function ht(){tt=!0}function ct(){g=CommonUtility.configureCommonGridViewLayout("vSalesOrderSwaps");g||setTimeout(ct,50)}function gt(){var n,t;ct();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],s.filter(t));st()?tt&&lt():(st(s),s.load().always(function(){ot.resolve()}))}function ni(){Dismoyo_Ciptoning_Client.DB.vSalesOrderSwaps.off("modified",ht)}function lt(){tt=!1;s.pageIndex(0);s.load()}function vt(n){return(n?n:"(Site Code)")+"-YY-03-(Auto Generated)"}function yt(n){return(n?n:"(Site Code)")+"-YY-10-(Auto Generated)"}function pt(n,t){t?Dismoyo_Ciptoning_Client.DB.vSites.byKey(t).done(function(n){c=n.IsLotNumberEntryRequired}):(t=null,c=undefined);var i=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["ID","Customer","Address","Category1","SalesmanID","Salesman","WarehouseID","TermOfPaymentID","PriceGroupID","DiscountGroupID","SiteID"],filter:[["IsDeleted","=",!1],"and",["StatusID","=",1],"and",["SiteID","=",t]],map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)}}),r=DataUtility.GetLookupSalesmanDataSource([["IsDeleted","=",!1],"and",["StatusID","=",1],"and",["SiteID","=",t]]);n.getEditor("CustomerID").option("value",null);n.getEditor("CustomerID").option("dataSource",i);i.load();n.getEditor("SalesmanID").option("value",null);n.getEditor("SalesmanID").option("dataSource",r);r.load()}function ri(n){var t=Dismoyo_Ciptoning_Client.LocalStore.vSystemParameters.dataByFilter(["ID","=",n]);return t.length>0?t[0].Value():null}function wt(n){CommonUtility.updateSummariesArrayStore(f().option("dataSource").store(),n)}function ui(n,t){CommonUtility.updateDeferSummariesArrayStore(f().option("dataSource").store(),n,t)}function fi(n){return CommonUtility.validateSummaryArrayStore(f().option("dataSource").store(),"vSalesOrderSwapSummaryViewModel",n)}function it(n){return CommonUtility.createArrayDataSource("vSalesOrderSwapSummaryViewModel",["ProductID"],n)}function ei(n,t,i){var r=$('<div class="dx-command-edit" style="text-align: right; padding-right: 5px;">'),o;if(r.append($('<a style="color: inherit;">').text(n[t]())),r.append("&nbsp;"),c){var u=t.replace("Conv",""),s=n[u](),f=n.ChildDetails(),e=0;for(o in f)e+=f[o][u]();r.append($('<a class="dx-link dxcustom-linkbutton dx-icon-icons8-view-details" title="Edit Lot Number">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<\/a><span id="LotMark_'+n.ProductID()+"_"+t+'" class="dx-icon-overflow '+(e==s?"hidden":"")+'" style="color:red; font-size: 14px; margin-left: -6px;"><\/span>').on("dxclick",function(){nt(function(){hi(n,i)})}));r.append("&nbsp;")}return r}function oi(n){var t=f().option("editing"),i=f().option("selection");i.mode=n?"multiple":"none";t.allowUpdating=n;t.allowDeleting=n;f().option("editing",t);f().option("selection",i);ai().option("disabled",!n);vi().option("disabled",!0);f().repaint()}function rt(n,t){showLoadingPanel();Dismoyo_Ciptoning_Client.DB.vSalesOrderSwaps.byKey(n,{expand:["ChildSummaries/ChildDetails"]}).done(function(n){hideLoadingPanel();d=t;ut(new Dismoyo_Ciptoning_Client.vSalesOrderSwapViewModel(n))}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function ut(n){var e=!1,u,t,s,k,p,d,g,w,tt,rt,ut,et;n||(n=new Dismoyo_Ciptoning_Client.vSalesOrderSwapViewModel,e=!0);i.popupEditData(n);i.popupEdit().option("title",(e?"New":"Edit")+" Sales Order Swap");i.popupEditOptions.editingKey=n.DocumentID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);u=Dismoyo_Ciptoning_Client.app.CurrentUser;t=i.form();DXUtility.resetFormValidation(t);var ot=n.DocumentCode(),st=n.DODocumentCode(),r=!1,h=[];if(c=n.IsSiteLotNumberEntryRequired(),e)n.DocumentID(new DevExpress.data.Guid),n.DocumentStatusID(null),u.IsHeadOffice()||(n.TerritoryID(u.TerritoryID()),n.RegionID(u.RegionID()),n.AreaID(u.AreaID()),n.SiteID(u.SiteID()),n.SiteCode(u.SiteCode()),n.CompanyID(u.CompanyID()),n.Company(u.Company())),ot=vt(n.SiteCode()),st=yt(n.SiteCode());else if(h=n.ChildSummaries(),n.DocumentStatusID()!=1||c)(n.DocumentStatusID()==2||n.DocumentStatusID()==3||n.DocumentStatusID()==4)&&(r=!0);else{for(s=[],k=0,p=0;p<h.length;p++){for(d=h[p].ChildDetails(),g=0,w=0;w<d.length;w++)d[w].ProductLotCode().indexOf("DUMMY")<0&&g++;g>0&&(s[k]=h[p],k++)}s.length>0&&(o=[],l=[],t.getEditor("SalesmanID").option("value",n.SalesmanID()),nt(function(){for(var t,n=0;n<s.length;n++)t={data:s[n].toJS()},ft(t,s)}))}oi(!r);li().option("disabled",e);a().option("disabled",e||r);b().option("disabled",e||r);v().option("disabled",n.DocumentStatusID()!=2);y().option("disabled",r);i.ok().option("disabled",r);t.itemOption("Organization").visible&&(t.getEditor("TerritoryID").option("value",n.TerritoryID()),t.getEditor("RegionID").option("value",n.RegionID()),t.getEditor("AreaID").option("value",n.AreaID()),t.getEditor("SiteID").option("value",n.SiteID()),t.getEditor("Company").option("value",n.Company()),t.getEditor("TerritoryID").option("readOnly",r),t.getEditor("RegionID").option("readOnly",r),t.getEditor("AreaID").option("readOnly",r),t.getEditor("SiteID").option("readOnly",r));pt(t,n.SiteID());t.getEditor("DocumentCode").option("value",ot);t.getEditor("TransactionDate").option("value",n.TransactionDate());t.getEditor("CustomerID").option("value",n.CustomerID());t.getEditor("SalesmanID").option("value",n.SalesmanID());t.getEditor("WarehouseID").option("value",n.WarehouseID());t.getEditor("ReferenceNumber").option("value",n.ReferenceNumber());tt=bt();CommonUtility.createEditDataAttachmentFileDownloader("vSalesOrderSwaps",tt,"SalesOrderSwaps",n.AttachmentFile());tt.option("value",null);t.getEditor("DocumentStatusID").option("value",n.DocumentStatusID());t.getEditor("DODocumentCode").option("value",st);t.getEditor("DOShipmentDate").option("value",n.DOShipmentDate());t.getEditor("DOReceivedDate").option("value",n.DOReceivedDate());t.getEditor("DOPrintedCount").option("value",n.DOPrintedCount());t.getEditor("DOLastPrintedDate").option("value",n.DOLastPrintedDate());t.getEditor("TransactionDate").option("readOnly",r);t.getEditor("CustomerID").option("readOnly",r);t.getEditor("SalesmanID").option("readOnly",r);t.getEditor("ReferenceNumber").option("readOnly",r);t.getEditor("DOShipmentDate").option("readOnly",r);t.getEditor("DOReceivedDate").option("readOnly",r);rt=$(".dx-fileuploader-input-wrapper");r?rt.hide():rt.show();ut=new Date;e&&(DXUtility.resetFormValidation(t),t.getEditor("TransactionDate").option("value",ut),t.getEditor("DOShipmentDate").option("value",ut));et=f();et.cancelEditData();n.ChildSummaries(h);et.option("dataSource",it(n.ChildSummaries()))}function p(n,t){var p,w,b,nt,r,k,u,h,o,a,v;showLoadingPanel();var s=i.form(),c=s.validate().isValid,l=c?"":"Please specify the required fields.",tt=e.dataGrid(),it=tt.option("dataSource"),g=f().option("dataSource"),y=[];for(h=0;h<g.store()._array.length;h++)y.push(new Dismoyo_Ciptoning_Client.vSalesOrderSwapSummaryViewModel(g.store()._array[h]));if(c&&y.length<=0&&(l="Please specify at least one item in Order Details.",c=!1),p=0,w=0,c)for(h=0;h<y.length;h++){for(o=y[h],b=0,p+=o.SubtotalWeight(),w+=o.SubtotalDimension(),a=0;a<o.ChildDetails().length;a++)v=o.ChildDetails()[a],b+=v.QtyOrder();o.QtyOrder()!=b&&(l==""?l="Following products quantity of Order Details items is not matched: ":l+=", ",l+=o.Product(),c=!1)}if(c&&$(".dx-fileuploader-button.dx-fileuploader-upload-button.dx-widget.dx-button-has-icon.dx-button.dx-button-normal").length>0&&(l="You have selected an attachment file. Please upload or cancel the attachment file.",c=!1),nt=Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID(),s.itemOption("Organization").visible&&(nt=s.getEditor("SiteID").option("value")),c){for(r=i.popupEditData(),r.TransactionDate(s.getEditor("TransactionDate").option("value")),r.CustomerID(s.getEditor("CustomerID").option("value")),r.SalesmanID(s.getEditor("SalesmanID").option("value")),r.WarehouseID(s.getEditor("WarehouseID").option("value")),r.ReferenceNumber(s.getEditor("ReferenceNumber").option("value")),k=bt(),r.AttachmentFile(k.option("values").length>0?k.fileName:null),r.DOShipmentDate(s.getEditor("DOShipmentDate").option("value")),r.DOReceivedDate(s.getEditor("DOReceivedDate").option("value")),r.DOPrintedCount(s.getEditor("DOPrintedCount").option("value")),r.DOLastPrintedDate(s.getEditor("DOLastPrintedDate").option("value")),r.TotalWeight(p),r.TotalDimension(w),r.ChildSummaries(y),u=ko.toJS(r),n&&(u.DocumentStatusID=n),u.DocumentStatusID||(u.DocumentStatusID=1),u.TransactionDate=DateTimeUtility.getFirstTimeOfDay(u.TransactionDate),u.DOShipmentDate=DateTimeUtility.getFirstTimeOfDay(u.DOShipmentDate),u.DOReceivedDate=DateTimeUtility.getFirstTimeOfDay(u.DOReceivedDate),h=0;h<u.ChildSummaries.length;h++){for(o=u.ChildSummaries[h],o.DocumentID=u.DocumentID,a=0;a<o.ChildDetails.length;a++)v=o.ChildDetails[a],v.DocumentID=u.DocumentID,v.Qty=v.QtyOrder*-1;o.Qty=o.QtyOrder*-1}it.store().insert(u).done(function(n){CommonUtility.documentSuccessMessage(n.DocumentStatusID,function(){});d=!0;switch(t){case 1:i.events.performCancel();hideLoadingPanel();break;case 2:ut(null);hideLoadingPanel();break;case 3:rt(r.DocumentID(),!0)}}).fail(function(n){DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})}else hideLoadingPanel();l!=""&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(l),"Save Failed")}function si(n){h.popupEdit().option("title","Print Delivery Order");h.popupEditOptions.visible(!0);var t=h.iframe();h.showLoadingPanel();t.attr("src",Dismoyo_Ciptoning_Client.ReportWebsite.ExtDeliveryOrderReport.url([["DocumentID","=",n]]))}function ft(n,t){var a,e,v,s,r,l,h;if(!c){var p=i.popupEditData(),y=f(),u=[];if(t){for(r=0;r<t.length;r++)t[r].ChildDetails([]);u=t}else for(a=y.option("dataSource").store(),r=0;r<a._array.length;r++)u.push(new Dismoyo_Ciptoning_Client.vSalesOrderSwapSummaryViewModel(a._array[r]));if(e=n.data,v=$.grep(o,function(n){return n.ProductID()==DXUtility.getValue(e,"ProductID")&&n.ProductLotCode().indexOf("DUMMY")>=0}),v.length>0)for(s=v[0],DXUtility.setValue(e,"ProductLotID",s.ProductLotID()),DXUtility.setValue(e,"ProductLotCode",s.ProductLotCode()),DXUtility.setValue(e,"QtyOnHandGood",s.QtyOnHandGood()),DXUtility.setValue(e,"QtyOnHandHold",s.QtyOnHandHold()),DXUtility.setValue(e,"QtyOnHandBad",s.QtyOnHandBad()),r=0;r<u.length;r++)u[r].ProductID()==DXUtility.getValue(e,"ProductID")&&(l=$.grep(u[r].ChildDetails(),function(n){return n.ProductLotID()==DXUtility.getValue(e,"ProductLotID")}),l.length==0&&(l=[new Dismoyo_Ciptoning_Client.vSalesOrderSwapDetailsViewModel(e)],u[r].ChildDetails().push(l[0])),h=l[0],h.QtyConvL(DXUtility.getValue(u[r],"QtyConvL")),h.QtyConvM(DXUtility.getValue(u[r],"QtyConvM")),h.QtyConvS(DXUtility.getValue(u[r],"QtyConvS")),h.QtyOrder(DXUtility.getValue(u[r],"QtyOrder")),h.QtyOrderConv(DXUtility.getValue(u[r],"QtyOrderConv")),wt(u[r]));else DevExpress.ui.dialog.alert("DUMMY Lot Number for the selected product is not available.","Save Failed")}}function w(n){var t=null;switch(n){case 1:t="Good";break;case 2:t="Hold";break;case 3:t="Bad"}var i="QtyOnHand"+t,r="QtyConvL"+t,u="QtyConvM"+t,f="QtyConvS"+t,e="QtyOrder"+t,o="QtyOrderConv"+t;return{itemStatusName:t,qtyOnHandColumn:i,qtyConvLColumn:r,qtyConvMColumn:u,qtyConvSColumn:f,qtyOrderColumn:e,qtyOrderConvColumn:o}}function hi(n,t){var o=i.popupEditData(),f,h,c;r.popupEditData(n);r.popupEditOptions.editingKey=n.ProductID();r.popupEditOptions.itemStatusID=t;r.popupEditOptions.visible(!0);var s=r.dataGrid(),e=r.form(),u=!1;(o.DocumentStatusID()==2||o.DocumentStatusID()==3||o.DocumentStatusID()==4)&&(u=!0);f=r.dataGrid().option("editing");f.allowUpdating=!u;f.allowDeleting=!u;f.editEnabled=!u;f.removeEnabled=!u;r.dataGrid().option("editing",f);r.dataGrid().option("selection",{mode:u?"none":"multiple"});r.newRow().option("disabled",u);r.dataGrid().repaint();e.getEditor("Product").option("value",n.Product());e.getEditor("QtyOnHand").option("value",n.QtyOnHand());e.getEditor("QtyOrderConv").option("value",n.QtyOrderConv());h=CommonUtility.getConversion(n.QtyOrderConv(),DXUtility.getValue(n,"ProductConversionL"),DXUtility.getValue(n,"ProductConversionM"),DXUtility.getValue(n,"ProductConversionS"));e.getEditor("QtyOrder").option("value",h.qtyTransaction);n=fi(n);c=CommonUtility.createArrayDataSource("vSalesOrderSwapDetailsViewModel",["ProductID","ProductLotID"],n.ChildDetails());s.cancelEditData();s.option("dataSource",c)}function ci(){var n=r.popupEditData(),t=r.popupEditOptions.itemStatusID,i=w(t);CommonUtility.validateProductLotEditing(n,r.dataGrid().option("dataSource"),r.form().getEditor("QtyOrder").option("value"),"Order","vSalesOrderSwapDetailsViewModel","QtyConvL","QtyConvM","QtyConvS","QtyOrderConv","QtyOrder",!1)&&(wt(n),r.popupEditOptions.visible(!1),f().refresh())}function nt(n){if(o.length==0&&l.length==0){showLoadingPanel();var t=i.form(),r=t.getEditor("SalesmanID").option("value");new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesmanProducts,select:["ProductID","ProductCode","Product","ProductUOMLID","ProductUOMMID","ProductUOMSID","ProductConversionL","ProductConversionM","ProductConversionS"],filter:[["SalesmanID","=",r],"and",["ProductName","notcontains","SAMPLE"]],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesmanProductViewModel(n)}}).load().done(function(i){var u,e;if(i.length>0){var h=i,s=t.getEditor("WarehouseID").option("value"),r=[],f=[];for(u=0;u<i.length;u++)DXUtility.addFilterExpression(f,"ProductID","=",i[u].ProductID(),"or");DXUtility.addGroupFilterExpression(r,f,"and");DXUtility.addFilterExpression(r,"WarehouseID","=",s,"and");DXUtility.addFilterExpression(r,"QtyOnHandGood",">",0,"and");e=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOnHandAvailables,select:["ProductID","ProductLotID","ProductLotCode","ProductLot","ProductLotExpiredDate","QtyOnHandGood"],filter:r,sort:["WarehouseID","ProductID","ProductLotID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(n)}});e.load().done(function(t){for(var e,h,r=null,s=[],u=[],f=0;f<t.length;f++)s.push(new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(t[f].toJS())),e=u.length-1,h=t[f].ProductID(),f==0||u[e].ProductID()!=h?(u.push(new Dismoyo_Ciptoning_Client.vStockOnHandAllViewModel(t[f].toJS())),e++,r=$.grep(i,function(n){return n.ProductID()==h})):(u[e].QtyOnHandGood(u[e].QtyOnHandGood()+t[f].QtyOnHandGood()),u[e].QtyOnHandHold(u[e].QtyOnHandHold()+t[f].QtyOnHandHold()),u[e].QtyOnHandBad(u[e].QtyOnHandBad()+t[f].QtyOnHandBad())),r[0]&&(s[f].ProductCode(r[0].ProductCode()),s[f].Product(r[0].Product()),s[f].ProductUOMLID(r[0].ProductUOMLID()),s[f].ProductUOMMID(r[0].ProductUOMMID()),s[f].ProductUOMSID(r[0].ProductUOMSID()),s[f].ProductConversionL(r[0].ProductConversionL()),s[f].ProductConversionM(r[0].ProductConversionM()),s[f].ProductConversionS(r[0].ProductConversionS()),u[e].ProductCode(r[0].ProductCode()),u[e].Product(r[0].Product()),u[e].ProductUOMLID(r[0].ProductUOMLID()),u[e].ProductUOMMID(r[0].ProductUOMMID()),u[e].ProductUOMSID(r[0].ProductUOMSID()),u[e].ProductConversionL(r[0].ProductConversionL()),u[e].ProductConversionM(r[0].ProductConversionM()),u[e].ProductConversionS(r[0].ProductConversionS()));o=s;l=u;o.length==0?DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Product lot stock with item status Good for the selected warehouse is empty."),"New Order Details Failed"):n();hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product lot data."),"Download Product Lot Failed");hideLoadingPanel()})}else DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("The selected Salesman does not have any reference products."),"New Order Details Failed"),hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product data."),"Download Product Failed");hideLoadingPanel()})}else n()}var tt=!1,dt=t.layoutController.name==="split",ot=$.Deferred(),st=ko.observable(),s,d,c,g,u,e,i,h,r;s=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderSwaps,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderSwapViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vSalesOrderSwaps.on("modified",ht);var ti=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderSwapSummaries,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderSwapSummaryViewModel(n)}}),ii=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSalesOrderSwapDetails,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vSalesOrderSwapDetailsViewModel(n)}}),o,l,at={type:"pattern",pattern:"(^[0-9]*$)|(^[0-9]*/[0-9]*$)|(^[0-9]*/[0-9]*/[0-9]*$)",message:"Format must be L/M/S or M/S or S."};u=new Dismoyo_Ciptoning_Client.CollapsibleFilter;u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){g&&g.resizeAll()})};u.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Salesman","Warehouse"])}}}]},{itemType:"group",caption:"Sales Order Swap",colCount:3,colSpan:3,items:[{name:"DocumentCode",dataField:"",label:{text:"Document Number"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateFrom",label:{text:"Transaction Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateTo",label:{text:"Transaction Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"SalesmanID",label:{text:"Salesman"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSalesmanDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Salesman",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Salesman",["Warehouse"],[])}}},{dataField:"WarehouseID",label:{text:"Warehouse"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){var i=null,t,r;i=Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?u.form().getEditor("SiteID").option("value"):Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID();t=u.form().getEditor("SalesmanID");r=t.option("selectedItem");r&&r.WarehouseID()!=n.value&&t.option("value",null);i==undefined?t.option("dataSource",DataUtility.GetLookupSalesmanDataSource(n.value?["WarehouseID","=",n.value]:null)):t.option("dataSource",DataUtility.GetLookupSalesmanDataSource(n.value?[["WarehouseID","=",n.value],"and",["SiteID","=",i]]:["SiteID","=",i]))}}},{dataField:"CustomerID",label:{text:"Customer"},editorType:"dxSelectBox",editorOptions:{dataSource:new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vCustomers,select:["ID","Customer","SiteID"],map:function(n){return new Dismoyo_Ciptoning_Client.vCustomerViewModel(n)},filter:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]}),displayExpr:"Customer",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}}]}];u.events.performSearch=function(){var f=e.dataGrid(),i=u.form(),n=[],t;f.clearFilter();var r=Dismoyo_Ciptoning_Client.app.CurrentUser,o=r.TerritoryID(),s=r.RegionID(),h=r.AreaID(),c=r.CompanyID(),l=r.SiteID();i.itemOption("Organization").visible&&(o=i.getEditor("TerritoryID").option("value"),s=i.getEditor("RegionID").option("value"),h=i.getEditor("AreaID").option("value"),c=i.getEditor("CompanyID").option("value"),l=i.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",o,"and");DXUtility.addFilterExpression(n,"RegionID","=",s,"and");DXUtility.addFilterExpression(n,"AreaID","=",h,"and");DXUtility.addFilterExpression(n,"CompanyID","=",c,"and");DXUtility.addFilterExpression(n,"SiteID","=",l,"and");t=i.getEditor("SalesmanID").option("value");DXUtility.addFilterExpression(n,"SalesmanID","=",t,"and");t=i.getEditor("WarehouseID").option("value");DXUtility.addFilterExpression(n,"WarehouseID","=",t,"and");t=i.getEditor("DocumentCode").option("value");DXUtility.addFilterExpression(n,"DocumentCode","contains",t,"and");t=i.getEditor("TransactionDateFrom").option("value");DXUtility.addFilterExpression(n,"TransactionDate",">=",t,"and");t=i.getEditor("TransactionDateTo").option("value");DXUtility.addFilterExpression(n,"TransactionDate","<=",t,"and");t=i.getEditor("CustomerID").option("value");DXUtility.addFilterExpression(n,"CustomerID","=",t,"and");t=i.getEditor("DocumentStatusID").option("value");DXUtility.addFilterExpression(n,"DocumentStatusID","=",t,"and");n.length>0?f.filter(n):f.refresh()};e=new Dismoyo_Ciptoning_Client.CommonGridView;e.dataGridOptions.dataSource=s;e.dataGridOptions.editing.editEnabled=!1;e.dataGridOptions.editing.removeEnabled=!1;e.dataGridOptions.selection.mode="single";e.deleteRowsOptions.visible=!1;e.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("SalesOrderSwaps.AddNewSalesOrderSwap");e.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("SalesOrderSwaps.EditSalesOrderSwap");e.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Territory",caption:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Region",caption:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Area",caption:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Company",caption:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Site",caption:"Site",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"DocumentCode",caption:"Document Number",width:"140px",sortOrder:"desc",headerCellTemplate:function(n,t){var r=$("#vSalesOrderSwaps_commonGridView").find(".dx-datagrid:first-child"),i,u,f;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',u=Dismoyo_Ciptoning_Client.app.CurrentUser,u.IsHeadOffice()&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',e.dataGridOptions.editing.allowUpdating&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",f=r.find(".dx-header-row:first-child"),$(i).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},cellTemplate:function(n,t){var u=Dismoyo_Ciptoning_Client.app.CurrentUser,f=u.isAuthorized("SalesOrderSwaps.EditSalesOrderSwap"),i=$('<div class="dx-command-edit" style="text-align: left;">'),r=$("<b>").text(t.data.DocumentCode());f&&(r=$('<a class="dx-link">').text(t.data.DocumentCode()).on("dxclick",function(){rt(t.data.DocumentID(),!1)}));i.append(r);i.append("&nbsp;");n.append(i)}},{dataField:"TransactionDate",caption:"Transaction Date",width:"100px",customizeText:function(n){return n.value?n.value.toLocaleDateString():null}},{dataField:"Customer",caption:"Customer",width:"200px"},{dataField:"Salesman",caption:"Salesman",width:"200px"},{dataField:"Warehouse",caption:"Warehouse",width:"200px"},{dataField:"ReferenceNumber",caption:"Reference Number",width:"120px",validationRules:[{type:"required"}]},{dataField:"DocumentStatusName",caption:"Status",width:"80px"},{dataField:"PostedDate",caption:"Posted Date",width:"100px",customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleDateString():null}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}];e.dataGridOptions.editing.allowUpdating&&e.dataGridOptions.columns.push({width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){rt(t.data.DocumentID(),!1)}));i.append("&nbsp;");n.append(i)}});i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.okOptions.text="Save";i.okOptions.icon="icons8-save";var bt=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSwaps_editDataAttachmentFile","dxFileUploader")},f=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSwaps_salesOrderSwapSummaryDataGrid","dxDataGrid")},li=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSwaps_salesOrderSwapPrintDO","dxButton")},a=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSwaps_salesOrderSwapPost","dxButton")},b=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSwaps_salesOrderSwapDiscard","dxButton")},v=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSwaps_salesOrderSwapVoid","dxButton")},y=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSwaps_salesOrderSwapSaveAsDraftAndNew","dxButton")},k=function(){return DXUtility.getDXInstance(null,"#commonPopupEdit_ok","dxButton")},ai=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSwaps_salesOrderSwapSummaryNewRow","dxButton")},vi=function(){return DXUtility.getDXInstance(null,"#vSalesOrderSwaps_salesOrderSwapSummaryDeleteRows","dxButton")},et,yi=function(){for(var t=$(".dx-command-edit","[id$=SummaryDataGrid]"),n=0;n<t.length;n++)if($(t[n]).text().trim().indexOf("Save")>=0)return!0;return!1},kt=function(){var n=!1,r=!0,t=i.popupEditData();t.DocumentStatusID()&&(r=!1);(t.DocumentStatusID()==2||t.DocumentStatusID()==3||t.DocumentStatusID()==4)&&(n=!0);yi()||(k()&&a()&&v()&y()&&k().option("disabled",n),k().option("disabled",n),a().option("disabled",r||n),b().option("disabled",r||n),v().option("disabled",t.DocumentStatusID()!=2),y().option("disabled",n),clearInterval(et))};return i.popupEditOptions.onContentReady=function(){var u=$("#commonPopupEdit_extContent"),t=DXUtility.createFormItemGroupContent();t.append(DXUtility.createFormItemLabelTop("Order Details"));var r=$('<div class="desktop-commonGridView-commands">'),e=$('<div id="vSalesOrderSwaps_salesOrderSwapSummaryNewRow">').dxButton({text:"New",icon:"add",onClick:function(){var n=i.form().validate().isValid;n?nt(function(){f().addRow()}):DevExpress.ui.dialog.alert("Please specify the required fields.","New Order Details Failed")}}),o=$('<div id="vSalesOrderSwaps_salesOrderSwapSummaryDeleteRows">').dxButton({text:"Delete",icon:"remove",disabled:!0,onClick:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(n){n&&DXUtility.deleteSelectedRows(f())})}});r.append(e);r.append(o);t.append(r);t.append($('<div id="vSalesOrderSwaps_salesOrderSwapSummaryDataGrid">').dxDataGrid({dataSource:[],showBorders:!0,paging:{enabled:!1},allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,editing:{editMode:"row",allowAdding:!1,allowUpdating:!0,allowDeleting:!0},onInitNewRow:function(n){k().option("disabled",!0);a().option("disabled",!0);b().option("disabled",!0);v().option("disabled",!0);y().option("disabled",!0);et=setInterval(kt,500);n.data.QtyOrder=0;n.data.QtyOrderConv="0/0/0"},onEditorPreparing:function(n){if(n.parentType=="dataRow")if(n.dataField=="Product")n.row.inserted?n.editorElement.dxLookup({dataSource:l,displayExpr:"Product",valueExpr:"Product",searchExpr:"Product",searchPlaceholder:"Product",popupWidth:"712px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){CommonUtility.createProductLookupHeader("vSalesOrderSwaps_productIDLookup",n.element,1)},itemTemplate:function(n,t,i){return CommonUtility.createProductLookupItem(n,i,1)},onValueChanged:function(t){if(t.value){var i=this.option("selectedItem");i&&(DXUtility.setValue(n.row.data,"QtyOnHand",i.QtyOnHand()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),DXUtility.setValue(n.row.data,"ProductWeight",0),DXUtility.setValue(n.row.data,"ProductDimensionL",0),DXUtility.setValue(n.row.data,"ProductDimensionW",0),DXUtility.setValue(n.row.data,"ProductDimensionH",0),CommonUtility.calcConversion(n.component.cellValue(n.row.rowIndex,"QtyOrderConv"),n.row.data))}n.component.cellValue(n.row.rowIndex,"Product",t.value);n.setValue(t.value)}}):(nt(function(){}),n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Product()))),n.cancel=!0;else if(n.dataField=="QtyOrderConv"){var t="";n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onEnterKey:function(){f().saveEditData()},onValueChanged:function(t){var i=CommonUtility.calcConversion(t.value,n.row.data);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}});n.cancel=!0}},onRowInserted:function(n){CommonUtility.validateDataGridInsertedTransactionSummary(n.component,new Dismoyo_Ciptoning_Client.vSalesOrderSwapSummaryViewModel(n.data).toJS());ft(n);f().clearSelection()},onRowUpdated:function(n){n.data.ProductID=n.key.ProductID;ft(n);f().clearSelection()},onRowRemoved:function(n){CommonUtility.validateDataGridRemovedTransactionSummary(n.component,n.data.toJS())},onEditingStart:function(){k().option("disabled",!0);a().option("disabled",!0);b().option("disabled",!0);v().option("disabled",!0);y().option("disabled",!0);et=setInterval(kt,500)},onRowUpdating:function(n){if(n.newData.QtyOrderConv){var t=CommonUtility.getConversion(n.newData.QtyOrderConv,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS"));n.newData.QtyConvL=t.qtyConvL;n.newData.QtyConvM=t.qtyConvM;n.newData.QtyConvS=t.qtyConvS;n.newData.QtyOrder=t.qtyTransaction}n.newData.SubtotalWeight=DXUtility.getValue(n.oldData,"SubtotalWeight");n.newData.SubtotalDimension=DXUtility.getValue(n.oldData,"SubtotalDimension");ui(n.oldData.ProductID(),n.newData)},onRowValidating:function(n){var i=DXUtility.getValue(n.newData,"QtyOnHand"),t;i==undefined&&(i=DXUtility.getValue(n.oldData,"QtyOnHand"));t=DXUtility.getValue(n.newData,"QtyOrder");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyOrder"));t<=0&&(n.errorText="Order Qty must be greater than 0.",n.isValid=!1);n.isValid&&t>i&&(n.errorText="Order Qty must be less than or equal to On Hand Qty.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},onDataErrorOccurred:function(n){var t=n.component._controllers.editing._editData[0].data.Product;switch(n.error.__id){case"E4008":n.error.message="Product '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},columns:[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"Product",caption:"Product",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$(f().element()),r,i,e;!u.find(".datagrid-bandedHeader:first").length>0&&(r=f().option("selection").mode=="none"?!1:!0,i='<tr class="dx-row dx-column-lines datagrid-bandedHeader" style="border-top-style: none !important;">',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",e=u.find(".dx-header-row:first-child"),$(i).insertBefore(e[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"150px",allowEditing:!1,dataType:"number"},{dataField:"QtyOrderConv",caption:"Order Qty (L/M/S)",width:"150px",alignment:"right",validationRules:[{type:"required"},at],cellTemplate:function(n,t){n.append(ei(t.data,"QtyOrderConv",1))}}]}));var n=$("#commonPopupEdit_extCommands"),s=$('<div id="vSalesOrderSwaps_salesOrderSwapPrintDO" style="margin-right: 32px;">').dxButton({text:"Print DO",icon:"icons8-print",onClick:function(){i.events.performPrintDO(this)}}),h=$('<div id="vSalesOrderSwaps_salesOrderSwapPost">').dxButton({text:"Post",icon:"icons8-check-green",onClick:function(){i.events.performPost(this)}}),c=$('<div id="vSalesOrderSwaps_salesOrderSwapDiscard">').dxButton({text:"Discard",icon:"icons8-trash-red",onClick:function(){i.events.performDiscard(this)}}),p=$('<div id="vSalesOrderSwaps_salesOrderSwapVoid" style="margin-right: 16px;">').dxButton({text:"Void",icon:"icons8-delete-red",onClick:function(){i.events.performVoid(this)}}),w=$('<div id="vSalesOrderSwaps_salesOrderSwapSaveAsDraftAndNew">').dxButton({text:"Save & New",icon:"icons8-save",onClick:function(){i.events.performSaveAsDraftAndNew(this)}});u.append(DXUtility.createFormItemGroupWithCaption("").append(t));n.append(s);n.append(h);n.append(c);n.append(p);n.append(w)},e.events.performNewRow=function(){ut(null)},i.events.performOK=function(){p(null,3)},i.events.performPrintDO=function(){var n=i.popupEditData();si(n.DODocumentID())},i.events.performPost=function(){DevExpress.ui.dialog.confirm("Are you sure want to Post this transaction?","Post Confirmation").done(function(n){n&&p(2,3)})},i.events.performDiscard=function(){DevExpress.ui.dialog.confirm("Are you sure want to Discard this transaction?","Discard Confirmation").done(function(n){n&&p(3,3)})},i.events.performVoid=function(){DevExpress.ui.dialog.confirm("Are you sure want to Void this transaction?","Void Confirmation").done(function(n){n&&p(4,3)})},i.events.performSaveAsDraftAndNew=function(){p(1,2)},i.formOptions.customizeItem=function(n){n.dataField=="AttachmentFile"&&(n.template=function(n,t){t.append(CommonUtility.createEditDataAttachmentFileUploader("vSalesOrderSwaps","SalesOrderSwaps"))})},i.events.performCancel=function(){i.popupEditOptions.visible(!1);d&&(e.dataGrid().refresh(),d=!1)},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form(),r,u;CommonUtility.cascadeValueChanged(t,n.selectedItem,n.value,"Site",["Area","Region","Territory"],[]);r="";u="";n.selectedItem?(r=vt(n.selectedItem.Code()),u=yt(n.selectedItem.Code()),t.getEditor("Company").option("value",n.selectedItem.Company())):n.previousValue!=null&&t.getEditor("Company").option("value",null);pt(t,n.value);t.getEditor("DocumentCode").option("value",r);t.getEditor("DODocumentCode").option("value",u)}}}]},{itemType:"group",caption:"Sales Order Swap",colCount:6,colSpan:3,items:[{dataField:"DocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"TransactionDate",label:{text:"Transaction Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();t.getEditor("DOShipmentDate").option("min",n.value)}}},{dataField:"DocumentStatusID",label:{text:"Status"},colSpan:1,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"NEW",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"CustomerID",label:{text:"Customer"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxLookup",editorOptions:{dataSource:[],displayExpr:"Customer",valueExpr:"ID",searchExpr:["Code","Name","Address1","Address2","Address3"],searchPlaceholder:"Customer/Address",searchEnabled:!1,popupWidth:"1082px",showPopupTitle:!1,fieldEditEnabled:!0,onOpened:function(){},onClosed:function(){},onContentReady:function(n){var t=i.form(),r=Dismoyo_Ciptoning_Client.app.CurrentUser;CommonUtility.createCustomerLookupHeader("vSalesOrderSwaps_customerIDLookup",n.element,ri("Customer.Category1"),r.SiteID(),t)},itemTemplate:function(n,t,i){return CommonUtility.createCustomerLookupItem(n,i)},onValueChanged:function(n){var t;if(n.value&&(t=n.selectedItem,t)){var e=i.popupEditData(),r=i.form(),u=null,f=null;t&&(u=t.SalesmanID(),f=t.WarehouseID());n.component.option("value",n.value);r.getEditor("SalesmanID").option("value",u);r.getEditor("WarehouseID").option("value",f)}}}},{itemType:"empty",colSpan:3},{dataField:"SalesmanID",label:{text:"Salesman"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Salesman",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t,u,r;o=[];l=[];n.value&&(t=i.popupEditData(),f().cancelEditData(),t.ChildSummaries([]),f().option("dataSource",it(t.ChildSummaries())));u=i.form();r=null;n.selectedItem&&(r=n.selectedItem.WarehouseID());u.getEditor("WarehouseID").option("value",r)}}},{dataField:"WarehouseID",label:{text:"Warehouse"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"",readOnly:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){if(o=[],l=[],n.value){var t=i.popupEditData(),r=f();r.cancelEditData();t.ChildSummaries([]);r.option("dataSource",it(t.ChildSummaries()))}}}},{itemType:"empty",colSpan:1},{dataField:"ReferenceNumber",label:{text:"Reference Number"},colSpan:3,editorOptions:{maxLength:30,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AttachmentFile",label:{text:"Attachment File"},colSpan:2,editorOptions:{onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1}]},{itemType:"group",caption:"Delivery Order",colCount:6,colSpan:3,items:[{dataField:"DODocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){commSonPopupEdit.events.performOK(this)}}},{dataField:"DOShipmentDate",label:{text:"Shipment Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();t.getEditor("DOReceivedDate").option("min",n.value)}}},{itemType:"empty"},{dataField:"DOPrintedCount",label:{text:"Printed Count"},colSpan:1,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DOLastPrintedDate",label:{text:"Last Printed Date"},colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DOReceivedDate",label:{text:"Received Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],h=new Dismoyo_Ciptoning_Client.CommonPopupIFrame,h.okOptions.visible=!1,h.cancelOptions.text="Close",r=new Dismoyo_Ciptoning_Client.ProductLotPopupEdit,r.formOptions.colCount=4,r.saveOptions.icon="icons8-save",r.events.performSave=function(){ci()},r.dataGridOptions.onInitNewRow=function(n){n.data.QtyOrder=0;n.data.QtyOrderConv="0/0/0"},r.dataGridOptions.onEditorPreparing=function(n){var i,u,t;n.parentType=="dataRow"&&(n.dataField=="ProductLotCode"?(n.row.inserted?(i=r.popupEditOptions.itemStatusID,u=w(i),n.editorElement.dxLookup({dataSource:new DevExpress.data.DataSource({store:o,filter:[["ProductID","=",r.popupEditData().ProductID()],"and",[u.qtyOnHandColumn,">",0]],sort:[{getter:"ProductLotExpiredDate",desc:!0}]}),displayExpr:"ProductLotCode",valueExpr:"ProductLotCode",searchExpr:"ProductLotCode",searchPlaceholder:"Lot Number",popupWidth:"582px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){var t=r.popupEditOptions.itemStatusID;CommonUtility.createProductLotLookupHeader("vSalesOrderSwaps_productLotIDLookup",n.element,t)},itemTemplate:function(n,t,i){var u=r.popupEditOptions.itemStatusID,f=w(u);return CommonUtility.createProductLotLookupItem(n,i,f.qtyOnHandColumn)},onValueChanged:function(t){var i,e,f,u;t.value&&(i=this.option("selectedItem"),i&&(e=r.popupEditOptions.itemStatusID,f=w(e),n.component.cellValue(n.row.rowIndex,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductLotID",i.ProductLotID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductLotCode",i.ProductLotCode()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),u=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyOrderConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyOrder",u.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",u.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",u.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",u.qtyConvS)));n.component.cellValue(n.row.rowIndex,"ProductLotCode",t.value);n.setValue(t.value)}})):(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.ProductLotCode()))),n.cancel=!0):n.dataField=="QtyOrderConv"&&(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyOrder",i.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvL",i.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvM",i.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvS",i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}}),n.cancel=!0))},r.dataGridOptions.onRowInserted=function(n){CommonUtility.validateDataGridInsertedTransactionDetails(n.component,new Dismoyo_Ciptoning_Client.vSalesOrderSwapDetailsViewModel(n.data).toJS())},r.dataGridOptions.onRowRemoved=function(n){CommonUtility.validateDataGridRemovedTransactionDetails(n.component,n.data.toJS())},r.dataGridOptions.onRowUpdating=function(n){CommonUtility.validateDataGridUpdatingTransactionDetails(n,"QtyConvL","QtyConvM","QtyConvS","QtyOrderConv","QtyOrder")},r.dataGridOptions.onRowValidating=function(n){var u=r.popupEditOptions.itemStatusID,f=w(u),i=DXUtility.getValue(n.newData,"QtyOnHand"),t;i==undefined&&(i=DXUtility.getValue(n.oldData,"QtyOnHand"));t=DXUtility.getValue(n.newData,"QtyOrder");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyOrder"));t<=0&&(n.errorText="Order Qty must be greater than 0.",n.isValid=!1);n.isValid&&t>i&&(n.errorText="Order Qty must be less than or equal to On Hand Qty.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.onDataErrorOccurred=function(n){var t=n.component._controllers.editing._editData[0].data.ProductLotCode;switch(n.error.__id){case"E4008":n.error.message="Lot Number '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.summary={totalItems:[{name:"TotalQtyPcs",showInColumn:"QtyOrderConv",displayFormat:"Total Qty (Pcs): {0}",valueFormat:"decimal",summaryType:"custom"},{name:"TotalQtyLMS",showInColumn:"QtyOrderConv",displayFormat:"(L/M/S): {0}",valueFormat:"string",summaryType:"custom"}],calculateCustomSummary:function(n){CommonUtility.updateProductLotEditingSummary(n,"QtyOrderConv","QtyOrder")}},r.dataGridOptions.columns=[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"ProductLotID",visible:!1},{dataField:"ProductLotCode",caption:"Lot Number",validationRules:[{type:"required"}]},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"120px",allowEditing:!1,dataType:"number"},{dataField:"QtyOrderConv",caption:"Order Qty (L/M/S)",width:"150px",alignment:"right",validationRules:[{type:"required"},at]}],r.formOptions.items=[{itemType:"group",caption:"Product",colCount:4,colSpan:4,items:[{dataField:"Product",label:{text:"Product"},colSpan:4,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOnHand",label:{text:"On Hand Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2},{dataField:"QtyOrder",label:{text:"Order Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOrderConv",label:{text:"(L/M/S)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],{isReady:ot.promise(),dataSource:s,refreshList:lt,viewShowing:gt,viewDisposing:ni,openCreateViewAsRoot:dt,icon:"Images/sales_order_swap_32px.png",dataSource_vSalesOrderSwapSummary:ti,dataSource_vSalesOrderSwapDetails:ii,dataSource_vStockOnHandAvailable:o,dataSource_vStockOnHandAvailableByProduct:l,collapsibleFilter:u,commonGridView:e,commonPopupEdit:i,commonPopupIFrame:h,productLotPopupEdit:r,salesOrderSwapSummaryDataGrid:f,salesOrderSwapPost:a,salesOrderSwapDiscard:b,salesOrderSwapVoid:v,salesOrderSwapSaveAsDraftAndNew:y,isLotNumberEntryRequired:c}};Dismoyo_Ciptoning_Client.vSites=function(n,t){"use strict";function y(){h=!0}function p(){s=CommonUtility.configureCommonGridViewLayout("vSites");s||setTimeout(p,50)}function g(){p();v()?h&&w():(v(e),e.load().always(function(){a.resolve()}))}function nt(){Dismoyo_Ciptoning_Client.DB.vSites.off("modified",y)}function w(){h=!1;e.pageIndex(0);e.load()}function tt(n){for(var t,r,i,u=ko.toJS(n),f=0;f<u.length;f++)for(t=u[f],t.key=t.ID,t.text=t.Brand,t.items=t.ChildProducts,r=0;r<t.items.length;r++)i=t.items[r],i.key=t.ID+"_"+i.ID,i.text=i.Product;return u}function it(n){for(var t,i=ko.toJS(n),r=0;r<i.length;r++)t=i[r],t.key=t.ID,t.text=t.Warehouse,t.selected=t.IsSOAllowed;return i}function f(n){var t=Dismoyo_Ciptoning_Client.LocalStore.vSystemParameters.dataByFilter(["ID","=",n]);return t.length>0?t[0].Value():null}function b(n,t){showLoadingPanel();Dismoyo_Ciptoning_Client.DB.vSites.byKey(n,{expand:["ChildProducts","ChildWarehouses"]}).done(function(n){hideLoadingPanel();o=t;k(new Dismoyo_Ciptoning_Client.vSiteViewModel(n))}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function k(n){var r=!1,t,e,o,f,u;if(n||(n=new Dismoyo_Ciptoning_Client.vSiteViewModel,n.StatusID(1),r=!0),i.popupEditData(n),i.popupEdit().option("title",(r?"New":"Edit")+" Site"),i.popupEditOptions.editingKey=n.ID(),i.popupEditOptions.visible(!0),i.popupContent().scrollTo(0),t=i.form(),DXUtility.resetFormValidation(t),e=[],o=[],r)n.StatusID(1),n.IsLotNumberEntryRequired(!1);else for(e=it(n.ChildWarehouses()),f=0;f<n.ChildProducts().length;f++)u=n.ChildProducts()[f],u.key=u.ProductBrandID()+"_"+u.ProductID(),o.push(u);t.getEditor("TerritoryID").option("value",n.TerritoryID());t.getEditor("RegionID").option("value",n.RegionID());t.getEditor("AreaID").option("value",n.AreaID());t.getEditor("CompanyID").option("value",n.CompanyID());t.getEditor("SAPCode").option("value",n.SAPCode());t.getEditor("Code").option("value",n.Code());t.getEditor("Name").option("value",n.Name());t.getEditor("DistributionTypeID").option("value",n.DistributionTypeID());t.getEditor("Address1").option("value",n.Address1());t.getEditor("Address2").option("value",n.Address2());t.getEditor("Address3").option("value",n.Address3());t.getEditor("City").option("value",n.City());t.getEditor("StateProvince").option("value",n.StateProvince());t.getEditor("CountryID").option("value",n.CountryID());t.getEditor("ZipCode").option("value",n.ZipCode());t.getEditor("Phone1").option("value",n.Phone1());t.getEditor("Phone2").option("value",n.Phone2());t.getEditor("Fax").option("value",n.Fax());t.getEditor("Email").option("value",n.Email());t.getEditor("AdditionalInfo1").option("value",n.AdditionalInfo1());t.getEditor("AdditionalInfo2").option("value",n.AdditionalInfo2());t.getEditor("AdditionalInfo3").option("value",n.AdditionalInfo3());t.getEditor("AdditionalInfo4").option("value",n.AdditionalInfo4());t.getEditor("AdditionalInfo5").option("value",n.AdditionalInfo5());t.getEditor("AdditionalInfo6").option("value",n.AdditionalInfo6());t.getEditor("AdditionalInfo7").option("value",n.AdditionalInfo7());t.getEditor("AdditionalInfo8").option("value",n.AdditionalInfo8());t.getEditor("AdditionalInfo9").option("value",n.AdditionalInfo9());t.getEditor("AdditionalInfo10").option("value",n.AdditionalInfo10());t.getEditor("Code").option("readOnly",!r);r&&DXUtility.resetFormValidation(t);t.getEditor("StatusID").option("value",n.StatusID());t.getEditor("IsLotNumberEntryRequired").option("value",n.IsLotNumberEntryRequired());l().option("dataSource",e);new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vProductBrands,select:["ID","Brand","ChildProducts","ChildProducts.ID","ChildProducts.Product"],expand:["ChildProducts"],map:function(n){return new Dismoyo_Ciptoning_Client.vProductBrandViewModel(n)}}).load().done(function(n){var t=tt(n);DXUtility.setSelectedTreeViewItems(t,o);c().option("dataSource",t)})}function rt(){var n,t,f,u,s,e,h;showLoadingPanel();var a=i.form().validate().isValid,v=r.dataGrid(),y=v.option("dataSource");if(a){for(n=i.popupEditData(),t=i.form(),n.TerritoryID(t.getEditor("TerritoryID").option("value")),n.RegionID(t.getEditor("RegionID").option("value")),n.AreaID(t.getEditor("AreaID").option("value")),n.CompanyID(t.getEditor("CompanyID").option("value")),n.SAPCode(t.getEditor("SAPCode").option("value")),n.Code(t.getEditor("Code").option("value")),n.Name(t.getEditor("Name").option("value")),n.DistributionTypeID(t.getEditor("DistributionTypeID").option("value")),n.StatusID(t.getEditor("StatusID").option("value")),n.Address1(t.getEditor("Address1").option("value")),n.Address2(t.getEditor("Address2").option("value")),n.Address3(t.getEditor("Address3").option("value")),n.City(t.getEditor("City").option("value")),n.StateProvince(t.getEditor("StateProvince").option("value")),n.CountryID(t.getEditor("CountryID").option("value")),n.ZipCode(t.getEditor("ZipCode").option("value")),n.Phone1(t.getEditor("Phone1").option("value")),n.Phone2(t.getEditor("Phone2").option("value")),n.Fax(t.getEditor("Fax").option("value")),n.Email(t.getEditor("Email").option("value")),n.IsLotNumberEntryRequired(t.getEditor("IsLotNumberEntryRequired").option("value")),n.AdditionalInfo1(t.getEditor("AdditionalInfo1").option("value")),n.AdditionalInfo2(t.getEditor("AdditionalInfo2").option("value")),n.AdditionalInfo3(t.getEditor("AdditionalInfo3").option("value")),n.AdditionalInfo4(t.getEditor("AdditionalInfo4").option("value")),n.AdditionalInfo5(t.getEditor("AdditionalInfo5").option("value")),n.AdditionalInfo6(t.getEditor("AdditionalInfo6").option("value")),n.AdditionalInfo7(t.getEditor("AdditionalInfo7").option("value")),n.AdditionalInfo8(t.getEditor("AdditionalInfo8").option("value")),n.AdditionalInfo9(t.getEditor("AdditionalInfo9").option("value")),n.AdditionalInfo10(t.getEditor("AdditionalInfo10").option("value")),f=[],DXUtility.getSelectedTreeViewItems(c().option("items"),f),u=0;u<f.length;){if(e=f[u],!e.Product){f.splice(u,1);continue}u++}for(u=0;u<f.length;u++)e=f[u],f[u]=new Dismoyo_Ciptoning_Client.vSiteProductViewModel({SiteID:n.ID(),ProductID:e.ID});for(s=l().option("items"),u=0;u<s.length;u++)e=s[u],s[u]=new Dismoyo_Ciptoning_Client.vWarehouseViewModel(e);n.ChildProducts(f);n.ChildWarehouses(s);h=ko.toJS(n);y.store().insert(h).done(function(){o=!0;i.events.performCancel();hideLoadingPanel()}).fail(function(n){var t=$(".dx-popup-normal>.dx-dialog-content");t.length==0&&DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})}else hideLoadingPanel()}var h=!1,d=t.layoutController.name==="split",a=$.Deferred(),v=ko.observable(),e,o,s,u,r,i,c,l;e=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSites,map:function(n){return new Dismoyo_Ciptoning_Client.vSiteViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vSites.on("modified",y);return u=new Dismoyo_Ciptoning_Client.CollapsibleFilter,u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){s&&s.resizeAll()})},u.formOptions.items=[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company"])}}},{dataField:"CompanyID",label:{text:"Company"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch()}}},{name:"Site",dataField:"",label:{text:"Site"},editorOptions:{placeholder:"Code/Name",onEnterKey:function(){u.events.performSearch()}}},{dataField:"DistributionTypeID",label:{text:"Distribution Type"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","SiteDistributionType"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch()}}}],u.events.performSearch=function(){var e=r.dataGrid(),i=u.form(),t=[],n,f;e.clearFilter();n=i.getEditor("TerritoryID").option("value");DXUtility.addFilterExpression(t,"TerritoryID","=",n,"and");n=i.getEditor("RegionID").option("value");DXUtility.addFilterExpression(t,"RegionID","=",n,"and");n=i.getEditor("AreaID").option("value");DXUtility.addFilterExpression(t,"AreaID","=",n,"and");n=i.getEditor("CompanyID").option("value");DXUtility.addFilterExpression(t,"CompanyID","=",n,"and");n=i.getEditor("DistributionTypeID").option("value");isNaN(n)||n===null||DXUtility.addFilterExpression(t,"DistributionTypeID","=",parseInt(n),"and");n=i.getEditor("Site").option("value");f=[];DXUtility.addFilterExpression(f,"Code","contains",n,"or");DXUtility.addFilterExpression(f,"Name","contains",n,"or");DXUtility.addGroupFilterExpression(t,f,"and");t.length>0?e.filter(t):e.refresh()},r=new Dismoyo_Ciptoning_Client.CommonGridView,r.dataGridOptions.dataSource=e,r.dataGridOptions.editing.editEnabled=!1,r.dataGridOptions.editing.removeEnabled=!1,r.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Sites.AddNewSite"),r.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Sites.EditSite"),r.dataGridOptions.editing.allowDeleting=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Sites.DeleteSite"),r.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Territory",caption:"Territory",width:"200px"},{dataField:"Region",caption:"Region",width:"200px"},{dataField:"Area",caption:"Area",width:"200px"},{dataField:"Company",caption:"Company",width:"200px"},{dataField:"Code",Caption:"Code",width:"70px",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$("#vSites_commonGridView").find(".dx-datagrid:first-child"),i,f;!u.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines data-grid-banded-header-border-top">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Site<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',(r.dataGridOptions.editing.allowUpdating||r.dataGridOptions.editing.allowDeleting)&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",f=u.find(".dx-header-row:first-child"),$(i).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: left;">'),u=$("<b>").text(t.data.Code());r.dataGridOptions.editing.allowUpdating&&(u=$('<a class="dx-link">').text(t.data.Code()).on("dxclick",function(){b(t.data.ID(),!1)}));i.append(u);i.append("&nbsp;");n.append(i)}},{dataField:"Name",width:"180px"},{dataField:"DistributionTypeName",caption:"Distribution Type",width:"150px"},{dataField:"StatusName",caption:"Status",width:"100px"},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],(r.dataGridOptions.editing.allowUpdating||r.dataGridOptions.editing.allowDeleting)&&r.dataGridOptions.columns.push({width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');r.dataGridOptions.editing.allowUpdating&&(i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){b(t.data.ID(),!1)})),i.append("&nbsp;"));r.dataGridOptions.editing.allowDeleting&&(i.append($('<a class="dx-link">').text("Delete").on("dxclick",function(){var n=r.dataGrid(),i=n.option("dataSource"),u=t.data.toJS(),f=u.ID;i.store().remove(f).done(function(){n.refresh()})})),i.append("&nbsp;"));n.append(i)}}),i=new Dismoyo_Ciptoning_Client.CommonPopupEdit,i.popupEditOptions.title="Site",i.okOptions.text="Save",i.okOptions.icon="icons8-save",c=function(){return DXUtility.getDXInstance(null,"#vSites_siteProductTreeView","dxTreeView")},l=function(){return DXUtility.getDXInstance(null,"#vSites_soWarehouseTreeView","dxTreeView")},i.popupEditOptions.onContentReady=function(){var r=$("#commonPopupEdit_extContent"),t=$("<div>"),i=$('<table width="100%">'),n=$("<tr>");n.append($('<td width="50%" style="vertical-align: top;">').append(DXUtility.createFormItemGroupWithCaption("Products").css("padding","0px 12px 0px 0px").append(DXUtility.createFormItemGroupContent().css("padding","16px 12px 0px 0px")).append($('<div id="vSites_siteProductTreeView">').dxTreeView({dataSource:[],dataStructure:"tree",keyExpr:"key",displayExpr:"text",rootValue:null,showCheckBoxesMode:"normal"}))));n.append($('<td width="50%" style="vertical-align: top;">').append(DXUtility.createFormItemGroupWithCaption("SO Allowed Warehouses").css("padding","0px 0px 0px 12px").append(DXUtility.createFormItemGroupContent().css("padding","16px 0px 0px 12px")).append($('<div id="vSites_soWarehouseTreeView">').dxTreeView({dataSource:[],dataStructure:"tree",keyExpr:"key",displayExpr:"text",rootValue:null,showCheckBoxesMode:"normal",onItemSelected:function(n){n.node.itemData.IsSOAllowed=n.node.selected}}))));i.append(n);t.append(i);r.append(DXUtility.createFormItemGroupWithCaption("").append(t))},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:3,validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2}]},{itemType:"group",caption:"Site",colCount:3,colSpan:3,items:[{dataField:"Code",validationRules:[{type:"required"}],label:{text:"Code"},editorOptions:{maxLength:5,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Name",validationRules:[{type:"required"}],label:{text:"Name"},colSpan:2,editorOptions:{width:"500px",maxLength:50,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DistributionTypeID",validationRules:[{type:"required"}],label:{text:"Distribution Type"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","SiteDistributionType"]),displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"StatusID",validationRules:[{type:"required"}],label:{text:"Status"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","SiteStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"Address1",validationRules:[{type:"required"}],label:{text:"Address"},colSpan:2,editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"Address2",label:{text:" "},colSpan:2,editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"Address3",label:{text:" "},colSpan:2,editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"City",validationRules:[{type:"required"}],label:{text:"City"},editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"StateProvince",validationRules:[{type:"required"}],label:{text:"Province"},editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"CountryID",validationRules:[{type:"required"}],label:{text:"Country"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCountryDataSource(null),displayExpr:"Name",valueExpr:"ID",searchEnabled:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"ZipCode",validationRules:[{type:"required"},{type:"numeric"}],label:{text:"Zip code"},editorOptions:{maxLength:10,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"Phone1",validationRules:[{type:"required"},{type:"numeric"}],label:{text:"Phone 1"},editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Phone2",validationRules:[{type:"numeric"}],label:{text:"Phone 2"},editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"Fax",validationRules:[{type:"numeric"}],label:{text:"Fax"},editorOptions:{maxLength:20,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"Email",validationRules:[{type:"email"}],label:{text:"Email"},editorOptions:{maxLength:256,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"SAPCode",validationRules:[{type:"required"}],label:{text:"SAP Code"},editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2},{dataField:"IsLotNumberEntryRequired",editorType:"dxCheckBox"}]},{itemType:"group",caption:"Additional Info",colCount:3,colSpan:3,items:[{dataField:"AdditionalInfo1",label:{text:f("Site.AdditionalInfo1")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo2",label:{text:f("Site.AdditionalInfo2")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"AdditionalInfo3",label:{text:f("Site.AdditionalInfo3")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo4",label:{text:f("Site.AdditionalInfo4")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"AdditionalInfo5",label:{text:f("Site.AdditionalInfo5")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo6",label:{text:f("Site.AdditionalInfo6")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"AdditionalInfo7",label:{text:f("Site.AdditionalInfo7")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo8",label:{text:f("Site.AdditionalInfo8")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"AdditionalInfo9",label:{text:f("Site.AdditionalInfo9")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AdditionalInfo10",label:{text:f("Site.AdditionalInfo10")},editorOptions:{maxLength:100,onEnterKey:function(){i.events.performOK(this)}}}]}],r.events.performNewRow=function(){k(null)},i.events.performOK=function(){rt()},i.events.performCancel=function(){i.popupEditOptions.visible(!1);o&&(r.dataGrid().refresh(),o=!1)},{isReady:a.promise(),dataSource:e,refreshList:w,viewShowing:g,viewDisposing:nt,openCreateViewAsRoot:d,icon:"/Images/site_32px.png",collapsibleFilter:u,commonGridView:r,commonPopupEdit:i}};Dismoyo_Ciptoning_Client.vStockChanges=function(n,t){"use strict";function it(){w=!0}function rt(){v=CommonUtility.configureCommonGridViewLayout("vStockChanges");v||setTimeout(rt,50)}function pt(){var n,t;rt();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],o.filter(t));tt()?w&&ut():(tt(o),o.load().always(function(){nt.resolve()}))}function wt(){Dismoyo_Ciptoning_Client.DB.vStockChanges.off("modified",it)}function ut(){w=!1;o.pageIndex(0);o.load()}function et(n){return(n?n:"(Site Code)")+"-YY-07-(Auto Generated)"}function ot(n,t){t?Dismoyo_Ciptoning_Client.DB.vSites.byKey(t).done(function(n){s=n.IsLotNumberEntryRequired}):(t=null,s=undefined);var i=DataUtility.GetLookupWarehouseDataSource(["SiteID","=",t]);n.getEditor("WarehouseID").option("value",null);n.getEditor("WarehouseID").option("dataSource",[]);i.load().done(function(){n.getEditor("WarehouseID").option("dataSource",i)})}function st(n){CommonUtility.updateSummariesArrayStore(f().option("dataSource").store(),n)}function dt(n,t){CommonUtility.updateDeferSummariesArrayStore(f().option("dataSource").store(),n,t)}function gt(n){return CommonUtility.validateSummaryArrayStore(f().option("dataSource").store(),"vStockChangesSummaryViewModel",n)}function b(n){return CommonUtility.createArrayDataSource("vStockChangesSummaryViewModel",["ProductID"],n)}function ni(n,t,i){var r=$('<div class="dx-command-edit" style="text-align: right; padding-right: 5px;">'),o;if(r.append($('<a style="color: inherit;">').text(n[t]())),r.append("&nbsp;"),s){var u=t.replace("Conv",""),h=n[u](),f=n.ChildDetails(),e=0;for(o in f)e+=f[o][u]();r.append($('<a class="dx-link dxcustom-linkbutton dx-icon-icons8-view-details" title="Edit Lot Number">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<\/a><span id="LotMark_'+n.ProductID()+"_"+t+'" class="dx-icon-overflow '+(e==h?"hidden":"")+'" style="color:red; font-size: 14px; margin-left: -6px;"><\/span>').on("dxclick",function(){p(function(){ii(n,i)})}));r.append("&nbsp;")}return r}function ti(n){var t=f().option("editing"),i=f().option("selection");i.mode=n?"multiple":"none";t.allowUpdating=n;t.allowDeleting=n;f().option("editing",t);f().option("selection",i);ui().option("disabled",!n);vt().option("disabled",!0);f().repaint()}function k(n,t){showLoadingPanel();Dismoyo_Ciptoning_Client.DB.vStockChanges.byKey(n,{expand:["ChildSummaries/ChildDetails"]}).done(function(n){hideLoadingPanel();a=t;d(new Dismoyo_Ciptoning_Client.vStockChangesViewModel(n))}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function d(n){var e=!1,u,t,o,v,c,y,w,l,a,rt,k,d,nt,ut,tt;n||(n=new Dismoyo_Ciptoning_Client.vStockChangesViewModel,e=!0);i.popupEditData(n);i.popupEdit().option("title",(e?"New":"Edit")+" Stock Changes");i.popupEditOptions.editingKey=n.DocumentID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);u=Dismoyo_Ciptoning_Client.app.CurrentUser;t=i.form();DXUtility.resetFormValidation(t);var it=n.DocumentCode(),r=!1,h=[];if(s=n.IsSiteLotNumberEntryRequired(),e)n.DocumentID(new DevExpress.data.Guid),n.DocumentStatusID(null),n.TerritoryID(u.TerritoryID()),n.RegionID(u.RegionID()),n.AreaID(u.AreaID()),n.SiteID(u.SiteID()),n.SiteCode(u.SiteCode()),n.CompanyID(u.CompanyID()),n.Company(u.Company()),it=et(n.SiteCode());else if(h=n.ChildSummaries(),n.DocumentStatusID()!=1||s)(n.DocumentStatusID()==2||n.DocumentStatusID()==3)&&(r=!0);else{for(o=[],v=0,c=0;c<h.length;c++){for(y=h[c].ChildDetails(),w=0,l=0;l<y.length;l++)y[l].ProductLotCode().indexOf("DUMMY")<0&&w++;w>0&&(o[v]=h[c],v++)}o.length>0&&p(function(){for(var t,n=0;n<o.length;n++)t={data:o[n].toJS()},g(t,o)})}ti(!r);ct().option("disabled",e||r);lt().option("disabled",e||r);at().option("disabled",r);i.ok().option("disabled",r);a=t.itemOption("Organization");a.visible=u.IsHeadOffice();u.IsHeadOffice()||(t.itemOption("Organization",a),rt=DataUtility.GetLookupSystemLookupDataSource([["Group","=","ProductItemStatus"],"and",["Value_Int32","<>",4],"and",["Value_Int32","<>",n.OldItemStatusID()?n.OldItemStatusID():4]]),k=t.getEditor("NewItemStatusID"),k.option("value",null),k.option("dataSource",rt));a.visible&&(t.getEditor("TerritoryID").option("value",n.TerritoryID()),t.getEditor("RegionID").option("value",n.RegionID()),t.getEditor("AreaID").option("value",n.AreaID()),t.getEditor("SiteID").option("value",n.SiteID()),t.getEditor("Company").option("value",n.Company()),t.getEditor("TerritoryID").option("readOnly",r),t.getEditor("RegionID").option("readOnly",r),t.getEditor("AreaID").option("readOnly",r),t.getEditor("SiteID").option("readOnly",r));ot(t,n.SiteID());t.getEditor("DocumentCode").option("value",it);t.getEditor("TransactionDate").option("value",n.TransactionDate());t.getEditor("WarehouseID").option("value",n.WarehouseID());t.getEditor("PIC").option("value",n.PIC());t.getEditor("OldItemStatusID").option("value",n.OldItemStatusID());t.getEditor("NewItemStatusID").option("value",n.NewItemStatusID());t.getEditor("ReferenceNumber").option("value",n.ReferenceNumber());d=ht();CommonUtility.createEditDataAttachmentFileDownloader("vStockChanges",d,"StockChanges",n.AttachmentFile());d.option("value",null);t.getEditor("DocumentStatusID").option("value",n.DocumentStatusID());t.getEditor("TransactionDate").option("readOnly",r);t.getEditor("WarehouseID").option("readOnly",r);t.getEditor("PIC").option("readOnly",r);t.getEditor("OldItemStatusID").option("readOnly",r);t.getEditor("NewItemStatusID").option("readOnly",r);t.getEditor("ReferenceNumber").option("readOnly",r);nt=$(".dx-fileuploader-input-wrapper");r?nt.hide():nt.show();ut=new Date;e&&(DXUtility.resetFormValidation(t),t.getEditor("TransactionDate").option("value",ut));tt=f();tt.cancelEditData();n.ChildSummaries(h);tt.option("dataSource",b(n.ChildSummaries()))}function g(n,t){var l,u,a,o,r,v,c;if(!s){var p=i.popupEditData(),y=f(),e=[];if(t){for(r=0;r<t.length;r++)t[r].ChildDetails([]);e=t}else for(l=y.option("dataSource").store(),r=0;r<l._array.length;r++)e.push(new Dismoyo_Ciptoning_Client.vStockChangesSummaryViewModel(l._array[r]));if(u=n.data,a=$.grep(h,function(n){return n.ProductID()==DXUtility.getValue(u,"ProductID")&&n.ProductLotCode().indexOf("DUMMY")>=0}),a.length>0)for(o=a[0],DXUtility.setValue(u,"ProductLotID",o.ProductLotID()),DXUtility.setValue(u,"ProductLotCode",o.ProductLotCode()),DXUtility.setValue(u,"QtyOnHandGood",o.QtyOnHandGood()),DXUtility.setValue(u,"QtyOnHandHold",o.QtyOnHandHold()),DXUtility.setValue(u,"QtyOnHandBad",o.QtyOnHandBad()),r=0;r<e.length;r++)e[r].ProductID()==DXUtility.getValue(u,"ProductID")&&(v=$.grep(e[r].ChildDetails(),function(n){return n.ProductLotID()==DXUtility.getValue(u,"ProductLotID")}),v.length>0?(c=v[0],c.QtyConvL(DXUtility.getValue(u,"QtyConvL")),c.QtyConvM(DXUtility.getValue(u,"QtyConvM")),c.QtyConvS(DXUtility.getValue(u,"QtyConvS")),c.QtyChanges(DXUtility.getValue(u,"QtyChanges")),c.QtyChangesConv(DXUtility.getValue(u,"QtyChangesConv"))):e[r].ChildDetails().push(new Dismoyo_Ciptoning_Client.vStockChangesDetailsViewModel(u)),st(e[r]));else DevExpress.ui.dialog.alert("DUMMY Lot Number for the selected product is not available.","Save Failed")}}function y(n,t){var w,nt,o,b,s,r,u,v,y;showLoadingPanel();var h=i.form(),c=h.validate().isValid,l=c?"":"Please specify the required fields.",tt=e.dataGrid(),it=tt.option("dataSource"),g=f().option("dataSource"),p=[];for(r=0;r<g.store()._array.length;r++)p.push(new Dismoyo_Ciptoning_Client.vStockChangesSummaryViewModel(g.store()._array[r]));if(c&&p.length<=0&&(l="Please specify at least one item in Changes Details.",c=!1),c)for(r=0;r<p.length;r++){for(u=p[r],w=0,v=0;v<u.ChildDetails().length;v++)y=u.ChildDetails()[v],w+=y.QtyChanges();u.QtyChanges()!=w&&(l==""?l="Following products quantity of Changes Details items is not matched: ":l+=", ",l+=u.Product(),c=!1)}if(c&&$(".dx-fileuploader-button.dx-fileuploader-upload-button.dx-widget.dx-button-has-icon.dx-button.dx-button-normal").length>0&&(l="You have selected an attachment file. Please upload or cancel the attachment file.",c=!1),nt=Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID(),h.itemOption("Organization").visible&&(nt=h.getEditor("SiteID").option("value")),c){for(o=i.popupEditData(),o.TransactionDate(h.getEditor("TransactionDate").option("value")),o.WarehouseID(h.getEditor("WarehouseID").option("value")),o.PIC(h.getEditor("PIC").option("value")),o.OldItemStatusID(h.getEditor("OldItemStatusID").option("value")),o.NewItemStatusID(h.getEditor("NewItemStatusID").option("value")),o.ReferenceNumber(h.getEditor("ReferenceNumber").option("value")),b=ht(),o.AttachmentFile(b.option("values").length>0?b.fileName:null),o.ChildSummaries(p),s=ko.toJS(o),n&&(s.DocumentStatusID=n),s.DocumentStatusID||(s.DocumentStatusID=1),s.TransactionDate=DateTimeUtility.getFirstTimeOfDay(s.TransactionDate),r=0;r<s.ChildSummaries.length;r++){for(u=s.ChildSummaries[r],u.DocumentID=s.DocumentID,v=0;v<u.ChildDetails.length;v++)y=u.ChildDetails[v],y.DocumentID=s.DocumentID,y.Qty=y.QtyChanges*-1;u.Qty=u.QtyChanges*-1}it.store().insert(s).done(function(n){CommonUtility.documentSuccessMessage(n.DocumentStatusID,function(){});a=!0;switch(t){case 1:i.events.performCancel();hideLoadingPanel();break;case 2:d(null);hideLoadingPanel();break;case 3:k(o.DocumentID(),!0)}}).fail(function(n){DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})}else hideLoadingPanel();l!=""&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(l),"Save Failed")}function l(n){var t=null;switch(n){case 1:t="Good";break;case 2:t="Hold";break;case 3:t="Bad"}var i="QtyOnHand"+t,r="QtyConvL"+t,u="QtyConvM"+t,f="QtyConvS"+t,e="QtyChanges"+t,o="QtyChangesConv"+t;return{itemStatusName:t,qtyOnHandColumn:i,qtyConvLColumn:r,qtyConvMColumn:u,qtyConvSColumn:f,qtyChangesColumn:e,qtyChangesConvColumn:o}}function ii(n,t){var o=i.popupEditData(),f,h,c;r.popupEditData(n);r.popupEditOptions.editingKey=n.ProductID();r.popupEditOptions.itemStatusID=t;r.popupEditOptions.visible(!0);var s=r.dataGrid(),e=r.form(),u=!1;(o.DocumentStatusID()==2||o.DocumentStatusID()==3)&&(u=!0);f=r.dataGrid().option("editing");f.allowUpdating=!u;f.allowDeleting=!u;f.editEnabled=!u;f.removeEnabled=!u;r.dataGrid().option("editing",f);r.dataGrid().option("selection",{mode:u?"none":"multiple"});r.newRow().option("disabled",u);r.dataGrid().repaint();e.getEditor("Product").option("value",n.Product());e.getEditor("QtyOnHand").option("value",n.QtyOnHand());e.getEditor("QtyChangesConv").option("value",n.QtyChangesConv());h=CommonUtility.getConversion(n.QtyChangesConv(),DXUtility.getValue(n,"ProductConversionL"),DXUtility.getValue(n,"ProductConversionM"),DXUtility.getValue(n,"ProductConversionS"));e.getEditor("QtyChanges").option("value",h.qtyTransaction);n=gt(n);c=CommonUtility.createArrayDataSource("vStockChangesDetailsViewModel",["ProductID","ProductLotID"],n.ChildDetails());s.cancelEditData();s.option("dataSource",c)}function ri(){var n=r.popupEditData(),t=r.popupEditOptions.itemStatusID,i=l(t);CommonUtility.validateProductLotEditing(n,r.dataGrid().option("dataSource"),r.form().getEditor("QtyChanges").option("value"),"Changes","vStockChangesDetailsViewModel","QtyConvL","QtyConvM","QtyConvS","QtyChangesConv","QtyChanges",!1)&&(st(n),r.popupEditOptions.visible(!1),f().refresh())}function p(n){if(h.length==0&&c.length==0){showLoadingPanel();var t=i.form();new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vProducts,select:["ID","Code","Product","UOMLID","UOMMID","UOMSID","ConversionL","ConversionM","ConversionS"],sort:["ID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vProductViewModel(n)}}).load().done(function(r){var o=r,e=t.getEditor("WarehouseID").option("value"),u="",f;switch(i.form().getEditor("OldItemStatusID").option("value")){case 1:u+="Good";break;case 2:u+="Hold";break;case 3:u+="Bad"}f=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOnHandAvailables,select:["ProductID","ProductLotID","ProductLotCode","ProductLot","ProductLotExpiredDate","QtyOnHand"+u],filter:[["WarehouseID","=",e],"and",["QtyOnHand"+u,">",0]],sort:["WarehouseID","ProductID","ProductLotID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(n)}});f.load().done(function(t){for(var o,l,f=null,s=[],i=[],e=0;e<t.length;e++)s.push(new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(t[e].toJS())),o=i.length-1,l=t[e].ProductID(),e==0||i[o].ProductID()!=l?(i.push(new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(t[e].toJS())),o++,f=$.grep(r,function(n){return n.ID()==l})):(i[o].QtyOnHandGood(i[o].QtyOnHandGood()+t[e].QtyOnHandGood()),i[o].QtyOnHandHold(i[o].QtyOnHandHold()+t[e].QtyOnHandHold()),i[o].QtyOnHandBad(i[o].QtyOnHandBad()+t[e].QtyOnHandBad())),s[e].ProductCode(f[0].Code()),s[e].Product(f[0].Product()),s[e].ProductUOMLID(f[0].UOMLID()),s[e].ProductUOMMID(f[0].UOMMID()),s[e].ProductUOMSID(f[0].UOMSID()),s[e].ProductConversionL(f[0].ConversionL()),s[e].ProductConversionM(f[0].ConversionM()),s[e].ProductConversionS(f[0].ConversionS()),i[o].ProductCode(f[0].Code()),i[o].Product(f[0].Product()),i[o].ProductUOMLID(f[0].UOMLID()),i[o].ProductUOMMID(f[0].UOMMID()),i[o].ProductUOMSID(f[0].UOMSID()),i[o].ProductConversionL(f[0].ConversionL()),i[o].ProductConversionM(f[0].ConversionM()),i[o].ProductConversionS(f[0].ConversionS());h=s;c=i;h.length==0?DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Product lot stock with item status "+u+" for the selected warehouse is empty."),"New Changes Details Failed"):n();hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product lot data."),"Download Product Lot Failed");hideLoadingPanel()})}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product data."),"Download Product Failed");hideLoadingPanel()})}else n()}var w=!1,yt=t.layoutController.name==="split",nt=$.Deferred(),tt=ko.observable(),o,a,s,v,u,e,i,r;o=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockChanges,map:function(n){return new Dismoyo_Ciptoning_Client.vStockChangesViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vStockChanges.on("modified",it);var bt=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockChangesDetails,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockChangesDetailsViewModel(n)}}),kt=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockChangesSummaries,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockChangesSummaryViewModel(n)}}),h,c,ft={type:"pattern",pattern:"(^[0-9]*$)|(^[0-9]*/[0-9]*$)|(^[0-9]*/[0-9]*/[0-9]*$)",message:"Format must be L/M/S or M/S or S."};u=new Dismoyo_Ciptoning_Client.CollapsibleFilter;u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){v&&v.resizeAll()})};u.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Warehouse"])}}}]},{itemType:"group",caption:"Stock Change",colCount:3,colSpan:3,items:[{dataField:"WarehouseID",label:{text:"Warehouse"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{name:"DocumentCode",dataField:"",label:{text:"Document Number"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateFrom",label:{text:"Transaction Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateTo",label:{text:"Transaction Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"PIC",label:{text:"PIC"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}}]}];u.events.performSearch=function(){var f=e.dataGrid(),t=u.form(),n=[],i;f.clearFilter();var r=Dismoyo_Ciptoning_Client.app.CurrentUser,o=r.TerritoryID(),s=r.RegionID(),h=r.AreaID(),c=r.CompanyID(),l=r.SiteID();t.itemOption("Organization").visible&&(o=t.getEditor("TerritoryID").option("value"),s=t.getEditor("RegionID").option("value"),h=t.getEditor("AreaID").option("value"),c=t.getEditor("CompanyID").option("value"),l=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",o,"and");DXUtility.addFilterExpression(n,"RegionID","=",s,"and");DXUtility.addFilterExpression(n,"AreaID","=",h,"and");DXUtility.addFilterExpression(n,"CompanyID","=",c,"and");DXUtility.addFilterExpression(n,"SiteID","=",l,"and");i=t.getEditor("WarehouseID").option("value");DXUtility.addFilterExpression(n,"WarehouseID","=",i,"and");i=t.getEditor("DocumentCode").option("value");DXUtility.addFilterExpression(n,"DocumentCode","contains",i,"and");i=t.getEditor("TransactionDateFrom").option("value");DXUtility.addFilterExpression(n,"TransactionDate",">=",i,"and");i=t.getEditor("TransactionDateTo").option("value");DXUtility.addFilterExpression(n,"TransactionDate","<=",i,"and");i=t.getEditor("PIC").option("value");DXUtility.addFilterExpression(n,"PIC","contains",i,"and");i=t.getEditor("DocumentStatusID").option("value");DXUtility.addFilterExpression(n,"DocumentStatusID","=",i,"and");n.length>0?f.filter(n):f.refresh()};e=new Dismoyo_Ciptoning_Client.CommonGridView;e.dataGridOptions.dataSource=o;e.dataGridOptions.editing.editEnabled=!1;e.dataGridOptions.editing.removeEnabled=!1;e.dataGridOptions.selection.mode="single";e.deleteRowsOptions.visible=!1;e.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("StockChanges.AddNewStockChanges");e.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("StockChanges.EditStockChanges");e.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Site",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"DocumentCode",caption:"Document Number",width:"140px",sortOrder:"desc",headerCellTemplate:function(n,t){var r=$("#vStockChanges_commonGridView").find(".dx-datagrid:first-child"),i,u,f;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',u=Dismoyo_Ciptoning_Client.app.CurrentUser,u.IsHeadOffice()&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Status Changes<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',e.dataGridOptions.editing.allowUpdating&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",f=r.find(".dx-header-row:first-child"),$(i).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},cellTemplate:function(n,t){var u=Dismoyo_Ciptoning_Client.app.CurrentUser,f=u.isAuthorized("StockChanges.EditStockChanges"),i=$('<div class="dx-command-edit" style="text-align: left;">'),r=$("<b>").text(t.data.DocumentCode());f&&(r=$('<a class="dx-link">').text(t.data.DocumentCode()).on("dxclick",function(){k(t.data.DocumentID(),!1)}));i.append(r);i.append("&nbsp;");n.append(i)}},{dataField:"TransactionDate",caption:"Transaction Date",width:"100px",customizeText:function(n){return n.value?n.value.toLocaleDateString():null}},{dataField:"Warehouse",caption:"Warehouse",width:"200px"},{dataField:"OldItemStatusName",caption:"From",width:"80px"},{dataField:"NewItemStatusName",caption:"To",width:"80px"},{dataField:"ReferenceNumber",caption:"Reference Number",width:"120px"},{dataField:"PIC",caption:"PIC",width:"180px"},{dataField:"DocumentStatusName",caption:"Status",width:"80px"},{dataField:"PostedDate",caption:"Posted Date",width:"100px",customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleDateString():null}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}];e.dataGridOptions.editing.allowUpdating&&e.dataGridOptions.columns.push({width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){k(t.data.DocumentID(),!1)}));i.append("&nbsp;");n.append(i)}});i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.okOptions.text="Save";i.okOptions.icon="icons8-save";var ht=function(){return DXUtility.getDXInstance(null,"#vStockChanges_editDataAttachmentFile","dxFileUploader")},f=function(){return DXUtility.getDXInstance(null,"#vStockChanges_stockChangesSummaryDataGrid","dxDataGrid")},ct=function(){return DXUtility.getDXInstance(null,"#vStockChanges_stockChangesPost","dxButton")},lt=function(){return DXUtility.getDXInstance(null,"#vStockChanges_stockChangesDiscard","dxButton")},at=function(){return DXUtility.getDXInstance(null,"#vStockChanges_stockChangesSaveAsDraftAndNew","dxButton")},ui=function(){return DXUtility.getDXInstance(null,"#vStockChanges_stockChangesSummaryNewRow","dxButton")},vt=function(){return DXUtility.getDXInstance(null,"#vStockChanges_stockChangesSummaryDeleteRows","dxButton")};return i.popupEditOptions.onContentReady=function(){var u=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop("Changes Details"));var t=$('<div class="desktop-commonGridView-commands">'),e=$('<div id="vStockChanges_stockChangesSummaryNewRow">').dxButton({text:"New",icon:"add",onClick:function(){var n=i.form().validate().isValid;n?p(function(){f().addRow()}):DevExpress.ui.dialog.alert("Please specify the required fields.","New Change Details Failed")}}),o=$('<div id="vStockChanges_stockChangesSummaryDeleteRows">').dxButton({text:"Delete",icon:"remove",disabled:!0,onClick:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(n){n&&DXUtility.deleteSelectedRows(f())})}});t.append(e);t.append(o);n.append(t);n.append($('<div id="vStockChanges_stockChangesSummaryDataGrid">').dxDataGrid({deferRendering:!1,dataSource:[],showBorders:!0,paging:{enabled:!1},allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,selection:{mode:"multiple",allowSelectAll:!0},editing:{editMode:"row",allowAdding:!1,allowUpdating:!0,allowDeleting:!0},onInitNewRow:function(n){n.data.QtyChanges=0;n.data.QtyChangesConv="0/0/0"},onSelectionChanged:function(n){vt().option("disabled",!n.selectedRowsData.length)},onEditorPreparing:function(n){var t,u,r;if(n.parentType=="dataRow")if(n.dataField=="Product"){if(n.row.inserted){t="QtyOnHand";switch(i.form().getEditor("OldItemStatusID").option("value")){case 1:t+="Good";break;case 2:t+="Hold";break;case 3:t+="Bad"}u=t;n.editorElement.dxLookup({dataSource:new DevExpress.data.DataSource({store:c,filter:[u,">",0]}),displayExpr:"Product",valueExpr:"Product",searchExpr:"Product",searchPlaceholder:"Product",popupWidth:"712px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){var t=i.form().getEditor("OldItemStatusID").option("value");CommonUtility.createProductLookupHeader("vStockChanges_productIDLookup",n.element,t)},itemTemplate:function(n,t,r){var u=i.form().getEditor("OldItemStatusID").option("value");return CommonUtility.createProductLookupItem(n,r,u)},onValueChanged:function(t){var i,r;t.value&&(i=this.option("selectedItem"),i&&(n.component.cellValue(n.row.rowIndex,"QtyOnHand",i.QtyOnHand()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),r=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyChangesConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyChanges",r.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",r.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",r.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",r.qtyConvS)));n.component.cellValue(n.row.rowIndex,"Product",t.value);n.setValue(t.value)}})}else p(function(){}),n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Product()));n.cancel=!0}else n.dataField=="QtyChangesConv"&&(r="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?r=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onEnterKey:function(){f().saveEditData()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=r)},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,n.dataField.replace("QtyChangesConv","QtyChanges"),i.qtyTransaction);DXUtility.setValue(n.row.data,n.dataField.replace("QtyChangesConv","QtyConvL"),i.qtyConvL);DXUtility.setValue(n.row.data,n.dataField.replace("QtyChangesConv","QtyConvM"),i.qtyConvM);DXUtility.setValue(n.row.data,n.dataField.replace("QtyChangesConv","QtyConvS"),i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}}),n.cancel=!0)},onRowInserted:function(n){CommonUtility.validateDataGridInsertedTransactionSummary(n.component,new Dismoyo_Ciptoning_Client.vStockChangesSummaryViewModel(n.data).toJS());g(n);f().clearSelection()},onRowUpdated:function(n){n.data.ProductID=n.key.ProductID;g(n);f().clearSelection()},onRowRemoved:function(n){CommonUtility.validateDataGridRemovedTransactionSummary(n.component,n.data.toJS())},onRowUpdating:function(n){if(n.newData.QtyChangesConv){var t=CommonUtility.getConversion(n.newData.QtyChangesConv,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS"));n.newData.QtyConvL=t.qtyConvL;n.newData.QtyConvM=t.qtyConvM;n.newData.QtyConvS=t.qtyConvS;n.newData.QtyChanges=t.qtyTransaction}dt(n.oldData.ProductID(),n.newData)},onRowValidating:function(n){var i=DXUtility.getValue(n.newData,"QtyOnHand"),t;i==undefined&&(i=DXUtility.getValue(n.oldData,"QtyOnHand"));t=DXUtility.getValue(n.newData,"QtyChanges");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyChanges"));t<=0&&(n.errorText="Changes Qty must be greater than 0.",n.isValid=!1);n.isValid&&t>i&&(n.errorText="Changes Qty must be less than or equal to On Hand Qty.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},onDataErrorOccurred:function(n){var t=n.component._controllers.editing._editData[0].data.Product;switch(n.error.__id){case"E4008":n.error.message="Product '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},columns:[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"Product",caption:"Product",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$(f().element()),r,i,e;!u.find(".datagrid-bandedHeader:first").length>0&&(r=f().option("selection").mode=="none"?!1:!0,i='<tr class="dx-row dx-column-lines datagrid-bandedHeader" style="border-top-style: none !important;">',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",e=u.find(".dx-header-row:first-child"),$(i).insertBefore(e[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"150px",allowEditing:!1,dataType:"number"},{dataField:"QtyChangesConv",caption:"Status Changes Qty (L/M/S)",width:"180px",alignment:"right",validationRules:[{type:"required"},ft],cellTemplate:function(n,t){n.append(ni(t.data,"QtyChangesConv",i.form().getEditor("OldItemStatusID").option("value")))}}]}));var r=$("#commonPopupEdit_extCommands"),s=$('<div id="vStockChanges_stockChangesPost">').dxButton({text:"Post",icon:"icons8-check-green",onClick:function(){i.events.performPost(this)}}),h=$('<div id="vStockChanges_stockChangesDiscard" style="margin-right: 16px;">').dxButton({text:"Discard",icon:"icons8-trash-red",onClick:function(){i.events.performDiscard(this)}}),l=$('<div id="vStockChanges_stockChangesSaveAsDraftAndNew">').dxButton({text:"Save & New",icon:"icons8-save",onClick:function(){i.events.performSaveAsDraftAndNew(this)}});u.append(DXUtility.createFormItemGroupWithCaption("").append(n));r.append(s);r.append(h);r.append(l)},e.events.performNewRow=function(){d(null)},i.events.performOK=function(){y(null,3)},i.events.performPost=function(){DevExpress.ui.dialog.confirm("Are you sure want to Post this transaction?","Post Confirmation").done(function(n){n&&y(2,3)})},i.events.performDiscard=function(){DevExpress.ui.dialog.confirm("Are you sure want to Discard this transaction?","Discard Confirmation").done(function(n){n&&y(3,3)})},i.events.performSaveAsDraftAndNew=function(){y(1,2)},i.formOptions.customizeItem=function(n){n.dataField=="AttachmentFile"&&(n.template=function(n,t){t.append(CommonUtility.createEditDataAttachmentFileUploader("vStockChanges","StockChanges"))})},i.events.performCancel=function(){i.popupEditOptions.visible(!1);a&&(e.dataGrid().refresh(),a=!1)},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form(),r;CommonUtility.cascadeValueChanged(t,n.selectedItem,n.value,"Site",["Area","Region","Territory"],[]);r="";n.selectedItem?(r=et(n.selectedItem.Code()),t.getEditor("Company").option("value",n.selectedItem.Company())):n.previousValue!=null&&t.getEditor("Company").option("value",null);ot(t,n.value);t.getEditor("DocumentCode").option("value",r)}}}]},{itemType:"group",caption:"Stock Changes",colCount:6,colSpan:3,items:[{dataField:"DocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"TransactionDate",label:{text:"Transaction Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},colSpan:1,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"NEW",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"WarehouseID",label:{text:"Warehouse"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){if(h=[],c=[],n.value){var t=i.popupEditData(),r=f();r.cancelEditData();t.ChildSummaries([]);r.option("dataSource",b(t.ChildSummaries()))}}}},{dataField:"PIC",label:{text:"PIC"},validationRules:[{type:"required"}],colSpan:2,editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty"},{dataField:"OldItemStatusID",label:{text:"Status Changes From"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource([["Group","=","ProductItemStatus"],"and",["Value_Int32","<>",4],]),displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var r=DataUtility.GetLookupSystemLookupDataSource([["Group","=","ProductItemStatus"],"and",["Value_Int32","<>",4],"and",["Value_Int32","<>",n.value?n.value:4]]),t=i.form().getEditor("NewItemStatusID");t.option("value",null);t.option("dataSource",r);this.stockChangesSummaryDataGrid().option("dataSource",b([]));this.stockChangesSummaryDataGrid().repaint()}}},{dataField:"NewItemStatusID",label:{text:"To"},validationRules:[{type:"required"}],colSpan:1,editorType:"dxSelectBox",editorOptions:{dataSource:function(){var n=i.form().getEditor("NewItemStatusID");return DataUtility.GetLookupSystemLookupDataSource([["Group","=","ProductItemStatus"],"and",["Value_Int32","<>",4],"and",["Value_Int32","<>",n?n:4]])},displayExpr:"Name",valueExpr:"Value_Int32",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:3},{dataField:"ReferenceNumber",label:{text:"Reference Number"},colSpan:3,editorOptions:{maxLength:30,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AttachmentFile",label:{text:"Attachment File"},colSpan:2,editorOptions:{onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1}]}],r=new Dismoyo_Ciptoning_Client.ProductLotPopupEdit,r.formOptions.colCount=4,r.saveOptions.icon="icons8-save",r.events.performSave=function(){ri()},r.dataGridOptions.onInitNewRow=function(n){n.data.QtyChanges=0;n.data.QtyChangesConv="0/0/0"},r.dataGridOptions.onEditorPreparing=function(n){var i,u,t;n.parentType=="dataRow"&&(n.dataField=="ProductLotCode"?(i=r.popupEditOptions.itemStatusID,u=l(i),n.row.inserted?n.editorElement.dxLookup({dataSource:new DevExpress.data.DataSource({store:h,filter:[["ProductID","=",r.popupEditData().ProductID()],"and",[u.qtyOnHandColumn,">",0]],sort:[{getter:"ProductLotExpiredDate",desc:!0}]}),displayExpr:"ProductLotCode",valueExpr:"ProductLotCode",searchExpr:"ProductLotCode",searchPlaceholder:"Lot Number",popupWidth:"582px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){var t=r.popupEditOptions.itemStatusID;CommonUtility.createProductLotLookupHeader("vStockChanges_productLotIDLookup",n.element,t)},itemTemplate:function(n,t,i){var u=r.popupEditOptions.itemStatusID,f=l(u);return CommonUtility.createProductLotLookupItem(n,i,f.qtyOnHandColumn)},onValueChanged:function(t){var i,e,f,u;t.value&&(i=this.option("selectedItem"),i&&(e=r.popupEditOptions.itemStatusID,f=l(e),n.component.cellValue(n.row.rowIndex,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductLotID",i.ProductLotID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductLotCode",i.ProductLotCode()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),u=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyChangesConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyChanges",u.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",u.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",u.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",u.qtyConvS)));n.component.cellValue(n.row.rowIndex,"ProductLotCode",t.value);n.setValue(t.value)}}):(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.ProductLotCode()))),n.cancel=!0):n.dataField=="QtyChangesConv"&&(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyChanges",i.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvL",i.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvM",i.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvS",i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}}),n.cancel=!0))},r.dataGridOptions.onRowInserted=function(n){CommonUtility.validateDataGridInsertedTransactionDetails(n.component,new Dismoyo_Ciptoning_Client.vStockChangesDetailsViewModel(n.data).toJS())},r.dataGridOptions.onRowRemoved=function(n){CommonUtility.validateDataGridRemovedTransactionDetails(n.component,n.data.toJS())},r.dataGridOptions.onRowUpdating=function(n){CommonUtility.validateDataGridUpdatingTransactionDetails(n,"QtyConvL","QtyConvM","QtyConvS","QtyChangesConv","QtyChanges")},r.dataGridOptions.onRowValidating=function(n){var u=r.popupEditOptions.itemStatusID,f=l(u),i=DXUtility.getValue(n.newData,"QtyOnHand"),t;i==undefined&&(i=DXUtility.getValue(n.oldData,"QtyOnHand"));t=DXUtility.getValue(n.newData,"QtyChanges");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyChanges"));t<=0&&(n.errorText="Changes Qty must be greater than 0.",n.isValid=!1);n.isValid&&t>i&&(n.errorText="Changes Qty  must be less than or equal to On Hand Qty.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.onDataErrorOccurred=function(n){var t=n.component._controllers.editing._editData[0].data.ProductLotCode;switch(n.error.__id){case"E4008":n.error.message="Lot Number '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.summary={totalItems:[{name:"TotalQtyPcs",showInColumn:"QtyChangesConv",displayFormat:"Total Qty (Pcs): {0}",valueFormat:"decimal",summaryType:"custom"},{name:"TotalQtyLMS",showInColumn:"QtyChangesConv",displayFormat:"(L/M/S): {0}",valueFormat:"string",summaryType:"custom"}],calculateCustomSummary:function(n){CommonUtility.updateProductLotEditingSummary(n,"QtyChangesConv","QtyChanges")}},r.dataGridOptions.columns=[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"ProductLotID",visible:!1},{dataField:"ProductLotCode",caption:"Lot Number",validationRules:[{type:"required"}]},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"120px",allowEditing:!1,dataType:"number"},{dataField:"QtyChangesConv",caption:"Changes Qty (L/M/S)",width:"150px",alignment:"right",validationRules:[{type:"required"},ft]}],r.formOptions.items=[{itemType:"group",caption:"Product",colCount:4,colSpan:4,items:[{dataField:"Product",label:{text:"Product"},colSpan:4,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOnHand",label:{text:"On Hand Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2},{dataField:"QtyChanges",label:{text:"Changes Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyChangesConv",label:{text:"(L/M/S)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],{isReady:nt.promise(),dataSource:o,refreshList:ut,viewShowing:pt,viewDisposing:wt,openCreateViewAsRoot:yt,icon:"Images/stock_changes_32px.png",dataSource_vStockChangesDetails:bt,dataSource_vStockChangesSummary:kt,dataSource_vStockOnHandAvailable:h,dataSource_vStockOnHandAvailableByProduct:c,collapsibleFilter:u,commonGridView:e,commonPopupEdit:i,productLotPopupEdit:r,stockChangesSummaryDataGrid:f,stockChangesPost:ct,stockChangesDiscard:lt,stockChangesSaveAsDraftAndNew:at,isLotNumberEntryRequired:s}};Dismoyo_Ciptoning_Client.vStockDisposals=function(n,t){"use strict";function tt(){w=!0}function it(){v=CommonUtility.configureCommonGridViewLayout("vStockDisposals");v||setTimeout(it,50)}function pt(){var n,t;it();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],o.filter(t));nt()?w&&rt():(nt(o),o.load().always(function(){g.resolve()}))}function wt(){Dismoyo_Ciptoning_Client.DB.vStockDisposals.off("modified",tt)}function rt(){w=!1;o.pageIndex(0);o.load()}function ft(n){return(n?n:"(Site Code)")+"-YY-09-(Auto Generated)"}function et(n,t){t?Dismoyo_Ciptoning_Client.DB.vSites.byKey(t).done(function(n){h=n.IsLotNumberEntryRequired}):(t=null,h=undefined);var i=DataUtility.GetLookupWarehouseDataSource([["SiteID","=",t],"and",["TypeID","=",1]]);n.getEditor("WarehouseID").option("value",null);n.getEditor("WarehouseID").option("dataSource",[]);i.load().done(function(){n.getEditor("WarehouseID").option("dataSource",i)})}function ot(n){CommonUtility.updateSummariesArrayStore(f().option("dataSource").store(),n)}function dt(n,t){CommonUtility.updateDeferSummariesArrayStore(f().option("dataSource").store(),n,t)}function gt(n){return CommonUtility.validateSummaryArrayStore(f().option("dataSource").store(),"vStockDisposalSummaryViewModel",n)}function st(n){return CommonUtility.createArrayDataSource("vStockDisposalSummaryViewModel",["ProductID"],n)}function ni(n,t,i){var r=$('<div class="dx-command-edit" style="text-align: right; padding-right: 5px;">'),o;if(r.append($('<a style="color: inherit;">').text(n[t]())),r.append("&nbsp;"),h){var u=t.replace("Conv",""),s=n[u](),f=n.ChildDetails(),e=0;for(o in f)e+=f[o][u]();r.append($('<a class="dx-link dxcustom-linkbutton dx-icon-icons8-view-details" title="Edit Lot Number">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<\/a><span id="LotMark_'+n.ProductID()+"_"+t+'" class="dx-icon-overflow '+(e==s?"hidden":"")+'" style="color:red; font-size: 14px; margin-left: -6px;"><\/span>').on("dxclick",function(){p(function(){ii(n,i)})}));r.append("&nbsp;")}return r}function ti(n){var t=f().option("editing"),i=f().option("selection");i.mode=n?"multiple":"none";t.allowUpdating=n;t.allowDeleting=n;f().option("editing",t);f().option("selection",i);ui().option("disabled",!n);vt().option("disabled",!0);f().repaint()}function b(n,t){showLoadingPanel();Dismoyo_Ciptoning_Client.DB.vStockDisposals.byKey(n,{expand:["ChildSummaries/ChildDetails"]}).done(function(n){hideLoadingPanel();a=t;k(new Dismoyo_Ciptoning_Client.vStockDisposalViewModel(n))}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function k(n){var e=!1,u,t,o,a,c,v,y,l,w,b,nt,k;n||(n=new Dismoyo_Ciptoning_Client.vStockDisposalViewModel,e=!0);i.popupEditData(n);i.popupEdit().option("title",(e?"New":"Edit")+" Stock Disposal");i.popupEditOptions.editingKey=n.DocumentID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);u=Dismoyo_Ciptoning_Client.app.CurrentUser;t=i.form();DXUtility.resetFormValidation(t);var g=n.DocumentCode(),r=!1,s=[];if(h=n.IsSiteLotNumberEntryRequired(),e)n.DocumentID(new DevExpress.data.Guid),n.DocumentStatusID(null),n.TerritoryID(u.TerritoryID()),n.RegionID(u.RegionID()),n.AreaID(u.AreaID()),n.SiteID(u.SiteID()),n.SiteCode(u.SiteCode()),n.CompanyID(u.CompanyID()),n.Company(u.Company()),g=ft(n.SiteCode());else if(s=n.ChildSummaries(),n.DocumentStatusID()!=1||h)(n.DocumentStatusID()==2||n.DocumentStatusID()==3)&&(r=!0);else{for(o=[],a=0,c=0;c<s.length;c++){for(v=s[c].ChildDetails(),y=0,l=0;l<v.length;l++)v[l].ProductLotCode().indexOf("DUMMY")<0&&y++;y>0&&(o[a]=s[c],a++)}o.length>0&&p(function(){for(var t,n=0;n<o.length;n++)t={data:o[n].toJS()},d(t,o)})}ti(!r);ct().option("disabled",e||r);lt().option("disabled",e||r);at().option("disabled",r);i.ok().option("disabled",r);t.itemOption("Organization").visible&&(t.getEditor("TerritoryID").option("value",n.TerritoryID()),t.getEditor("RegionID").option("value",n.RegionID()),t.getEditor("AreaID").option("value",n.AreaID()),t.getEditor("SiteID").option("value",n.SiteID()),t.getEditor("Company").option("value",n.Company()),t.getEditor("TerritoryID").option("readOnly",r),t.getEditor("RegionID").option("readOnly",r),t.getEditor("AreaID").option("readOnly",r),t.getEditor("SiteID").option("readOnly",r));et(t,n.SiteID());t.getEditor("DocumentCode").option("value",g);t.getEditor("TransactionDate").option("value",n.TransactionDate());t.getEditor("WarehouseID").option("value",n.WarehouseID());t.getEditor("PIC").option("value",n.PIC());t.getEditor("ReferenceNumber").option("value",n.ReferenceNumber());w=ht();CommonUtility.createEditDataAttachmentFileDownloader("vStockDisposals",w,"StockDisposals",n.AttachmentFile());w.option("value",null);t.getEditor("DocumentStatusID").option("value",n.DocumentStatusID());t.getEditor("TransactionDate").option("readOnly",r);t.getEditor("WarehouseID").option("readOnly",r);t.getEditor("PIC").option("readOnly",r);t.getEditor("ReferenceNumber").option("readOnly",r);b=$(".dx-fileuploader-input-wrapper");r?b.hide():b.show();nt=new Date;e&&(DXUtility.resetFormValidation(t),t.getEditor("TransactionDate").option("value",nt));k=f();k.cancelEditData();n.ChildSummaries(s);k.option("dataSource",st(n.ChildSummaries()))}function d(n,t){var l,u,a,o,r,v,c;if(!h){var p=i.popupEditData(),y=f(),e=[];if(t){for(r=0;r<t.length;r++)t[r].ChildDetails([]);e=t}else for(l=y.option("dataSource").store(),r=0;r<l._array.length;r++)e.push(new Dismoyo_Ciptoning_Client.vStockDisposalSummaryViewModel(l._array[r]));if(u=n.data,a=$.grep(s,function(n){return n.ProductID()==DXUtility.getValue(u,"ProductID")&&n.ProductLotCode().indexOf("DUMMY")>=0}),a.length>0)for(o=a[0],DXUtility.setValue(u,"ProductLotID",o.ProductLotID()),DXUtility.setValue(u,"ProductLotCode",o.ProductLotCode()),DXUtility.setValue(u,"QtyOnHandGood",o.QtyOnHandGood()),DXUtility.setValue(u,"QtyOnHandHold",o.QtyOnHandHold()),DXUtility.setValue(u,"QtyOnHandBad",o.QtyOnHandBad()),r=0;r<e.length;r++)e[r].ProductID()==DXUtility.getValue(u,"ProductID")&&(v=$.grep(e[r].ChildDetails(),function(n){return n.ProductLotID()==DXUtility.getValue(u,"ProductLotID")}),v.length>0?(c=v[0],c.QtyConvL(DXUtility.getValue(u,"QtyConvL")),c.QtyConvM(DXUtility.getValue(u,"QtyConvM")),c.QtyConvS(DXUtility.getValue(u,"QtyConvS")),c.QtyDisposal(DXUtility.getValue(u,"QtyDisposal")),c.QtyDisposalConv(DXUtility.getValue(u,"QtyDisposalConv"))):e[r].ChildDetails().push(new Dismoyo_Ciptoning_Client.vStockDisposalDetailsViewModel(u)),ot(e[r]));else DevExpress.ui.dialog.alert("DUMMY Lot Number for the selected product is not available.","Save Failed")}}function y(n,t){var w,nt,s,d,o,r,u,l,y;showLoadingPanel();var v=i.form(),h=v.validate().isValid,c=h?"":"Please specify the required fields.",tt=e.dataGrid(),it=tt.option("dataSource"),g=f().option("dataSource"),p=[];for(r=0;r<g.store()._array.length;r++)p.push(new Dismoyo_Ciptoning_Client.vStockDisposalSummaryViewModel(g.store()._array[r]));if(h&&p.length<=0&&(c="Please specify at least one item in Disposal Details.",h=!1),h)for(r=0;r<p.length;r++){for(u=p[r],w=0,l=0;l<u.ChildDetails().length;l++)y=u.ChildDetails()[l],w+=y.QtyDisposal();u.QtyDisposal()!=w&&(c==""?c="Following products quantity of Disposal Details items is not matched: ":c+=", ",c+=u.Product(),h=!1)}if(h&&$(".dx-fileuploader-button.dx-fileuploader-upload-button.dx-widget.dx-button-has-icon.dx-button.dx-button-normal").length>0&&(c="You have selected an attachment file. Please upload or cancel the attachment file.",h=!1),nt=Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID(),v.itemOption("Organization").visible&&(nt=v.getEditor("SiteID").option("value")),h){for(s=i.popupEditData(),s.TransactionDate(v.getEditor("TransactionDate").option("value")),s.WarehouseID(v.getEditor("WarehouseID").option("value")),s.PIC(v.getEditor("PIC").option("value")),s.ReferenceNumber(v.getEditor("ReferenceNumber").option("value")),d=ht(),s.AttachmentFile(d.option("values").length>0?d.fileName:null),s.ChildSummaries(p),o=ko.toJS(s),n&&(o.DocumentStatusID=n),o.DocumentStatusID||(o.DocumentStatusID=1),o.TransactionDate=DateTimeUtility.getFirstTimeOfDay(o.TransactionDate),r=0;r<o.ChildSummaries.length;r++){for(u=o.ChildSummaries[r],u.DocumentID=o.DocumentID,l=0;l<u.ChildDetails.length;l++)y=u.ChildDetails[l],y.DocumentID=o.DocumentID,y.Qty=y.QtyDisposal*-1;u.Qty=u.QtyDisposal*-1}it.store().insert(o).done(function(n){CommonUtility.documentSuccessMessage(n.DocumentStatusID,function(){});a=!0;switch(t){case 1:i.events.performCancel();hideLoadingPanel();break;case 2:k(null);hideLoadingPanel();break;case 3:b(s.DocumentID(),!0)}}).fail(function(n){DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})}else hideLoadingPanel();c!=""&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(c),"Save Failed")}function l(n){var t=null;switch(n){case 1:t="Good";break;case 2:t="Hold";break;case 3:t="Bad"}var i="QtyOnHand"+t,r="QtyConvL"+t,u="QtyConvM"+t,f="QtyConvS"+t,e="QtyDisposal"+t,o="QtyDisposalConv"+t;return{itemStatusName:t,qtyOnHandColumn:i,qtyConvLColumn:r,qtyConvMColumn:u,qtyConvSColumn:f,qtyDisposalColumn:e,qtyDisposalConvColumn:o}}function ii(n,t){var o=i.popupEditData(),f,h,c;r.popupEditData(n);r.popupEditOptions.editingKey=n.ProductID();r.popupEditOptions.itemStatusID=t;r.popupEditOptions.visible(!0);var s=r.dataGrid(),e=r.form(),u=!1;(o.DocumentStatusID()==2||o.DocumentStatusID()==3)&&(u=!0);f=r.dataGrid().option("editing");f.allowUpdating=!u;f.allowDeleting=!u;f.editEnabled=!u;f.removeEnabled=!u;r.dataGrid().option("editing",f);r.dataGrid().option("selection",{mode:u?"none":"multiple"});r.newRow().option("disabled",u);r.dataGrid().repaint();e.getEditor("Product").option("value",n.Product());e.getEditor("QtyOnHand").option("value",n.QtyOnHand());e.getEditor("QtyDisposalConv").option("value",n.QtyDisposalConv());h=CommonUtility.getConversion(n.QtyDisposalConv(),DXUtility.getValue(n,"ProductConversionL"),DXUtility.getValue(n,"ProductConversionM"),DXUtility.getValue(n,"ProductConversionS"));e.getEditor("QtyDisposal").option("value",h.qtyTransaction);n=gt(n);c=CommonUtility.createArrayDataSource("vStockDisposalDetailsViewModel",["ProductID","ProductLotID"],n.ChildDetails());s.cancelEditData();s.option("dataSource",c)}function ri(){var n=r.popupEditData(),t=r.popupEditOptions.itemStatusID,i=l(t);CommonUtility.validateProductLotEditing(n,r.dataGrid().option("dataSource"),r.form().getEditor("QtyDisposal").option("value"),"Disposal","vStockDisposalDetailsViewModel","QtyConvL","QtyConvM","QtyConvS","QtyDisposalConv","QtyDisposal",!1)&&(ot(n),r.popupEditOptions.visible(!1),f().refresh())}function p(n){if(s.length==0&&c.length==0){showLoadingPanel();var t=i.form();new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vProducts,select:["ID","Code","Product","UOMLID","UOMMID","UOMSID","ConversionL","ConversionM","ConversionS"],sort:["ID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vProductViewModel(n)}}).load().done(function(i){var f=i,r=t.getEditor("WarehouseID").option("value"),u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOnHandAvailables,select:["ProductID","ProductLotID","ProductLotCode","ProductLot","ProductLotExpiredDate","QtyOnHandBad"],filter:[["WarehouseID","=",r],"and",["QtyOnHandBad",">",0]],sort:["WarehouseID","ProductID","ProductLotID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(n)}});u.load().done(function(t){for(var e,h,u=null,o=[],r=[],f=0;f<t.length;f++)o.push(new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(t[f].toJS())),e=r.length-1,h=t[f].ProductID(),f==0||r[e].ProductID()!=h?(r.push(new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(t[f].toJS())),e++,u=$.grep(i,function(n){return n.ID()==h})):(r[e].QtyOnHandGood(r[e].QtyOnHandGood()+t[f].QtyOnHandGood()),r[e].QtyOnHandHold(r[e].QtyOnHandHold()+t[f].QtyOnHandHold()),r[e].QtyOnHandBad(r[e].QtyOnHandBad()+t[f].QtyOnHandBad())),o[f].ProductCode(u[0].Code()),o[f].Product(u[0].Product()),o[f].ProductUOMLID(u[0].UOMLID()),o[f].ProductUOMMID(u[0].UOMMID()),o[f].ProductUOMSID(u[0].UOMSID()),o[f].ProductConversionL(u[0].ConversionL()),o[f].ProductConversionM(u[0].ConversionM()),o[f].ProductConversionS(u[0].ConversionS()),r[e].ProductCode(u[0].Code()),r[e].Product(u[0].Product()),r[e].ProductUOMLID(u[0].UOMLID()),r[e].ProductUOMMID(u[0].UOMMID()),r[e].ProductUOMSID(u[0].UOMSID()),r[e].ProductConversionL(u[0].ConversionL()),r[e].ProductConversionM(u[0].ConversionM()),r[e].ProductConversionS(u[0].ConversionS());s=o;c=r;s.length==0?DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Product lot stock with item status Bad for the selected warehouse is empty."),"New Disposal Details Failed"):n();hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product lot data."),"Download Product Lot Failed");hideLoadingPanel()})}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product data."),"Download Product Failed");hideLoadingPanel()})}else n()}var w=!1,yt=t.layoutController.name==="split",g=$.Deferred(),nt=ko.observable(),o,a,h,v,u,e,i,r;o=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockDisposals,map:function(n){return new Dismoyo_Ciptoning_Client.vStockDisposalViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vStockDisposals.on("modified",tt);var bt=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockDisposalDetails,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockDisposalDetailsViewModel(n)}}),kt=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockDisposalSummaries,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockDisposalSummaryViewModel(n)}}),s,c,ut={type:"pattern",pattern:"(^[0-9]*$)|(^[0-9]*/[0-9]*$)|(^[0-9]*/[0-9]*/[0-9]*$)",message:"Format must be L/M/S or M/S or S."};u=new Dismoyo_Ciptoning_Client.CollapsibleFilter;u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){v&&v.resizeAll()})};u.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Warehouse"])}}}]},{itemType:"group",caption:"Stock Disposal",colCount:3,colSpan:3,items:[{dataField:"WarehouseID",label:{text:"Warehouse"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{name:"DocumentCode",dataField:"",label:{text:"Document Number"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateFrom",label:{text:"Transaction Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateTo",label:{text:"Transaction Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"PIC",label:{text:"PIC"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}}]}];u.events.performSearch=function(){var f=e.dataGrid(),t=u.form(),n=[],i;f.clearFilter();var r=Dismoyo_Ciptoning_Client.app.CurrentUser,o=r.TerritoryID(),s=r.RegionID(),h=r.AreaID(),c=r.CompanyID(),l=r.SiteID();t.itemOption("Organization").visible&&(o=t.getEditor("TerritoryID").option("value"),s=t.getEditor("RegionID").option("value"),h=t.getEditor("AreaID").option("value"),c=t.getEditor("CompanyID").option("value"),l=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",o,"and");DXUtility.addFilterExpression(n,"RegionID","=",s,"and");DXUtility.addFilterExpression(n,"AreaID","=",h,"and");DXUtility.addFilterExpression(n,"CompanyID","=",c,"and");DXUtility.addFilterExpression(n,"SiteID","=",l,"and");i=t.getEditor("WarehouseID").option("value");DXUtility.addFilterExpression(n,"WarehouseID","=",i,"and");i=t.getEditor("DocumentCode").option("value");DXUtility.addFilterExpression(n,"DocumentCode","contains",i,"and");i=t.getEditor("TransactionDateFrom").option("value");DXUtility.addFilterExpression(n,"TransactionDate",">=",i,"and");i=t.getEditor("TransactionDateTo").option("value");DXUtility.addFilterExpression(n,"TransactionDate","<=",i,"and");i=t.getEditor("PIC").option("value");DXUtility.addFilterExpression(n,"PIC","contains",i,"and");i=t.getEditor("DocumentStatusID").option("value");DXUtility.addFilterExpression(n,"DocumentStatusID","=",i,"and");n.length>0?f.filter(n):f.refresh()};e=new Dismoyo_Ciptoning_Client.CommonGridView;e.dataGridOptions.dataSource=o;e.dataGridOptions.editing.editEnabled=!1;e.dataGridOptions.editing.removeEnabled=!1;e.dataGridOptions.selection.mode="single";e.deleteRowsOptions.visible=!1;e.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("StockDisposals.AddNewStockDisposal");e.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("StockDisposals.EditStockDisposal");e.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Site",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"DocumentCode",caption:"Document Number",width:"140px",sortOrder:"desc",headerCellTemplate:function(n,t){var r=$("#vStockDisposals_commonGridView").find(".dx-datagrid:first-child"),i,u,f;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',u=Dismoyo_Ciptoning_Client.app.CurrentUser,u.IsHeadOffice()&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',e.dataGridOptions.editing.allowUpdating&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",f=r.find(".dx-header-row:first-child"),$(i).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},cellTemplate:function(n,t){var u=Dismoyo_Ciptoning_Client.app.CurrentUser,f=u.isAuthorized("StockDisposals.EditStockDisposal"),i=$('<div class="dx-command-edit" style="text-align: left;">'),r=$("<b>").text(t.data.DocumentCode());f&&(r=$('<a class="dx-link">').text(t.data.DocumentCode()).on("dxclick",function(){b(t.data.DocumentID(),!1)}));i.append(r);i.append("&nbsp;");n.append(i)}},{dataField:"TransactionDate",caption:"Transaction Date",width:"100px",customizeText:function(n){return n.value?n.value.toLocaleDateString():null}},{dataField:"Warehouse",caption:"Warehouse",width:"200px"},{dataField:"ReferenceNumber",caption:"Reference Number",width:"120px"},{dataField:"PIC",caption:"PIC",width:"180px"},{dataField:"DocumentStatusName",caption:"Status",width:"80px"},{dataField:"PostedDate",caption:"Posted Date",width:"100px",customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleDateString():null}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}];e.dataGridOptions.editing.allowUpdating&&e.dataGridOptions.columns.push({width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){b(t.data.DocumentID(),!1)}));i.append("&nbsp;");n.append(i)}});i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.okOptions.text="Save";i.okOptions.icon="icons8-save";var ht=function(){return DXUtility.getDXInstance(null,"#vStockDisposals_editDataAttachmentFile","dxFileUploader")},f=function(){return DXUtility.getDXInstance(null,"#vStockDisposals_stockDisposalSummaryDataGrid","dxDataGrid")},ct=function(){return DXUtility.getDXInstance(null,"#vStockDisposals_stockDisposalPost","dxButton")},lt=function(){return DXUtility.getDXInstance(null,"#vStockDisposals_stockDisposalDiscard","dxButton")},at=function(){return DXUtility.getDXInstance(null,"#vStockDisposals_stockDisposalSaveAsDraftAndNew","dxButton")},ui=function(){return DXUtility.getDXInstance(null,"#vStockDisposals_stockDisposalSummaryNewRow","dxButton")},vt=function(){return DXUtility.getDXInstance(null,"#vStockDisposals_stockDisposalSummaryDeleteRows","dxButton")};return i.popupEditOptions.onContentReady=function(){var u=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop("Disposal Details"));var t=$('<div class="desktop-commonGridView-commands">'),e=$('<div id="vStockDisposals_stockDisposalSummaryNewRow">').dxButton({text:"New",icon:"add",onClick:function(){var n=i.form().validate().isValid;n?p(function(){f().addRow()}):DevExpress.ui.dialog.alert("Please specify the required fields.","New Disposal Details Failed")}}),o=$('<div id="vStockDisposals_stockDisposalSummaryDeleteRows">').dxButton({text:"Delete",icon:"remove",disabled:!0,onClick:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(n){n&&DXUtility.deleteSelectedRows(f())})}});t.append(e);t.append(o);n.append(t);n.append($('<div id="vStockDisposals_stockDisposalSummaryDataGrid">').dxDataGrid({deferRendering:!1,dataSource:[],showBorders:!0,paging:{enabled:!1},allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,selection:{mode:"multiple",allowSelectAll:!0},editing:{editMode:"row",allowAdding:!1,allowUpdating:!0,allowDeleting:!0},onInitNewRow:function(n){n.data.QtyDisposal=0;n.data.QtyDisposalConv="0/0/0"},onSelectionChanged:function(n){vt().option("disabled",!n.selectedRowsData.length)},onEditorPreparing:function(n){if(n.parentType=="dataRow")if(n.dataField=="Product")n.row.inserted?n.editorElement.dxLookup({dataSource:c,displayExpr:"Product",valueExpr:"Product",searchExpr:"Product",searchPlaceholder:"Product",popupWidth:"712px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){CommonUtility.createProductLookupHeader("vStockDisposals_productIDLookup",n.element,3)},itemTemplate:function(n,t,i){return CommonUtility.createProductLookupItem(n,i,3)},onValueChanged:function(t){var i,r;t.value&&(i=this.option("selectedItem"),i&&(n.component.cellValue(n.row.rowIndex,"QtyOnHand",i.QtyOnHand()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),r=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyDisposalConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyDisposal",r.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",r.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",r.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",r.qtyConvS)));n.component.cellValue(n.row.rowIndex,"Product",t.value);n.setValue(t.value)}}):(p(function(){}),n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Product()))),n.cancel=!0;else if(n.dataField=="QtyDisposalConv"){var t="";n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onEnterKey:function(){f().saveEditData()},onValueChanged:function(t){var r,u,i,f,e;if(DXUtility.getValue(n.row.data,"Product")==undefined&&(t.value=""),t.value.indexOf("/")>-1){for(r=0,u=t.value.split("/"),i=0;i<u.length;i++){if(u[i]=="")break;f=parseInt(u[i]);i==0?r+=f*DXUtility.getValue(n.row.data,"ProductConversionL"):i==1?u.length==2&&DXUtility.getValue(n.row.data,"Product").indexOf("Single")>-1?r+=f:DXUtility.getValue(n.row.data,"ProductConversionM")!=null&&(r+=f*DXUtility.getValue(n.row.data,"ProductConversionM")):i==2&&(r+=f)}t.value=r+"";DXUtility.setValue(n.row.data,n.dataField.replace("QtyDisposalConv","QtyDisposal"),r)}e=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,n.dataField.replace("QtyDisposalConv","QtyConvL"),e.qtyConvL);DXUtility.setValue(n.row.data,n.dataField.replace("QtyDisposalConv","QtyConvM"),e.qtyConvM);DXUtility.setValue(n.row.data,n.dataField.replace("QtyDisposalConv","QtyConvS"),e.qtyConvS);t.value=e.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}});n.cancel=!0}},onRowInserted:function(n){CommonUtility.validateDataGridInsertedTransactionSummary(n.component,new Dismoyo_Ciptoning_Client.vStockDisposalSummaryViewModel(n.data).toJS());d(n);f().clearSelection()},onRowUpdated:function(n){n.data.ProductID=n.key.ProductID;d(n);f().clearSelection()},onRowRemoved:function(n){CommonUtility.validateDataGridRemovedTransactionSummary(n.component,n.data.toJS())},onRowUpdating:function(n){if(n.newData.QtyDisposalConv){var t=CommonUtility.getConversion(n.newData.QtyDisposalConv,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS"));n.newData.QtyConvL=t.qtyConvL;n.newData.QtyConvM=t.qtyConvM;n.newData.QtyConvS=t.qtyConvS;n.newData.QtyDisposal=t.qtyTransaction}dt(n.oldData.ProductID(),n.newData)},onRowValidating:function(n){var i=DXUtility.getValue(n.newData,"QtyOnHand"),t;i==undefined&&(i=DXUtility.getValue(n.oldData,"QtyOnHand"));t=DXUtility.getValue(n.newData,"QtyDisposal");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyDisposal"));t<=0&&(n.errorText="Disposal Qty must be greater than 0.",n.isValid=!1);n.isValid&&t>i&&(n.errorText="Disposal Qty must be less than or equal to On Hand Qty.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},onDataErrorOccurred:function(n){var t=n.component._controllers.editing._editData[0].data.Product;switch(n.error.__id){case"E4008":n.error.message="Product '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},columns:[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"Product",caption:"Product",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$(f().element()),r,i,e;!u.find(".datagrid-bandedHeader:first").length>0&&(r=f().option("selection").mode=="none"?!1:!0,i='<tr class="dx-row dx-column-lines datagrid-bandedHeader" style="border-top-style: none !important;">',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",e=u.find(".dx-header-row:first-child"),$(i).insertBefore(e[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"150px",allowEditing:!1,dataType:"number"},{dataField:"QtyDisposalConv",caption:"Disposal Qty (L/M/S)",width:"180px",alignment:"right",validationRules:[{type:"required"},ut],cellTemplate:function(n,t){n.append(ni(t.data,"QtyDisposalConv",3))}}]}));var r=$("#commonPopupEdit_extCommands"),s=$('<div id="vStockDisposals_stockDisposalPost">').dxButton({text:"Post",icon:"icons8-check-green",onClick:function(){i.events.performPost(this)}}),h=$('<div id="vStockDisposals_stockDisposalDiscard" style="margin-right: 16px;">').dxButton({text:"Discard",icon:"icons8-trash-red",onClick:function(){i.events.performDiscard(this)}}),l=$('<div id="vStockDisposals_stockDisposalSaveAsDraftAndNew">').dxButton({text:"Save & New",icon:"icons8-save",onClick:function(){i.events.performSaveAsDraftAndNew(this)}});u.append(DXUtility.createFormItemGroupWithCaption("").append(n));r.append(s);r.append(h);r.append(l)},e.events.performNewRow=function(){k(null)},i.events.performOK=function(){y(null,3)},i.events.performPost=function(){DevExpress.ui.dialog.confirm("Are you sure want to Post this transaction?","Post Confirmation").done(function(n){n&&y(2,3)})},i.events.performDiscard=function(){DevExpress.ui.dialog.confirm("Are you sure want to Discard this transaction?","Discard Confirmation").done(function(n){n&&y(3,3)})},i.events.performSaveAsDraftAndNew=function(){y(1,2)},i.formOptions.customizeItem=function(n){n.dataField=="AttachmentFile"&&(n.template=function(n,t){t.append(CommonUtility.createEditDataAttachmentFileUploader("vStockDisposals","StockDisposals"))})},i.events.performCancel=function(){i.popupEditOptions.visible(!1);a&&(e.dataGrid().refresh(),a=!1)},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form(),r,u;CommonUtility.cascadeValueChanged(t,n.selectedItem,n.value,"Site",["Area","Region","Territory"],[]);r="";u=null;n.selectedItem&&(r=ft(n.selectedItem.Code()),u=n.selectedItem.Company());t.getEditor("Company").option("value",u);et(t,n.value);t.getEditor("DocumentCode").option("value",r)}}}]},{itemType:"group",caption:"Stock Disposal",colCount:6,colSpan:3,items:[{dataField:"DocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"TransactionDate",label:{text:"Transaction Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},colSpan:1,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"NEW",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"WarehouseID",label:{text:"Warehouse"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){if(s=[],c=[],n.value){var t=i.popupEditData(),r=f();r.cancelEditData();t.ChildSummaries([]);r.option("dataSource",st(t.ChildSummaries()))}}}},{dataField:"PIC",label:{text:"PIC"},validationRules:[{type:"required"}],colSpan:2,editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1},{dataField:"ReferenceNumber",label:{text:"Reference Number"},colSpan:3,editorOptions:{maxLength:30,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AttachmentFile",label:{text:"Attachment File"},colSpan:2,editorOptions:{onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1}]}],r=new Dismoyo_Ciptoning_Client.ProductLotPopupEdit,r.formOptions.colCount=4,r.saveOptions.icon="icons8-save",r.events.performSave=function(){ri()},r.dataGridOptions.onInitNewRow=function(n){n.data.QtyDisposal=0;n.data.QtyDisposalConv="0/0/0"},r.dataGridOptions.onEditorPreparing=function(n){var i,u,t;n.parentType=="dataRow"&&(n.dataField=="ProductLotCode"?(n.row.inserted?(i=r.popupEditOptions.itemStatusID,u=l(i),n.editorElement.dxLookup({dataSource:new DevExpress.data.DataSource({store:s,filter:[["ProductID","=",r.popupEditData().ProductID()],"and",[u.qtyOnHandColumn,">",0]],sort:[{getter:"ProductLotExpiredDate",desc:!0}]}),displayExpr:"ProductLotCode",valueExpr:"ProductLotCode",searchExpr:"ProductLotCode",searchPlaceholder:"Lot Number",popupWidth:"582px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){var t=r.popupEditOptions.itemStatusID;CommonUtility.createProductLotLookupHeader("vStockDisposals_productLotIDLookup",n.element,t)},itemTemplate:function(n,t,i){var u=r.popupEditOptions.itemStatusID,f=l(u);return CommonUtility.createProductLotLookupItem(n,i,f.qtyOnHandColumn)},onValueChanged:function(t){var i,e,f,u;t.value&&(i=this.option("selectedItem"),i&&(e=r.popupEditOptions.itemStatusID,f=l(e),n.component.cellValue(n.row.rowIndex,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductLotID",i.ProductLotID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductLotCode",i.ProductLotCode()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),u=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyDisposalConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyDisposal",u.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",u.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",u.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",u.qtyConvS)));n.component.cellValue(n.row.rowIndex,"ProductLotCode",t.value);n.setValue(t.value)}})):(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.ProductLotCode()))),n.cancel=!0):n.dataField=="QtyDisposalConv"&&(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyDisposal",i.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvL",i.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvM",i.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvS",i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}}),n.cancel=!0))},r.dataGridOptions.onRowInserted=function(n){CommonUtility.validateDataGridInsertedTransactionDetails(n.component,new Dismoyo_Ciptoning_Client.vStockDisposalDetailsViewModel(n.data).toJS())},r.dataGridOptions.onRowRemoved=function(n){CommonUtility.validateDataGridRemovedTransactionDetails(n.component,n.data.toJS())},r.dataGridOptions.onRowUpdating=function(n){CommonUtility.validateDataGridUpdatingTransactionDetails(n,"QtyConvL","QtyConvM","QtyConvS","QtyDisposalConv","QtyDisposal")},r.dataGridOptions.onRowValidating=function(n){var u=r.popupEditOptions.itemStatusID,f=l(u),i=DXUtility.getValue(n.newData,"QtyOnHand"),t;i==undefined&&(i=DXUtility.getValue(n.oldData,"QtyOnHand"));t=DXUtility.getValue(n.newData,"QtyDisposal");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyDisposal"));t<=0&&(n.errorText="Disposal Qty must be greater than 0.",n.isValid=!1);n.isValid&&t>i&&(n.errorText="Disposal Qty must be less than or equal to On Hand Qty.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.onDataErrorOccurred=function(n){var t=n.component._controllers.editing._editData[0].data.ProductLotCode;switch(n.error.__id){case"E4008":n.error.message="Lot Number '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.summary={totalItems:[{name:"TotalQtyPcs",showInColumn:"QtyDisposalConv",displayFormat:"Total Qty (Pcs): {0}",valueFormat:"decimal",summaryType:"custom"},{name:"TotalQtyLMS",showInColumn:"QtyDisposalConv",displayFormat:"(L/M/S): {0}",valueFormat:"string",summaryType:"custom"}],calculateCustomSummary:function(n){CommonUtility.updateProductLotEditingSummary(n,"QtyDisposalConv","QtyDisposal")}},r.dataGridOptions.columns=[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"ProductLotID",visible:!1},{dataField:"ProductLotCode",caption:"Lot Number",validationRules:[{type:"required"}]},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"120px",allowEditing:!1,dataType:"number"},{dataField:"QtyDisposalConv",caption:"Disposal Qty (L/M/S)",width:"150px",alignment:"right",validationRules:[{type:"required"},ut]}],r.formOptions.items=[{itemType:"group",caption:"Product",colCount:4,colSpan:4,items:[{dataField:"Product",label:{text:"Product"},colSpan:4,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOnHand",label:{text:"On Hand Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2},{dataField:"QtyDisposal",label:{text:"Disposal Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyDisposalConv",label:{text:"(L/M/S)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],{isReady:g.promise(),dataSource:o,refreshList:rt,viewShowing:pt,viewDisposing:wt,openCreateViewAsRoot:yt,icon:"Images/stock_disposal_32px.png",dataSource_vStockDisposalDetails:bt,dataSource_vStockDisposalSummary:kt,dataSource_vStockOnHandAvailable:s,dataSource_vStockOnHandAvailableByProduct:c,collapsibleFilter:u,commonGridView:e,commonPopupEdit:i,productLotPopupEdit:r,stockDisposalSummaryDataGrid:f,stockDisposalPost:ct,stockDisposalDiscard:lt,stockDisposalSaveAsDraftAndNew:at}};Dismoyo_Ciptoning_Client.vStockOpnames=function(n,t){"use strict";function et(){d=!0}function ot(){y=CommonUtility.configureCommonGridViewLayout("vStockOpnames");y||setTimeout(ot,50)}function dt(){var n,t;ot();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],s.filter(t));ft()?d&&st():(ft(s),s.load().always(function(){ut.resolve()}))}function gt(){Dismoyo_Ciptoning_Client.DB.vStockOpnames.off("modified",et)}function st(){d=!1;s.pageIndex(0);s.load()}function ht(n){return(n?n:"(Site Code)")+"-YY-06-(Auto Generated)"}function ct(n,t){t?Dismoyo_Ciptoning_Client.DB.vSites.byKey(t).done(function(n){c=n.IsLotNumberEntryRequired}):(t=null,c=undefined);var i=DataUtility.GetLookupWarehouseDataSource(["SiteID","=",t]);n.getEditor("WarehouseID").option("value",null);n.getEditor("WarehouseID").option("dataSource",[]);i.load().done(function(){n.getEditor("WarehouseID").option("dataSource",i)})}function lt(n){CommonUtility.updateSummariesArrayStore(f().option("dataSource").store(),n)}function ii(n,t){CommonUtility.updateDeferSummariesArrayStore(f().option("dataSource").store(),n,t)}function ri(n){return CommonUtility.validateSummaryArrayStore(f().option("dataSource").store(),"vStockOpnameSummaryViewModel",n)}function w(n){return CommonUtility.createArrayDataSource("vStockOpnameSummaryViewModel",["ProductID"],n)}function nt(n,t,i){var r=$('<div class="dx-command-edit" style="text-align: right; padding-right: 5px;">'),o;if(r.append($('<a style="color: inherit;">').text(n[t]())),r.append("&nbsp;"),c){var u=t.replace("Conv",""),s=n[u](),f=n.ChildDetails(),e=0;for(o in f)e+=f[o][u]();r.append($('<a class="dx-link dxcustom-linkbutton dx-icon-icons8-view-details" title="Edit Lot Number">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<\/a><span id="LotMark_'+n.ProductID()+"_"+t+'" class="dx-icon-overflow '+(e==s?"hidden":"")+'" style="color:red; font-size: 14px; margin-left: -6px;"><\/span>').on("dxclick",function(){k(function(){ei(n,i)})}));r.append("&nbsp;")}return r}function ui(n){var t=f().option("editing"),i=f().option("selection");i.mode=n?"multiple":"none";t.allowUpdating=n;t.allowDeleting=n;f().option("editing",t);f().option("selection",i);si().option("disabled",!n);bt().option("disabled",!0);f().repaint()}function tt(n,t){showLoadingPanel();Dismoyo_Ciptoning_Client.DB.vStockOpnames.byKey(n,{expand:["ChildSummaries/ChildDetails"]}).done(function(n){hideLoadingPanel();v=t;it(new Dismoyo_Ciptoning_Client.vStockOpnameViewModel(n))}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function it(n){var e=!1,u,t,o,a,h,v,y,l,p,b,d,nt;n||(n=new Dismoyo_Ciptoning_Client.vStockOpnameViewModel,e=!0);i.popupEditData(n);i.popupEdit().option("title",(e?"New":"Edit")+" Stock Opname");i.popupEditOptions.editingKey=n.DocumentID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);u=Dismoyo_Ciptoning_Client.app.CurrentUser;t=i.form();DXUtility.resetFormValidation(t);var tt=n.DocumentCode(),r=!1,s=[];if(c=n.IsSiteLotNumberEntryRequired(),e)n.DocumentID(new DevExpress.data.Guid),n.DocumentStatusID(null),n.TerritoryID(u.TerritoryID()),n.RegionID(u.RegionID()),n.AreaID(u.AreaID()),n.SiteID(u.SiteID()),n.SiteCode(u.SiteCode()),n.CompanyID(u.CompanyID()),n.Company(u.Company()),tt=ht(n.SiteCode());else if(s=n.ChildSummaries(),n.DocumentStatusID()!=1||c)(n.DocumentStatusID()==2||n.DocumentStatusID()==3)&&(r=!0);else{for(o=[],a=0,h=0;h<s.length;h++){for(v=s[h].ChildDetails(),y=0,l=0;l<v.length;l++)v[l].ProductLotCode().indexOf("DUMMY")<0&&y++;y>0&&(o[a]=s[h],a++)}o.length>0&&k(function(){for(var t,n=0;n<o.length;n++)t={data:o[n].toJS()},rt(t,o)})}ui(!r);vt().option("disabled",e);yt().option("disabled",e||r);pt().option("disabled",e||r);wt().option("disabled",r);i.ok().option("disabled",r);t.itemOption("Organization").visible&&(t.getEditor("TerritoryID").option("value",n.TerritoryID()),t.getEditor("RegionID").option("value",n.RegionID()),t.getEditor("AreaID").option("value",n.AreaID()),t.getEditor("SiteID").option("value",n.SiteID()),t.getEditor("Company").option("value",n.Company()),t.getEditor("TerritoryID").option("readOnly",r),t.getEditor("RegionID").option("readOnly",r),t.getEditor("AreaID").option("readOnly",r),t.getEditor("SiteID").option("readOnly",r));ct(t,n.SiteID());t.getEditor("DocumentCode").option("value",tt);g=!0;t.getEditor("WarehouseID").option("value",n.WarehouseID());t.getEditor("TransactionDate").option("value",n.TransactionDate());t.getEditor("PIC").option("value",n.PIC());t.getEditor("ReferenceNumber").option("value",n.ReferenceNumber());p=at();CommonUtility.createEditDataAttachmentFileDownloader("vStockOpnames",p,"StockOpnames",n.AttachmentFile());p.option("value",null);t.getEditor("DocumentStatusID").option("value",n.DocumentStatusID());t.getEditor("TransactionDate").option("readOnly",!0);t.getEditor("WarehouseID").option("readOnly",r);t.getEditor("PIC").option("readOnly",r);t.getEditor("ReferenceNumber").option("readOnly",r);b=$(".dx-fileuploader-input-wrapper");r?b.hide():b.show();d=new Date;e?(DXUtility.resetFormValidation(t),t.getEditor("TransactionDate").option("value",d)):n.DocumentStatusID()==1&&t.getEditor("TransactionDate").option("value",d);nt=f();nt.cancelEditData();n.ChildSummaries(s);nt.option("dataSource",w(n.ChildSummaries()))}function b(n,t){var nt,h,w,s,o,r,a,u;showLoadingPanel();var y=i.form(),c=y.validate().isValid,l=c?"":"Please specify the required fields.",rt=e.dataGrid(),ut=rt.option("dataSource"),b=f().option("dataSource"),p=[];for(o=0;o<b.store()._array.length;o++)p.push(new Dismoyo_Ciptoning_Client.vStockOpnameSummaryViewModel(b.store()._array[o]));if(c&&p.length<=0&&(l="Please specify at least one item in Opname Details.",c=!1),c)for(o=0;o<p.length;o++){var r=p[o],k=0,d=0,g=0;for(a=0;a<r.ChildDetails().length;a++)u=r.ChildDetails()[a],k+=u.QtyOpnameGood(),d+=u.QtyOpnameHold(),g+=u.QtyOpnameBad();(r.QtyOpnameGood()!=k||r.QtyOpnameHold()!=d||r.QtyOpnameBad()!=g)&&(l==""?l="Following products quantity of Opname Details items is not matched: ":l+=", ",l+=r.Product(),c=!1)}if(c&&$(".dx-fileuploader-button.dx-fileuploader-upload-button.dx-widget.dx-button-has-icon.dx-button.dx-button-normal").length>0&&(l="You have selected an attachment file. Please upload or cancel the attachment file.",c=!1),nt=Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID(),y.itemOption("Organization").visible&&(nt=y.getEditor("SiteID").option("value")),c){for(h=i.popupEditData(),h.TransactionDate(y.getEditor("TransactionDate").option("value")),h.WarehouseID(y.getEditor("WarehouseID").option("value")),h.PIC(y.getEditor("PIC").option("value")),h.ReferenceNumber(y.getEditor("ReferenceNumber").option("value")),w=at(),h.AttachmentFile(w.option("values").length>0?w.fileName:null),h.ChildSummaries(p),s=ko.toJS(h),n&&(s.DocumentStatusID=n),s.DocumentStatusID||(s.DocumentStatusID=1),s.TransactionDate=DateTimeUtility.getFirstTimeOfDay(s.TransactionDate),o=0;o<s.ChildSummaries.length;o++){for(r=s.ChildSummaries[o],r.DocumentID=s.DocumentID,a=0;a<r.ChildDetails.length;a++)u=r.ChildDetails[a],u.DocumentID=s.DocumentID,u.QtyGood=u.QtyOpnameGood-u.QtyOnHandGood,u.QtyHold=u.QtyOpnameHold-u.QtyOnHandHold,u.QtyBad=u.QtyOpnameBad-u.QtyOnHandBad;r.QtyGood=r.QtyOpnameGood-r.QtyOnHandGood;r.QtyHold=r.QtyOpnameHold-r.QtyOnHandHold;r.QtyBad=r.QtyOpnameBad-r.QtyOnHandBad}ut.store().insert(s).done(function(n){CommonUtility.documentSuccessMessage(n.DocumentStatusID,function(){});v=!0;switch(t){case 1:i.events.performCancel();hideLoadingPanel();break;case 2:it(null);hideLoadingPanel();break;case 3:tt(h.DocumentID(),!0)}}).fail(function(n){DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})}else hideLoadingPanel();l!=""&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(l),"Save Failed")}function fi(n){h.popupEdit().option("title","Print Stock Opname");h.popupEditOptions.visible(!0);var t=h.iframe();h.showLoadingPanel();t.attr("src",Dismoyo_Ciptoning_Client.ReportWebsite.StockOpnameReport.url([["DocumentID","=",n]]))}function o(n){var t=null;switch(n){case 1:t="Good";break;case 2:t="Hold";break;case 3:t="Bad"}var i="QtyOnHand"+t,r="QtyConvL"+t,u="QtyConvM"+t,f="QtyConvS"+t,e="QtyOpname"+t,o="QtyOpnameConv"+t;return{itemStatusName:t,qtyOnHandColumn:i,qtyConvLColumn:r,qtyConvMColumn:u,qtyConvSColumn:f,qtyOpnameColumn:e,qtyOpnameConvColumn:o}}function ei(n,t){var v=i.popupEditData(),s,w,l,a,c,b;r.popupEditData(n);r.popupEditOptions.editingKey=n.ProductID();r.popupEditOptions.itemStatusID=t;r.popupEditOptions.visible(!0);var e=r.dataGrid(),h=r.form(),f=!1;(v.DocumentStatusID()==2||v.DocumentStatusID()==3)&&(f=!0);s=r.dataGrid().option("editing");s.allowUpdating=!f;s.allowDeleting=!f;s.editEnabled=!f;s.removeEnabled=!f;r.dataGrid().option("editing",s);r.dataGrid().option("selection",{mode:f?"none":"multiple"});r.newRow().option("disabled",f);r.dataGrid().repaint();var u=o(t),y=e.columnOption("QtyOnHand"),p=e.columnOption("QtyOpnameConv");if(y.dataField=u.qtyOnHandColumn,p.dataField=u.qtyOpnameConvColumn,e.columnOption("QtyOnHand",y),e.columnOption("QtyOpnameConv",p),h.getEditor("Product").option("value",n.Product()),h.getEditor("QtyOnHand").option("value",n[u.qtyOnHandColumn]()),h.getEditor("QtyOpnameConv").option("value",n[u.qtyOpnameConvColumn]()),w=CommonUtility.getConversion(n[u.qtyOpnameConvColumn](),DXUtility.getValue(n,"ProductConversionL"),DXUtility.getValue(n,"ProductConversionM"),DXUtility.getValue(n,"ProductConversionS")),h.getEditor("QtyOpname").option("value",w.qtyTransaction),n=ri(n),l=[],n.ChildDetails().length>0)for(a=$.grep(n.ChildDetails(),function(n){return n[u.qtyOnHandColumn]()>0||n[u.qtyConvLColumn]()>0||n[u.qtyConvMColumn]()>0||n[u.qtyConvSColumn]()>0}),c=0;c<a.length;c++)l.push(a[c]);b=CommonUtility.createArrayDataSource("vStockOpnameDetailsViewModel",["ProductID","ProductLotID"],l);e.cancelEditData();e.option("dataSource",b)}function rt(n,t){var v,r,y,h,e,a,p,u,o;if(!c){var a=i.popupEditData(),w=f(),s=[];if(t){for(e=0;e<t.length;e++)t[e].ChildDetails([]);s=t}else for(v=w.option("dataSource").store(),e=0;e<v._array.length;e++)s.push(new Dismoyo_Ciptoning_Client.vStockOpnameSummaryViewModel(v._array[e]));if(r=n.data,y=$.grep(l,function(n){return n.ProductID()==DXUtility.getValue(r,"ProductID")&&n.ProductLotCode().indexOf("DUMMY")>=0}),y.length>0)for(h=y[0],DXUtility.setValue(r,"ProductLotID",h.ProductLotID()),DXUtility.setValue(r,"ProductLotCode",h.ProductLotCode()),DXUtility.setValue(r,"QtyOnHandGood",h.QtyOnHandGood()),DXUtility.setValue(r,"QtyOnHandHold",h.QtyOnHandHold()),DXUtility.setValue(r,"QtyOnHandBad",h.QtyOnHandBad()),e=0;e<s.length;e++)a=s[e],a.ProductID()==DXUtility.getValue(r,"ProductID")&&(p=$.grep(a.ChildDetails(),function(n){return n.ProductLotID()==DXUtility.getValue(r,"ProductLotID")}),p.length>0?(u=p[0],o=DXUtility.getValue(r,"QtyOpnameGood"),o!=undefined&&(u.QtyConvLGood(DXUtility.getValue(r,"QtyConvLGood")),u.QtyConvMGood(DXUtility.getValue(r,"QtyConvMGood")),u.QtyConvSGood(DXUtility.getValue(r,"QtyConvSGood")),u.QtyOpnameGood(o),u.QtyOpnameConvGood(DXUtility.getValue(r,"QtyOpnameConvGood"))),o=DXUtility.getValue(r,"QtyOpnameHold"),o!=undefined&&(u.QtyConvLHold(DXUtility.getValue(r,"QtyConvLHold")),u.QtyConvMHold(DXUtility.getValue(r,"QtyConvMHold")),u.QtyConvSHold(DXUtility.getValue(r,"QtyConvSHold")),u.QtyOpnameHold(o),u.QtyOpnameConvHold(DXUtility.getValue(r,"QtyOpnameConvHold"))),o=DXUtility.getValue(r,"QtyOpnameBad"),o!=undefined&&(u.QtyConvLBad(DXUtility.getValue(r,"QtyConvLBad")),u.QtyConvMBad(DXUtility.getValue(r,"QtyConvMBad")),u.QtyConvSBad(DXUtility.getValue(r,"QtyConvSBad")),u.QtyOpnameBad(o),u.QtyOpnameConvBad(DXUtility.getValue(r,"QtyOpnameConvBad")))):(r.QtyOpnameGood==undefined&&(DXUtility.setValue(r,"QtyConvLGood",0),DXUtility.setValue(r,"QtyConvMGood",0),DXUtility.setValue(r,"QtyConvSGood",0),DXUtility.setValue(r,"QtyOpnameGood",0),DXUtility.setValue(r,"QtyOpnameConvGood","0/0/0")),r.QtyOpnameHold==undefined&&(DXUtility.setValue(r,"QtyConvLHold",0),DXUtility.setValue(r,"QtyConvMHold",0),DXUtility.setValue(r,"QtyConvSHold",0),DXUtility.setValue(r,"QtyOpnameHold",0),DXUtility.setValue(r,"QtyOpnameConvHold","0/0/0")),r.QtyOpnameBad==undefined&&(DXUtility.setValue(r,"QtyConvLBad",0),DXUtility.setValue(r,"QtyConvMBad",0),DXUtility.setValue(r,"QtyConvSBad",0),DXUtility.setValue(r,"QtyOpnameBad",0),DXUtility.setValue(r,"QtyOpnameConvBad","0/0/0")),s[e].ChildDetails().push(new Dismoyo_Ciptoning_Client.vStockOpnameDetailsViewModel(r))),lt(s[e]));else DevExpress.ui.dialog.alert("DUMMY Lot Number for the selected product is not available.","Save Failed")}}function oi(){var t=r.popupEditData(),i=r.popupEditOptions.itemStatusID,n=o(i);CommonUtility.validateProductLotEditing(t,r.dataGrid().option("dataSource"),r.form().getEditor("QtyOpname").option("value"),"Opname","vStockOpnameDetailsViewModel",n.qtyConvLColumn,n.qtyConvMColumn,n.qtyConvSColumn,n.qtyOpnameConvColumn,n.qtyOpnameColumn,!0)&&(lt(t),r.popupEditOptions.visible(!1),f().refresh())}function k(n){if(l.length==0&&a.length==0){showLoadingPanel();var t=i.form();new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vProducts,select:["ID","Code","Product","UOMLID","UOMMID","UOMSID","ConversionL","ConversionM","ConversionS"],sort:["ID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vProductViewModel(n)}}).load().done(function(i){var f=i,r=t.getEditor("WarehouseID").option("value"),u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOnHandAlls,select:["ProductID","ProductLotID","ProductLotCode","ProductLot","ProductLotExpiredDate","QtyOnHandGood","QtyOnHandHold","QtyOnHandBad"],filter:["WarehouseID","=",r],sort:["WarehouseID","ProductID","ProductLotID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOnHandAllViewModel(n)}});u.load().done(function(t){for(var e,s,u=null,o=[],r=[],f=0;f<t.length;f++)o.push(new Dismoyo_Ciptoning_Client.vStockOnHandAllViewModel(t[f].toJS())),e=r.length-1,s=t[f].ProductID(),f==0||r[e].ProductID()!=s?(r.push(new Dismoyo_Ciptoning_Client.vStockOnHandAllViewModel(t[f].toJS())),e++,u=$.grep(i,function(n){return n.ID()==s})):(r[e].QtyOnHandGood(r[e].QtyOnHandGood()+t[f].QtyOnHandGood()),r[e].QtyOnHandHold(r[e].QtyOnHandHold()+t[f].QtyOnHandHold()),r[e].QtyOnHandBad(r[e].QtyOnHandBad()+t[f].QtyOnHandBad())),o[f].ProductCode(u[0].Code()),o[f].Product(u[0].Product()),o[f].ProductUOMLID(u[0].UOMLID()),o[f].ProductUOMMID(u[0].UOMMID()),o[f].ProductUOMSID(u[0].UOMSID()),o[f].ProductConversionL(u[0].ConversionL()),o[f].ProductConversionM(u[0].ConversionM()),o[f].ProductConversionS(u[0].ConversionS()),r[e].ProductCode(u[0].Code()),r[e].Product(u[0].Product()),r[e].ProductUOMLID(u[0].UOMLID()),r[e].ProductUOMMID(u[0].UOMMID()),r[e].ProductUOMSID(u[0].UOMSID()),r[e].ProductConversionL(u[0].ConversionL()),r[e].ProductConversionM(u[0].ConversionM()),r[e].ProductConversionS(u[0].ConversionS());l=o;a=r;n();hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product lot data."),"Download Product Lot Failed");hideLoadingPanel()})}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product data."),"Download Product Failed");hideLoadingPanel()})}else n()}var d=!1,kt=t.layoutController.name==="split",ut=$.Deferred(),ft=ko.observable(),s,v,c,g=!1,y,u,e,i,h,r;s=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOpnames,select:["DocumentID","DocumentCode","Territory","Region","Area","Company","TransactionDate","Warehouse","ReferenceNumber","DocumentStatusName","PIC","PostedDate","CreatedByUserName","CreatedDate","ModifiedByUserName","ModifiedDate"],map:function(n){return new Dismoyo_Ciptoning_Client.vStockOpnameViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vStockOpnames.on("modified",et);var ni=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOpnameDetails,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOpnameDetailsViewModel(n)}}),ti=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOpnameSummaries,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOpnameSummaryViewModel(n)}}),l,a,p={type:"pattern",pattern:"(^[0-9]*$)|(^[0-9]*/[0-9]*$)|(^[0-9]*/[0-9]*/[0-9]*$)",message:"Format must be L/M/S or M/S or S."};u=new Dismoyo_Ciptoning_Client.CollapsibleFilter;u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){y&&y.resizeAll()})};u.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Warehouse"])}}}]},{itemType:"group",caption:"Stock Opname",colCount:3,colSpan:3,items:[{dataField:"WarehouseID",label:{text:"Warehouse"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{name:"DocumentCode",dataField:"",label:{text:"Document Number"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateFrom",label:{text:"Transaction Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateTo",label:{text:"Transaction Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"PIC",label:{text:"PIC"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}}]}];u.events.performSearch=function(){var f=e.dataGrid(),t=u.form(),n=[],i;f.clearFilter();var r=Dismoyo_Ciptoning_Client.app.CurrentUser,o=r.TerritoryID(),s=r.RegionID(),h=r.AreaID(),c=r.CompanyID(),l=r.SiteID();t.itemOption("Organization").visible&&(o=t.getEditor("TerritoryID").option("value"),s=t.getEditor("RegionID").option("value"),h=t.getEditor("AreaID").option("value"),c=t.getEditor("CompanyID").option("value"),l=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",o,"and");DXUtility.addFilterExpression(n,"RegionID","=",s,"and");DXUtility.addFilterExpression(n,"AreaID","=",h,"and");DXUtility.addFilterExpression(n,"CompanyID","=",c,"and");DXUtility.addFilterExpression(n,"SiteID","=",l,"and");i=t.getEditor("WarehouseID").option("value");DXUtility.addFilterExpression(n,"WarehouseID","=",i,"and");i=t.getEditor("DocumentCode").option("value");DXUtility.addFilterExpression(n,"DocumentCode","contains",i,"and");i=t.getEditor("TransactionDateFrom").option("value");DXUtility.addFilterExpression(n,"TransactionDate",">=",i,"and");i=t.getEditor("TransactionDateTo").option("value");DXUtility.addFilterExpression(n,"TransactionDate","<=",i,"and");i=t.getEditor("PIC").option("value");DXUtility.addFilterExpression(n,"PIC","contains",i,"and");i=t.getEditor("DocumentStatusID").option("value");DXUtility.addFilterExpression(n,"DocumentStatusID","=",i,"and");n.length>0?f.filter(n):f.refresh()};e=new Dismoyo_Ciptoning_Client.CommonGridView;e.dataGridOptions.dataSource=s;e.dataGridOptions.editing.editEnabled=!1;e.dataGridOptions.editing.removeEnabled=!1;e.dataGridOptions.selection.mode="single";e.deleteRowsOptions.visible=!1;e.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("StockOpnames.AddNewStockOpname");e.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("StockOpnames.EditStockOpname");e.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{},{dataField:"DocumentCode",caption:"Document Number",width:"140px",sortOrder:"desc",headerCellTemplate:function(n,t){var r=$("#vStockOpnames_commonGridView").find(".dx-datagrid:first-child"),i,u,f;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',u=Dismoyo_Ciptoning_Client.app.CurrentUser,u.IsHeadOffice()&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',e.dataGridOptions.editing.allowUpdating&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",f=r.find(".dx-header-row:first-child"),$(i).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},cellTemplate:function(n,t){var u=Dismoyo_Ciptoning_Client.app.CurrentUser,f=u.isAuthorized("StockOpnames.EditStockOpname"),i=$('<div class="dx-command-edit" style="text-align: left;">'),r=$("<b>").text(t.data.DocumentCode());f&&(r=$('<a class="dx-link">').text(t.data.DocumentCode()).on("dxclick",function(){tt(t.data.DocumentID(),!1)}));i.append(r);i.append("&nbsp;");n.append(i)}},{dataField:"TransactionDate",caption:"Transaction Date",width:"100px",customizeText:function(n){return n.value?n.value.toLocaleDateString():null}},{dataField:"Warehouse",caption:"Warehouse",width:"200px"},{dataField:"ReferenceNumber",caption:"Reference Number",width:"120px"},{dataField:"PIC",caption:"PIC",width:"180px"},{dataField:"DocumentStatusName",caption:"Status",width:"80px"},{dataField:"PostedDate",caption:"Posted Date",width:"100px",customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleDateString():null}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}];e.dataGridOptions.editing.allowUpdating&&e.dataGridOptions.columns.push({width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){tt(t.data.DocumentID(),!1)}));i.append("&nbsp;");n.append(i)}});i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.okOptions.text="Save";i.okOptions.icon="icons8-save";var at=function(){return DXUtility.getDXInstance(null,"#vStockOpnames_editDataAttachmentFile","dxFileUploader")},f=function(){return DXUtility.getDXInstance(null,"#vStockOpnames_stockOpnameSummaryDataGrid","dxDataGrid")},vt=function(){return DXUtility.getDXInstance(null,"#vStockOpnames_stockOpnamePrint","dxButton")},yt=function(){return DXUtility.getDXInstance(null,"#vStockOpnames_stockOpnamePost","dxButton")},pt=function(){return DXUtility.getDXInstance(null,"#vStockOpnames_stockOpnameDiscard","dxButton")},wt=function(){return DXUtility.getDXInstance(null,"#vStockOpnames_stockOpnameSaveAsDraftAndNew","dxButton")},si=function(){return DXUtility.getDXInstance(null,"#vStockOpnames_stockOpnameSummaryNewRow","dxButton")},bt=function(){return DXUtility.getDXInstance(null,"#vStockOpnames_stockOpnameSummaryDeleteRows","dxButton")};return i.popupEditOptions.onContentReady=function(){var u=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop("Opname Details"));var r=$('<div class="desktop-commonGridView-commands">'),e=$('<div id="vStockOpnames_stockOpnameSummaryNewRow">').dxButton({text:"New",icon:"add",onClick:function(){var n=i.form().validate().isValid;n?k(function(){f().addRow()}):DevExpress.ui.dialog.alert("Please specify the required fields.","New Opname Details Failed")}}),o=$('<div id="vStockOpnames_stockOpnameSummaryDeleteRows">').dxButton({text:"Delete",icon:"remove",disabled:!0,onClick:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(n){n&&DXUtility.deleteSelectedRows(f())})}});r.append(e);r.append(o);n.append(r);n.append($('<div id="vStockOpnames_stockOpnameSummaryDataGrid">').dxDataGrid({deferRendering:!1,dataSource:[],showBorders:!0,paging:{enabled:!1},allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,selection:{mode:"multiple",allowSelectAll:!0},editing:{editMode:"row",allowAdding:!1,allowUpdating:!0,allowDeleting:!0},onSelectionChanged:function(n){bt().option("disabled",!n.selectedRowsData.length)},onInitNewRow:function(n){n.data.QtyOpnameGood=0;n.data.QtyOpnameHold=0;n.data.QtyOpnameBad=0;n.data.QtyOpnameConvGood="0/0/0";n.data.QtyOpnameConvHold="0/0/0";n.data.QtyOpnameConvBad="0/0/0"},onEditorPreparing:function(n){if(n.parentType=="dataRow")if(n.dataField=="Product")n.row.inserted?n.editorElement.dxLookup({dataSource:a,displayExpr:"Product",valueExpr:"Product",searchExpr:"Product",searchPlaceholder:"Product",popupWidth:"832px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){CommonUtility.createProductLookupHeader("vStockOpnames_productIDLookup",n.element,null)},itemTemplate:function(n,t,i){return CommonUtility.createProductLookupItem(n,i,null)},onValueChanged:function(t){var i;if(t.value&&(i=this.option("selectedItem"),i)){n.component.cellValue(n.row.rowIndex,"QtyOnHandGood",i.QtyOnHandGood());n.component.cellValue(n.row.rowIndex,"QtyOnHandHold",i.QtyOnHandHold());n.component.cellValue(n.row.rowIndex,"QtyOnHandBad",i.QtyOnHandBad());DXUtility.setValue(n.row.data,"ProductID",i.ProductID());DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode());DXUtility.setValue(n.row.data,"Product",i.Product());DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID());DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID());DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID());DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL());DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM());DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS());var r=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyOpnameConvGood"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),u=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyOpnameConvHold"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),f=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyOpnameConvBad"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyOpnameGood",r.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvLGood",r.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvMGood",r.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvSGood",r.qtyConvS);DXUtility.setValue(n.row.data,"QtyOpnameHold",u.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvLHold",u.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvMHold",u.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvSHold",u.qtyConvS);DXUtility.setValue(n.row.data,"QtyOpnameBad",f.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvLBad",f.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvMBad",f.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvSBad",f.qtyConvS)}n.component.cellValue(n.row.rowIndex,"Product",t.value);n.setValue(t.value)}}):(k(function(){}),n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Product()))),n.cancel=!0;else if(n.dataField=="QtyOpnameConvGood"||n.dataField=="QtyOpnameConvHold"||n.dataField=="QtyOpnameConvBad"){var t="";n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onEnterKey:function(){f().saveEditData()},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,n.dataField.replace("QtyOpnameConv","QtyOpname"),i.qtyTransaction);DXUtility.setValue(n.row.data,n.dataField.replace("QtyOpnameConv","QtyConvL"),i.qtyConvL);DXUtility.setValue(n.row.data,n.dataField.replace("QtyOpnameConv","QtyConvM"),i.qtyConvM);DXUtility.setValue(n.row.data,n.dataField.replace("QtyOpnameConv","QtyConvS"),i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}});n.cancel=!0}},onRowInserted:function(n){CommonUtility.validateDataGridInsertedTransactionSummary(n.component,new Dismoyo_Ciptoning_Client.vStockOpnameSummaryViewModel(n.data).toJS());rt(n);f().clearSelection()},onRowUpdated:function(n){n.data.ProductID=n.key.ProductID;rt(n);f().clearSelection()},onRowRemoved:function(n){CommonUtility.validateDataGridRemovedTransactionSummary(n.component,n.data.toJS())},onRowUpdating:function(n){var t;n.newData.QtyOpnameConvGood&&(t=CommonUtility.getConversion(n.newData.QtyOpnameConvGood,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS")),n.newData.QtyConvLGood=t.qtyConvL,n.newData.QtyConvMGood=t.qtyConvM,n.newData.QtyConvSGood=t.qtyConvS,n.newData.QtyOpnameGood=t.qtyTransaction);n.newData.QtyOpnameConvHold&&(t=CommonUtility.getConversion(n.newData.QtyOpnameConvHold,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS")),n.newData.QtyConvLHold=t.qtyConvL,n.newData.QtyConvMHold=t.qtyConvM,n.newData.QtyConvSHold=t.qtyConvS,n.newData.QtyOpnameHold=t.qtyTransaction);n.newData.QtyOpnameConvBad&&(t=CommonUtility.getConversion(n.newData.QtyOpnameConvBad,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS")),n.newData.QtyConvLBad=t.qtyConvL,n.newData.QtyConvMBad=t.qtyConvM,n.newData.QtyConvSBad=t.qtyConvS,n.newData.QtyOpnameBad=t.qtyTransaction);ii(n.oldData.ProductID(),n.newData)},onRowValidating:function(n){var e=DXUtility.getValue(n.newData,"QtyOnHandGood"),t,i,r,u,f;e==undefined&&(e=DXUtility.getValue(n.oldData,"QtyOnHandGood"));t=DXUtility.getValue(n.newData,"QtyOnHandHold");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyOnHandHold"));i=DXUtility.getValue(n.newData,"QtyOnHandBad");i==undefined&&(i=DXUtility.getValue(n.oldData,"QtyOnHandBad"));r=DXUtility.getValue(n.newData,"QtyOpnameGood");r==undefined&&(r=DXUtility.getValue(n.oldData,"QtyOpnameGood"));u=DXUtility.getValue(n.newData,"QtyOpnameHold");u==undefined&&(u=DXUtility.getValue(n.oldData,"QtyOpnameHold"));f=DXUtility.getValue(n.newData,"QtyOpnameBad");f==undefined&&(f=DXUtility.getValue(n.oldData,"QtyOpnameBad"));e==0&&r<=0&&t==0&&u<=0&&i==0&&f<=0&&(n.errorText="Opname Qty Good/Hold/Bad must be greater than 0 when On Hand Qty Good/Hold/Bad is 0.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},onDataErrorOccurred:function(n){var t=n.component._controllers.editing._editData[0].data.Product;switch(n.error.__id){case"E4008":n.error.message="Product '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},columns:[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"Product",caption:"Product",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$(f().element()),r,i,e;!u.find(".datagrid-bandedHeader:first").length>0&&(r=f().option("selection").mode=="none"?!1:!0,i='<tr class="dx-row dx-column-lines datagrid-bandedHeader" style="border-top-style: none !important;">',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="3">On Hand Qty (Pcs)<\/td>',i+='       <td class="dx-datagrid-action" colspan="3">Opname Qty (L/M/S)<\/td>',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",e=u.find(".dx-header-row:first-child"),$(i).insertBefore(e[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"QtyOnHandGood",caption:"Good",width:"70px",allowEditing:!1,dataType:"number"},{dataField:"QtyOnHandHold",caption:"Hold",width:"70px",allowEditing:!1,dataType:"number"},{dataField:"QtyOnHandBad",caption:"Bad",width:"70px",allowEditing:!1,dataType:"number"},{dataField:"QtyOpnameConvGood",caption:"Good",width:"90px",alignment:"right",validationRules:[{type:"required"},p],cellTemplate:function(n,t){n.append(nt(t.data,"QtyOpnameConvGood",1))}},{dataField:"QtyOpnameConvHold",caption:"Hold",width:"90px",alignment:"right",validationRules:[{type:"required"},p],cellTemplate:function(n,t){n.append(nt(t.data,"QtyOpnameConvHold",2))}},{dataField:"QtyOpnameConvBad",caption:"Bad",width:"90px",alignment:"right",validationRules:[{type:"required"},p],cellTemplate:function(n,t){n.append(nt(t.data,"QtyOpnameConvBad",3))}}]}));var t=$("#commonPopupEdit_extCommands"),s=$('<div id="vStockOpnames_stockOpnamePrint" style="margin-right: 32px;">').dxButton({text:"Print",icon:"icons8-print",onClick:function(){i.events.performPrint(this)}}),t=$("#commonPopupEdit_extCommands"),h=$('<div id="vStockOpnames_stockOpnamePost">').dxButton({text:"Post",icon:"icons8-check-green",onClick:function(){i.events.performPost(this)}}),c=$('<div id="vStockOpnames_stockOpnameDiscard" style="margin-right: 16px;">').dxButton({text:"Discard",icon:"icons8-trash-red",onClick:function(){i.events.performDiscard(this)}}),l=$('<div id="vStockOpnames_stockOpnameSaveAsDraftAndNew">').dxButton({text:"Save & New",icon:"icons8-save",onClick:function(){i.events.performSaveAsDraftAndNew(this)}});u.append(DXUtility.createFormItemGroupWithCaption("").append(n));t.append(s);t.append(h);t.append(c);t.append(l)},e.events.performNewRow=function(){it(null)},i.events.performOK=function(){b(null,3)},i.events.performPrint=function(){var n=i.popupEditData();fi(n.DocumentID())},i.events.performPost=function(){DevExpress.ui.dialog.confirm("Are you sure want to Post this transaction?","Post Confirmation").done(function(n){n&&b(2,3)})},i.events.performDiscard=function(){DevExpress.ui.dialog.confirm("Are you sure want to Discard this transaction?","Discard Confirmation").done(function(n){n&&b(3,3)})},i.events.performSaveAsDraftAndNew=function(){b(1,2)},i.formOptions.customizeItem=function(n){n.dataField=="AttachmentFile"&&(n.template=function(n,t){t.append(CommonUtility.createEditDataAttachmentFileUploader("vStockOpnames","StockOpnames"))})},i.events.performCancel=function(){i.popupEditOptions.visible(!1);v&&(e.dataGrid().refresh(),v=!1)},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form(),r;CommonUtility.cascadeValueChanged(t,n.selectedItem,n.value,"Site",["Area","Region","Territory"],[]);r="";n.selectedItem?(r=ht(n.selectedItem.Code()),t.getEditor("Company").option("value",n.selectedItem.Company())):n.previousValue!=null&&t.getEditor("Company").option("value",null);ct(t,n.value);t.getEditor("DocumentCode").option("value",r)}}}]},{itemType:"group",caption:"Stock Opname",colCount:6,colSpan:3,items:[{dataField:"DocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"TransactionDate",label:{text:"Transaction Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},colSpan:1,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"NEW",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"WarehouseID",label:{text:"Warehouse"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var r,e,o,t,u;l=[];a=[];r=i.form();n.value&&(e=[["WarehouseID","=",n.value],"and",["DocumentStatusID","=",2]],o=new DevExpress.data.DataSource({select:["TransactionDate",],filter:e,store:Dismoyo_Ciptoning_Client.DB.vStockOpnames,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOpnameViewModel(n)}}),o.load().done(function(n){n.sort(function(n,t){var i=new Date(n.TransactionDate()),r=new Date(t.TransactionDate());return i-r});n.length>0&&(r.getEditor("TransactionDate").option("min",n[n.length-1].TransactionDate()),new Date(r.getEditor("TransactionDate").option("value")).setHours(0,0,0,0)<new Date(r.getEditor("TransactionDate").option("min")).setHours(0,0,0,0)&&(r.validate().isValid=!1,r.getEditor("TransactionDate").option("isValid",!1)))}));n.value&&!g&&(t=i.popupEditData(),u=f(),u.cancelEditData(),showLoadingPanel(),new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vProducts,select:["ID","Code","Product","UOMLID","UOMMID","UOMSID","ConversionL","ConversionM","ConversionS"],sort:["ID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vProductViewModel(n)}}).load().done(function(i){var f=i,r=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOnHandAvailables,select:["ProductID","ProductLotID","ProductLotCode","QtyOnHandGood","QtyOnHandHold","QtyOnHandBad"],filter:[["WarehouseID","=",n.value],"and",[["QtyOnHandGood",">",0],"or",["QtyOnHandHold",">",0],"or",["QtyOnHandBad",">",0],]],sort:["WarehouseID","ProductID","ProductLotID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(n)}});r.load().done(function(n){for(var f,h,e,o=null,r=[],s=0;s<n.length;s++)f=r.length-1,h=n[s].ProductID(),s==0||r[f].ProductID()!=h?(r.push(new Dismoyo_Ciptoning_Client.vStockOpnameSummaryViewModel),f++,o=$.grep(i,function(n){return n.ID()==h}),r[f].ProductID(o[0].ID()),r[f].ProductCode(o[0].Code()),r[f].Product(o[0].Product()),r[f].ProductUOMLID(o[0].UOMLID()),r[f].ProductUOMMID(o[0].UOMMID()),r[f].ProductUOMSID(o[0].UOMSID()),r[f].ProductConversionL(o[0].ConversionL()),r[f].ProductConversionM(o[0].ConversionM()),r[f].ProductConversionS(o[0].ConversionS()),r[f].QtyOpnameConvGood("0/0/0"),r[f].QtyOpnameConvHold("0/0/0"),r[f].QtyOpnameConvBad("0/0/0"),r[f].QtyOpnameGood(0),r[f].QtyOpnameHold(0),r[f].QtyOpnameBad(0),r[f].QtyOnHandGood(n[s].QtyOnHandGood()),r[f].QtyOnHandHold(n[s].QtyOnHandHold()),r[f].QtyOnHandBad(n[s].QtyOnHandBad()),r[f].ChildDetails([])):(r[f].QtyOnHandGood(r[f].QtyOnHandGood()+n[s].QtyOnHandGood()),r[f].QtyOnHandHold(r[f].QtyOnHandHold()+n[s].QtyOnHandHold()),r[f].QtyOnHandBad(r[f].QtyOnHandBad()+n[s].QtyOnHandBad())),e=new Dismoyo_Ciptoning_Client.vStockOpnameDetailsViewModel,e.ProductID(o[0].ID()),e.ProductCode(o[0].Code()),e.Product(o[0].Product()),e.ProductUOMLID(o[0].UOMLID()),e.ProductUOMMID(o[0].UOMMID()),e.ProductUOMSID(o[0].UOMSID()),e.ProductConversionL(o[0].ConversionL()),e.ProductConversionM(o[0].ConversionM()),e.ProductConversionS(o[0].ConversionS()),e.ProductLotID(n[s].ProductLotID()),e.ProductLotCode(n[s].ProductLotCode()),e.QtyOpnameConvGood("0/0/0"),e.QtyOpnameConvHold("0/0/0"),e.QtyOpnameConvBad("0/0/0"),e.QtyOpnameGood(0),e.QtyOpnameHold(0),e.QtyOpnameBad(0),e.QtyOnHandGood(n[s].QtyOnHandGood()),e.QtyOnHandHold(n[s].QtyOnHandHold()),e.QtyOnHandBad(n[s].QtyOnHandBad()),r[f].ChildDetails().push(e);t.ChildSummaries(r);u.option("dataSource",w(t.ChildSummaries()));hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product lot data."),"Download Product Lot Failed");t.ChildSummaries([]);u.option("dataSource",w(t.ChildSummaries()));hideLoadingPanel()})}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product data."),"Download Product Failed");t.ChildSummaries([]);u.option("dataSource",w(t.ChildSummaries()));hideLoadingPanel()}));g=!1}}},{dataField:"PIC",label:{text:"PIC"},validationRules:[{type:"required"}],colSpan:2,editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1},{dataField:"ReferenceNumber",label:{text:"Reference Number"},colSpan:3,editorOptions:{maxLength:30,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AttachmentFile",label:{text:"Attachment File"},colSpan:2,editorOptions:{onEnterKey:function(){i.events.performOK(this)}}}]}],h=new Dismoyo_Ciptoning_Client.CommonPopupIFrame,h.okOptions.visible=!1,h.cancelOptions.text="Close",r=new Dismoyo_Ciptoning_Client.ProductLotPopupEdit,r.formOptions.colCount=4,r.saveOptions.icon="icons8-save",r.events.performSave=function(){oi()},r.events.performDeleteRows=function(){for(var u,h=r.popupEditOptions.itemStatusID,c=o(h),f=r.dataGrid(),e=f.option("dataSource"),s=f.getSelectedRowsData(),t="",i=[],n=0;n<s.length;n++){if(u=s[n],DXUtility.getValue(u,c.qtyOnHandColumn)>0){t==""?t="Following product lot code cannot be deleted due to the On Hand Qty (Pcs) is greater than 0: ":t+=", ";t+=DXUtility.getValue(u,"ProductLotCode");continue}i.push({ProductID:DXUtility.getValue(u,"ProductID"),ProductLotID:DXUtility.getValue(u,"ProductLotID")})}for(n=0;n<i.length;n++)e.store().remove(i[n]).done(function(){n>=i.length-1&&e.load().done(function(){f.refresh()})}).fail(function(){n>=i.length-1&&e.load().done(function(){f.refresh()})});t!=""&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(t),"Delete Product Lot")},r.dataGridOptions.onInitNewRow=function(n){var i=r.popupEditOptions.itemStatusID,t=o(i);n.data[t.qtyOpnameColumn]=0;n.data[t.qtyOpnameConvColumn]="0/0/0"},r.dataGridOptions.onEditorPreparing=function(n){if(n.parentType=="dataRow")if(n.dataField=="ProductLotCode")n.row.inserted?n.editorElement.dxLookup({dataSource:new DevExpress.data.DataSource({store:l,filter:["ProductID","=",r.popupEditData().ProductID()],sort:[{getter:"ProductLotExpiredDate",desc:!0}]}),displayExpr:"ProductLotCode",valueExpr:"ProductLotCode",searchExpr:"ProductLot",searchPlaceholder:"Lot Number",popupWidth:"582px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){var t=r.popupEditOptions.itemStatusID;CommonUtility.createProductLotLookupHeader("vStockOpnames_productLotIDLookup",n.element,t)},itemTemplate:function(n,t,i){var u=r.popupEditOptions.itemStatusID,f=o(u);return CommonUtility.createProductLotLookupItem(n,i,f.qtyOnHandColumn)},onValueChanged:function(t){var i,e,u,f;t.value&&(i=this.option("selectedItem"),i&&(e=r.popupEditOptions.itemStatusID,u=o(e),n.component.cellValue(n.row.rowIndex,"QtyOnHand",i[u.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"QtyOnHandGood",i.QtyOnHandGood()),DXUtility.setValue(n.row.data,"QtyOnHandHold",i.QtyOnHandHold()),DXUtility.setValue(n.row.data,"QtyOnHandBad",i.QtyOnHandBad()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductLotID",i.ProductLotID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductLotCode",i.ProductLotCode()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),f=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyOpnameConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,u.qtyOpnameColumn,f.qtyTransaction),DXUtility.setValue(n.row.data,u.qtyConvLColumn,f.qtyConvL),DXUtility.setValue(n.row.data,u.qtyConvMColumn,f.qtyConvM),DXUtility.setValue(n.row.data,u.qtyConvSColumn,f.qtyConvS)));n.component.cellValue(n.row.rowIndex,"ProductLotCode",t.value);n.setValue(t.value)}}):(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.ProductLotCode()))),n.cancel=!0;else if(n.name=="QtyOpnameConv"){var t="";n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,n.dataField.replace("QtyOpnameConv","QtyOpname"),i.qtyTransaction);DXUtility.setValue(n.row.data,n.dataField.replace("QtyOpnameConv","QtyConvL"),i.qtyConvL);DXUtility.setValue(n.row.data,n.dataField.replace("QtyOpnameConv","QtyConvM"),i.qtyConvM);DXUtility.setValue(n.row.data,n.dataField.replace("QtyOpnameConv","QtyConvS"),i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}});n.cancel=!0}},r.dataGridOptions.onRowInserted=function(n){CommonUtility.validateDataGridInsertedTransactionDetails(n.component,new Dismoyo_Ciptoning_Client.vStockOpnameDetailsViewModel(n.data).toJS())},r.dataGridOptions.onRowRemoved=function(n){CommonUtility.validateDataGridRemovedTransactionDetails(n.component,n.data.toJS())},r.dataGridOptions.onRowUpdating=function(n){var i=r.popupEditOptions.itemStatusID,t=o(i);CommonUtility.validateDataGridUpdatingTransactionDetails(n,t.qtyConvLColumn,t.qtyConvMColumn,t.qtyConvSColumn,t.qtyOpnameConvColumn,t.qtyOpnameColumn)},r.dataGridOptions.onRowRemoving=function(n){var t=r.popupEditOptions.itemStatusID,i=o(t);n.data[i.qtyOnHandColumn]()>0&&(DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Deleting product lot is not allowed when Qty On Hand (Pcs) is greater than 0."),"Delete Product Lot Failed"),n.cancel=!0)},r.dataGridOptions.onRowValidating=function(n){var f=r.popupEditOptions.itemStatusID,t=o(f),u=DXUtility.getValue(n.newData,t.qtyOnHandColumn),i;u==undefined&&(u=DXUtility.getValue(n.oldData,t.qtyOnHandColumn));i=DXUtility.getValue(n.newData,t.qtyOpnameColumn);i==undefined&&(i=DXUtility.getValue(n.oldData,t.qtyOpnameColumn));u==0&&i<=0&&(n.errorText="Opname Qty must be greater than 0 when On Hand Qty is 0.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.onDataErrorOccurred=function(n){var t=n.component._controllers.editing._editData[0].data.ProductLotCode;switch(n.error.__id){case"E4008":n.error.message="Lot Number '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.summary={totalItems:[{name:"TotalQtyPcs",showInColumn:"QtyOpnameConv",displayFormat:"Total Qty (Pcs): {0}",valueFormat:"decimal",summaryType:"custom"},{name:"TotalQtyLMS",showInColumn:"QtyOpnameConv",displayFormat:"(L/M/S): {0}",valueFormat:"string",summaryType:"custom"}],calculateCustomSummary:function(n){var i=r.popupEditOptions.itemStatusID,t=o(i);CommonUtility.updateProductLotEditingSummary(n,t.qtyOpnameConvColumn,t.qtyOpnameColumn)}},r.dataGridOptions.columns=[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"ProductLotID",visible:!1},{dataField:"ProductLotCode",caption:"Lot Number",validationRules:[{type:"required"}]},{name:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"180px",allowEditing:!1,dataType:"number"},{name:"QtyOpnameConv",caption:"Opname Qty (L/M/S)",width:"180px",alignment:"right",validationRules:[{type:"required"},p]}],r.formOptions.items=[{itemType:"group",caption:"Product",colCount:4,colSpan:4,items:[{dataField:"Product",label:{text:"Product"},colSpan:4,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOnHand",label:{text:"On Hand Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2},{dataField:"QtyOpname",label:{text:"Opname Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOpnameConv",label:{text:"(L/M/S)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],{isReady:ut.promise(),dataSource:s,refreshList:st,viewShowing:dt,viewDisposing:gt,openCreateViewAsRoot:kt,icon:"Images/stock_opname_32px.png",dataSource_vStockOpnameDetails:ni,dataSource_vStockOpnameSummary:ti,dataSource_vStockOnHandAll:l,dataSource_vStockOnHandAllByProduct:a,collapsibleFilter:u,commonGridView:e,commonPopupEdit:i,commonPopupIFrame:h,productLotPopupEdit:r,stockOpnameSummaryDataGrid:f,stockOpnamePrint:vt,stockOpnamePost:yt,stockOpnameDiscard:pt,stockOpnameSaveAsDraftAndNew:wt,isLotNumberEntryRequired:c}};Dismoyo_Ciptoning_Client.vStockReceives=function(n,t){"use strict";function tt(){w=!0}function it(){a=CommonUtility.configureCommonGridViewLayout("vStockReceives");a||setTimeout(it,50)}function pt(){var n,t;it();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],o.filter(t));nt()?w&&rt():(nt(o),o.load().always(function(){g.resolve()}))}function wt(){Dismoyo_Ciptoning_Client.DB.vStockReceives.off("modified",tt)}function rt(){w=!1;o.pageIndex(0);o.load()}function ft(n){return(n?n:"(Site Code)")+"-YY-12-(Auto Generated)"}function et(n,t){t?Dismoyo_Ciptoning_Client.DB.vSites.byKey(t).done(function(n){s=n.IsLotNumberEntryRequired}):s=undefined;var i=DataUtility.GetLookupWarehouseDataSource([["SiteID","=",t],"and",["TypeID","=",1]]);n.getEditor("WarehouseID").option("value",null);n.getEditor("WarehouseID").option("dataSource",[]);i.load().done(function(){n.getEditor("WarehouseID").option("dataSource",i)})}function ot(n){CommonUtility.updateSummariesArrayStore(f().option("dataSource").store(),n)}function dt(n,t){CommonUtility.updateDeferSummariesArrayStore(f().option("dataSource").store(),n,t)}function gt(n){return CommonUtility.validateSummaryArrayStore(f().option("dataSource").store(),"vStockReceiveSummaryViewModel",n)}function st(n){return CommonUtility.createArrayDataSource("vStockReceiveSummaryViewModel",["ProductID"],n)}function ni(n,t,i){var r=$('<div class="dx-command-edit" style="text-align: right; padding-right: 5px;">'),o;if(r.append($('<a style="color: inherit;">').text(n[t]())),r.append("&nbsp;"),s){var u=t.replace("Conv",""),h=n[u](),f=n.ChildDetails(),e=0;for(o in f)e+=f[o][u]();r.append($('<a class="dx-link dxcustom-linkbutton dx-icon-icons8-view-details" title="Edit Lot Number">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<\/a><span id="LotMark_'+n.ProductID()+"_"+t+'" class="dx-icon-overflow '+(e==h?"hidden":"")+'" style="color:red; font-size: 14px; margin-left: -6px;"><\/span>').on("dxclick",function(){p(function(){ii(n,i)})}));r.append("&nbsp;")}return r}function ti(n){var t=f().option("editing"),i=f().option("selection");i.mode=n?"multiple":"none";t.allowUpdating=n;t.allowDeleting=n;f().option("editing",t);f().option("selection",i);ui().option("disabled",!n);vt().option("disabled",!0);f().repaint()}function b(n,t){showLoadingPanel();Dismoyo_Ciptoning_Client.DB.vStockReceives.byKey(n,{expand:["ChildSummaries/ChildDetails"]}).done(function(n){hideLoadingPanel();l=t;k(new Dismoyo_Ciptoning_Client.vStockReceiveViewModel(n))}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function k(n){var e=!1,u,t,o,a,c,v,y,l,w,b,nt,k;n||(n=new Dismoyo_Ciptoning_Client.vStockReceiveViewModel,e=!0);i.popupEditData(n);i.popupEdit().option("title",(e?"New":"Edit")+" Stock Receival");i.popupEditOptions.editingKey=n.DocumentID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);u=Dismoyo_Ciptoning_Client.app.CurrentUser;t=i.form();DXUtility.resetFormValidation(t);var g=n.DocumentCode(),r=!1,h=[];if(s=n.IsSiteLotNumberEntryRequired(),e)n.DocumentID(new DevExpress.data.Guid),n.DocumentStatusID(null),n.TerritoryID(u.TerritoryID()),n.RegionID(u.RegionID()),n.AreaID(u.AreaID()),n.SiteID(u.SiteID()),n.SiteCode(u.SiteCode()),n.CompanyID(u.CompanyID()),n.Company(u.Company()),g=ft(n.SiteCode());else if(h=n.ChildSummaries(),n.DocumentStatusID()!=1||s)(n.DocumentStatusID()==2||n.DocumentStatusID()==3)&&(r=!0);else{for(o=[],a=0,c=0;c<h.length;c++){for(v=h[c].ChildDetails(),y=0,l=0;l<v.length;l++)v[l].ProductLotCode().indexOf("DUMMY")<0&&y++;y>0&&(o[a]=h[c],a++)}o.length>0&&p(function(){for(var t,n=0;n<o.length;n++)t={data:o[n].toJS()},d(t,o)})}ti(!r);ct().option("disabled",e||r);lt().option("disabled",e||r);at().option("disabled",r);i.ok().option("disabled",r);t.itemOption("Organization").visible&&(t.getEditor("TerritoryID").option("value",n.TerritoryID()),t.getEditor("RegionID").option("value",n.RegionID()),t.getEditor("AreaID").option("value",n.AreaID()),t.getEditor("SiteID").option("value",n.SiteID()),t.getEditor("Company").option("value",n.Company()),t.getEditor("TerritoryID").option("readOnly",r),t.getEditor("RegionID").option("readOnly",r),t.getEditor("AreaID").option("readOnly",r),t.getEditor("SiteID").option("readOnly",r));et(t,n.SiteID());t.getEditor("PrincipalName").option("value","PT. Amerta Indah Otsuka");t.getEditor("DocumentCode").option("value",g);t.getEditor("TransactionDate").option("value",n.TransactionDate());t.getEditor("WarehouseID").option("value",n.WarehouseID());t.getEditor("PIC").option("value",n.PIC());t.getEditor("ReferenceNumber").option("value",n.ReferenceNumber());w=ht();CommonUtility.createEditDataAttachmentFileDownloader("vStockReceives",w,"StockReceives",n.AttachmentFile());w.option("value",null);t.getEditor("DocumentStatusID").option("value",n.DocumentStatusID());t.getEditor("TransactionDate").option("readOnly",r);t.getEditor("WarehouseID").option("readOnly",r);t.getEditor("PIC").option("readOnly",r);t.getEditor("ReferenceNumber").option("readOnly",r);b=$(".dx-fileuploader-input-wrapper");r?b.hide():b.show();nt=new Date;e&&(DXUtility.resetFormValidation(t),t.getEditor("TransactionDate").option("value",nt));k=f();k.cancelEditData();n.ChildSummaries(h);k.option("dataSource",st(n.ChildSummaries()))}function v(n,t){var w,nt,s,d,o,r,u,a,y;showLoadingPanel();var v=i.form(),h=v.validate().isValid,c=h?"":"Please specify the required fields.",tt=e.dataGrid(),it=tt.option("dataSource"),g=f().option("dataSource"),p=[];for(r=0;r<g.store()._array.length;r++)p.push(new Dismoyo_Ciptoning_Client.vStockReceiveSummaryViewModel(g.store()._array[r]));if(h&&p.length<1&&(c="Please specify at least one item in Receival Details.",h=!1),h)for(r=0;r<p.length;r++){for(u=p[r],w=0,a=0;a<u.ChildDetails().length;a++)y=u.ChildDetails()[a],w+=y.QtyReceive();u.QtyReceive()!=w&&(c==""?c="Following products quantity of Receival Details items is not matched: ":c+=", ",c+=u.Product(),h=!1)}if(h&&$(".dx-fileuploader-button.dx-fileuploader-upload-button.dx-widget.dx-button-has-icon.dx-button.dx-button-normal").length>0&&(c="You have selected an attachment file. Please upload or cancel the attachment file.",h=!1),nt=Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID(),v.itemOption("Organization").visible&&(nt=v.getEditor("SiteID").option("value")),h){for(s=i.popupEditData(),s.TransactionDate(v.getEditor("TransactionDate").option("value")),s.WarehouseID(v.getEditor("WarehouseID").option("value")),s.PIC(v.getEditor("PIC").option("value")),s.ReferenceNumber(v.getEditor("ReferenceNumber").option("value")),d=ht(),s.AttachmentFile(d.option("values").length>0?d.fileName:null),s.ChildSummaries(p),o=ko.toJS(s),n&&(o.DocumentStatusID=n),o.DocumentStatusID||(o.DocumentStatusID=1),o.TransactionDate=DateTimeUtility.getFirstTimeOfDay(o.TransactionDate),r=0;r<o.ChildSummaries.length;r++){for(u=o.ChildSummaries[r],u.DocumentID=o.DocumentID,a=0;a<u.ChildDetails.length;a++)y=u.ChildDetails[a],y.DocumentID=o.DocumentID,y.Qty=y.QtyReceive*-1;u.Qty=u.QtyReceive*-1}it.store().insert(o).done(function(n){CommonUtility.documentSuccessMessage(n.DocumentStatusID,function(){});l=!0;switch(t){case 1:i.events.performCancel();hideLoadingPanel();break;case 2:k(null);hideLoadingPanel();break;case 3:b(s.DocumentID(),!0)}}).fail(function(n){DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})}else hideLoadingPanel();c!=""&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(c),"Save Failed")}function y(n){var t=null;switch(n){case 1:t="Good";break;case 2:t="Hold";break;case 3:t="Bad"}var i="QtyOnHand"+t,r="QtyConvL"+t,u="QtyConvM"+t,f="QtyConvS"+t,e="QtyReceive"+t,o="QtyReceiveConv"+t;return{itemStatusName:t,qtyOnHandColumn:i,qtyConvLColumn:r,qtyConvMColumn:u,qtyConvSColumn:f,qtyReceiveColumn:e,qtyReceiveConvColumn:o}}function ii(n,t){var o=i.popupEditData(),f,h;r.popupEditData(n);r.popupEditOptions.editingKey=n.ProductID();r.popupEditOptions.itemStatusID=t;r.popupEditOptions.visible(!0);var s=r.dataGrid(),e=r.form(),u=!1;(o.DocumentStatusID()==2||o.DocumentStatusID()==3)&&(u=!0);f=r.dataGrid().option("editing");f.allowUpdating=!u;f.allowDeleting=!u;f.editEnabled=!u;f.removeEnabled=!u;r.dataGrid().option("editing",f);r.dataGrid().option("selection",{mode:u?"none":"multiple"});r.newRow().option("disabled",u);r.dataGrid().repaint();e.getEditor("Product").option("value",n.Product());e.getEditor("QtyOnHand").option("value",n.QtyOnHand());e.getEditor("QtyReceiveConv").option("value",n.QtyReceiveConv());e.getEditor("QtyReceive").option("value",n.QtyReceive());n=gt(n);h=CommonUtility.createArrayDataSource("vStockReceiveDetailsViewModel",["ProductID","ProductLotID"],ko.toJS(n.ChildDetails()));s.cancelEditData();s.option("dataSource",h)}function d(n,t){var l,u,a,o,r,v,c;if(!s){var p=i.popupEditData(),y=f(),e=[];if(t){for(r=0;r<t.length;r++)t[r].ChildDetails([]);e=t}else for(l=y.option("dataSource").store(),r=0;r<l._array.length;r++)e.push(new Dismoyo_Ciptoning_Client.vStockReceiveSummaryViewModel(l._array[r]));if(u=n.data,a=$.grep(h,function(n){return n.ProductID()==DXUtility.getValue(u,"ProductID")&&n.ProductLotCode().indexOf("DUMMY")>=0}),a.length>0)for(o=a[0],DXUtility.setValue(u,"ProductLotID",o.ProductLotID()),DXUtility.setValue(u,"ProductLotCode",o.ProductLotCode()),DXUtility.setValue(u,"QtyOnHandGood",o.QtyOnHandGood()),DXUtility.setValue(u,"QtyOnHandHold",o.QtyOnHandHold()),DXUtility.setValue(u,"QtyOnHandBad",o.QtyOnHandBad()),r=0;r<e.length;r++)e[r].ProductID()==DXUtility.getValue(u,"ProductID")&&(v=$.grep(e[r].ChildDetails(),function(n){return n.ProductLotID()==DXUtility.getValue(u,"ProductLotID")}),v.length>0?(c=v[0],c.QtyConvL(DXUtility.getValue(u,"QtyConvL")),c.QtyConvM(DXUtility.getValue(u,"QtyConvM")),c.QtyConvS(DXUtility.getValue(u,"QtyConvS")),c.QtyReceive(DXUtility.getValue(u,"QtyReceive")),c.QtyReceiveConv(DXUtility.getValue(u,"QtyReceiveConv"))):e[r].ChildDetails().push(new Dismoyo_Ciptoning_Client.vStockReceiveDetailsViewModel(u)),ot(e[r]));else DevExpress.ui.dialog.alert("DUMMY Lot Number for the selected product is not available.","Save Failed")}}function ri(){var n=r.popupEditData(),t=r.popupEditOptions.itemStatusID,i=y(t);CommonUtility.validateProductLotEditing(n,r.dataGrid().option("dataSource"),r.form().getEditor("QtyReceive").option("value"),"Receive","vStockReceiveDetailsViewModel","QtyConvL","QtyConvM","QtyConvS","QtyReceiveConv","QtyReceive",!1)&&(ot(n),r.popupEditOptions.visible(!1),f().refresh())}function p(n){if(h.length==0&&c.length==0){showLoadingPanel();var t=i.form();new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vProducts,select:["ID","Code","Product","UOMLID","UOMMID","UOMSID","ConversionL","ConversionM","ConversionS"],sort:["ID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vProductViewModel(n)}}).load().done(function(i){var f=i,r=t.getEditor("WarehouseID").option("value"),u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOnHandAlls,select:["ProductID","ProductLotID","ProductLotCode","ProductLot","ProductLotExpiredDate","QtyOnHandGood"],filter:[["WarehouseID","=",r]],sort:["WarehouseID","ProductID","ProductLotID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOnHandAllViewModel(n)}});u.load().done(function(t){for(var e,s,u=null,o=[],r=[],f=0;f<t.length;f++)o.push(new Dismoyo_Ciptoning_Client.vStockOnHandAllViewModel(t[f].toJS())),e=r.length-1,s=t[f].ProductID(),f==0||r[e].ProductID()!=s?(r.push(new Dismoyo_Ciptoning_Client.vStockOnHandAllViewModel(t[f].toJS())),e++,u=$.grep(i,function(n){return n.ID()==s})):(r[e].QtyOnHandGood(r[e].QtyOnHandGood()+t[f].QtyOnHandGood()),r[e].QtyOnHandHold(r[e].QtyOnHandHold()+t[f].QtyOnHandHold()),r[e].QtyOnHandBad(r[e].QtyOnHandBad()+t[f].QtyOnHandBad())),o[f].ProductCode(u[0].Code()),o[f].Product(u[0].Product()),o[f].ProductUOMLID(u[0].UOMLID()),o[f].ProductUOMMID(u[0].UOMMID()),o[f].ProductUOMSID(u[0].UOMSID()),o[f].ProductConversionL(u[0].ConversionL()),o[f].ProductConversionM(u[0].ConversionM()),o[f].ProductConversionS(u[0].ConversionS()),r[e].ProductCode(u[0].Code()),r[e].Product(u[0].Product()),r[e].ProductUOMLID(u[0].UOMLID()),r[e].ProductUOMMID(u[0].UOMMID()),r[e].ProductUOMSID(u[0].UOMSID()),r[e].ProductConversionL(u[0].ConversionL()),r[e].ProductConversionM(u[0].ConversionM()),r[e].ProductConversionS(u[0].ConversionS());h=o;c=r;n();hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product lot data."),"Download Product Lot Failed");hideLoadingPanel()})}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product data."),"Download Product Failed");hideLoadingPanel()})}else n()}var w=!1,yt=t.layoutController.name==="split",g=$.Deferred(),nt=ko.observable(),o,l,s,a,u,e,i,r;o=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockReceives,map:function(n){return new Dismoyo_Ciptoning_Client.vStockReceiveViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vStockReceives.on("modified",tt);var bt=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockReceiveDetails,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockReceiveDetailsViewModel(n)}}),kt=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockReceiveSummaries,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockReceiveSummaryViewModel(n)}}),h,c,ut={type:"pattern",pattern:"(^[0-9]*$)|(^[0-9]*/[0-9]*$)|(^[0-9]*/[0-9]*/[0-9]*$)",message:"Format must be L/M/S or M/S or S."};u=new Dismoyo_Ciptoning_Client.CollapsibleFilter;u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){a&&a.resizeAll()})};u.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Warehouse"])}}}]},{itemType:"group",caption:"Stock Receival",colCount:3,colSpan:3,items:[{dataField:"WarehouseID",label:{text:"Warehouse"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{name:"DocumentCode",dataField:"",label:{text:"Document Number"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateFrom",label:{text:"Transaction Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateTo",label:{text:"Transaction Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"PIC",label:{text:"PIC"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}}]}];u.events.performSearch=function(){var f=e.dataGrid(),t=u.form(),n=[],i;f.clearFilter();var r=Dismoyo_Ciptoning_Client.app.CurrentUser,o=r.TerritoryID(),s=r.RegionID(),h=r.AreaID(),c=r.CompanyID(),l=r.SiteID();t.itemOption("Organization").visible&&(o=t.getEditor("TerritoryID").option("value"),s=t.getEditor("RegionID").option("value"),h=t.getEditor("AreaID").option("value"),c=t.getEditor("CompanyID").option("value"),l=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",o,"and");DXUtility.addFilterExpression(n,"RegionID","=",s,"and");DXUtility.addFilterExpression(n,"AreaID","=",h,"and");DXUtility.addFilterExpression(n,"CompanyID","=",c,"and");DXUtility.addFilterExpression(n,"SiteID","=",l,"and");i=t.getEditor("WarehouseID").option("value");DXUtility.addFilterExpression(n,"WarehouseID","=",i,"and");i=t.getEditor("DocumentCode").option("value");DXUtility.addFilterExpression(n,"DocumentCode","contains",i,"and");i=t.getEditor("TransactionDateFrom").option("value");DXUtility.addFilterExpression(n,"TransactionDate",">=",i,"and");i=t.getEditor("TransactionDateTo").option("value");DXUtility.addFilterExpression(n,"TransactionDate","<=",i,"and");i=t.getEditor("PIC").option("value");DXUtility.addFilterExpression(n,"PIC","contains",i,"and");i=t.getEditor("DocumentStatusID").option("value");DXUtility.addFilterExpression(n,"DocumentStatusID","=",i,"and");n.length>0?f.filter(n):f.refresh()};e=new Dismoyo_Ciptoning_Client.CommonGridView;e.dataGridOptions.dataSource=o;e.dataGridOptions.editing.editEnabled=!1;e.dataGridOptions.editing.removeEnabled=!1;e.dataGridOptions.selection.mode="single";e.deleteRowsOptions.visible=!1;e.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("StockReceives.AddNewStockReceive");e.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("StockReceives.EditStockReceive");e.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"Site",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"DocumentCode",caption:"Document Number",width:"140px",sortOrder:"desc",headerCellTemplate:function(n,t){var u=$("#vStockReceives_commonGridView").find(".dx-datagrid:first-child"),i,r,f,e;!u.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r=Dismoyo_Ciptoning_Client.app.CurrentUser,r.IsHeadOffice()&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',f=r.isAuthorized("StockReceives.EditStockReceive"),f&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",e=u.find(".dx-header-row:first-child"),$(i).insertBefore(e[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},cellTemplate:function(n,t){var u=Dismoyo_Ciptoning_Client.app.CurrentUser,f=u.isAuthorized("StockReceives.EditStockReceive"),i=$('<div class="dx-command-edit" style="text-align: left;">'),r=$("<b>").text(t.data.DocumentCode());f&&(r=$('<a class="dx-link">').text(t.data.DocumentCode()).on("dxclick",function(){b(t.data.DocumentID(),!1)}));i.append(r);i.append("&nbsp;");n.append(i)}},{dataField:"TransactionDate",caption:"Transaction Date",width:"100px",customizeText:function(n){return n.value?n.value.toLocaleDateString():null}},{dataField:"Warehouse",caption:"Warehouse",width:"200px"},{dataField:"ReferenceNumber",caption:"Reference Number",width:"120px"},{dataField:"PIC",caption:"PIC",width:"180px"},{dataField:"DocumentStatusName",caption:"Status",width:"80px"},{dataField:"PostedDate",caption:"Posted Date",width:"100px",customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleDateString():null}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}];e.dataGridOptions.editing.allowUpdating&&e.dataGridOptions.columns.push({width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){b(t.data.DocumentID(),!1)}));i.append("&nbsp;");n.append(i)}});i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.okOptions.text="Save";i.okOptions.icon="icons8-save";var ht=function(){return DXUtility.getDXInstance(null,"#vStockReceives_editDataAttachmentFile","dxFileUploader")},f=function(){return DXUtility.getDXInstance(null,"#vStockReceives_stockReceiveSummaryDataGrid","dxDataGrid")},ct=function(){return DXUtility.getDXInstance(null,"#vStockReceives_stockReceivePost","dxButton")},lt=function(){return DXUtility.getDXInstance(null,"#vStockReceives_stockReceiveDiscard","dxButton")},at=function(){return DXUtility.getDXInstance(null,"#vStockReceives_stockReceiveSaveAsDraftAndNew","dxButton")},ui=function(){return DXUtility.getDXInstance(null,"#vStockReceives_stockReceiveSummaryNewRow","dxButton")},vt=function(){return DXUtility.getDXInstance(null,"#vStockReceives_stockReceiveSummaryDeleteRows","dxButton")};return i.popupEditOptions.onContentReady=function(){var u=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop("Receival Details"));var t=$('<div class="desktop-commonGridView-commands">'),e=$('<div id="vStockReceives_stockReceiveSummaryNewRow">').dxButton({text:"New",icon:"add",onClick:function(){var n=i.form().validate().isValid;n?p(function(){f().addRow()}):DevExpress.ui.dialog.alert("Please specify the required fields.","New Receival Details Failed")}}),o=$('<div id="vStockReceives_stockReceiveSummaryDeleteRows">').dxButton({text:"Delete",icon:"remove",disabled:!0,onClick:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(n){n&&DXUtility.deleteSelectedRows(f())})}});t.append(e);t.append(o);n.append(t);n.append($('<div id="vStockReceives_stockReceiveSummaryDataGrid">').dxDataGrid({deferRendering:!1,dataSource:[],showBorders:!0,paging:{enabled:!1},allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,selection:{mode:"multiple",allowSelectAll:!0},editing:{editMode:"row",allowAdding:!1,allowUpdating:!0,allowDeleting:!0},onInitNewRow:function(n){n.data.QtyReceive=0;n.data.QtyReceiveConv="0/0/0"},onSelectionChanged:function(n){vt().option("disabled",!n.selectedRowsData.length)},onEditorPreparing:function(n){if(n.parentType=="dataRow")if(n.dataField=="Product")n.row.inserted?n.editorElement.dxLookup({dataSource:c,displayExpr:"Product",valueExpr:"Product",searchExpr:"Product",searchPlaceholder:"Product",popupWidth:"712px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){CommonUtility.createProductLookupHeader("vStockReceives_productIDLookup",n.element,1)},itemTemplate:function(n,t,i){return CommonUtility.createProductLookupItem(n,i,1)},onValueChanged:function(t){var i,r;t.value&&(i=this.option("selectedItem"),i&&(n.component.cellValue(n.row.rowIndex,"QtyOnHand",i.QtyOnHand()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),r=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyReceiveConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyReceive",r.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",r.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",r.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",r.qtyConvS)));n.component.cellValue(n.row.rowIndex,"Product",t.value);n.setValue(t.value)}}):(p(function(){}),n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Product()))),n.cancel=!0;else if(n.dataField=="QtyReceiveConv"){var t="";n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onEnterKey:function(){f().saveEditData()},onValueChanged:function(t){var r,u,i,f,e;if(DXUtility.getValue(n.row.data,"Product")==undefined&&(t.value=""),t.value.indexOf("/")>-1){for(r=0,u=t.value.split("/"),i=0;i<u.length;i++){if(u[i]=="")break;f=parseInt(u[i]);i==0?r+=f*DXUtility.getValue(n.row.data,"ProductConversionL"):i==1?u.length==2&&DXUtility.getValue(n.row.data,"Product").indexOf("Single")>-1?r+=f:DXUtility.getValue(n.row.data,"ProductConversionM")!=null&&(r+=f*DXUtility.getValue(n.row.data,"ProductConversionM")):i==2&&(r+=f)}t.value=r+"";DXUtility.setValue(n.row.data,n.dataField.replace("QtyReceiveConv","QtyReceive"),r)}e=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,n.dataField.replace("QtyReceiveConv","QtyConvL"),e.qtyConvL);DXUtility.setValue(n.row.data,n.dataField.replace("QtyReceiveConv","QtyConvM"),e.qtyConvM);DXUtility.setValue(n.row.data,n.dataField.replace("QtyReceiveConv","QtyConvS"),e.qtyConvS);t.value=e.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}});n.cancel=!0}},onRowInserted:function(n){CommonUtility.validateDataGridInsertedTransactionSummary(n.component,new Dismoyo_Ciptoning_Client.vStockReceiveSummaryViewModel(n.data).toJS());d(n);f().clearSelection()},onRowUpdated:function(n){n.data.ProductID=n.key.ProductID;d(n);f().clearSelection()},onRowRemoved:function(n){CommonUtility.validateDataGridRemovedTransactionSummary(n.component,n.data.toJS())},onRowUpdating:function(n){if(n.newData.QtyReceiveConv){var t=CommonUtility.getConversion(n.newData.QtyReceiveConv,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS"));n.newData.QtyConvL=t.qtyConvL;n.newData.QtyConvM=t.qtyConvM;n.newData.QtyConvS=t.qtyConvS;n.newData.QtyReceive=t.qtyTransaction}dt(n.oldData.ProductID(),n.newData)},onRowValidating:function(n){var t=DXUtility.getValue(n.newData,"QtyReceive");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyReceive"));t<=0&&(n.errorText="Receival Qty must be greater than 0.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},onDataErrorOccurred:function(n){var t=n.component._controllers.editing._editData[0].data.Product;switch(n.error.__id){case"E4008":n.error.message="Product '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},columns:[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"Product",caption:"Product",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var u=$(f().element()),r,i,e;!u.find(".datagrid-bandedHeader:first").length>0&&(r=f().option("selection").mode=="none"?!1:!0,i='<tr class="dx-row dx-column-lines datagrid-bandedHeader" style="border-top-style: none !important;">',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",e=u.find(".dx-header-row:first-child"),$(i).insertBefore(e[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"150px",allowEditing:!1,dataType:"number"},{dataField:"QtyReceiveConv",caption:"Receival Qty (L/M/S)",width:"180px",alignment:"right",validationRules:[{type:"required"},ut],cellTemplate:function(n,t){n.append(ni(t.data,"QtyReceiveConv",1))}}]}));var r=$("#commonPopupEdit_extCommands"),s=$('<div id="vStockReceives_stockReceivePost">').dxButton({text:"Post",icon:"icons8-check-green",onClick:function(){i.events.performPost(this)}}),h=$('<div id="vStockReceives_stockReceiveDiscard" style="margin-right: 16px;">').dxButton({text:"Discard",icon:"icons8-trash-red",onClick:function(){i.events.performDiscard(this)}}),l=$('<div id="vStockReceives_stockReceiveSaveAsDraftAndNew">').dxButton({text:"Save & New",icon:"icons8-save",onClick:function(){i.events.performSaveAsDraftAndNew(this)}});u.append(DXUtility.createFormItemGroupWithCaption("").append(n));r.append(s);r.append(h);r.append(l)},e.events.performNewRow=function(){k(null)},i.events.performOK=function(){v(null,3)},i.events.performPost=function(){DevExpress.ui.dialog.confirm("Are you sure want to Post this transaction?","Post Confirmation").done(function(n){n&&v(2,3)})},i.events.performDiscard=function(){DevExpress.ui.dialog.confirm("Are you sure want to Discard this transaction?","Discard Confirmation").done(function(n){n&&v(3,3)})},i.events.performSaveAsDraftAndNew=function(){v(1,2)},i.formOptions.customizeItem=function(n){n.dataField=="AttachmentFile"&&(n.template=function(n,t){t.append(CommonUtility.createEditDataAttachmentFileUploader("vStockReceives","StockReceives"))})},i.events.performCancel=function(){i.popupEditOptions.visible(!1);l&&(e.dataGrid().refresh(),l=!1)},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form(),r,u;CommonUtility.cascadeValueChanged(t,n.selectedItem,n.value,"Site",["Area","Region","Territory"],[]);r="";u=null;n.selectedItem&&(r=ft(n.selectedItem.Code()),u=n.selectedItem.Company());t.getEditor("Company").option("value",u);et(t,n.value);t.getEditor("DocumentCode").option("value",r)}}}]},{itemType:"group",caption:"Stock Receival",colCount:6,colSpan:3,items:[{dataField:"DocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"TransactionDate",label:{text:"Transaction Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},colSpan:1,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"NEW",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"WarehouseID",label:{text:"Warehouse"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){if(h=[],c=[],n.value){var t=i.popupEditData(),r=f();r.cancelEditData();t.ChildSummaries([]);r.option("dataSource",st(t.ChildSummaries()))}}}},{dataField:"PIC",label:{text:"PIC"},validationRules:[{type:"required"}],colSpan:2,editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1},{dataField:"PrincipalName",label:{text:"Principal"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:3},{dataField:"ReferenceNumber",label:{text:"Reference Number"},colSpan:3,editorOptions:{maxLength:30,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AttachmentFile",label:{text:"Attachment File"},colSpan:2,editorOptions:{onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1}]}],r=new Dismoyo_Ciptoning_Client.ProductLotPopupEdit,r.formOptions.colCount=4,r.saveOptions.icon="icons8-save",r.events.performSave=function(){ri()},r.dataGridOptions.onInitNewRow=function(n){n.data.QtyReceive=0;n.data.QtyReceiveConv="0/0/0"},r.dataGridOptions.onEditorPreparing=function(n){if(n.parentType=="dataRow")if(n.dataField=="ProductLotCode")n.row.inserted?n.editorElement.dxLookup({dataSource:new DevExpress.data.DataSource({store:h,filter:["ProductID","=",r.popupEditData().ProductID()],sort:[{getter:"ProductLotExpiredDate",desc:!0}]}),displayExpr:"ProductLotCode",valueExpr:"ProductLotCode",searchExpr:"ProductLotCode",searchPlaceholder:"Lot Number",popupWidth:"602px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){var t=r.popupEditOptions.itemStatusID;CommonUtility.createProductLotLookupHeader("vStockReceives_productLotIDLookup",n.element,t)},itemTemplate:function(n,t,i){var u=r.popupEditOptions.itemStatusID,f=y(u);return CommonUtility.createProductLotLookupItem(n,i,f.qtyOnHandColumn)},onValueChanged:function(t){var i,e,f,u;t.value&&(i=this.option("selectedItem"),i&&(e=r.popupEditOptions.itemStatusID,f=y(e),n.component.cellValue(n.row.rowIndex,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"QtyOnHand",i[f.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductLotID",i.ProductLotID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductLotCode",i.ProductLotCode()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),u=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyReceiveConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,"QtyReceive",u.qtyTransaction),DXUtility.setValue(n.row.data,"QtyConvL",u.qtyConvL),DXUtility.setValue(n.row.data,"QtyConvM",u.qtyConvM),DXUtility.setValue(n.row.data,"QtyConvS",u.qtyConvS)));n.component.cellValue(n.row.rowIndex,"ProductLotCode",t.value);n.setValue(t.value)}}):(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.ProductLotCode()))),n.cancel=!0;else if(n.dataField=="QtyReceiveConv"){var t="";n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyReceive",i.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvL",i.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvM",i.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvS",i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}});n.cancel=!0}},r.dataGridOptions.onRowInserted=function(n){CommonUtility.validateDataGridInsertedTransactionDetails(n.component,new Dismoyo_Ciptoning_Client.vStockReceiveDetailsViewModel(n.data).toJS())},r.dataGridOptions.onRowRemoved=function(n){CommonUtility.validateDataGridRemovedTransactionDetails(n.component,n.data.toJS())},r.dataGridOptions.onRowUpdating=function(n){CommonUtility.validateDataGridUpdatingTransactionDetails(n,"QtyConvL","QtyConvM","QtyConvS","QtyReceiveConv","QtyReceive")},r.dataGridOptions.onRowValidating=function(n){var i=r.popupEditOptions.itemStatusID,u=y(i),t=DXUtility.getValue(n.newData,"QtyReceive");t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyReceive"));t<=0&&(n.errorText="Receival Qty must be greater than 0.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.onDataErrorOccurred=function(n){var t=n.component._controllers.editing._editData[0].data.ProductLotCode;switch(n.error.__id){case"E4008":n.error.message="Lot Number '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.summary={totalItems:[{name:"TotalQtyPcs",showInColumn:"QtyReceiveConv",displayFormat:"Total Qty (Pcs): {0}",valueFormat:"decimal",summaryType:"custom"},{name:"TotalQtyLMS",showInColumn:"QtyReceiveConv",displayFormat:"(L/M/S): {0}",valueFormat:"string",summaryType:"custom"}],calculateCustomSummary:function(n){CommonUtility.updateProductLotEditingSummary(n,"QtyReceiveConv","QtyReceive")}},r.dataGridOptions.columns=[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"ProductLotID",visible:!1},{dataField:"ProductLotCode",caption:"Lot Number",validationRules:[{type:"required"}]},{dataField:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"120px",allowEditing:!1,dataType:"number"},{dataField:"QtyReceiveConv",caption:"Receival Qty (L/M/S)",width:"150px",alignment:"right",validationRules:[{type:"required"},ut]}],r.formOptions.items=[{itemType:"group",caption:"Product",colCount:4,colSpan:4,items:[{dataField:"Product",label:{text:"Product"},colSpan:4,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOnHand",label:{text:"On Hand Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2},{dataField:"QtyReceive",label:{text:"Receival Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyReceiveConv",label:{text:"(L/M/S)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],{isReady:g.promise(),dataSource:o,refreshList:rt,viewShowing:pt,viewDisposing:wt,openCreateViewAsRoot:yt,icon:"Images/stock_receive_32px.png",dataSource_vStockReceiveDetails:bt,dataSource_vStockReceiveSummary:kt,dataSource_vStockOnHandAll:h,dataSource_vStockOnHandAllByProduct:c,collapsibleFilter:u,commonGridView:e,commonPopupEdit:i,productLotPopupEdit:r,stockReceiveSummaryDataGrid:f,stockReceivePost:ct,stockReceiveDiscard:lt,stockReceiveSaveAsDraftAndNew:at,isLotNumberEntryRequired:s}};Dismoyo_Ciptoning_Client.vStockTransfers=function(n,t){"use strict";function ut(){k=!0}function ft(){y=CommonUtility.configureCommonGridViewLayout("vStockTransfers");y||setTimeout(ft,50)}function gt(){var n,t;ft();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["SourceTerritoryID","=",n.TerritoryID()],"and",["SourceRegionID","=",n.RegionID()],"and",["SourceAreaID","=",n.AreaID()],"and",["SourceCompanyID","=",n.CompanyID()],"and",["SourceSiteID","=",n.SiteID()]],s.filter(t));rt()?k&&et():(rt(s),s.load().always(function(){it.resolve()}))}function ni(){Dismoyo_Ciptoning_Client.DB.vStockTransfers.off("modified",ut)}function et(){k=!1;s.pageIndex(0);s.load()}function ot(n){return(n?n:"(Site Code)")+"-YY-08-(Auto Generated)"}function st(n){return(n?n:"(Site Code)")+"-YY-10-(Auto Generated)"}function ht(n,t,i){var r,u;t?Dismoyo_Ciptoning_Client.DB.vSites.byKey(t).done(function(n){l=n.IsLotNumberEntryRequired}):(t=null,l=undefined);r=DataUtility.GetLookupWarehouseDataSource(["SiteID","=",t]);n.getEditor("SourceWarehouseID").option("value",null);n.getEditor("SourceWarehouseID").option("dataSource",[]);r.load().done(function(){n.getEditor("SourceWarehouseID").option("dataSource",r)});u=DataUtility.GetLookupSiteDataSource(["CompanyID","=",i]);n.getEditor("DestinationSiteID").option("value",null);n.getEditor("DestinationSiteID").option("dataSource",[]);u.load().done(function(){n.getEditor("DestinationSiteID").option("dataSource",u)})}function ri(n){var t=Dismoyo_Ciptoning_Client.LocalStore.vSystemParameters.dataByFilter(["ID","=",n]);return t.length>0?t[0].Value():null}function ct(n){var t=ri("User.SFAUserName");return n!=undefined&&n!=null&&n.toLowerCase()==t.toLowerCase()}function lt(n){CommonUtility.updateSummariesArrayStore(f().option("dataSource").store(),n)}function ui(n,t){CommonUtility.updateDeferSummariesArrayStore(f().option("dataSource").store(),n,t)}function fi(n){return CommonUtility.validateSummaryArrayStore(f().option("dataSource").store(),"vStockTransferSummaryViewModel",n)}function at(n){return CommonUtility.createArrayDataSource("vStockTransferSummaryViewModel",["ProductID"],n)}function d(n,t,i){var r=$('<div class="dx-command-edit" style="text-align: right; padding-right: 5px;">'),o;if(r.append($('<a style="color: inherit;">').text(n[t]())),r.append("&nbsp;"),l){var u=t.replace("Conv",""),s=n[u](),f=n.ChildDetails(),e=0;for(o in f)e+=f[o][u]();r.append($('<a class="dx-link dxcustom-linkbutton dx-icon-icons8-view-details" title="Edit Lot Number">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<\/a><span id="LotMark_'+n.ProductID()+"_"+t+'" class="dx-icon-overflow '+(e==s?"hidden":"")+'" style="color:red; font-size: 14px; margin-left: -6px;"><\/span>').on("dxclick",function(){b(function(){si(n,i)})}));r.append("&nbsp;")}return r}function ei(n,t){var i=f().option("editing"),r=f().option("selection");r.mode=n&&!t?"multiple":"none";i.allowUpdating=n;i.allowDeleting=n&&!t;f().option("editing",i);f().option("selection",r);ci().option("disabled",!(n&&!t));kt().option("disabled",!0);f().repaint()}function g(n,t){showLoadingPanel();Dismoyo_Ciptoning_Client.DB.vStockTransfers.byKey(n,{expand:["ChildSummaries/ChildDetails"]}).done(function(n){hideLoadingPanel();v=t;nt(new Dismoyo_Ciptoning_Client.vStockTransferViewModel(n))}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to load selected data."),"Load Failed");hideLoadingPanel()})}function nt(n){var o=!1,e,t,s,v,c,y,p,a,w,k,d,g;n||(n=new Dismoyo_Ciptoning_Client.vStockTransferViewModel,n.DocumentStatusID(null),o=!0);i.popupEditData(n);i.popupEdit().option("title",(o?"New":"Edit")+" Stock Transfer");i.popupEditOptions.editingKey=n.DocumentID();i.popupEditOptions.visible(!0);i.popupContent().scrollTo(0);e=Dismoyo_Ciptoning_Client.app.CurrentUser;t=i.form();DXUtility.resetFormValidation(t);var nt=n.DocumentCode(),it=n.DODocumentCode(),r=!1,u=!1,h=[];if(l=n.IsSourceSiteLotNumberEntryRequired(),o)n.DocumentID(new DevExpress.data.Guid),n.DocumentStatusID(null),n.SourceTerritoryID(e.TerritoryID()),n.SourceRegionID(e.RegionID()),n.SourceAreaID(e.AreaID()),n.SourceSiteID(e.SiteID()),n.SourceSiteCode(e.SiteCode()),n.SourceCompanyID(e.CompanyID()),n.SourceCompany(e.Company()),nt=ot(n.SourceSiteCode()),it=st(n.SourceSiteCode());else if(h=n.ChildSummaries(),n.DocumentStatusID()!=1||l)(n.DocumentStatusID()==2||n.DocumentStatusID()==3)&&(r=!0);else{for(u=ct(n.CreatedByUserName()),s=[],v=0,c=0;c<h.length;c++){for(y=h[c].ChildDetails(),p=0,a=0;a<y.length;a++)y[a].ProductLotCode().indexOf("DUMMY")<0&&p++;p>0&&(s[v]=h[c],v++)}s.length>0&&b(function(){for(var t,n=0;n<s.length;n++)t={data:s[n].toJS()},tt(t,s)})}ei(!r,u);yt().option("disabled",o);pt().option("disabled",o||r);wt().option("disabled",o||r);bt().option("disabled",r||u);i.ok().option("disabled",r||u);t.itemOption("Organization").visible&&(t.getEditor("TerritoryID").option("value",n.SourceTerritoryID()),t.getEditor("RegionID").option("value",n.SourceRegionID()),t.getEditor("AreaID").option("value",n.SourceAreaID()),t.getEditor("SiteID").option("value",n.SourceSiteID()),t.getEditor("Company").option("value",n.SourceCompany()),t.getEditor("TerritoryID").option("readOnly",r||u),t.getEditor("RegionID").option("readOnly",r||u),t.getEditor("AreaID").option("readOnly",r||u),t.getEditor("SiteID").option("readOnly",r||u));ht(t,n.SourceSiteID(),n.SourceCompanyID());t.getEditor("DocumentCode").option("value",nt);t.getEditor("TransactionDate").option("value",n.TransactionDate());t.getEditor("SourceWarehouseID").option("value",n.SourceWarehouseID());t.getEditor("SourcePIC").option("value",n.SourcePIC());t.getEditor("DestinationSiteID").option("value",n.DestinationSiteID());t.getEditor("DestinationWarehouseID").option("value",n.DestinationWarehouseID());t.getEditor("DestinationPIC").option("value",n.DestinationPIC());t.getEditor("ReferenceNumber").option("value",n.ReferenceNumber());w=vt();CommonUtility.createEditDataAttachmentFileDownloader("vStockTransfers",w,"StockTransfers",n.AttachmentFile());w.option("value",null);t.getEditor("DocumentStatusID").option("value",n.DocumentStatusID());t.getEditor("DODocumentCode").option("value",it);t.getEditor("DOShipmentDate").option("value",n.DOShipmentDate());t.getEditor("DOReceivedDate").option("value",n.DOReceivedDate());t.getEditor("DOPrintedCount").option("value",n.DOPrintedCount());t.getEditor("DOLastPrintedDate").option("value",n.DOLastPrintedDate());t.getEditor("TransactionDate").option("readOnly",r||u);t.getEditor("SourceWarehouseID").option("readOnly",r||u);t.getEditor("SourcePIC").option("readOnly",r);t.getEditor("DestinationSiteID").option("readOnly",r||u);t.getEditor("DestinationWarehouseID").option("readOnly",r||u);t.getEditor("DestinationPIC").option("readOnly",r||u);t.getEditor("ReferenceNumber").option("readOnly",r);t.getEditor("DOShipmentDate").option("readOnly",r);t.getEditor("DOReceivedDate").option("readOnly",r);k=$(".dx-fileuploader-input-wrapper");r?k.hide():k.show();d=new Date;o&&(DXUtility.resetFormValidation(t),t.getEditor("TransactionDate").option("value",d),t.getEditor("DOShipmentDate").option("value",d));g=f();g.cancelEditData();n.ChildSummaries(h);g.option("dataSource",at(n.ChildSummaries()))}function tt(n,t){var v,r,y,h,e,a,p,u,o;if(!l){var a=i.popupEditData(),w=f(),s=[];if(t){for(e=0;e<t.length;e++)t[e].ChildDetails([]);s=t}else for(v=w.option("dataSource").store(),e=0;e<v._array.length;e++)s.push(new Dismoyo_Ciptoning_Client.vStockTransferSummaryViewModel(v._array[e]));if(r=n.data,y=$.grep(c,function(n){return n.ProductID()==DXUtility.getValue(r,"ProductID")&&n.ProductLotCode().indexOf("DUMMY")>=0}),y.length>0)for(h=y[0],DXUtility.setValue(r,"ProductLotID",h.ProductLotID()),DXUtility.setValue(r,"ProductLotCode",h.ProductLotCode()),DXUtility.setValue(r,"QtyOnHandGood",h.QtyOnHandGood()),DXUtility.setValue(r,"QtyOnHandHold",h.QtyOnHandHold()),DXUtility.setValue(r,"QtyOnHandBad",h.QtyOnHandBad()),e=0;e<s.length;e++)a=s[e],a.ProductID()==DXUtility.getValue(r,"ProductID")&&(p=$.grep(a.ChildDetails(),function(n){return n.ProductLotID()==DXUtility.getValue(r,"ProductLotID")}),p.length>0?(u=p[0],o=DXUtility.getValue(r,"QtyTransferGood"),o!=undefined&&(u.QtyConvLGood(DXUtility.getValue(r,"QtyConvLGood")),u.QtyConvMGood(DXUtility.getValue(r,"QtyConvMGood")),u.QtyConvSGood(DXUtility.getValue(r,"QtyConvSGood")),u.QtyTransferGood(o),u.QtyTransferConvGood(DXUtility.getValue(r,"QtyTransferConvGood"))),o=DXUtility.getValue(r,"QtyTransferHold"),o!=undefined&&(u.QtyConvLHold(DXUtility.getValue(r,"QtyConvLHold")),u.QtyConvMHold(DXUtility.getValue(r,"QtyConvMHold")),u.QtyConvSHold(DXUtility.getValue(r,"QtyConvSHold")),u.QtyTransferHold(o),u.QtyTransferConvHold(DXUtility.getValue(r,"QtyTransferConvHold"))),o=DXUtility.getValue(r,"QtyTransferBad"),o!=undefined&&(u.QtyConvLBad(DXUtility.getValue(r,"QtyConvLBad")),u.QtyConvMBad(DXUtility.getValue(r,"QtyConvMBad")),u.QtyConvSBad(DXUtility.getValue(r,"QtyConvSBad")),u.QtyTransferBad(o),u.QtyTransferConvBad(DXUtility.getValue(r,"QtyTransferConvBad")))):(r.QtyTransferGood==undefined&&(DXUtility.setValue(r,"QtyConvLGood",0),DXUtility.setValue(r,"QtyConvMGood",0),DXUtility.setValue(r,"QtyConvSGood",0),DXUtility.setValue(r,"QtyTransferGood",0),DXUtility.setValue(r,"QtyTransferConvGood","0/0/0")),r.QtyTransferHold==undefined&&(DXUtility.setValue(r,"QtyConvLHold",0),DXUtility.setValue(r,"QtyConvMHold",0),DXUtility.setValue(r,"QtyConvSHold",0),DXUtility.setValue(r,"QtyTransferHold",0),DXUtility.setValue(r,"QtyTransferConvHold","0/0/0")),r.QtyTransferBad==undefined&&(DXUtility.setValue(r,"QtyConvLBad",0),DXUtility.setValue(r,"QtyConvMBad",0),DXUtility.setValue(r,"QtyConvSBad",0),DXUtility.setValue(r,"QtyTransferBad",0),DXUtility.setValue(r,"QtyTransferConvBad","0/0/0")),s[e].ChildDetails().push(new Dismoyo_Ciptoning_Client.vStockTransferDetailsViewModel(r))),lt(s[e]));else DevExpress.ui.dialog.alert("DUMMY Lot Number for the selected product is not available.","Save Failed")}}function w(n,t){var it,u,w,o,h,r,y,c;showLoadingPanel();var s=i.form(),l=s.validate().isValid,a=l?"":"Please specify the required fields.",rt=e.dataGrid(),ut=rt.option("dataSource"),b=f().option("dataSource"),p=[];for(h=0;h<b.store()._array.length;h++)p.push(new Dismoyo_Ciptoning_Client.vStockTransferSummaryViewModel(b.store()._array[h]));if(l&&p.length<=0&&(a="Please specify at least one item in Transfer Details.",l=!1),l)for(h=0;h<p.length;h++){var r=p[h],k=0,d=0,tt=0;for(y=0;y<r.ChildDetails().length;y++)c=r.ChildDetails()[y],k+=c.QtyTransferGood(),d+=c.QtyTransferHold(),tt+=c.QtyTransferBad();(r.QtyTransferGood()!=k||r.QtyTransferHold()!=d||r.QtyTransferBad()!=tt)&&(a==""?a="Following products quantity of Transfer Details items is not matched: ":a+=", ",a+=r.Product(),l=!1)}if(l&&$(".dx-fileuploader-button.dx-fileuploader-upload-button.dx-widget.dx-button-has-icon.dx-button.dx-button-normal").length>0&&(a="You have selected an attachment file. Please upload or cancel the attachment file.",l=!1),it=Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID(),s.itemOption("Organization").visible&&(it=s.getEditor("SiteID").option("value")),l){for(u=i.popupEditData(),u.TransactionDate(s.getEditor("TransactionDate").option("value")),u.SourceWarehouseID(s.getEditor("SourceWarehouseID").option("value")),u.SourcePIC(s.getEditor("SourcePIC").option("value")),u.DestinationWarehouseID(s.getEditor("DestinationWarehouseID").option("value")),u.DestinationPIC(s.getEditor("DestinationPIC").option("value")),u.ReferenceNumber(s.getEditor("ReferenceNumber").option("value")),u.DOShipmentDate(s.getEditor("DOShipmentDate").option("value")),u.DOReceivedDate(s.getEditor("DOReceivedDate").option("value")),u.DOPrintedCount(s.getEditor("DOPrintedCount").option("value")),u.DOLastPrintedDate(s.getEditor("DOLastPrintedDate").option("value")),w=vt(),u.AttachmentFile(w.option("values").length>0?w.fileName:null),u.ChildSummaries(p),o=ko.toJS(u),n&&(o.DocumentStatusID=n),o.DocumentStatusID||(o.DocumentStatusID=1),o.TransactionDate=DateTimeUtility.getFirstTimeOfDay(o.TransactionDate),o.DOShipmentDate=DateTimeUtility.getFirstTimeOfDay(o.DOShipmentDate),o.DOReceivedDate=DateTimeUtility.getFirstTimeOfDay(o.DOReceivedDate),h=0;h<o.ChildSummaries.length;h++){for(r=o.ChildSummaries[h],r.DocumentID=o.DocumentID,y=0;y<r.ChildDetails.length;y++)c=r.ChildDetails[y],c.DocumentID=o.DocumentID,c.QtyGood=c.QtyTransferGood*-1,c.QtyHold=c.QtyTransferHold*-1,c.QtyBad=c.QtyTransferBad*-1;r.QtyGood=r.QtyTransferGood*-1;r.QtyHold=r.QtyTransferHold*-1;r.QtyBad=r.QtyTransferBad*-1}ut.store().insert(o).done(function(n){CommonUtility.documentSuccessMessage(n.DocumentStatusID,function(){});v=!0;switch(t){case 1:i.events.performCancel();hideLoadingPanel();break;case 2:nt(null);hideLoadingPanel();break;case 3:g(u.DocumentID(),!0)}}).fail(function(n){DevExpress.ui.dialog.alert(n.message,"Save Failed");hideLoadingPanel()})}else hideLoadingPanel();a!=""&&DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode(a),"Save Failed")}function oi(n){h.popupEdit().option("title","Print Delivery Order");h.popupEditOptions.visible(!0);var t=h.iframe();h.showLoadingPanel();t.attr("src",Dismoyo_Ciptoning_Client.ReportWebsite.DeliveryOrderReport.url([["DocumentID","=",n]]))}function o(n){var t=null;switch(n){case 1:t="Good";break;case 2:t="Hold";break;case 3:t="Bad"}var i="QtyOnHand"+t,r="QtyConvL"+t,u="QtyConvM"+t,f="QtyConvS"+t,e="QtyTransfer"+t,o="QtyTransferConv"+t;return{itemStatusName:t,qtyOnHandColumn:i,qtyConvLColumn:r,qtyConvMColumn:u,qtyConvSColumn:f,qtyTransferColumn:e,qtyTransferConvColumn:o}}function si(n,t){var v=i.popupEditData(),s,w,l,a,c,b;r.popupEditData(n);r.popupEditOptions.editingKey=n.ProductID();r.popupEditOptions.itemStatusID=t;r.popupEditOptions.visible(!0);var e=r.dataGrid(),h=r.form(),f=!1;(v.DocumentStatusID()==2||v.DocumentStatusID()==3)&&(f=!0);s=r.dataGrid().option("editing");s.allowUpdating=!f;s.allowDeleting=!f;s.editEnabled=!f;s.removeEnabled=!f;r.dataGrid().option("editing",s);r.dataGrid().option("selection",{mode:f?"none":"multiple"});r.newRow().option("disabled",f);r.dataGrid().repaint();var u=o(t),y=e.columnOption("QtyOnHand"),p=e.columnOption("QtyTransferConv");if(y.dataField=u.qtyOnHandColumn,p.dataField=u.qtyTransferConvColumn,e.columnOption("QtyOnHand",y),e.columnOption("QtyTransferConv",p),h.getEditor("Product").option("value",n.Product()),h.getEditor("QtyOnHand").option("value",n[u.qtyOnHandColumn]()),h.getEditor("QtyTransferConv").option("value",n[u.qtyTransferConvColumn]()),w=CommonUtility.getConversion(n[u.qtyTransferConvColumn](),DXUtility.getValue(n,"ProductConversionL"),DXUtility.getValue(n,"ProductConversionM"),DXUtility.getValue(n,"ProductConversionS")),h.getEditor("QtyTransfer").option("value",w.qtyTransaction),n=fi(n),l=[],n.ChildDetails().length>0)for(a=$.grep(n.ChildDetails(),function(n){return n[u.qtyConvLColumn]()>0||n[u.qtyConvMColumn]()>0||n[u.qtyConvSColumn]()>0}),c=0;c<a.length;c++)l.push(a[c]);b=CommonUtility.createArrayDataSource("vStockTransferDetailsViewModel",["ProductID","ProductLotID"],l);e.cancelEditData();e.option("dataSource",b)}function hi(){var t=r.popupEditData(),i=r.popupEditOptions.itemStatusID,n=o(i);CommonUtility.validateProductLotEditing(t,r.dataGrid().option("dataSource"),r.form().getEditor("QtyTransfer").option("value"),"Transfer","vStockTransferDetailsViewModel",n.qtyConvLColumn,n.qtyConvMColumn,n.qtyConvSColumn,n.qtyTransferConvColumn,n.qtyTransferColumn,!0)&&(lt(t),r.popupEditOptions.visible(!1),f().refresh())}function b(n){if(c.length==0&&a.length==0){showLoadingPanel();var t=i.form();new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vProducts,select:["ID","Code","Product","UOMLID","UOMMID","UOMSID","ConversionL","ConversionM","ConversionS"],sort:["ID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vProductViewModel(n)}}).load().done(function(i){var f=i,r=t.getEditor("SourceWarehouseID").option("value"),u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockOnHandAvailables,select:["ProductID","ProductLotID","ProductLotCode","ProductLot","ProductLotExpiredDate","QtyOnHandGood","QtyOnHandHold","QtyOnHandBad"],filter:[["WarehouseID","=",r],"and",[["QtyOnHandGood",">",0],"or",["QtyOnHandHold",">",0],"or",["QtyOnHandBad",">",0]]],sort:["WarehouseID","ProductID","ProductLotID"],paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(n)}});u.load().done(function(t){for(var e,s,u=null,o=[],r=[],f=0;f<t.length;f++)o.push(new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(t[f].toJS())),e=r.length-1,s=t[f].ProductID(),f==0||r[e].ProductID()!=s?(r.push(new Dismoyo_Ciptoning_Client.vStockOnHandAvailableViewModel(t[f].toJS())),e++,u=$.grep(i,function(n){return n.ID()==s})):(r[e].QtyOnHandGood(r[e].QtyOnHandGood()+t[f].QtyOnHandGood()),r[e].QtyOnHandHold(r[e].QtyOnHandHold()+t[f].QtyOnHandHold()),r[e].QtyOnHandBad(r[e].QtyOnHandBad()+t[f].QtyOnHandBad())),o[f].ProductCode(u[0].Code()),o[f].Product(u[0].Product()),o[f].ProductUOMLID(u[0].UOMLID()),o[f].ProductUOMMID(u[0].UOMMID()),o[f].ProductUOMSID(u[0].UOMSID()),o[f].ProductConversionL(u[0].ConversionL()),o[f].ProductConversionM(u[0].ConversionM()),o[f].ProductConversionS(u[0].ConversionS()),r[e].ProductCode(u[0].Code()),r[e].Product(u[0].Product()),r[e].ProductUOMLID(u[0].UOMLID()),r[e].ProductUOMMID(u[0].UOMMID()),r[e].ProductUOMSID(u[0].UOMSID()),r[e].ProductConversionL(u[0].ConversionL()),r[e].ProductConversionM(u[0].ConversionM()),r[e].ProductConversionS(u[0].ConversionS());c=o;a=r;c.length==0?DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Product lot stock with item status Good/Hold/Bad for the selected warehouse is empty."),"New Transfer Details Failed"):n();hideLoadingPanel()}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product lot data."),"Download Product Lot Failed");hideLoadingPanel()})}).fail(function(){DevExpress.ui.dialog.alert(HtmlUtility.htmlEncode("Failed to download product data."),"Download Product Failed");hideLoadingPanel()})}else n()}var k=!1,dt=t.layoutController.name==="split",it=$.Deferred(),rt=ko.observable(),s,v,l,y,u,e,i,h,r;s=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockTransfers,map:function(n){return new Dismoyo_Ciptoning_Client.vStockTransferViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vStockTransfers.on("modified",ut);var ti=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockTransferDetails,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockTransferDetailsViewModel(n)}}),ii=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockTransferSummaries,paginate:!1,map:function(n){return new Dismoyo_Ciptoning_Client.vStockTransferSummaryViewModel(n)}}),c,a,p={type:"pattern",pattern:"(^[0-9]*$)|(^[0-9]*/[0-9]*$)|(^[0-9]*/[0-9]*/[0-9]*$)",message:"Format must be L/M/S or M/S or S."};u=new Dismoyo_Ciptoning_Client.CollapsibleFilter;u.filterOptions.onInitialized=function(){u.filter().element().resize(function(){y&&y.resizeAll()})};u.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(u.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],[]);var t=u.form().getEditor("SourceWarehouseID").option("selectedItem");t&&t.SiteID()!=n.value&&u.form().getEditor("SourceWarehouseID").option("value",null);t=u.form().getEditor("DestinationWarehouseID").option("selectedItem");t&&t.SiteID()!=n.value&&u.form().getEditor("DestinationWarehouseID").option("value",null);u.form().getEditor("SourceWarehouseID").option("dataSource",DataUtility.GetLookupWarehouseDataSource(n.value?["SiteID","=",n.value]:null));u.form().getEditor("DestinationWarehouseID").option("dataSource",DataUtility.GetLookupWarehouseDataSource(n.value?["SiteID","=",n.value]:null))}}}]},{itemType:"group",caption:"Stock Transfer",colCount:3,colSpan:3,items:[{dataField:"SourceWarehouseID",label:{text:"Source Warehouse"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"DestinationWarehouseID",label:{text:"Destination Warehouse"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{name:"DocumentCode",dataField:"",label:{text:"Document Number"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateFrom",label:{text:"Transaction Date From"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"TransactionDateTo",label:{text:"Transaction Date To"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"PIC",label:{text:"PIC"},editorOptions:{onEnterKey:function(){u.events.performSearch(this)}}},{dataField:"DocumentStatusID",label:{text:"Status"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){u.events.performSearch(this)}}}]}];u.events.performSearch=function(){var o=e.dataGrid(),i=u.form(),t=[],n,f;o.clearFilter();var r=Dismoyo_Ciptoning_Client.app.CurrentUser,s=r.TerritoryID(),h=r.RegionID(),c=r.AreaID(),l=r.CompanyID(),a=r.SiteID();i.itemOption("Organization").visible&&(s=i.getEditor("TerritoryID").option("value"),h=i.getEditor("RegionID").option("value"),c=i.getEditor("AreaID").option("value"),l=i.getEditor("CompanyID").option("value"),a=i.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(t,"SourceTerritoryID","=",s,"and");DXUtility.addFilterExpression(t,"SourceRegionID","=",h,"and");DXUtility.addFilterExpression(t,"SourceAreaID","=",c,"and");DXUtility.addFilterExpression(t,"SourceCompanyID","=",l,"and");DXUtility.addFilterExpression(t,"SourceSiteID","=",a,"and");n=i.getEditor("SourceWarehouseID").option("value");DXUtility.addFilterExpression(t,"SourceWarehouseID","=",n,"and");n=i.getEditor("DestinationWarehouseID").option("value");DXUtility.addFilterExpression(t,"DestinationWarehouseID","=",n,"and");n=i.getEditor("DocumentCode").option("value");DXUtility.addFilterExpression(t,"DocumentCode","contains",n,"and");n=i.getEditor("TransactionDateFrom").option("value");DXUtility.addFilterExpression(t,"TransactionDate",">=",n,"and");n=i.getEditor("TransactionDateTo").option("value");DXUtility.addFilterExpression(t,"TransactionDate","<=",n,"and");n=i.getEditor("PIC").option("value");f=[];DXUtility.addFilterExpression(f,"SourcePIC","contains",n,"or");DXUtility.addFilterExpression(f,"DestinationPIC","contains",n,"or");DXUtility.addGroupFilterExpression(t,f,"and");n=i.getEditor("DocumentStatusID").option("value");DXUtility.addFilterExpression(t,"DocumentStatusID","=",n,"and");t.length>0?o.filter(t):o.refresh()};e=new Dismoyo_Ciptoning_Client.CommonGridView;e.dataGridOptions.dataSource=s;e.dataGridOptions.editing.editEnabled=!1;e.dataGridOptions.editing.removeEnabled=!1;e.dataGridOptions.selection.mode="single";e.deleteRowsOptions.visible=!1;e.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("StockTransfers.AddNewStockTransfer");e.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("StockTransfers.EditStockTransfer");e.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"SourceTerritory",caption:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"SourceRegion",caption:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"SourceArea",caption:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"SourceCompany",caption:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"SourceSite",caption:"Site",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()},{dataField:"DocumentCode",caption:"Document Number",width:"140px",sortOrder:"desc",headerCellTemplate:function(n,t){var r=$("#vStockTransfers_commonGridView").find(".dx-datagrid:first-child"),i,u,f;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',u=Dismoyo_Ciptoning_Client.app.CurrentUser,u.IsHeadOffice()&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Source<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Destination<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',e.dataGridOptions.editing.allowUpdating&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",f=r.find(".dx-header-row:first-child"),$(i).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))},cellTemplate:function(n,t){var u=Dismoyo_Ciptoning_Client.app.CurrentUser,f=u.isAuthorized("StockTransfers.EditStockTransfer"),i=$('<div class="dx-command-edit" style="text-align: left;">'),r=$("<b>").text(t.data.DocumentCode());f&&(r=$('<a class="dx-link">').text(t.data.DocumentCode()).on("dxclick",function(){g(t.data.DocumentID(),!1)}));i.append(r);i.append("&nbsp;");n.append(i)}},{dataField:"TransactionDate",caption:"Transaction Date",width:"100px",customizeText:function(n){return n.value?n.value.toLocaleDateString():null}},{dataField:"SourceWarehouse",caption:"Warehouse",width:"200px"},{dataField:"SourcePIC",caption:"PIC",width:"180px"},{dataField:"DestinationWarehouse",caption:"Warehouse",width:"200px"},{dataField:"DestinationPIC",caption:"PIC",width:"180px"},{dataField:"ReferenceNumber",caption:"Reference Number",width:"120px"},{dataField:"DocumentStatusName",caption:"Status",width:"80px"},{dataField:"PostedDate",caption:"Posted Date",width:"100px",customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleDateString():null}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}];e.dataGridOptions.editing.allowUpdating&&e.dataGridOptions.columns.push({width:100,alignment:"center",cellTemplate:function(n,t){var i=$('<div class="dx-command-edit" style="text-align: center;">');i.append($('<a class="dx-link">').text("Edit").on("dxclick",function(){g(t.data.DocumentID(),!1)}));i.append("&nbsp;");n.append(i)}});i=new Dismoyo_Ciptoning_Client.CommonPopupEdit;i.okOptions.text="Save";i.okOptions.icon="icons8-save";var vt=function(){return DXUtility.getDXInstance(null,"#vStockTransfers_editDataAttachmentFile","dxFileUploader")},f=function(){return DXUtility.getDXInstance(null,"#vStockTransfers_stockTransferSummaryDataGrid","dxDataGrid")},yt=function(){return DXUtility.getDXInstance(null,"#vStockTransfers_stockTransferPrintDO","dxButton")},pt=function(){return DXUtility.getDXInstance(null,"#vStockTransfers_stockTransferPost","dxButton")},wt=function(){return DXUtility.getDXInstance(null,"#vStockTransfers_stockTransferDiscard","dxButton")},bt=function(){return DXUtility.getDXInstance(null,"#vStockTransfers_stockTransferSaveAsDraftAndNew","dxButton")},ci=function(){return DXUtility.getDXInstance(null,"#vStockTransfers_stockTransferSummaryNewRow","dxButton")},kt=function(){return DXUtility.getDXInstance(null,"#vStockTransfers_stockTransferSummaryDeleteRows","dxButton")};return i.popupEditOptions.onContentReady=function(){var u=$("#commonPopupEdit_extContent"),n=DXUtility.createFormItemGroupContent();n.append(DXUtility.createFormItemLabelTop("Transfer Details"));var r=$('<div class="desktop-commonGridView-commands">'),e=$('<div id="vStockTransfers_stockTransferSummaryNewRow">').dxButton({text:"New",icon:"add",onClick:function(){var n=i.form().validate().isValid;n?b(function(){f().addRow()}):DevExpress.ui.dialog.alert("Please specify the required fields.","New Transfer Details Failed")}}),o=$('<div id="vStockTransfers_stockTransferSummaryDeleteRows">').dxButton({text:"Delete",icon:"remove",disabled:!0,onClick:function(){DevExpress.ui.dialog.confirm("Are you sure want to delete the selected records?","Delete Confirmation").done(function(n){n&&DXUtility.deleteSelectedRows(f())})}});r.append(e);r.append(o);n.append(r);n.append($('<div id="vStockTransfers_stockTransferSummaryDataGrid">').dxDataGrid({deferRendering:!1,dataSource:[],showBorders:!0,paging:{enabled:!1},allowColumnResizing:!1,columnAutoWidth:!0,hoverStateEnabled:!0,selection:{mode:"multiple",allowSelectAll:!0},editing:{editMode:"row",allowAdding:!1,allowUpdating:!0,allowDeleting:!0},onSelectionChanged:function(n){kt().option("disabled",!n.selectedRowsData.length)},onInitNewRow:function(n){n.data.QtyTransferGood=0;n.data.QtyTransferHold=0;n.data.QtyTransferBad=0;n.data.QtyTransferConvGood="0/0/0";n.data.QtyTransferConvHold="0/0/0";n.data.QtyTransferConvBad="0/0/0"},onEditorPreparing:function(n){if(n.parentType=="dataRow")if(n.dataField=="Product")n.row.inserted?n.editorElement.dxLookup({dataSource:a,displayExpr:"Product",valueExpr:"Product",searchExpr:"Product",searchPlaceholder:"Product",popupWidth:"832px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){CommonUtility.createProductLookupHeader("vStockTransfers_productIDLookup",n.element,null)},itemTemplate:function(n,t,i){return CommonUtility.createProductLookupItem(n,i,null)},onValueChanged:function(t){var i;if(t.value&&(i=this.option("selectedItem"),i)){n.component.cellValue(n.row.rowIndex,"QtyOnHandGood",i.QtyOnHandGood());n.component.cellValue(n.row.rowIndex,"QtyOnHandHold",i.QtyOnHandHold());n.component.cellValue(n.row.rowIndex,"QtyOnHandBad",i.QtyOnHandBad());DXUtility.setValue(n.row.data,"ProductID",i.ProductID());DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode());DXUtility.setValue(n.row.data,"Product",i.Product());DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID());DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID());DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID());DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL());DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM());DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS());var r=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyTransferConvGood"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),u=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyTransferConvHold"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),f=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyTransferConvBad"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,"QtyTransferGood",r.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvLGood",r.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvMGood",r.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvSGood",r.qtyConvS);DXUtility.setValue(n.row.data,"QtyTransferHold",u.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvLHold",u.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvMHold",u.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvSHold",u.qtyConvS);DXUtility.setValue(n.row.data,"QtyTransferBad",f.qtyTransaction);DXUtility.setValue(n.row.data,"QtyConvLBad",f.qtyConvL);DXUtility.setValue(n.row.data,"QtyConvMBad",f.qtyConvM);DXUtility.setValue(n.row.data,"QtyConvSBad",f.qtyConvS)}n.component.cellValue(n.row.rowIndex,"Product",t.value);n.setValue(t.value)}}):(b(function(){}),n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Product()))),n.cancel=!0;else if(n.dataField=="QtyTransferConvGood"||n.dataField=="QtyTransferConvHold"||n.dataField=="QtyTransferConvBad"){var t="";n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onEnterKey:function(){f().saveEditData()},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,n.dataField.replace("QtyTransferConv","QtyTransfer"),i.qtyTransaction);DXUtility.setValue(n.row.data,n.dataField.replace("QtyTransferConv","QtyConvL"),i.qtyConvL);DXUtility.setValue(n.row.data,n.dataField.replace("QtyTransferConv","QtyConvM"),i.qtyConvM);DXUtility.setValue(n.row.data,n.dataField.replace("QtyTransferConv","QtyConvS"),i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}});n.cancel=!0}},onRowInserted:function(n){CommonUtility.validateDataGridInsertedTransactionSummary(n.component,new Dismoyo_Ciptoning_Client.vStockTransferSummaryViewModel(n.data).toJS());tt(n);f().clearSelection()},onRowUpdated:function(n){n.data.ProductID=n.key.ProductID;tt(n);f().clearSelection()},onRowRemoved:function(n){CommonUtility.validateDataGridRemovedTransactionSummary(n.component,n.data.toJS())},onRowUpdating:function(n){var t;n.newData.QtyTransferConvGood&&(t=CommonUtility.getConversion(n.newData.QtyTransferConvGood,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS")),n.newData.QtyConvLGood=t.qtyConvL,n.newData.QtyConvMGood=t.qtyConvM,n.newData.QtyConvSGood=t.qtyConvS,n.newData.QtyTransferGood=t.qtyTransaction);n.newData.QtyTransferConvHold&&(t=CommonUtility.getConversion(n.newData.QtyTransferConvHold,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS")),n.newData.QtyConvLHold=t.qtyConvL,n.newData.QtyConvMHold=t.qtyConvM,n.newData.QtyConvSHold=t.qtyConvS,n.newData.QtyTransferHold=t.qtyTransaction);n.newData.QtyTransferConvBad&&(t=CommonUtility.getConversion(n.newData.QtyTransferConvBad,DXUtility.getValue(n.oldData,"ProductConversionL"),DXUtility.getValue(n.oldData,"ProductConversionM"),DXUtility.getValue(n.oldData,"ProductConversionS")),n.newData.QtyConvLBad=t.qtyConvL,n.newData.QtyConvMBad=t.qtyConvM,n.newData.QtyConvSBad=t.qtyConvS,n.newData.QtyTransferBad=t.qtyTransaction);ui(n.oldData.ProductID(),n.newData)},onRowValidating:function(n){var c=DXUtility.getValue(n.newData,"QtyOnHandGood"),e,o,t,r,u,s,h,f;if(c==undefined&&(c=DXUtility.getValue(n.oldData,"QtyOnHandGood")),e=DXUtility.getValue(n.newData,"QtyOnHandHold"),e==undefined&&(e=DXUtility.getValue(n.oldData,"QtyOnHandHold")),o=DXUtility.getValue(n.newData,"QtyOnHandBad"),o==undefined&&(o=DXUtility.getValue(n.oldData,"QtyOnHandBad")),t=DXUtility.getValue(n.newData,"QtyTransferGood"),t==undefined&&(t=DXUtility.getValue(n.oldData,"QtyTransferGood")),r=DXUtility.getValue(n.newData,"QtyTransferHold"),r==undefined&&(r=DXUtility.getValue(n.oldData,"QtyTransferHold")),u=DXUtility.getValue(n.newData,"QtyTransferBad"),u==undefined&&(u=DXUtility.getValue(n.oldData,"QtyTransferBad")),t<=0&&r<=0&&u<=0&&(n.errorText="Transfer Qty Good/Hold/Bad must be greater than 0.",n.isValid=!1),n.isValid&&(t>c||r>e||u>o)&&(n.errorText="Transfer Qty Good/Hold/Bad must be less than or equal to On Hand Qty.",n.isValid=!1),n.isValid&&(s=i.popupEditData(),ct(DXUtility.getValue(s,"CreatedByUserName"))))for(h=0;h<s.ChildSummaries().length;h++)if(f=s.ChildSummaries()[h],f.ProductID()==n.oldData.ProductID()&&(t>f.QtyGood()*-1||r>f.QtyHold()*-1||u>f.QtyBad()*-1)){n.errorText="This document was created by SFA (mobile device). New Transfer Qty Good/Hold/Bad is limited to less than or equal to original Transfer Qty.";n.isValid=!1;break}n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},onDataErrorOccurred:function(n){var t=n.component._controllers.editing._editData[0].data.Product;switch(n.error.__id){case"E4008":n.error.message="Product '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},columns:[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"Product",caption:"Product",validationRules:[{type:"required"}],headerCellTemplate:function(n,t){var r=$(f().element()),o;if(!r.find(".datagrid-bandedHeader:first").length>0){var u=f().option("selection").mode=="none"?!1:!0,e=f().option("editing"),i='<tr class="dx-row dx-column-lines datagrid-bandedHeader" style="border-top-style: none !important;">';u&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>');i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>';i+='       <td class="dx-datagrid-action" colspan="3">On Hand Qty (Pcs)<\/td>';i+='       <td class="dx-datagrid-action" colspan="3">Transfer Qty (L/M/S)<\/td>';(u||e.allowUpdating||e.allowDeleting)&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>');i+="<\/tr>";o=r.find(".dx-header-row:first-child");$(i).insertBefore(o[0].parentElement);$(n).append(HtmlUtility.htmlEncode(t.column.caption))}}},{dataField:"QtyOnHandGood",caption:"Good",width:"70px",allowEditing:!1,dataType:"number"},{dataField:"QtyOnHandHold",caption:"Hold",width:"70px",allowEditing:!1,dataType:"number"},{dataField:"QtyOnHandBad",caption:"Bad",width:"70px",allowEditing:!1,dataType:"number"},{dataField:"QtyTransferConvGood",caption:"Good",width:"90px",alignment:"right",validationRules:[{type:"required"},p],cellTemplate:function(n,t){n.append(d(t.data,"QtyTransferConvGood",1))}},{dataField:"QtyTransferConvHold",caption:"Hold",width:"90px",alignment:"right",validationRules:[{type:"required"},p],cellTemplate:function(n,t){n.append(d(t.data,"QtyTransferConvHold",2))}},{dataField:"QtyTransferConvBad",caption:"Bad",width:"90px",alignment:"right",validationRules:[{type:"required"},p],cellTemplate:function(n,t){n.append(d(t.data,"QtyTransferConvBad",3))}}]}));var t=$("#commonPopupEdit_extCommands"),s=$('<div id="vStockTransfers_stockTransferPrintDO" style="margin-right: 32px;">').dxButton({text:"Print DO",icon:"icons8-print",onClick:function(){i.events.performPrintDO(this)}}),h=$('<div id="vStockTransfers_stockTransferPost">').dxButton({text:"Post",icon:"icons8-check-green",onClick:function(){i.events.performPost(this)}}),c=$('<div id="vStockTransfers_stockTransferDiscard" style="margin-right: 16px;">').dxButton({text:"Discard",icon:"icons8-trash-red",onClick:function(){i.events.performDiscard(this)}}),l=$('<div id="vStockTransfers_stockTransferSaveAsDraftAndNew">').dxButton({text:"Save & New",icon:"icons8-save",onClick:function(){i.events.performSaveAsDraftAndNew(this)}});u.append(DXUtility.createFormItemGroupWithCaption("").append(n));t.append(s);t.append(h);t.append(c);t.append(l)},e.events.performNewRow=function(){nt(null)},i.events.performOK=function(){w(null,3)},i.events.performPrintDO=function(){var n=i.popupEditData();oi(n.DODocumentID())},i.events.performPost=function(){DevExpress.ui.dialog.confirm("Are you sure want to Post this transaction?","Post Confirmation").done(function(n){n&&w(2,3)})},i.events.performDiscard=function(){DevExpress.ui.dialog.confirm("Are you sure want to Discard this transaction?","Discard Confirmation").done(function(n){n&&w(3,3)})},i.events.performSaveAsDraftAndNew=function(){w(1,2)},i.formOptions.customizeItem=function(n){n.dataField=="AttachmentFile"&&(n.template=function(n,t){t.append(CommonUtility.createEditDataAttachmentFileUploader("vStockTransfers","StockTransfers"))})},i.events.performCancel=function(){i.popupEditOptions.visible(!1);v&&(e.dataGrid().refresh(),v=!1)},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"Company",label:{text:"Company"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SiteID",label:{text:"Site"},validationRules:[{type:"required"}],editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();CommonUtility.cascadeValueChanged(t,n.selectedItem,n.value,"Site",["Area","Region","Territory"],[]);var r="",u="",f=null,e=null;n.selectedItem&&(r=ot(n.selectedItem.Code()),u=st(n.selectedItem.Code()),f=n.selectedItem.Company(),e=n.selectedItem.CompanyID());t.getEditor("Company").option("value",f);ht(t,n.value,e);t.getEditor("DocumentCode").option("value",r);t.getEditor("DODocumentCode").option("value",u)}}}]},{itemType:"group",caption:"Stock Transfer",colCount:6,colSpan:3,items:[{dataField:"DocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"TransactionDate",label:{text:"Transaction Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();t.getEditor("DOShipmentDate").option("min",n.value)}}},{dataField:"DocumentStatusID",label:{text:"Status"},colSpan:1,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSystemLookupDataSource(["Group","=","DocumentStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",placeholder:"NEW",readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SourceWarehouseID",label:{text:"Source Warehouse"},validationRules:[{type:"required"}],colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onValueChanged:function(n){var t=i.form(),r,u,e,o;t.getEditor("DestinationSiteID").option("value")&&(r=t.getEditor("DestinationSiteID").option("value"),t.getEditor("DestinationWarehouseID").option("value",null),u=Dismoyo_Ciptoning_Client.LocalStore.vWarehouses.dataSource(),r===undefined&&(r=null),n.value===undefined&&(n.value=null),u.filter(["ID","<>",n.value],"and",["SiteID","=",r]),t.getEditor("DestinationWarehouseID").option("dataSource",u));c=[];a=[];n.value&&(e=i.popupEditData(),o=f(),o.cancelEditData(),e.ChildSummaries([]),o.option("dataSource",at(e.ChildSummaries())))},onEnterKey:function(){i.events.performOK(this)}}},{dataField:"SourcePIC",label:{text:"PIC"},validationRules:[{type:"required"}],colSpan:2,editorOptions:{maxlength:50,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1},{dataField:"DestinationSiteID",label:{text:"Destination Site"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vSites.dataSource(),displayExpr:"Site",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){n.component.option("value",n.value);var t=i.form().getEditor("SourceWarehouseID").option("value"),r=Dismoyo_Ciptoning_Client.LocalStore.vWarehouses.dataSource();t===undefined&&(t=null);n.value===undefined&&(n.value=null);r.filter(["ID","<>",t],"and",["SiteID","=",n.value]);i.form().getEditor("DestinationWarehouseID").option("dataSource",r)}}},{dataField:"DestinationWarehouseID",label:{text:"Warehouse"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:[],displayExpr:"Warehouse",valueExpr:"ID",searchExpr:["Code","Name"],searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DestinationPIC",label:{text:"PIC"},validationRules:[{type:"required"}],colSpan:2,editorOptions:{maxLength:50,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"ReferenceNumber",label:{text:"Reference Number"},colSpan:3,editorOptions:{maxlength:30,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"AttachmentFile",label:{text:"Attachment File"},colSpan:2,editorOptions:{onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:1}]},{itemType:"group",caption:"Delivery Order",colCount:6,colSpan:3,items:[{dataField:"DODocumentCode",label:{text:"Document Number"},colSpan:3,editorOptions:{readOnly:!0,onEnterKey:function(){commSonPopupEdit.events.performOK(this)}}},{dataField:"DOShipmentDate",label:{text:"Shipment Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)},onValueChanged:function(n){var t=i.form();t.getEditor("DOReceivedDate").option("min",n.value)}}},{itemType:"empty",colSpan:1},{dataField:"DOPrintedCount",editorType:"dxNumberBox",label:{text:"Printed Count"},colSpan:1,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DOLastPrintedDate",label:{text:"Last Printed Date"},colSpan:2,editorType:"dxDateBox",editorOptions:{readOnly:!0,width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"DOReceivedDate",label:{text:"Received Date"},validationRules:[{type:"required"}],colSpan:2,editorType:"dxDateBox",editorOptions:{width:"100%",showClearButton:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],h=new Dismoyo_Ciptoning_Client.CommonPopupIFrame,h.okOptions.visible=!1,h.cancelOptions.text="Close",r=new Dismoyo_Ciptoning_Client.ProductLotPopupEdit,r.formOptions.colCount=4,r.saveOptions.icon="icons8-save",r.events.performSave=function(){hi()},r.dataGridOptions.onInitNewRow=function(n){var i=r.popupEditOptions.itemStatusID,t=o(i);n.data[t.qtyTransferColumn]=0;n.data[t.qtyTransferConvColumn]="0/0/0"},r.dataGridOptions.onEditorPreparing=function(n){var i,u,t;n.parentType=="dataRow"&&(n.dataField=="ProductLotCode"?(n.row.inserted?(i=r.popupEditOptions.itemStatusID,u=o(i),n.editorElement.dxLookup({dataSource:new DevExpress.data.DataSource({store:c,filter:[["ProductID","=",r.popupEditData().ProductID()],"and",[u.qtyOnHandColumn,">",0]],sort:[{getter:"ProductLotExpiredDate",desc:!0}]}),displayExpr:"ProductLotCode",valueExpr:"ProductLotCode",searchExpr:"ProductLotCode",searchPlaceholder:"Lot Number",popupWidth:"582px",showPopupTitle:!1,fieldEditEnabled:!0,value:n.value,onContentReady:function(n){var t=r.popupEditOptions.itemStatusID;CommonUtility.createProductLotLookupHeader("vStockTransfers_productLotIDLookup",n.element,t)},itemTemplate:function(n,t,i){var u=r.popupEditOptions.itemStatusID,f=o(u);return CommonUtility.createProductLotLookupItem(n,i,f.qtyOnHandColumn)},onValueChanged:function(t){var i,e,u,f;t.value&&(i=this.option("selectedItem"),i&&(e=r.popupEditOptions.itemStatusID,u=o(e),n.component.cellValue(n.row.rowIndex,"QtyOnHand",i[u.qtyOnHandColumn]()),DXUtility.setValue(n.row.data,"QtyOnHandGood",i.QtyOnHandGood()),DXUtility.setValue(n.row.data,"QtyOnHandHold",i.QtyOnHandHold()),DXUtility.setValue(n.row.data,"QtyOnHandBad",i.QtyOnHandBad()),DXUtility.setValue(n.row.data,"ProductID",i.ProductID()),DXUtility.setValue(n.row.data,"ProductLotID",i.ProductLotID()),DXUtility.setValue(n.row.data,"ProductCode",i.ProductCode()),DXUtility.setValue(n.row.data,"Product",i.Product()),DXUtility.setValue(n.row.data,"ProductLotCode",i.ProductLotCode()),DXUtility.setValue(n.row.data,"ProductUOMLID",i.ProductUOMLID()),DXUtility.setValue(n.row.data,"ProductUOMMID",i.ProductUOMMID()),DXUtility.setValue(n.row.data,"ProductUOMSID",i.ProductUOMSID()),DXUtility.setValue(n.row.data,"ProductConversionL",i.ProductConversionL()),DXUtility.setValue(n.row.data,"ProductConversionM",i.ProductConversionM()),DXUtility.setValue(n.row.data,"ProductConversionS",i.ProductConversionS()),f=CommonUtility.getConversion(n.component.cellValue(n.row.rowIndex,"QtyTransferConv"),DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS")),DXUtility.setValue(n.row.data,u.qtyTransferColumn,f.qtyTransaction),DXUtility.setValue(n.row.data,u.qtyConvLColumn,f.qtyConvL),DXUtility.setValue(n.row.data,u.qtyConvMColumn,f.qtyConvM),DXUtility.setValue(n.row.data,u.qtyConvSColumn,f.qtyConvS)));n.component.cellValue(n.row.rowIndex,"ProductLotCode",t.value);n.setValue(t.value)}})):(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.ProductLotCode()))),n.cancel=!0):n.name=="QtyTransferConv"&&(t="",n.editorElement.dxTextBox({value:n.value,onFocusIn:function(n){DXUtility.selectAllText(n.element,"dxTextBox")},onKeyDown:function(n){n.jQueryEvent.keyCode>47&&n.jQueryEvent.keyCode<=57||n.jQueryEvent.keyCode==191||n.jQueryEvent.keyCode>95&&n.jQueryEvent.keyCode<=105?t=n.jQueryEvent.target.value:n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&n.jQueryEvent.preventDefault()},onKeyUp:function(n){/(^[0-9]*$)|(^[0-9]*\/[0-9]*$)|(^[0-9]*\/[0-9]*\/[0-9]*$)/.test(n.jQueryEvent.target.value)||n.jQueryEvent.keyCode!=8&&n.jQueryEvent.keyCode!=46&&n.jQueryEvent.keyCode!=13&&n.jQueryEvent.keyCode!=9&&(n.jQueryEvent.target.value=t)},onValueChanged:function(t){var i=CommonUtility.getConversion(t.value?t.value:"0/0/0",DXUtility.getValue(n.row.data,"ProductConversionL"),DXUtility.getValue(n.row.data,"ProductConversionM"),DXUtility.getValue(n.row.data,"ProductConversionS"));DXUtility.setValue(n.row.data,n.dataField.replace("QtyTransferConv","QtyTransfer"),i.qtyTransaction);DXUtility.setValue(n.row.data,n.dataField.replace("QtyTransferConv","QtyConvL"),i.qtyConvL);DXUtility.setValue(n.row.data,n.dataField.replace("QtyTransferConv","QtyConvM"),i.qtyConvM);DXUtility.setValue(n.row.data,n.dataField.replace("QtyTransferConv","QtyConvS"),i.qtyConvS);t.value=i.qtyTransactionConv;t.component.option("value",t.value);n.setValue(t.value)}}),n.cancel=!0))},r.dataGridOptions.onRowInserted=function(n){CommonUtility.validateDataGridInsertedTransactionDetails(n.component,new Dismoyo_Ciptoning_Client.vStockTransferDetailsViewModel(n.data).toJS())},r.dataGridOptions.onRowRemoved=function(n){CommonUtility.validateDataGridRemovedTransactionDetails(n.component,n.data.toJS())},r.dataGridOptions.onRowUpdating=function(n){var i=r.popupEditOptions.itemStatusID,t=o(i);CommonUtility.validateDataGridUpdatingTransactionDetails(n,t.qtyConvLColumn,t.qtyConvMColumn,t.qtyConvSColumn,t.qtyTransferConvColumn,t.qtyTransferColumn)},r.dataGridOptions.onRowValidating=function(n){var f=r.popupEditOptions.itemStatusID,i=o(f),u=DXUtility.getValue(n.newData,i.qtyOnHandColumn),t;u==undefined&&(u=DXUtility.getValue(n.oldData,i.qtyOnHandColumn));t=DXUtility.getValue(n.newData,i.qtyTransferColumn);t==undefined&&(t=DXUtility.getValue(n.oldData,i.qtyTransferColumn));t<=0&&(n.errorText="Transfer Qty must be greater than 0.",n.isValid=!1);n.isValid&&t>u&&(n.errorText="Transfer Qty must be less than or equal to On Hand Qty.",n.isValid=!1);n.errorText&&CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.onDataErrorOccurred=function(n){var t=n.component._controllers.editing._editData[0].data.ProductLotCode;switch(n.error.__id){case"E4008":n.error.message="Lot Number '"+t+"' is already exist."}CommonUtility.hideErrorMessageOnDataGrid()},r.dataGridOptions.summary={totalItems:[{name:"TotalQtyPcs",showInColumn:"QtyTransferConv",displayFormat:"Total Qty (Pcs): {0}",valueFormat:"decimal",summaryType:"custom"},{name:"TotalQtyLMS",showInColumn:"QtyTransferConv",displayFormat:"(L/M/S): {0}",valueFormat:"string",summaryType:"custom"}],calculateCustomSummary:function(n){var i=r.popupEditOptions.itemStatusID,t=o(i);CommonUtility.updateProductLotEditingSummary(n,t.qtyTransferConvColumn,t.qtyTransferColumn)}},r.dataGridOptions.columns=[{dataField:"DocumentID",visible:!1},{dataField:"ProductID",visible:!1},{dataField:"ProductLotID",visible:!1},{dataField:"ProductLotCode",caption:"Lot Number",validationRules:[{type:"required"}]},{name:"QtyOnHand",caption:"On Hand Qty (Pcs)",width:"120px",allowEditing:!1,dataType:"number"},{name:"QtyTransferConv",caption:"Transfer Qty (L/M/S)",width:"150px",alignment:"right",validationRules:[{type:"required"},p]}],r.formOptions.items=[{itemType:"group",caption:"Product",colCount:4,colSpan:4,items:[{dataField:"Product",label:{text:"Product"},colSpan:4,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyOnHand",label:{text:"On Hand Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{itemType:"empty",colSpan:2},{dataField:"QtyTransfer",label:{text:"Transfer Qty (Pcs)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}},{dataField:"QtyTransferConv",label:{text:"(L/M/S)"},colSpan:2,editorOptions:{readOnly:!0,onEnterKey:function(){i.events.performOK(this)}}}]}],{isReady:it.promise(),dataSource:s,refreshList:et,viewShowing:gt,viewDisposing:ni,openCreateViewAsRoot:dt,icon:"Images/stock_transfer_32px.png",dataSource_vStockTransferDetails:ti,dataSource_vStockTransferSummary:ii,dataSource_vStockOnHandAvailable:c,dataSource_vStockOnHandAvailableByProduct:a,collapsibleFilter:u,commonGridView:e,commonPopupEdit:i,commonPopupIFrame:h,productLotPopupEdit:r,stockTransferSummaryDataGrid:f,stockTransferPrintDO:yt,stockTransferPost:pt,stockTransferDiscard:wt,stockTransferSaveAsDraftAndNew:bt}};Dismoyo_Ciptoning_Client.vStockViews=function(n,t){"use strict";function h(){e=!0}function c(){f=CommonUtility.configureCommonGridViewLayout("vStockViews");f||setTimeout(c,50)}function v(){var n,t;c();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],u.filter(t));s()?e&&l():(s(u),u.load().always(function(){o.resolve()}))}function y(){Dismoyo_Ciptoning_Client.DB.vStockViews.off("modified",h)}function l(){e=!1;u.pageIndex(0);u.load()}var e=!1,a=t.layoutController.name==="split",o=$.Deferred(),s=ko.observable(),u,f,i,r;u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vStockViews,select:["ProductID","Product","ProductLotID","ProductLotCode","WarehouseID","Warehouse","QtyOnHandGood","QtyOnHandHold","QtyOnHandBad"],sort:["ProductID","ProductLotID"]});Dismoyo_Ciptoning_Client.DB.vStockViews.on("modified",h);return i=new Dismoyo_Ciptoning_Client.CollapsibleFilter,i.filterOptions.onInitialized=function(){i.filter().element().resize(function(){f&&f.resizeAll()})},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(){}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],["Warehouse"])}}}]},{itemType:"group",caption:"Stock View",colCount:3,colSpan:3,items:[{dataField:"TransactionDate",label:{text:"Transaction Date"},editorType:"dxDateBox",editorOptions:{width:"100%",placeholder:"mm/dd/yyyy",showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)}}},{dataField:"WarehouseID",label:{text:"Warehouse"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupWarehouseDataSource(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?null:["SiteID","=",Dismoyo_Ciptoning_Client.app.CurrentUser.SiteID()]),displayExpr:"Warehouse",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)}}},{dataField:"ProductID",label:{text:"Product"},editorType:"dxSelectBox",editorOptions:{dataSource:Dismoyo_Ciptoning_Client.LocalStore.vProducts.dataSource(),displayExpr:"Product",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)}}}]}],i.events.performSearch=function(){var e=r.dataGrid(),t=i.form(),n=[],u;e.clearFilter();var f=Dismoyo_Ciptoning_Client.app.CurrentUser,o=f.TerritoryID(),s=f.RegionID(),h=f.AreaID(),c=f.CompanyID(),l=f.SiteID();t.itemOption("Organization").visible&&(o=t.getEditor("TerritoryID").option("value"),s=t.getEditor("RegionID").option("value"),h=t.getEditor("AreaID").option("value"),c=t.getEditor("CompanyID").option("value"),l=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",o,"and");DXUtility.addFilterExpression(n,"RegionID","=",s,"and");DXUtility.addFilterExpression(n,"AreaID","=",h,"and");DXUtility.addFilterExpression(n,"CompanyID","=",c,"and");DXUtility.addFilterExpression(n,"SiteID","=",l,"and");u=t.getEditor("TransactionDate").option("value");u instanceof Date&&(u=DateTimeUtility.getFirstTimeOfDay(u),DXUtility.addFilterExpression(n,"TransactionDate","=",u,"and"));u=t.getEditor("WarehouseID").option("value");DXUtility.addFilterExpression(n,"WarehouseID","=",u,"and");u=t.getEditor("ProductID").option("value");DXUtility.addFilterExpression(n,"ProductID","=",u,"and");n.length>0?e.filter(n):e.refresh()},r=new Dismoyo_Ciptoning_Client.CommonGridView,r.dataGridOptions.dataSource=u,r.dataGridOptions.selection.mode="single",r.dataGridOptions.editing.editEnabled=!1,r.dataGridOptions.editing.removeEnabled=!1,r.newRowOptions.visible=!1,r.deleteRowsOptions.visible=!1,r.dataGridOptions.grouping={autoExpandAll:!1},r.dataGridOptions.columns=[{dataField:"Warehouse",caption:"Product -> Lot Number -> Warehouse",headerCellTemplate:function(n,t){var r=$("#vStockViews_commonGridView").find(".dx-datagrid:first-child"),i,u;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none; border-left-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none; border-left-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="3">Item Status<\/td>',i+="<\/tr>",u=r.find(".dx-header-row:first-child"),$(i).insertBefore(u[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"Product",caption:"Product",groupIndex:0},{dataField:"ProductLotCode",caption:"Lot Number",groupIndex:1},{dataField:"QtyOnHandGood",caption:"Good",width:"100px"},{dataField:"QtyOnHandHold",caption:"Hold",width:"100px"},{dataField:"QtyOnHandBad",caption:"Bad",width:"100px"}],r.dataGridOptions.customizeColumns=function(n){$.each(n,function(n,t){t.groupCellTemplate=function(n,t){n.append($("<div>").html(t.text).css("font-weight","normal").css("font-style","normal"))}})},r.dataGridOptions.summary={groupItems:[{column:"QtyOnHandGood",summaryType:"sum",displayFormat:"{0}",showInGroupFooter:!1,alignByColumn:!0},{column:"QtyOnHandHold",summaryType:"sum",displayFormat:"{0}",showInGroupFooter:!1,alignByColumn:!0},{column:"QtyOnHandBad",summaryType:"sum",displayFormat:"{0}",showInGroupFooter:!1,alignByColumn:!0}]},{isReady:o.promise(),dataSource:u,refreshList:l,viewShowing:v,viewDisposing:y,openCreateViewAsRoot:a,icon:"Images/stock_view_32px.png",collapsibleFilter:i,commonGridView:r}};Dismoyo_Ciptoning_Client.vSystemParameters=function(n,t){"use strict";function h(){e=!0}function c(){f=CommonUtility.configureCommonGridViewLayout("vSystemParameters");f||setTimeout(c,50)}function v(){c();s()?e&&l():(s(u),u.load().always(function(){o.resolve()}))}function y(){Dismoyo_Ciptoning_Client.DB.vSystemParameters.off("modified",h)}function l(){e=!1;u.pageIndex(0);u.load()}var e=!1,a=t.layoutController.name==="split",o=$.Deferred(),s=ko.observable(),u,f,r,i;u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vSystemParameters,map:function(n){return new Dismoyo_Ciptoning_Client.vSystemParameterViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vSystemParameters.on("modified",h);return r=new Dismoyo_Ciptoning_Client.CollapsibleFilter,r.filterOptions.onInitialized=function(){r.filter().element().resize(function(){f&&f.resizeAll()})},r.formOptions.items=[{name:"SystemParameter",dataField:"",label:{text:"System Parameter"},editorOptions:{placeholder:"ID/Description",onEnterKey:function(){r.events.performSearch()}}},{dataField:"",label:{text:"",visible:!1},editorOptions:{visible:!1}}],r.events.performSearch=function(){var t=i.dataGrid(),e=r.form(),u=[],f,n;t.clearFilter();f=e.getEditor("SystemParameter").option("value");n=[];DXUtility.addFilterExpression(n,"ID","contains",f,"or");DXUtility.addFilterExpression(n,"Description","contains",f,"or");DXUtility.addGroupFilterExpression(u,n,"and");u.length>0?t.filter(u):t.refresh()},i=new Dismoyo_Ciptoning_Client.CommonGridView,i.dataGridOptions.dataSource=u,i.dataGridOptions.editing.removeEnabled=!1,i.newRowOptions.visible=!1,i.deleteRowsOptions.visible=!1,i.dataGridOptions.onEditorPreparing=function(n){n.parentType=="dataRow"&&n.dataField=="Code"&&(n.row.inserted||(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Code())),n.cancel=!0))},i.dataGridOptions.columns=[{dataField:"ID",caption:"ID",width:"180px",onlyAllowAdd:!0,headerCellTemplate:function(n,t){var r=$("#vSystemParameters_commonGridView").find(".dx-datagrid:first-child"),i,u;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="3">SystemParameter<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+="<\/tr>",u=r.find(".dx-header-row:first-child"),$(i).insertBefore(u[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"Description",width:"250px",onlyAllowAdd:!0},{dataField:"Value",width:"180px",editorOptions:{maxLength:256},validationRules:[{type:"required"}]},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],{isReady:o.promise(),dataSource:u,refreshList:l,viewShowing:v,viewDisposing:y,openCreateViewAsRoot:a,icon:"Images/system_parameter_32px.png",collapsibleFilter:r,commonGridView:i}};Dismoyo_Ciptoning_Client.vTerritories=function(n,t){"use strict";function h(){e=!0}function c(){f=CommonUtility.configureCommonGridViewLayout("vTerritories");f||setTimeout(c,50)}function v(){c();s()?e&&l():(s(u),u.load().always(function(){o.resolve()}))}function y(){Dismoyo_Ciptoning_Client.DB.vTerritories.off("modified",h)}function l(){e=!1;u.pageIndex(0);u.load()}var e=!1,a=t.layoutController.name==="split",o=$.Deferred(),s=ko.observable(),u,f,r,i;u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vTerritories,map:function(n){return new Dismoyo_Ciptoning_Client.vTerritoryViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vTerritories.on("modified",h);return r=new Dismoyo_Ciptoning_Client.CollapsibleFilter,r.filterOptions.onInitialized=function(){r.filter().element().resize(function(){f&&f.resizeAll()})},r.formOptions.items=[{name:"Territory",dataField:"",label:{text:"Territory"},editorOptions:{placeholder:"Code/Name",onEnterKey:function(){r.events.performSearch()}}},{dataField:"",label:{text:"",visible:!1},editorOptions:{visible:!1}}],r.events.performSearch=function(){var t=i.dataGrid(),e=r.form(),u=[],f,n;t.clearFilter();f=e.getEditor("Territory").option("value");n=[];DXUtility.addFilterExpression(n,"Code","contains",f,"or");DXUtility.addFilterExpression(n,"Name","contains",f,"or");DXUtility.addGroupFilterExpression(u,n,"and");u.length>0?t.filter(u):t.refresh()},i=new Dismoyo_Ciptoning_Client.CommonGridView,i.dataGridOptions.dataSource=u,i.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Territories.AddNewTerritory"),i.dataGridOptions.editing.editEnabled=i.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Territories.EditTerritory"),i.dataGridOptions.editing.removeEnabled=i.dataGridOptions.editing.allowDeleting=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Territories.DeleteTerritory"),i.dataGridOptions.onEditorPreparing=function(n){n.parentType=="dataRow"&&n.dataField=="Code"&&(n.row.inserted||(n.allowEditing=!1,n.editorElement.append($('<td style="padding: 5px;">').text(n.row.data.Code())),n.cancel=!0))},i.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Code",caption:"Code",width:"70px",validationRules:[{type:"required"}],onlyAllowAdd:!0,editorOptions:{maxLength:10},headerCellTemplate:function(n,t){var u=$("#vTerritories_commonGridView").find(".dx-datagrid:first-child"),r,f;!u.find(".datagrid-bandedHeader:first").length>0&&(r='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Territory<\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',r+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',(i.dataGridOptions.editing.allowUpdating||i.dataGridOptions.editing.allowDeleting)&&(r+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),r+="<\/tr>",f=u.find(".dx-header-row:first-child"),$(r).insertBefore(f[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"Name",width:"180px",editorOptions:{maxLength:50},validationRules:[{type:"required"}]},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],{isReady:o.promise(),dataSource:u,refreshList:l,viewShowing:v,viewDisposing:y,openCreateViewAsRoot:a,icon:"Images/territory_32px.png",collapsibleFilter:r,commonGridView:i}};Dismoyo_Ciptoning_Client.vUsers=function(n,t){"use strict";function h(){e=!0}function c(){f=CommonUtility.configureCommonGridViewLayout("vUsers");f||setTimeout(c,50)}function v(){c();s()?e&&l():(s(u),u.load().always(function(){o.resolve()}))}function y(){Dismoyo_Ciptoning_Client.DB.vUsers.off("modified",h)}function l(){e=!1;u.pageIndex(0);u.load()}var e=!1,a=t.layoutController.name==="split",o=$.Deferred(),s=ko.observable(),u,f,i,r;u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vUsers,map:function(n){return new Dismoyo_Ciptoning_Client.vUserViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vUsers.on("modified",h);return i=new Dismoyo_Ciptoning_Client.CollapsibleFilter,i.filterOptions.onInitialized=function(){i.filter().element().resize(function(){f&&f.resizeAll()})},i.formOptions.items=[{name:"User",dataField:"",label:{text:"User"},editorOptions:{placeholder:"Name",onEnterKey:function(){i.events.performSearch()}}},{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Site"])}}},{dataField:"CompanyID",label:{text:"Company"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],[])}}}],i.events.performSearch=function(){var f=r.dataGrid(),u=i.form(),t=[],n;f.clearFilter();n=u.getEditor("TerritoryID").option("value");DXUtility.addFilterExpression(t,"TerritoryID","=",n,"and");n=u.getEditor("RegionID").option("value");DXUtility.addFilterExpression(t,"RegionID","=",n,"and");n=u.getEditor("AreaID").option("value");DXUtility.addFilterExpression(t,"AreaID","=",n,"and");n=u.getEditor("CompanyID").option("value");DXUtility.addFilterExpression(t,"CompanyID","=",n,"and");n=u.getEditor("SiteID").option("value");DXUtility.addFilterExpression(t,"SiteID","=",n,"and");n=u.getEditor("User").option("value");DXUtility.addFilterExpression(t,"Name","contains",n,"and");t.length>0?f.filter(t):f.refresh()},r=new Dismoyo_Ciptoning_Client.CommonGridView,r.dataGridOptions.dataSource=u,r.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Users.AddNewUser"),r.dataGridOptions.editing.editEnabled=r.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Users.EditUser"),r.dataGridOptions.editing.removeEnabled=r.dataGridOptions.editing.allowDeleting=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Users.DeleteUser"),r.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"Name",caption:"User Name",width:"180px",validationRules:[{type:"required"}],onlyAllowAdd:!0,editorOptions:{maxLength:256},headerCellTemplate:function(n,t){var r=$("#vUsers_commonGridView").find(".dx-datagrid:first-child"),i,u;!r.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+="<\/tr>",u=r.find(".dx-header-row:first-child"),$(i).insertBefore(u[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"IsHeadOffice",caption:"Head Office",width:"100px",dataType:"boolean",defaultValue:!1,setCellValue:function(n,t){var o=t?!0:!1,s,e,u,i,h,f;for(o&&(n.TerritoryID=null,n.RegionID=null,n.AreaID=null,n.SiteID=null,n.Company=null),s=r.dataGrid(),e=["TerritoryID","RegionID","AreaID","SiteID"],u=0;u<e.length;u++){if(i=s.columnOption(e[u]),h=-1,i.validationRules)for(f=0;f<i.validationRules.length;f++)if(i.validationRules[f].type=="required"){h=f;break}h>=0&&i.validationRules.splice(0,1);o||i.validationRules.splice(0,0,{type:"required"});i.allowEditing=!o;s.columnOption(e[u],i)}this.defaultSetCellValue(n,t)}},{dataField:"TerritoryID",caption:"Territory",width:"200px",validationRules:[{type:"required"}],lookup:{dataSource:DataUtility.vTerritories.dataSource(null),displayExpr:"Territory",valueExpr:"ID",allowClearing:!0},setCellValue:function(n,t){n.RegionID=null;n.AreaID=null;n.SiteID=null;n.Company=null;this.defaultSetCellValue(n,t)}},{dataField:"RegionID",caption:"Region",width:"200px",validationRules:[{type:"required"}],lookup:{dataSource:function(n){return CommonUtility.cascadeLoadLookupDataSource(n.data,"TerritoryID",DataUtility.vRegions.dataSource)},displayExpr:"Region",valueExpr:"ID",allowClearing:!0},setCellValue:function(n,t){CommonUtility.cascadeLookupValueChanged(this.lookup.items,n,"ID",t,["TerritoryID"]);t||(n.TerritoryID=null);n.AreaID=null;n.SiteID=null;n.Company=null;this.defaultSetCellValue(n,t)}},{dataField:"AreaID",caption:"Area",width:"200px",validationRules:[{type:"required"}],lookup:{dataSource:function(n){return CommonUtility.cascadeLoadLookupDataSource(n.data,"RegionID",DataUtility.vAreas.dataSource)},displayExpr:"Area",valueExpr:"ID",allowClearing:!0},setCellValue:function(n,t){CommonUtility.cascadeLookupValueChanged(this.lookup.items,n,"ID",t,["TerritoryID","RegionID"]);t||(n.TerritoryID=null,n.RegionID=null);n.SiteID=null;n.Company=null;this.defaultSetCellValue(n,t)}},{dataField:"Company",caption:"Company",width:"200px",allowEditing:!1},{dataField:"SiteID",caption:"Site",width:"200px",validationRules:[{type:"required"}],lookup:{dataSource:function(n){return CommonUtility.cascadeLoadLookupDataSource(n.data,"AreaID",DataUtility.vSites.dataSource)},displayExpr:"Site",valueExpr:"ID",allowClearing:!0},setCellValue:function(n,t){CommonUtility.cascadeLookupGuidValueChanged(this.lookup.items,n,"ID",t,["TerritoryID","RegionID","AreaID","Company"]);t||(n.TerritoryID=null,n.RegionID=null,n.AreaID=null,n.Company=null);this.defaultSetCellValue(n,t)}},{dataField:"StatusID",caption:"Status",width:"100px",defaultValue:1,validationRules:[{type:"required"}],lookup:{dataSource:DataUtility.vSystemLookups.dataSource(["Group","=","UserStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",allowClearing:!0}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],{isReady:o.promise(),dataSource:u,refreshList:l,viewShowing:v,viewDisposing:y,openCreateViewAsRoot:a,icon:"Images/user_32px.png",collapsibleFilter:i,commonGridView:r}};Dismoyo_Ciptoning_Client.vWarehouses=function(n,t){"use strict";function h(){e=!0}function c(){f=CommonUtility.configureCommonGridViewLayout("vWarehouses");f||setTimeout(c,50)}function p(){var n,t;c();n=Dismoyo_Ciptoning_Client.app.CurrentUser;n.IsHeadOffice()||(t=[["TerritoryID","=",n.TerritoryID()],"and",["RegionID","=",n.RegionID()],"and",["AreaID","=",n.AreaID()],"and",["CompanyID","=",n.CompanyID()],"and",["SiteID","=",n.SiteID()]],u.filter(t));s()?e&&l():(s(u),u.load().always(function(){o.resolve()}))}function w(){Dismoyo_Ciptoning_Client.DB.vWarehouses.off("modified",h)}function l(){e=!1;u.pageIndex(0);u.load()}var e=!1,y=t.layoutController.name==="split",o=$.Deferred(),s=ko.observable(),u,f,i,r,a,v;u=new DevExpress.data.DataSource({store:Dismoyo_Ciptoning_Client.DB.vWarehouses,map:function(n){return new Dismoyo_Ciptoning_Client.vWarehouseViewModel(n)}});Dismoyo_Ciptoning_Client.DB.vWarehouses.on("modified",h);return i=new Dismoyo_Ciptoning_Client.CollapsibleFilter,i.filterOptions.onInitialized=function(){i.filter().element().resize(function(){f&&f.resizeAll()})},i.formOptions.items=[{itemType:"group",caption:"Organization",colCount:3,colSpan:3,visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),items:[{dataField:"TerritoryID",label:{text:"Territory"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupTerritoryDataSource(null),displayExpr:"Territory",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Territory",[],["Region"])}}},{dataField:"RegionID",label:{text:"Region"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupRegionDataSource(null),displayExpr:"Region",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Region",["Territory"],["Area"])}}},{dataField:"AreaID",label:{text:"Area"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupAreaDataSource(null),displayExpr:"Area",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Area",["Region","Territory"],["Company","Site"])}}},{dataField:"CompanyID",label:{text:"Company"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupCompanyDataSource(null),displayExpr:"Company",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch(this)}}},{dataField:"SiteID",label:{text:"Site"},editorType:"dxSelectBox",editorOptions:{dataSource:DataUtility.GetLookupSiteDataSource(null),displayExpr:"Site",valueExpr:"ID",placeholder:"(All)",searchEnabled:!0,showClearButton:!0,onEnterKey:function(){i.events.performSearch()},onValueChanged:function(n){CommonUtility.cascadeValueChanged(i.form(),n.selectedItem,n.value,"Site",["Company","Area","Region","Territory"],[])}}}]},{itemType:"group",caption:"Warehouse",colCount:3,colSpan:3,items:[{name:"Warehouse",dataField:"",label:{text:"Warehouse"},editorType:"dxTextBox",editorOptions:{placeholder:"Code/Name",onEnterKey:function(){i.events.performSearch()}}},{dataField:"",label:{text:"",visible:!1},editorOptions:{visible:!1}}]}],i.events.performSearch=function(){var e=r.dataGrid(),t=i.form(),n=[],o,f;e.clearFilter();var u=Dismoyo_Ciptoning_Client.app.CurrentUser,s=u.TerritoryID(),h=u.RegionID(),c=u.AreaID(),l=u.CompanyID(),a=u.SiteID();t.itemOption("Organization").visible&&(s=t.getEditor("TerritoryID").option("value"),h=t.getEditor("RegionID").option("value"),c=t.getEditor("AreaID").option("value"),l=t.getEditor("CompanyID").option("value"),a=t.getEditor("SiteID").option("value"));DXUtility.addFilterExpression(n,"TerritoryID","=",s,"and");DXUtility.addFilterExpression(n,"RegionID","=",h,"and");DXUtility.addFilterExpression(n,"AreaID","=",c,"and");DXUtility.addFilterExpression(n,"CompanyID","=",l,"and");DXUtility.addFilterExpression(n,"SiteID","=",a,"and");o=t.getEditor("Warehouse").option("value");f=[];DXUtility.addFilterExpression(f,"Code","contains",o,"or");DXUtility.addFilterExpression(f,"Name","contains",o,"or");DXUtility.addGroupFilterExpression(n,f,"and");n.length>0?e.filter(n):e.refresh()},r=new Dismoyo_Ciptoning_Client.CommonGridView,r.dataGridOptions.dataSource=u,r.newRowOptions.disabled=!Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Warehouses.AddNewWarehouse"),r.dataGridOptions.editing.editEnabled=r.dataGridOptions.editing.allowUpdating=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Warehouses.EditWarehouse"),r.dataGridOptions.editing.removeEnabled=r.dataGridOptions.editing.allowDeleting=Dismoyo_Ciptoning_Client.app.CurrentUser.isAuthorized("Warehouses.DeleteWarehouse"),r.events.initRow=function(n){var t=Dismoyo_Ciptoning_Client.app.CurrentUser;t.IsHeadOffice()||(n.data.TerritoryID=t.TerritoryID(),n.data.RegionID=t.RegionID(),n.data.AreaID=t.AreaID(),n.data.SiteID=t.SiteID(),n.data.CompanyID=t.CompanyID())},r.dataGridOptions.onEditorPreparing=function(n){n.parentType=="dataRow"&&n.row&&(n.component.editRowIndex=n.row.rowIndex)},a={type:"pattern",pattern:/^\w+\-\w+$/,message:"Format must be [Site Code]-[Warehouse Code]."},v={type:"custom",validationCallback:function(n){var u=!0,t="",i,r;return Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?(i=n.validator._validationGroup.data,i.SiteID&&(r=Dismoyo_Ciptoning_Client.LocalStore.vSites.dataByFilter(["ID","=",i.SiteID._value])[0],r&&(t=r.Code()))):t=Dismoyo_Ciptoning_Client.app.CurrentUser.SiteCode(),t!=""&&t!=undefined&&t!=n.value.split("-")[0]&&(u=!1),u},message:"Site Code must be "+(Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?"same as selected Site.":Dismoyo_Ciptoning_Client.app.CurrentUser.SiteCode()+".")},r.dataGridOptions.columns=[{dataField:"ID",visible:!1},{dataField:"TerritoryID",caption:"Territory",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),validationRules:[{type:"required"}],lookup:{dataSource:DataUtility.vTerritories.dataSource(null),displayExpr:"Territory",valueExpr:"ID",allowClearing:!0},setCellValue:function(n,t){n.RegionID=null;n.AreaID=null;n.SiteID=null;n.Company=null;this.defaultSetCellValue(n,t)}},{dataField:"RegionID",caption:"Region",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),validationRules:[{type:"required"}],lookup:{dataSource:function(n){return CommonUtility.cascadeLoadLookupDataSource(n.data,"TerritoryID",DataUtility.vRegions.dataSource)},displayExpr:"Region",valueExpr:"ID",allowClearing:!0},setCellValue:function(n,t){CommonUtility.cascadeLookupValueChanged(this.lookup.items,n,"ID",t,["TerritoryID"]);n.AreaID=null;n.SiteID=null;n.Company=null;this.defaultSetCellValue(n,t)}},{dataField:"AreaID",caption:"Area",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),validationRules:[{type:"required"}],lookup:{dataSource:function(n){return CommonUtility.cascadeLoadLookupDataSource(n.data,"RegionID",DataUtility.vAreas.dataSource)},displayExpr:"Area",valueExpr:"ID",allowClearing:!0},setCellValue:function(n,t){CommonUtility.cascadeLookupValueChanged(this.lookup.items,n,"ID",t,["TerritoryID","RegionID"]);n.SiteID=null;n.Company=null;this.defaultSetCellValue(n,t)}},{dataField:"Company",caption:"Company",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),allowEditing:!1},{dataField:"SiteID",caption:"Site",width:"200px",visible:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice(),validationRules:[{type:"required"}],lookup:{dataSource:function(n){return CommonUtility.cascadeLoadLookupDataSource(n.data,"AreaID",DataUtility.vSites.dataSource)},displayExpr:"Site",valueExpr:"ID",allowClearing:!0},setCellValue:function(n,t){CommonUtility.cascadeLookupGuidValueChanged(this.lookup.items,n,"ID",t,["TerritoryID","RegionID","AreaID","Company"]);n.Code=$.grep(this.lookup.items,function(n){return n.ID()._value==t._value})[0].Code()+"-";this.defaultSetCellValue(n,t)}},{dataField:"Code",width:"120px",defaultValue:Dismoyo_Ciptoning_Client.app.CurrentUser.IsHeadOffice()?undefined:Dismoyo_Ciptoning_Client.app.CurrentUser.SiteCode()+"-",validationRules:[{type:"required"},a,v],editorOptions:{maxLength:12},onlyAllowAdd:!0,headerCellTemplate:function(n,t){var u=$("#vWarehouses_commonGridView").find(".dx-datagrid:first-child"),i,f,e;!u.find(".datagrid-bandedHeader:first").length>0&&(i='<tr class="dx-row dx-column-lines datagrid-bandedHeader">',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',f=Dismoyo_Ciptoning_Client.app.CurrentUser,f.IsHeadOffice()&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+='       <td class="dx-datagrid-action" colspan="2">Warehouse<\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Created<\/td>',i+='       <td class="dx-datagrid-action" colspan="2">Modified<\/td>',(r.dataGridOptions.editing.allowUpdating||r.dataGridOptions.editing.allowDeleting)&&(i+='       <td class="dx-datagrid-action" style="border-bottom-style: none;"><\/td>'),i+="<\/tr>",e=u.find(".dx-header-row:first-child"),$(i).insertBefore(e[0].parentElement),$(n).append(HtmlUtility.htmlEncode(t.column.caption)))}},{dataField:"Name",width:"180px",editorOptions:{maxLength:50},validationRules:[{type:"required"}]},{dataField:"TypeID",caption:"Type",width:"120px",validationRules:[{type:"required"}],lookup:{dataSource:DataUtility.vSystemLookups.dataSource(["Group","=","WarehouseType"]),displayExpr:"Name",valueExpr:"Value_Int32",allowClearing:!0}},{dataField:"StatusID",caption:"Status",width:"100px",defaultValue:1,validationRules:[{type:"required"}],lookup:{dataSource:DataUtility.vSystemLookups.dataSource(["Group","=","WarehouseStatus"]),displayExpr:"Name",valueExpr:"Value_Int32",allowClearing:!0}},{dataField:"CreatedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"CreatedByUserName",caption:"By",width:"140px",allowEditing:!1},{dataField:"ModifiedDate",caption:"Date",width:"140px",allowEditing:!1,customizeText:function(n){return n.value?DateTimeUtility.convertToLocal(n.value).toLocaleString():null}},{dataField:"ModifiedByUserName",caption:"By",width:"140px",allowEditing:!1}],{isReady:o.promise(),dataSource:u,refreshList:l,viewShowing:p,viewDisposing:w,openCreateViewAsRoot:y,icon:"Images/warehouse_32px.png",collapsibleFilter:i,commonGridView:r}};
