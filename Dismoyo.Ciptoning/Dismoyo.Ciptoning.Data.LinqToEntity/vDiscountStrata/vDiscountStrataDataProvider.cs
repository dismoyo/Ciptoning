// ===================================================================================
// Author        : System
// Created date  : 29 Feb 2016 12:50:57
// Description   : vDiscountStrataDataProvider partial class.
//
// Modified date :
// Modified by   :
// Comments      :
//
// NOTE: This file is initially generated by system and can be modified following
//       the requirement.
// ===================================================================================

using Dismoyo.Utilities;
using System;
using System.Collections.Generic;
using System.Linq;
//using WebMatrix.WebData;

namespace Dismoyo.Ciptoning.Data
{

    public partial class vDiscountStrataDataProvider : DefaultViewDataProvider<vDiscountStrata>, IvDiscountStrataDataProvider
    {

        #region Methods

        protected override void OnInsertData(vDiscountStrata obj, bool useTransaction)
        {
            var discountStrataDataProvider = DataConfiguration.GetDefaultDataProvider<IDiscountStrataDataProvider>();

            var discountStrata = new DiscountStrata();

            var existingCode = GetByCode(obj.Code);
            if (existingCode.Count() > 0)
            {
                Exception ex = new Exception("Code value '" + obj.Code + "' is already exist.");
                throw ex;
            }

            discountStrata.Code = obj.Code;
            discountStrata.Name = obj.Name;            
            discountStrata.ValidDateFrom = obj.ValidDateFrom;
            discountStrata.ValidDateTo = obj.ValidDateTo;
            discountStrata.StatusID = obj.StatusID;
            
            discountStrataDataProvider.InsertData(discountStrata, useTransaction);
            if ((obj.ChildDetails != null) && (obj.ChildDetails.Count > 0))
            {
                // Insert new child data.
                var vDiscountStrataDetailsDataProvider =
                    DataConfiguration.GetDefaultDataProvider<IvDiscountStrataDetailsDataProvider>();
                foreach (var details in obj.ChildDetails)
                {
                    details.StrataID = discountStrata.ID;
                    vDiscountStrataDetailsDataProvider.InsertData(details, useTransaction);
                }
            }
        }

        protected override void OnUpdateData(vDiscountStrata obj, bool useTransaction)
        {
            var discountStrataDataProvider = DataConfiguration.GetDefaultDataProvider<IDiscountStrataDataProvider>();

            var discountStrata = discountStrataDataProvider.GetData(obj.ID);

            discountStrata.Code = obj.Code;
            discountStrata.Name = obj.Name;            
            discountStrata.ValidDateFrom = obj.ValidDateFrom;
            discountStrata.ValidDateTo = obj.ValidDateTo;
            discountStrata.StatusID = obj.StatusID;

            if ((obj.ChildDetails != null) && (obj.ChildDetails.Count > 0))
            {
                var discountStrataDetailsDataProvider =
                    DataConfiguration.GetDefaultDataProvider<IDiscountStrataDetailsDataProvider>();
                var vDiscountStrataDetailsDataProvider =
                    DataConfiguration.GetDefaultDataProvider<IvDiscountStrataDetailsDataProvider>();

                var insertChilds = obj.ChildDetails.ToList();
                var deleteChilds = discountStrataDetailsDataProvider.GetDataByStrataID(discountStrata.ID);
                var updateChilds = new List<vDiscountStrataDetails>();
                int i = 0;
                while (i < deleteChilds.Count)
                {
                    var data = insertChilds.SingleOrDefault(p => (p.ID == deleteChilds[i].ID));
                    if (data != null)
                    {
                        insertChilds.Remove(data);
                        deleteChilds.RemoveAt(i);
                        updateChilds.Add(data);
                        continue;
                    }

                    i++;
                }

                // Removes existing and unused child data.
                foreach (var details in deleteChilds)
                    discountStrataDetailsDataProvider.DeleteData(details, useTransaction);

                // Update existing child data.
                foreach (var details in updateChilds)
                    vDiscountStrataDetailsDataProvider.UpdateData(details, useTransaction);

                // Insert new child data.
                foreach (var details in insertChilds)
                {
                    details.StrataID = discountStrata.ID;
                    vDiscountStrataDetailsDataProvider.InsertData(details, useTransaction);
                }
            }

            discountStrataDataProvider.UpdateData(discountStrata);
        }

        protected override void OnDeleteData(vDiscountStrata obj, bool useTransaction)
        {
            var discountStrataDataProvider = DataConfiguration.GetDefaultDataProvider<IDiscountStrataDataProvider>();

            var discountStrata = discountStrataDataProvider.GetData(obj.ID);

            discountStrata.IsDeleted = true;

            discountStrataDataProvider.UpdateData(discountStrata);
        }

        public IEnumerable<DiscountStrata> GetByCode(string code)
        {
            IQueryable<DiscountStrata> query = (from obj in DataContext.Set<DiscountStrata>()
                                              where obj.Code == code
                                                 && !obj.IsDeleted
                                              select obj);
            return query;
        }

        #endregion

    }

}
