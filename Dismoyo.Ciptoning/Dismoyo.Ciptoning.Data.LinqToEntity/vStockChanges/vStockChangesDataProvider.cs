// ===================================================================================
// Author        : System
// Created date  : 29 Feb 2016 12:50:57
// Description   : vStockChangesDataProvider partial class.
//
// Modified date :
// Modified by   :
// Comments      :
//
// NOTE: This file is initially generated by system and can be modified following
//       the requirement.
// ===================================================================================

using Dismoyo.Utilities;
using System;
using System.Collections.Generic;
using System.Linq;
//using WebMatrix.WebData;

namespace Dismoyo.Ciptoning.Data
{

    public partial class vStockChangesDataProvider : DefaultViewDataProvider<vStockChanges>, IvStockChangesDataProvider
    {

        #region Methods

        protected override void OnInsertData(vStockChanges obj, bool useTransaction)
        {
            var stockChangesDataProvider = DataConfiguration.GetDefaultDataProvider<IStockChangesDataProvider>();
            var vWarehouseDataProvider = DataConfiguration.GetDefaultDataProvider<IvWarehouseDataProvider>();

            var stockChanges = new StockChanges();
            var vWarehouse = vWarehouseDataProvider.GetData(obj.WarehouseID);

            stockChanges.DocumentID = (obj.DocumentID.Equals(Guid.Empty) ? Guid.NewGuid() : obj.DocumentID);
            stockChanges.DocumentCode = string.Format("{0}-{1}-07-{2}", vWarehouse.SiteCode,
                DateTime.Today.ToString("yy"),
                DefaultDataContext.GetAutoNumberCounter(vWarehouse.SiteID.Value, 7).ToString().PadLeft(7, '0'));
            stockChanges.TransactionDate = obj.TransactionDate;
            stockChanges.WarehouseID = obj.WarehouseID;
            stockChanges.PIC = obj.PIC;
            stockChanges.OldItemStatusID = obj.OldItemStatusID;
            stockChanges.NewItemStatusID = obj.NewItemStatusID;
            stockChanges.ReferenceNumber = obj.ReferenceNumber;
            stockChanges.AttachmentFile = obj.AttachmentFile;
            stockChanges.DocumentStatusID = 1; // Draft

            stockChangesDataProvider.InsertData(stockChanges, useTransaction);
            if ((obj.ChildSummaries != null) && (obj.ChildSummaries.Count > 0))
            {
                // Insert new child data.
                var vStockChangesSummaryDataProvider =
                    DataConfiguration.GetDefaultDataProvider<IvStockChangesSummaryDataProvider>();
                foreach (var summary in obj.ChildSummaries)
                {
                    summary.DocumentID = stockChanges.DocumentID;
                    vStockChangesSummaryDataProvider.InsertData(summary, useTransaction);
                }
            }
        }

        protected override void OnUpdateData(vStockChanges obj, bool useTransaction)
        {
            var stockChangesDataProvider = DataConfiguration.GetDefaultDataProvider<IStockChangesDataProvider>();
            var vWarehouseDataProvider = DataConfiguration.GetDefaultDataProvider<IvWarehouseDataProvider>();

            var stockChanges = stockChangesDataProvider.GetData(obj.DocumentID);
            var vWarehouse = vWarehouseDataProvider.GetData(obj.WarehouseID);

            var stockChangesSummaryDataProvider =
                DataConfiguration.GetDefaultDataProvider<IStockChangesSummaryDataProvider>();
            var vStockChangesSummaryDataProvider =
                DataConfiguration.GetDefaultDataProvider<IvStockChangesSummaryDataProvider>();

            if (stockChanges.DocumentStatusID == 1) // Draft
            {
                stockChanges.TransactionDate = obj.TransactionDate;
                stockChanges.PIC = obj.PIC;
                stockChanges.NewItemStatusID = obj.NewItemStatusID;
                stockChanges.ReferenceNumber = obj.ReferenceNumber;
                if (obj.AttachmentFile != null)
                    stockChanges.AttachmentFile = obj.AttachmentFile;

                if ((obj.ChildSummaries != null) && (obj.ChildSummaries.Count > 0))
                {
                    var insertChilds = obj.ChildSummaries.ToList();
                    var deleteChilds = stockChangesSummaryDataProvider.GetDataByDocumentID(stockChanges.DocumentID);
                    var updateChilds = new List<vStockChangesSummary>();
                    int i = 0;
                    while (i < deleteChilds.Count)
                    {
                        var data = insertChilds.SingleOrDefault(p => (p.ProductID == deleteChilds[i].ProductID));
                        if (data != null)
                        {
                            insertChilds.Remove(data);
                            deleteChilds.RemoveAt(i);
                            updateChilds.Add(data);
                            continue;
                        }

                        i++;
                    }

                    // Removes existing and unused child data.
                    foreach (var summary in deleteChilds)
                        stockChangesSummaryDataProvider.DeleteData(summary, useTransaction);

                    // Update existing child data.
                    foreach (var summary in updateChilds)
                        vStockChangesSummaryDataProvider.UpdateData(summary, useTransaction);

                    // Insert new child data.
                    foreach (var summary in insertChilds)
                    {
                        summary.DocumentID = stockChanges.DocumentID;
                        vStockChangesSummaryDataProvider.InsertData(summary, useTransaction);
                    }
                }
            }

            if (stockChanges.DocumentStatusID != obj.DocumentStatusID)
            {
                if ((stockChanges.DocumentStatusID == 1) && (obj.DocumentStatusID == 2)) // Draft to Posted
                {
                    var closingPeriodDataProvider = DataConfiguration.GetDefaultDataProvider<IClosingPeriodDataProvider>();

                    if (!closingPeriodDataProvider.IsOpenPeriod(vWarehouse.SiteID.Value, obj.TransactionDate.Year,
                        obj.TransactionDate.Month))
                        throw new Exception(string.Format("This Site for {0:MMM} {0:yyyy} period is already Closed.",
                            obj.TransactionDate));

                    stockChanges.PostedDate = DefaultDataContext.GetDBServerUtcDateTime();

                    // Insert data to Stock Transaction.
                    var stockTransactionDataProvider = DataConfiguration.GetDefaultDataProvider<IStockTransactionDataProvider>();
                    var stockOnHandCurrentDataProvider = DataConfiguration.GetDefaultDataProvider<IStockOnHandCurrentDataProvider>();

                    if ((obj.ChildSummaries != null) && (obj.ChildSummaries.Count > 0))
                    {
                        foreach (var summary in obj.ChildSummaries)
                        {
                            if ((summary.ChildDetails != null) && (summary.ChildDetails.Count > 0))
                            {
                                int qtyOnHand = stockOnHandCurrentDataProvider.GetProductSummaryStockOnHand(
                                    stockChanges.WarehouseID, summary.ProductID, stockChanges.OldItemStatusID);

                                foreach (var details in summary.ChildDetails)
                                {
                                    var stockOnHandCurrent = stockOnHandCurrentDataProvider.GetData(stockChanges.WarehouseID,
                                        summary.ProductID, details.ProductLotID);

                                    if ((stockOnHandCurrent == null) ||
                                        (((stockChanges.OldItemStatusID == 1) &&(stockOnHandCurrent.QtyOnHandGood + details.Qty) < 0) ||
                                        ((stockChanges.OldItemStatusID == 2) && (stockOnHandCurrent.QtyOnHandHold + details.Qty) < 0) ||
                                        ((stockChanges.OldItemStatusID == 3) && (stockOnHandCurrent.QtyOnHandBad + details.Qty) < 0)))
                                        throw new Exception("There is not enough stock for Product '" + summary.Product +
                                            "', Lot Number '" + details.ProductLotCode + "'.");

                                    switch (stockChanges.OldItemStatusID)
                                    {
                                        case 1: details.QtyOnHand = stockOnHandCurrent.QtyOnHandGood; break;
                                        case 2: details.QtyOnHand = stockOnHandCurrent.QtyOnHandHold; break;
                                        case 3: details.QtyOnHand = stockOnHandCurrent.QtyOnHandBad; break;
                                    }
                                    
                                    var stockTransaction = new StockTransaction();

                                    stockTransaction.DocumentID = stockChanges.DocumentID;
                                    stockTransaction.TransactionDate = stockChanges.TransactionDate;
                                    stockTransaction.TransactionTypeID = 7; // Stock Changes
                                    stockTransaction.DocumentCode = stockChanges.DocumentCode;
                                    stockTransaction.SourceID = stockChanges.WarehouseID;
                                    stockTransaction.DestinationID = null;

                                    stockTransaction.ProductID = summary.ProductID;

                                    stockTransaction.ProductLotID = details.ProductLotID;
                                    switch (stockChanges.OldItemStatusID)
                                    {
                                        case 1: // Good
                                            stockTransaction.QtyGood = details.Qty;
                                            if (stockOnHandCurrent != null)
                                                stockOnHandCurrent.QtyOnHandGood += details.Qty;

                                            break;
                                        case 2: // Hold
                                            stockTransaction.QtyHold = details.Qty;
                                            if (stockOnHandCurrent != null)
                                                stockOnHandCurrent.QtyOnHandHold += details.Qty;

                                            break;
                                        case 3: // Bad
                                            stockTransaction.QtyBad = details.Qty;
                                            if (stockOnHandCurrent != null)
                                                stockOnHandCurrent.QtyOnHandBad += details.Qty;

                                            break;
                                    }

                                    switch (stockChanges.NewItemStatusID)
                                    {
                                        case 1: // Good
                                            stockTransaction.QtyGood = details.Qty * -1;
                                            if (stockOnHandCurrent != null)
                                                stockOnHandCurrent.QtyOnHandGood += details.Qty * -1;

                                            break;
                                        case 2: // Hold
                                            stockTransaction.QtyHold = details.Qty * -1;
                                            if (stockOnHandCurrent != null)
                                                stockOnHandCurrent.QtyOnHandHold += details.Qty * -1;

                                            break;
                                        case 3: // Bad
                                            stockTransaction.QtyBad = details.Qty * -1;
                                            if (stockOnHandCurrent != null)
                                                stockOnHandCurrent.QtyOnHandBad += details.Qty * -1;

                                            break;
                                    }

                                    if (stockOnHandCurrent == null)
                                    {
                                        stockOnHandCurrent = new StockOnHandCurrent();
                                        stockOnHandCurrent.WarehouseID = stockChanges.WarehouseID;
                                        stockOnHandCurrent.ProductID = summary.ProductID;
                                        stockOnHandCurrent.ProductLotID = details.ProductLotID;
                                        stockOnHandCurrent.QtyOnHandGood = 0;
                                        stockOnHandCurrent.QtyOnHandHold = 0;
                                        stockOnHandCurrent.QtyOnHandBad = 0;

                                        stockOnHandCurrentDataProvider.InsertData(stockOnHandCurrent, useTransaction);
                                    }
                                    else
                                    {
                                        stockOnHandCurrentDataProvider.UpdateData(stockOnHandCurrent, useTransaction);
                                    }

                                    stockTransactionDataProvider.InsertData(stockTransaction, useTransaction);
                                }

                                if (summary.QtyOnHand != qtyOnHand)
                                {
                                    summary.QtyOnHand = qtyOnHand;
                                    vStockChangesSummaryDataProvider.UpdateData(summary, useTransaction);
                                }
                            }
                        }
                    }

                    stockChanges.DocumentStatusID = 2; // Posted
                }
                else if ((stockChanges.DocumentStatusID == 1) && (obj.DocumentStatusID == 3)) // Draft to Discarded
                {
                    stockChanges.DocumentStatusID = 3; // Discarded
                }
            }

            stockChangesDataProvider.UpdateData(stockChanges);
        }

        #endregion

    }

}
